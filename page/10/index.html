<!DOCTYPE HTML>
<html>
<head>
	<meta name="generator" content="Hugo 0.51" />
	<meta charset="utf-8">
    
    
    <title>凝雨 - Yun</title>
    <meta name="author" content="凝雨-Yun">
    <meta name="description" content="">
    <meta name="keywords" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link href="https://ningyu1.github.io/site/index.xml" rel="alternate" title="凝雨 - Yun" type="application/atom+xml">
    <link href="https://ningyu1.github.io/site/images/fav.ico" rel="shortcut icon">
    <style>
    @charset "UTF-8";
@font-face {
  font-family: 'FontAwesome';
  src: url("https://ningyu1.github.io/site/font/fontawesome-webfont.eot");
  src: url("https://ningyu1.github.io/site/font/fontawesome-webfont.eot?#iefix") format("embedded-opentype"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.woff") format("woff"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.ttf") format("truetype"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.svgz#FontAwesomeRegular") format("svg"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.svg#FontAwesomeRegular") format("svg");
  font-weight: normal;
  font-style: normal; }

@font-face{
    font-family: 'MyHermit';
    src: url('https://ningyu1.github.io/site/font/hermit-medium-webfont.eot');
    src: url('https://ningyu1.github.io/site/font/hermit-medium-webfont.eot?#iefix') format('embedded-opentype'),
         url('https://ningyu1.github.io/site/font/hermit-medium-webfont.woff') format('woff'),
         url('https://ningyu1.github.io/site/font/hermit-medium-webfont.ttf') format('truetype');
}

* {
  margin: 0;
  padding: 0; }

body {
  font-family: 'PingFang SC', serif;
  font-weight: 300;
  font-size: 16px;
  /*background: url("https://ningyu1.github.io/site/images/retina_dust.png");*/
  color: #444;
  colori: #666666; }
  @media screen and (max-width: 1040px) {
    body {
      margin: 0 20px; } }
  @media screen and (max-width: 600px) {
    body {
      font-size: 13px; } }

.bBackground {
  position: fixed;
  height: 100%;
  width: 100%;
  background: -moz-radial-gradient(50% 50%, farthest-side, white, #efefef);
  background: -webkit-gradient(radial, 50% 50%, 250, 50% 50%, 750, from(white), to(#bbbbbb));
  z-index: -100; }

h1 {
  font-size: 1.8em; }

h2 {
  font-family: 'Fjalla One', sans-serif;
  font-size: 1.5em; }

h3 {
  font-size: 1.3em; }

a {
  text-decoration: none;
  outline-width: 0;
  color: #258fb8; }

.alignleft {
  float: left; }

.alignright {
  float: right; }

.clearfix {
  *zoom: 1; }
  .clearfix:after {
    content: "";
    display: table;
    clear: both; }

.inner {
  width: 900px;
  margin: 0 auto; }
  @media screen and (max-width: 1040px) {
    .inner {
      width: 100%; } }

#w2btoTop {
  display: none;
  text-decoration: none;
  position: fixed;
  bottom: 10px;
  right: 10px;
  overflow: hidden;
  width: 51px;
  height: 51px;
  border: none;
  text-indent: -999px;
  background: url(https://ningyu1.github.io/site/images/totop.png) no-repeat left top; }

#w2btoTopHover {
  background: url(https://ningyu1.github.io/site/images/totop.png) no-repeat left -51px;
  width: 51px;
  height: 51px;
  display: block;
  overflow: hidden;
  float: left;
  opacity: 0;
  -moz-opacity: 0;
  filter: alpha(opacity=0); }

#w2btoTop:active, #w2btoTop:focus {
  outline: none; }

.basic-alignment.left, article .entry-content img.left, article .entry-content video.left {
  float: left;
  margin-right: 1.5em; }
.basic-alignment.right, article .entry-content img.right, article .entry-content video.right {
  float: right;
  margin-left: 1.5em; }
.basic-alignment.center, article .entry-content img.center, article .entry-content video.center {
  display: block;
  margin: 0 auto 1.5em; }
.basic-alignment.left, article .entry-content img.left, article .entry-content video.left, .basic-alignment.right, article .entry-content img.right, article .entry-content video.right {
  margin-bottom: .8em; }

/* changes tooltip, to use, make elements 'class' as 'tooltip' and 'title' would be shown in tooltip */
.tooltip {
  display: inline;
  position: relative; }

.tooltip:hover {
  text-decoration: none; }

.tooltip:hover:after {
  background: #111;
  background: rgba(0, 0, 0, 0.8);
  border-radius: 5px;
  bottom: 18px;
  color: #fff;
  content: attr(title);
  display: block;
  left: 50%;
  padding: 5px 15px;
  position: absolute;
  white-space: nowrap;
  z-index: 98; }

.tooltip:hover:before {
  border: solid;
  border-color: #111 transparent;
  border-width: 6px 6px 0 6px;
  bottom: 12px;
  content: "";
  display: block;
  left: 75%;
  position: absolute;
  z-index: 99; }

.pullquote-right:before,
.pullquote-left:before {
  /* Reset metrics. */
  padding: 0;
  border: none;
  /* Content */
  content: attr(data-pullquote);
  /* Pull out to the right, modular scale based margins. */
  float: right;
  width: 45%;
  margin: .5em 0 1em 1.5em;
  /* Baseline correction */
  position: relative;
  top: 7px;
  font-size: 1.4em;
  line-height: 1.45em; }

.pullquote-left:before {
  /* Make left pullquotes align properly. */
  float: left;
  margin: .5em 1.5em 1em 0; }

#header {
  padding: 20px 0 20px 0; }
  @media screen and (max-width: 1040px) {
    #header {
      height: auto;
      position: relative;
      padding-bottom: 10px; } }
  #header a {
    color: #666666;
    -webkit-transition: compact(compact(color 0.3s, false, false, false, false, false, false, false, false, false) false false);
    -moz-transition: compact(compact(color 0.3s, false, false, false, false, false, false, false, false, false) false false false);
    -o-transition: compact(compact(color 0.3s, false, false, false, false, false, false, false, false, false) false false false);
    transition: compact(color 0.3s, false, false, false, false, false, false, false, false, false); }
    #header a:hover {
      color: #258fb8; }
  #header h1 {
    font-family: 'Slackey', cursive;
    font-weight: 300;
    font-size: 52px; }
    @media screen and (max-width: 1040px) {
      #header h1 {
        float: none; } }

#headerbg {
  text-align: center;
  background: #444;
  padding: 10px 10px;
  display: table;
  color: #fff;
  margin: 0 auto;
  border-radius: 5px;
  font-weight: bold;
  -webkit-mask-image: -webkit-linear-gradient(black, rgba(0, 0, 0, 0.9));
  -webkit-backface-visibility: hidden;
  -moz-backface-visibility: hidden;
  -ms-backface-visibility: hidden;
  -o-backface-visibility: hidden;
  backface-visibility: hidden;
  -webkit-animation-duration: 1s;
  -webkit-animation-delay: .2s;
  -webkit-animation-timing-function: ease;
  -webkit-animation-fill-mode: both;
  -moz-animation-duration: 1s;
  -moz-animation-delay: .2s;
  -moz-animation-timing-function: ease;
  -moz-animation-fill-mode: both;
  -ms-animation-duration: 1s;
  -ms-animation-delay: .2s;
  -ms-animation-timing-function: ease;
  -ms-animation-fill-mode: both;
  -o-animation-duration: 1s;
  -o-animation-delay: .2s;
  -o-animation-timing-function: ease;
  -o-animation-fill-mode: both;
  animation-duration: 1s;
  animation-delay: .2s;
  animation-timing-function: ease;
  animation-fill-mode: both; }

#load {
  display: none;
  position: absolute;
  right: 50%;
  top: 50%;
  background: url("https://ningyu1.github.io/site/images/loading.gif");
  width: 50px;
  height: 50px;
  text-indent: -9999em; }

#social-links li {
  display: inline-block;
  width: 35px;
  height: 35px;
  border-radius: 35px;
  margin-top: 20px;
  margin-right: 9px;
  background-color: #ddd;
  text-align: center;
  line-height: 35px;
  -webkit-transition: compact(compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false) false false);
  -moz-transition: compact(compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false) false false false);
  -o-transition: compact(compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false) false false false);
  transition: compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false); }
  #social-links li:hover {
    background-color: #555; }
#social-links a {
  display: inline-block;
  position: relative;
  width: 100%;
  height: 100%; }
  #social-links a svg {
    position: absolute; }
  #social-links a .github {
    top: 3px;
    left: 2px; }
  #social-links a .sina-weibo {
    top: 8px;
    left: 6px; }
  #social-links a .tencent-weibo {
    top: 6px;
    left: 4px; }
  #social-links a .twitter {
    top: 2px;
    left: 3px; }

a.facebook {
  background: url("https://ningyu1.github.io/site/images/social/Facebook.png") center no-repeat; }

a.facebook:hover {
  background: url("https://ningyu1.github.io/site/images/social/FacebookH.png") center no-repeat; }

a.github {
  background: url("https://ningyu1.github.io/site/images/social/Github.png") center no-repeat; }

a.github:hover {
  background: url("https://ningyu1.github.io/site/images/social/GithubH.png") center no-repeat; }

a.gitee {
  background: url("https://ningyu1.github.io/site/images/social/Gitee.png") center no-repeat; }

a.gitee:hover {
  background: url("https://ningyu1.github.io/site/images/social/GiteeH.png") center no-repeat; }

a.gitlab {
  background: url("https://ningyu1.github.io/site/images/social/Gitlab.png") center no-repeat; }

a.gitlab:hover {
  background: url("https://ningyu1.github.io/site/images/social/GitlabH.png") center no-repeat; }

a.email {
  background: url("https://ningyu1.github.io/site/images/social/Email.png") center no-repeat; }

a.email:hover {
  background: url("https://ningyu1.github.io/site/images/social/EmailH.png") center no-repeat; }

a.rss {
  background: url("https://ningyu1.github.io/site/images/social/Rss.png") center no-repeat; }

a.rss:hover {
  background: url("https://ningyu1.github.io/site/images/social/RssH.png") center no-repeat; }

a.twitter {
  background: url("https://ningyu1.github.io/site/images/social/Twitter.png") center no-repeat; }

a.twitter:hover {
  background: url("https://ningyu1.github.io/site/images/social/TwitterH.png") center no-repeat; }

a.google {
  background: url("https://ningyu1.github.io/site/images/social/Picasa.png") center no-repeat; }

a.google:hover {
  background: url("https://ningyu1.github.io/site/images/social/PicasaH.png") center no-repeat; }

a.skype {
  background: url("https://ningyu1.github.io/site/images/social/Skype.png") center no-repeat; }

a.skype:hover {
  background: url("https://ningyu1.github.io/site/images/social/SkypeH.png") center no-repeat; }

a.linkedin {
  background: url("https://ningyu1.github.io/site/images/social/LinkedIn.png") center no-repeat; }

a.linkedin:hover {
  background: url("https://ningyu1.github.io/site/images/social/LinkedInH.png") center no-repeat; }

a.youtube {
  background: url("https://ningyu1.github.io/site/images/social/Youtube.png") center no-repeat; }

a.youtube:hover {
  background: url("https://ningyu1.github.io/site/images/social/YoutubeH.png") center no-repeat; }

a.lastfm {
  background: url("https://ningyu1.github.io/site/images/social/LastFM.png") center no-repeat; }

a.lastfm:hover {
  background: url("https://ningyu1.github.io/site/images/social/LastFMH.png") center no-repeat; }

/* search bar */
#search {
  display: inline; }

#search input[type="text"] {
  background: url("https://ningyu1.github.io/site/images/search-dark.png") no-repeat 10px 6px #444444;
  border: 0 none;
  font: bold 12px Arial,Helvetica,Sans-serif;
  color: #777;
  width: 110px;
  padding: 6px 15px 6px 35px;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  text-shadow: 0 2px 2px rgba(0, 0, 0, 0.3);
  -webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -moz-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -webkit-transition: all 0.7s ease 0s;
  -moz-transition: all 0.7s ease 0s;
  -o-transition: all 0.7s ease 0s;
  transition: all 0.7s ease 0s; }

#search input[type="text"]:focus {
  width: 160px; }

#dark {
  display: inline-block;
  height: 70px; }

#dark #search input[type="text"] {
  background: url("https://ningyu1.github.io/site/images/search-dark.png") no-repeat 10px 6px #444444;
  border: 0 none;
  font: bold 12px Arial,Helvetica,Sans-serif;
  color: #ddd;
  width: 110px;
  padding: 6px 15px 6px 35px;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  text-shadow: 0 2px 2px rgba(0, 0, 0, 0.3);
  -webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -moz-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -webkit-transition: all 0.4s ease 0s;
  -moz-transition: all 0.4s ease 0s;
  -o-transition: all 0.4s ease 0s;
  transition: all 0.4s ease 0s; }

#dark #search input[type="text"]:focus {
  width: 160px;
  outline: 0; }

/* nav */
#nav {
  text-align: center;
  position: relative;
  margin: 10px auto; }

ul#nav *{
	box-sizing:content-box
}

ul#nav li {
  display: inline-block; }

ul#nav li {
  list-style-type: none;
  background-repeat: no-repeat;
  overflow: hidden;
  margin-right: 1px; }

ul#nav li a {
  display: inline-block;
  width: 110px;
  height: 40px;
  text-align: center;
  padding-top: 20px;
  padding-bottom: 20px;
  color: #222;
  font-weight: normal;
  text-decoration: none;
  font-family: "Lucida Grande", Arial, Helvetica, sans-serif;
  text-transform: uppercase;
  font-size: 16px;
  font-style: normal;
  text-shadow: 1px 1px 10px #222;
  overflow: hidden; }

ul#nav li a:hover {
  color: #fff;
  font-style: normal;
  font-weight: normal;
  background-image: url("https://ningyu1.github.io/site/images/hover.png");
  background-repeat: no-repeat;
  background-position: center top; }

ul#nav li a:active {
  position: relative;
  top: 2px; }

ul#nav li#active a {
  color: #FFF;
  background-image: url("https://ningyu1.github.io/site/images/active.png");
  background-repeat: no-repeat;
  background-position: center top; }

#pagenavi {
  padding: 20px 0;
  height: 20px;
  line-height: 20px;
  position: relative;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }
  #pagenavi a:hover {
    text-decoration: underline; }
  #pagenavi .prev, #pagenavi .next {
    position: absolute; }
  #pagenavi .prev {
    padding-left: 30px;
    left: 0; }
    #pagenavi .prev:before {
      content: "\f060";
      font: 1.3em FontAwesome;
      position: absolute;
      left: 0; }
  #pagenavi .next {
    padding-right: 30px;
    right: 0; }
    #pagenavi .next:before {
      content: "\f061";
      font: 1.3em FontAwesome;
      position: absolute;
      right: 0; }
  #pagenavi .center {
    text-align: center;
    width: 100%;
    display: block; }
    @media screen and (max-width: 400px) {
      #pagenavi .center {
        display: none; } }

article {
  border-bottom: 1px solid #dddddd;
  padding: 30px 0;
  position: relative; }
  @media screen and (max-width: 800px) {
    article {
      padding-bottom: 15px; } }
  @media screen and (max-width: 600px) {
    article {
      padding: 15px 0; } }
  article h2.title {
    font-family: 'Fjalla One', sans-serif;
    font-size: 2em;
    font-weight: 300;
    line-height: 35px;
    margin-bottom: 20px; }
    article h2.title a {
      color: #1094e8; }
  article .title a {
    color: #7c7873;
    -webkit-transition: all 1s ease-in-out;
    -moz-transition: all 1s ease-in-out;
    -o-transition: all 1s ease-in-out;
    transition: all 1s ease-in-out; }
  article .title a:hover {
    color: #084B8A;
    text-shadow: 3px 3px 12px #888;
    -webkit-transform: scale(1.3);
    -moz-transform: scale(1.3); }
  article .entry-content {
    line-height: 2;
    text-align: justify; }
    article .entry-content a:hover {
      text-decoration: underline; }
    article .entry-content .more-link {
      display: block;
      margin-top: 16px;
      padding-left: 30px;
      position: relative; }
      article .entry-content .more-link:before {
        content: "\f061";
        font: 1.3em FontAwesome;
        line-height: 1.6em;
        position: absolute;
        left: 0; }
    article .entry-content p, article .entry-content blockquote, article .entry-content ul, article .entry-content ol, article .entry-content dl, article .entry-content iframe, article .entry-content h1, article .entry-content h2, article .entry-content h3, article .entry-content h4, article .entry-content h5, article .entry-content h6, article .entry-content .video-container {
      margin-top: 10px; }
    article .entry-content ul, article .entry-content ol, article .entry-content dl {
      margin-left: 20px; }
      article .entry-content ul ul, article .entry-content ul ol, article .entry-content ul dl, article .entry-content ol ul, article .entry-content ol ol, article .entry-content ol dl, article .entry-content dl ul, article .entry-content dl ol, article .entry-content dl dl {
        margin-top: 0; }
    article .entry-content strong {
      font-weight: bold; }
    article .entry-content em {
      font-style: italic; }
    article .entry-content p {
      margin-top: 10px; }
    article .entry-content h2 {
      font-weight: 300;
      border-bottom: 1px solid #dddddd;
      position: relative; }
      article .entry-content h2:before {
        content: "";
        position: absolute;
        bottom: -2px;
        border-bottom: 1px solid white;
        width: 100%; }
    article .entry-content img, article .entry-content video {
      margin: 10px 0;
      max-width: 100%;
      height: auto;
      -moz-border-radius: 0.3em;
      -webkit-border-radius: 0.3em;
      -o-border-radius: 0.3em;
      -ms-border-radius: 0.3em;
      -khtml-border-radius: 0.3em;
      border-radius: 0.3em;
      -moz-box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      -webkit-box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      -o-box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      -ms-box-sizing: border-box;
      box-sizing: border-box;
      border: #fff 0.3em solid; }
    article .entry-content img.noborder, article .entry-content video.noborder {
      border: none;
      box-shadow: none; }
    article .entry-content blockquote {
      background: #dddddd;
      border-left: 5px solid #cccccc;
      padding: 15px 20px;
      margin-top: 10px; }
      article .entry-content blockquote > p:first-of-type {
        margin-top: 0; }
    article .entry-content iframe {
      border: none; }
    article .entry-content .caption {
      display: block;
      font-size: 0.9em;
      color: #999999;
      padding-left: 25px;
      position: relative; }
      article .entry-content .caption:before {
        content: "\f040";
        color: #cccccc;
        font: 1.3em FontAwesome;
        line-height: 1.6em;
        position: absolute;
        left: 0; }
    article .entry-content .video-container {
      position: relative;
      padding-bottom: 56.25%;
      padding-top: 30px;
      height: 0;
      overflow: hidden; }
      article .entry-content .video-container iframe, article .entry-content .video-container object, article .entry-content .video-container embed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        margin-top: 0; }

.share {
  padding: 15px 0;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }

@media screen and (max-width: 800px) {
  .post h2.title, .post .entry-content {
    margin-left: 0; } }
.post .meta {
  line-height: 2;
  color: #999999;
  width: 370px; }
  @media screen and (max-width: 800px) {
    .post .meta {
      margin-top: 15px;
      position: static;
      width: auto; } }
  .post .meta a {
    color: #999999;
    -webkit-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false);
    -moz-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    -o-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    transition: compact(0.3s, false, false, false, false, false, false, false, false, false); }
    .post .meta a:hover {
      color: #666666; }
  .post .meta .date, .post .meta .tags, .post .meta .comments {
    padding-left: 30px;
    position: relative; }
    .post .meta .date:before, .post .meta .tags:before, .post .meta .comments:before {
      color: #cccccc;
      font: 1.3em FontAwesome;
      line-height: 1.6em;
      position: absolute;
      left: 0; }
    @media screen and (max-width: 800px) {
      .post .meta .date, .post .meta .tags, .post .meta .comments {
        display: -moz-inline-stack;
        display: inline-block;
        vertical-align: middle;
        *vertical-align: auto;
        zoom: 1;
        *display: inline;
        margin-right: 30px; } }
  .post .meta .date:before {
    content: "\f073"; }
  .post .meta .tags:before {
    content: "\f02c"; }
  .post .meta .comments:before {
    content: "\f075"; }

.archives {
  position: relative; }
  .archives:last-of-type:before {
    content: "";
    position: absolute;
    bottom: 0;
    width: 200px;
    border-top: 1px solid #dddddd; }
  .archives .top-border-padding {
    border-top: 1px solid #fff; }
    .archives .top-border-padding:before {
      content: "";
      position: absolute;
      top: -1px;
      width: 100%;
      border-top: 1px solid #dddddd; }
  .archives .year {
    line-height: 35px;
    width: 200px;
    position: absolute;
    top: 0;
    padding-top: 15px;
    border-top: 1px solid #fff; }
    .archives .year:before {
      content: "";
      position: absolute;
      top: -2px;
      width: 100%;
      border-top: 1px solid #dddddd; }
    @media screen and (max-width: 600px) {
      .archives .year {
        position: relative;
        width: 100%; } }
  .archives article {
    margin-left: 200px;
    padding: 10px 0; }
    @media screen and (max-width: 600px) {
      .archives article {
        margin-left: 0; }
        .archives article:first-of-type {
          border-top: none;
          padding-top: 30px; } }
    .archives article .title {
      margin-bottom: 0;
      font-size: 25px; }
    .archives article .meta {
      color: #999999;
      font-size: 0.9em;
      line-height: 2;
      margin-top: 10px; }
      @media screen and (max-width: 600px) {
        .archives article .meta {
          display: none; } }
      .archives article .meta span {
        margin-right: 30px;
        display: -moz-inline-stack;
        display: inline-block;
        vertical-align: middle;
        *vertical-align: auto;
        zoom: 1;
        *display: inline; }
        .archives article .meta span:before {
          color: #cccccc;
          font: 1.3em FontAwesome;
          padding-right: 10px; }
      .archives article .meta a {
        color: #999999;
        -webkit-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false);
        -moz-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
        -o-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
        transition: compact(0.3s, false, false, false, false, false, false, false, false, false); }
        .archives article .meta a:hover {
          color: #666666; }
      .archives article .meta .date:before {
        content: "\f073"; }
      .archives article .meta .tags:before {
        content: "\f02c"; }
      .archives article .meta .comments:before {
        content: "\f075"; }

#comment {
  padding: 30px 0;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }
  #comment h2.title {
    font-size: 25px;
    font-weight: 300;
    line-height: 35px;
    margin-bottom: 20px; }

footer {
  padding: 20px 0;
  text-align: center;
  font-size: 0.6em;
  color: #666; }

footer a {
  color: #123; }

footer a:hover {
  color: #456; }

#banner {
  color: #999999;
  padding: 30px 0;
  line-height: 30px;
  text-align: center;
  position: relative;
  display: none;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }
  #banner:hover a {
    color: #258fb8; }
  #banner a {
    color: #999999;
    -webkit-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false);
    -moz-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    -o-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    transition: compact(0.3s, false, false, false, false, false, false, false, false, false); }
    #banner a:hover {
      text-decoration: underline; }
  #banner small {
    position: absolute;
    right: 0;
    bottom: 0; }
  #banner .loading {
    background: image-url("loading_pacman.gif") center no-repeat;
    text-indent: -9999px; }
  #banner .container {
    height: 30px;
    overflow: hidden;
    position: relative;
    display: none; }
    #banner .container .feed {
      list-style: none;
      position: absolute;
      top: 0;
      width: 100%; }
      #banner .container .feed li {
        position: relative; }
        #banner .container .feed li small {
          position: absolute;
          right: 0; }

/*! fancyBox v2.0.6 fancyapps.com | fancyapps.com/fancybox/#license */
.fancybox-tmp iframe, .fancybox-tmp object {
  vertical-align: top;
  padding: 0;
  margin: 0; }

.fancybox-wrap {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 8020; }

.fancybox-skin {
  position: relative;
  padding: 0;
  margin: 0;
  background: #f9f9f9;
  color: #444;
  text-shadow: none;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  -ms-border-radius: 4px;
  -o-border-radius: 4px;
  border-radius: 4px; }

.fancybox-opened {
  z-index: 8030; }

.fancybox-opened .fancybox-skin {
  -webkit-box-shadow: compact(0 10px 25px rgba(0, 0, 0, 0.5), false, false, false, false, false, false, false, false, false);
  -moz-box-shadow: compact(0 10px 25px rgba(0, 0, 0, 0.5), false, false, false, false, false, false, false, false, false);
  box-shadow: compact(0 10px 25px rgba(0, 0, 0, 0.5), false, false, false, false, false, false, false, false, false); }

.fancybox-outer, .fancybox-inner {
  padding: 0;
  margin: 0;
  position: relative;
  outline: none; }

.fancybox-inner {
  overflow: hidden; }

.fancybox-type-iframe .fancybox-inner {
  -webkit-overflow-scrolling: touch; }

.fancybox-error {
  color: #444;
  font: 14px/20px "Helvetica Neue",Helvetica,Arial,sans-serif;
  margin: 0;
  padding: 10px; }

.fancybox-image, .fancybox-iframe {
  display: block;
  width: 100%;
  height: 100%;
  border: 0;
  padding: 0;
  margin: 0;
  vertical-align: top; }

.fancybox-image {
  max-width: 100%;
  max-height: 100%; }

#fancybox-loading, .fancybox-close, .fancybox-prev span, .fancybox-next span {
  background-image: image-url("fancybox/fancybox_sprite.png"); }

#fancybox-loading {
  position: fixed;
  top: 50%;
  left: 50%;
  margin-top: -22px;
  margin-left: -22px;
  background-position: 0 -108px;
  opacity: 0.8;
  cursor: pointer;
  z-index: 8020; }

#fancybox-loading div {
  width: 44px;
  height: 44px;
  background: image-url("fancybox/fancybox_loading.gif") center center no-repeat; }

.fancybox-close {
  position: absolute;
  top: -18px;
  right: -18px;
  width: 36px;
  height: 36px;
  cursor: pointer;
  z-index: 8040; }

.fancybox-nav {
  position: absolute;
  top: 0;
  width: 40%;
  height: 100%;
  cursor: pointer;
  background: transparent image-url("fancybox/blank.gif");
  /* helps IE */
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  z-index: 8040; }

.fancybox-prev {
  left: 0; }

.fancybox-next {
  right: 0; }

.fancybox-nav span {
  position: absolute;
  top: 50%;
  width: 36px;
  height: 34px;
  margin-top: -18px;
  cursor: pointer;
  z-index: 8040;
  visibility: hidden; }

.fancybox-prev span {
  left: 20px;
  background-position: 0 -36px; }

.fancybox-next span {
  right: 20px;
  background-position: 0 -72px; }

.fancybox-nav:hover span {
  visibility: visible; }

.fancybox-tmp {
  position: absolute;
  top: -9999px;
  left: -9999px;
  padding: 0;
  overflow: visible;
  visibility: hidden; }

/* Overlay helper */
#fancybox-overlay {
  position: absolute;
  top: 0;
  left: 0;
  overflow: hidden;
  display: none;
  z-index: 8010;
  background: #000; }

#fancybox-overlay.overlay-fixed {
  position: fixed;
  bottom: 0;
  right: 0; }

/* Title helper */
.fancybox-title {
  visibility: hidden;
  font: normal 13px/20px "Helvetica Neue",Helvetica,Arial,sans-serif;
  position: relative;
  text-shadow: none;
  z-index: 8050; }

.fancybox-opened .fancybox-title {
  visibility: visible; }

.fancybox-title-float-wrap {
  position: absolute;
  bottom: 0;
  right: 50%;
  margin-bottom: -35px;
  z-index: 8030;
  text-align: center; }

.fancybox-title-float-wrap .child {
  display: inline-block;
  margin-right: -100%;
  padding: 2px 20px;
  background: transparent;
  /* Fallback for web browsers that doesn't support RGBa */
  background: rgba(0, 0, 0, 0.8);
  text-shadow: 0 1px 2px #222;
  color: #FFF;
  font-weight: bold;
  line-height: 24px;
  white-space: nowrap;
  -webkit-border-radius: 15px;
  -moz-border-radius: 15px;
  -ms-border-radius: 15px;
  -o-border-radius: 15px;
  border-radius: 15px; }

.fancybox-title-outside-wrap {
  position: relative;
  margin-top: 10px;
  color: #fff; }

.fancybox-title-inside-wrap {
  margin-top: 10px; }

.fancybox-title-over-wrap {
  position: absolute;
  bottom: 0;
  left: 0;
  color: #fff;
  padding: 10px;
  background: #000;
  background: rgba(0, 0, 0, 0.8); }

/*
Animate.css - http://daneden.me/animate
Licensed under the ☺ license (http://licence.visualidiot.com/)

Copyright (c) 2012 Dan Eden

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
body {
  /* Addresses a small issue in webkit: http://bit.ly/NEdoDq */
  -webkit-backface-visibility: hidden; }

.animated {
  -webkit-animation-duration: 1s;
  -moz-animation-duration: 1s;
  -o-animation-duration: 1s;
  animation-duration: 1s;
  -webkit-animation-fill-mode: both;
  -moz-animation-fill-mode: both;
  -o-animation-fill-mode: both;
  animation-fill-mode: both; }

.animated.hinge {
  -webkit-animation-duration: 2s;
  -moz-animation-duration: 2s;
  -o-animation-duration: 2s;
  animation-duration: 2s; }

@-webkit-keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

@-moz-keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

@-o-keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

@keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

.flash {
  -webkit-animation-name: flash;
  -moz-animation-name: flash;
  -o-animation-name: flash;
  animation-name: flash; }

@-webkit-keyframes shake {
  0%, 100% {
    -webkit-transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    -webkit-transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    -webkit-transform: translateX(10px); } }

@-moz-keyframes shake {
  0%, 100% {
    -moz-transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    -moz-transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    -moz-transform: translateX(10px); } }

@-o-keyframes shake {
  0%, 100% {
    -o-transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    -o-transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    -o-transform: translateX(10px); } }

@keyframes shake {
  0%, 100% {
    transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    transform: translateX(10px); } }

.shake {
  -webkit-animation-name: shake;
  -moz-animation-name: shake;
  -o-animation-name: shake;
  animation-name: shake; }

@-webkit-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -webkit-transform: translateY(0); }

  40% {
    -webkit-transform: translateY(-30px); }

  60% {
    -webkit-transform: translateY(-15px); } }

@-moz-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -moz-transform: translateY(0); }

  40% {
    -moz-transform: translateY(-30px); }

  60% {
    -moz-transform: translateY(-15px); } }

@-o-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -o-transform: translateY(0); }

  40% {
    -o-transform: translateY(-30px); }

  60% {
    -o-transform: translateY(-15px); } }

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0); }

  40% {
    transform: translateY(-30px); }

  60% {
    transform: translateY(-15px); } }

.bounce {
  -webkit-animation-name: bounce;
  -moz-animation-name: bounce;
  -o-animation-name: bounce;
  animation-name: bounce; }

@-webkit-keyframes tada {
  0% {
    -webkit-transform: scale(1); }

  10%, 20% {
    -webkit-transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    -webkit-transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    -webkit-transform: scale(1.1) rotate(-3deg); }

  100% {
    -webkit-transform: scale(1) rotate(0); } }

@-moz-keyframes tada {
  0% {
    -moz-transform: scale(1); }

  10%, 20% {
    -moz-transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    -moz-transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    -moz-transform: scale(1.1) rotate(-3deg); }

  100% {
    -moz-transform: scale(1) rotate(0); } }

@-o-keyframes tada {
  0% {
    -o-transform: scale(1); }

  10%, 20% {
    -o-transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    -o-transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    -o-transform: scale(1.1) rotate(-3deg); }

  100% {
    -o-transform: scale(1) rotate(0); } }

@keyframes tada {
  0% {
    transform: scale(1); }

  10%, 20% {
    transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    transform: scale(1.1) rotate(-3deg); }

  100% {
    transform: scale(1) rotate(0); } }

.tada {
  -webkit-animation-name: tada;
  -moz-animation-name: tada;
  -o-animation-name: tada;
  animation-name: tada; }

@-webkit-keyframes swing {
  20%, 40%, 60%, 80%, 100% {
    -webkit-transform-origin: top center; }

  20% {
    -webkit-transform: rotate(15deg); }

  40% {
    -webkit-transform: rotate(-10deg); }

  60% {
    -webkit-transform: rotate(5deg); }

  80% {
    -webkit-transform: rotate(-5deg); }

  100% {
    -webkit-transform: rotate(0deg); } }

@-moz-keyframes swing {
  20% {
    -moz-transform: rotate(15deg); }

  40% {
    -moz-transform: rotate(-10deg); }

  60% {
    -moz-transform: rotate(5deg); }

  80% {
    -moz-transform: rotate(-5deg); }

  100% {
    -moz-transform: rotate(0deg); } }

@-o-keyframes swing {
  20% {
    -o-transform: rotate(15deg); }

  40% {
    -o-transform: rotate(-10deg); }

  60% {
    -o-transform: rotate(5deg); }

  80% {
    -o-transform: rotate(-5deg); }

  100% {
    -o-transform: rotate(0deg); } }

@keyframes swing {
  20% {
    transform: rotate(15deg); }

  40% {
    transform: rotate(-10deg); }

  60% {
    transform: rotate(5deg); }

  80% {
    transform: rotate(-5deg); }

  100% {
    transform: rotate(0deg); } }

.swing {
  -webkit-transform-origin: top center;
  -moz-transform-origin: top center;
  -o-transform-origin: top center;
  transform-origin: top center;
  -webkit-animation-name: swing;
  -moz-animation-name: swing;
  -o-animation-name: swing;
  animation-name: swing; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes wobble {
  0% {
    -webkit-transform: translateX(0%); }

  15% {
    -webkit-transform: translateX(-25%) rotate(-5deg); }

  30% {
    -webkit-transform: translateX(20%) rotate(3deg); }

  45% {
    -webkit-transform: translateX(-15%) rotate(-3deg); }

  60% {
    -webkit-transform: translateX(10%) rotate(2deg); }

  75% {
    -webkit-transform: translateX(-5%) rotate(-1deg); }

  100% {
    -webkit-transform: translateX(0%); } }

@-moz-keyframes wobble {
  0% {
    -moz-transform: translateX(0%); }

  15% {
    -moz-transform: translateX(-25%) rotate(-5deg); }

  30% {
    -moz-transform: translateX(20%) rotate(3deg); }

  45% {
    -moz-transform: translateX(-15%) rotate(-3deg); }

  60% {
    -moz-transform: translateX(10%) rotate(2deg); }

  75% {
    -moz-transform: translateX(-5%) rotate(-1deg); }

  100% {
    -moz-transform: translateX(0%); } }

@-o-keyframes wobble {
  0% {
    -o-transform: translateX(0%); }

  15% {
    -o-transform: translateX(-25%) rotate(-5deg); }

  30% {
    -o-transform: translateX(20%) rotate(3deg); }

  45% {
    -o-transform: translateX(-15%) rotate(-3deg); }

  60% {
    -o-transform: translateX(10%) rotate(2deg); }

  75% {
    -o-transform: translateX(-5%) rotate(-1deg); }

  100% {
    -o-transform: translateX(0%); } }

@keyframes wobble {
  0% {
    transform: translateX(0%); }

  15% {
    transform: translateX(-25%) rotate(-5deg); }

  30% {
    transform: translateX(20%) rotate(3deg); }

  45% {
    transform: translateX(-15%) rotate(-3deg); }

  60% {
    transform: translateX(10%) rotate(2deg); }

  75% {
    transform: translateX(-5%) rotate(-1deg); }

  100% {
    transform: translateX(0%); } }

.wobble {
  -webkit-animation-name: wobble;
  -moz-animation-name: wobble;
  -o-animation-name: wobble;
  animation-name: wobble; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes pulse {
  0% {
    -webkit-transform: scale(1); }

  50% {
    -webkit-transform: scale(1.1); }

  100% {
    -webkit-transform: scale(1); } }

@-moz-keyframes pulse {
  0% {
    -moz-transform: scale(1); }

  50% {
    -moz-transform: scale(1.1); }

  100% {
    -moz-transform: scale(1); } }

@-o-keyframes pulse {
  0% {
    -o-transform: scale(1); }

  50% {
    -o-transform: scale(1.1); }

  100% {
    -o-transform: scale(1); } }

@keyframes pulse {
  0% {
    transform: scale(1); }

  50% {
    transform: scale(1.1); }

  100% {
    transform: scale(1); } }

.pulse {
  -webkit-animation-name: pulse;
  -moz-animation-name: pulse;
  -o-animation-name: pulse;
  animation-name: pulse; }

@-webkit-keyframes flip {
  0% {
    -webkit-transform: perspective(400px) rotateY(0);
    -webkit-animation-timing-function: ease-out; }

  40% {
    -webkit-transform: perspective(400px) translateZ(150px) rotateY(170deg);
    -webkit-animation-timing-function: ease-out; }

  50% {
    -webkit-transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    -webkit-animation-timing-function: ease-in; }

  80% {
    -webkit-transform: perspective(400px) rotateY(360deg) scale(0.95);
    -webkit-animation-timing-function: ease-in; }

  100% {
    -webkit-transform: perspective(400px) scale(1);
    -webkit-animation-timing-function: ease-in; } }

@-moz-keyframes flip {
  0% {
    -moz-transform: perspective(400px) rotateY(0);
    -moz-animation-timing-function: ease-out; }

  40% {
    -moz-transform: perspective(400px) translateZ(150px) rotateY(170deg);
    -moz-animation-timing-function: ease-out; }

  50% {
    -moz-transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    -moz-animation-timing-function: ease-in; }

  80% {
    -moz-transform: perspective(400px) rotateY(360deg) scale(0.95);
    -moz-animation-timing-function: ease-in; }

  100% {
    -moz-transform: perspective(400px) scale(1);
    -moz-animation-timing-function: ease-in; } }

@-o-keyframes flip {
  0% {
    -o-transform: perspective(400px) rotateY(0);
    -o-animation-timing-function: ease-out; }

  40% {
    -o-transform: perspective(400px) translateZ(150px) rotateY(170deg);
    -o-animation-timing-function: ease-out; }

  50% {
    -o-transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    -o-animation-timing-function: ease-in; }

  80% {
    -o-transform: perspective(400px) rotateY(360deg) scale(0.95);
    -o-animation-timing-function: ease-in; }

  100% {
    -o-transform: perspective(400px) scale(1);
    -o-animation-timing-function: ease-in; } }

@keyframes flip {
  0% {
    transform: perspective(400px) rotateY(0);
    animation-timing-function: ease-out; }

  40% {
    transform: perspective(400px) translateZ(150px) rotateY(170deg);
    animation-timing-function: ease-out; }

  50% {
    transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    animation-timing-function: ease-in; }

  80% {
    transform: perspective(400px) rotateY(360deg) scale(0.95);
    animation-timing-function: ease-in; }

  100% {
    transform: perspective(400px) scale(1);
    animation-timing-function: ease-in; } }

.flip {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flip;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flip;
  -o-backface-visibility: visible !important;
  -o-animation-name: flip;
  backface-visibility: visible !important;
  animation-name: flip; }

@-webkit-keyframes flipInX {
  0% {
    -webkit-transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    -webkit-transform: perspective(400px) rotateX(-10deg); }

  70% {
    -webkit-transform: perspective(400px) rotateX(10deg); }

  100% {
    -webkit-transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

@-moz-keyframes flipInX {
  0% {
    -moz-transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    -moz-transform: perspective(400px) rotateX(-10deg); }

  70% {
    -moz-transform: perspective(400px) rotateX(10deg); }

  100% {
    -moz-transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

@-o-keyframes flipInX {
  0% {
    -o-transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    -o-transform: perspective(400px) rotateX(-10deg); }

  70% {
    -o-transform: perspective(400px) rotateX(10deg); }

  100% {
    -o-transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

@keyframes flipInX {
  0% {
    transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    transform: perspective(400px) rotateX(-10deg); }

  70% {
    transform: perspective(400px) rotateX(10deg); }

  100% {
    transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

.flipInX {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flipInX;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flipInX;
  -o-backface-visibility: visible !important;
  -o-animation-name: flipInX;
  backface-visibility: visible !important;
  animation-name: flipInX; }

@-webkit-keyframes flipOutX {
  0% {
    -webkit-transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    -webkit-transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

@-moz-keyframes flipOutX {
  0% {
    -moz-transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    -moz-transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

@-o-keyframes flipOutX {
  0% {
    -o-transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    -o-transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

@keyframes flipOutX {
  0% {
    transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

.flipOutX {
  -webkit-animation-name: flipOutX;
  -webkit-backface-visibility: visible !important;
  -moz-animation-name: flipOutX;
  -moz-backface-visibility: visible !important;
  -o-animation-name: flipOutX;
  -o-backface-visibility: visible !important;
  animation-name: flipOutX;
  backface-visibility: visible !important; }

@-webkit-keyframes flipInY {
  0% {
    -webkit-transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    -webkit-transform: perspective(400px) rotateY(-10deg); }

  70% {
    -webkit-transform: perspective(400px) rotateY(10deg); }

  100% {
    -webkit-transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

@-moz-keyframes flipInY {
  0% {
    -moz-transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    -moz-transform: perspective(400px) rotateY(-10deg); }

  70% {
    -moz-transform: perspective(400px) rotateY(10deg); }

  100% {
    -moz-transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

@-o-keyframes flipInY {
  0% {
    -o-transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    -o-transform: perspective(400px) rotateY(-10deg); }

  70% {
    -o-transform: perspective(400px) rotateY(10deg); }

  100% {
    -o-transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

@keyframes flipInY {
  0% {
    transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    transform: perspective(400px) rotateY(-10deg); }

  70% {
    transform: perspective(400px) rotateY(10deg); }

  100% {
    transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

.flipInY {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flipInY;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flipInY;
  -o-backface-visibility: visible !important;
  -o-animation-name: flipInY;
  backface-visibility: visible !important;
  animation-name: flipInY; }

@-webkit-keyframes flipOutY {
  0% {
    -webkit-transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    -webkit-transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

@-moz-keyframes flipOutY {
  0% {
    -moz-transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    -moz-transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

@-o-keyframes flipOutY {
  0% {
    -o-transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    -o-transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

@keyframes flipOutY {
  0% {
    transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

.flipOutY {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flipOutY;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flipOutY;
  -o-backface-visibility: visible !important;
  -o-animation-name: flipOutY;
  backface-visibility: visible !important;
  animation-name: flipOutY; }

@-webkit-keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

@-moz-keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

@-o-keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

@keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

.fadeIn {
  -webkit-animation-name: fadeIn;
  -moz-animation-name: fadeIn;
  -o-animation-name: fadeIn;
  animation-name: fadeIn; }

@-webkit-keyframes fadeInUp {
  0% {
    opacity: 0;
    -webkit-transform: translateY(20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInUp {
  0% {
    opacity: 0;
    -moz-transform: translateY(20px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInUp {
  0% {
    opacity: 0;
    -o-transform: translateY(20px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(20px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInUp {
  -webkit-animation-name: fadeInUp;
  -moz-animation-name: fadeInUp;
  -o-animation-name: fadeInUp;
  animation-name: fadeInUp; }

@-webkit-keyframes fadeInDown {
  0% {
    opacity: 0;
    -webkit-transform: translateY(-20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInDown {
  0% {
    opacity: 0;
    -moz-transform: translateY(-20px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInDown {
  0% {
    opacity: 0;
    -o-transform: translateY(-20px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInDown {
  0% {
    opacity: 0;
    transform: translateY(-20px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInDown {
  -webkit-animation-name: fadeInDown;
  -moz-animation-name: fadeInDown;
  -o-animation-name: fadeInDown;
  animation-name: fadeInDown; }

@-webkit-keyframes fadeInLeft {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInLeft {
  0% {
    opacity: 0;
    -moz-transform: translateX(-20px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInLeft {
  0% {
    opacity: 0;
    -o-transform: translateX(-20px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInLeft {
  0% {
    opacity: 0;
    transform: translateX(-20px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInLeft {
  -webkit-animation-name: fadeInLeft;
  -moz-animation-name: fadeInLeft;
  -o-animation-name: fadeInLeft;
  animation-name: fadeInLeft; }

@-webkit-keyframes fadeInRight {
  0% {
    opacity: 0;
    -webkit-transform: translateX(20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInRight {
  0% {
    opacity: 0;
    -moz-transform: translateX(20px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInRight {
  0% {
    opacity: 0;
    -o-transform: translateX(20px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInRight {
  0% {
    opacity: 0;
    transform: translateX(20px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInRight {
  -webkit-animation-name: fadeInRight;
  -moz-animation-name: fadeInRight;
  -o-animation-name: fadeInRight;
  animation-name: fadeInRight; }

@-webkit-keyframes fadeInUpBig {
  0% {
    opacity: 0;
    -webkit-transform: translateY(2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInUpBig {
  0% {
    opacity: 0;
    -moz-transform: translateY(2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInUpBig {
  0% {
    opacity: 0;
    -o-transform: translateY(2000px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInUpBig {
  0% {
    opacity: 0;
    transform: translateY(2000px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInUpBig {
  -webkit-animation-name: fadeInUpBig;
  -moz-animation-name: fadeInUpBig;
  -o-animation-name: fadeInUpBig;
  animation-name: fadeInUpBig; }

@-webkit-keyframes fadeInDownBig {
  0% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInDownBig {
  0% {
    opacity: 0;
    -moz-transform: translateY(-2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInDownBig {
  0% {
    opacity: 0;
    -o-transform: translateY(-2000px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInDownBig {
  0% {
    opacity: 0;
    transform: translateY(-2000px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInDownBig {
  -webkit-animation-name: fadeInDownBig;
  -moz-animation-name: fadeInDownBig;
  -o-animation-name: fadeInDownBig;
  animation-name: fadeInDownBig; }

@-webkit-keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    -moz-transform: translateX(-2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    -o-transform: translateX(-2000px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    transform: translateX(-2000px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInLeftBig {
  -webkit-animation-name: fadeInLeftBig;
  -moz-animation-name: fadeInLeftBig;
  -o-animation-name: fadeInLeftBig;
  animation-name: fadeInLeftBig; }

@-webkit-keyframes fadeInRightBig {
  0% {
    opacity: 0;
    -webkit-transform: translateX(2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInRightBig {
  0% {
    opacity: 0;
    -moz-transform: translateX(2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInRightBig {
  0% {
    opacity: 0;
    -o-transform: translateX(2000px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInRightBig {
  0% {
    opacity: 0;
    transform: translateX(2000px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInRightBig {
  -webkit-animation-name: fadeInRightBig;
  -moz-animation-name: fadeInRightBig;
  -o-animation-name: fadeInRightBig;
  animation-name: fadeInRightBig; }

@-webkit-keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

@-moz-keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

@-o-keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

@keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

.fadeOut {
  -webkit-animation-name: fadeOut;
  -moz-animation-name: fadeOut;
  -o-animation-name: fadeOut;
  animation-name: fadeOut; }

@-webkit-keyframes fadeOutUp {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(-20px); } }

@-moz-keyframes fadeOutUp {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(-20px); } }

@-o-keyframes fadeOutUp {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(-20px); } }

@keyframes fadeOutUp {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(-20px); } }

.fadeOutUp {
  -webkit-animation-name: fadeOutUp;
  -moz-animation-name: fadeOutUp;
  -o-animation-name: fadeOutUp;
  animation-name: fadeOutUp; }

@-webkit-keyframes fadeOutDown {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(20px); } }

@-moz-keyframes fadeOutDown {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(20px); } }

@-o-keyframes fadeOutDown {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(20px); } }

@keyframes fadeOutDown {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(20px); } }

.fadeOutDown {
  -webkit-animation-name: fadeOutDown;
  -moz-animation-name: fadeOutDown;
  -o-animation-name: fadeOutDown;
  animation-name: fadeOutDown; }

@-webkit-keyframes fadeOutLeft {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(-20px); } }

@-moz-keyframes fadeOutLeft {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(-20px); } }

@-o-keyframes fadeOutLeft {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(-20px); } }

@keyframes fadeOutLeft {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(-20px); } }

.fadeOutLeft {
  -webkit-animation-name: fadeOutLeft;
  -moz-animation-name: fadeOutLeft;
  -o-animation-name: fadeOutLeft;
  animation-name: fadeOutLeft; }

@-webkit-keyframes fadeOutRight {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(20px); } }

@-moz-keyframes fadeOutRight {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(20px); } }

@-o-keyframes fadeOutRight {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(20px); } }

@keyframes fadeOutRight {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(20px); } }

.fadeOutRight {
  -webkit-animation-name: fadeOutRight;
  -moz-animation-name: fadeOutRight;
  -o-animation-name: fadeOutRight;
  animation-name: fadeOutRight; }

@-webkit-keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); } }

@-moz-keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(-2000px); } }

@-o-keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(-2000px); } }

@keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(-2000px); } }

.fadeOutUpBig {
  -webkit-animation-name: fadeOutUpBig;
  -moz-animation-name: fadeOutUpBig;
  -o-animation-name: fadeOutUpBig;
  animation-name: fadeOutUpBig; }

@-webkit-keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(2000px); } }

@-moz-keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(2000px); } }

@-o-keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(2000px); } }

@keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(2000px); } }

.fadeOutDownBig {
  -webkit-animation-name: fadeOutDownBig;
  -moz-animation-name: fadeOutDownBig;
  -o-animation-name: fadeOutDownBig;
  animation-name: fadeOutDownBig; }

@-webkit-keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); } }

@-moz-keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(-2000px); } }

@-o-keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(-2000px); } }

@keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(-2000px); } }

.fadeOutLeftBig {
  -webkit-animation-name: fadeOutLeftBig;
  -moz-animation-name: fadeOutLeftBig;
  -o-animation-name: fadeOutLeftBig;
  animation-name: fadeOutLeftBig; }

@-webkit-keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(2000px); } }

@-moz-keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(2000px); } }

@-o-keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(2000px); } }

@keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(2000px); } }

.fadeOutRightBig {
  -webkit-animation-name: fadeOutRightBig;
  -moz-animation-name: fadeOutRightBig;
  -o-animation-name: fadeOutRightBig;
  animation-name: fadeOutRightBig; }

@-webkit-keyframes bounceIn {
  0% {
    opacity: 0;
    -webkit-transform: scale(0.3); }

  50% {
    opacity: 1;
    -webkit-transform: scale(1.05); }

  70% {
    -webkit-transform: scale(0.9); }

  100% {
    -webkit-transform: scale(1); } }

@-moz-keyframes bounceIn {
  0% {
    opacity: 0;
    -moz-transform: scale(0.3); }

  50% {
    opacity: 1;
    -moz-transform: scale(1.05); }

  70% {
    -moz-transform: scale(0.9); }

  100% {
    -moz-transform: scale(1); } }

@-o-keyframes bounceIn {
  0% {
    opacity: 0;
    -o-transform: scale(0.3); }

  50% {
    opacity: 1;
    -o-transform: scale(1.05); }

  70% {
    -o-transform: scale(0.9); }

  100% {
    -o-transform: scale(1); } }

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3); }

  50% {
    opacity: 1;
    transform: scale(1.05); }

  70% {
    transform: scale(0.9); }

  100% {
    transform: scale(1); } }

.bounceIn {
  -webkit-animation-name: bounceIn;
  -moz-animation-name: bounceIn;
  -o-animation-name: bounceIn;
  animation-name: bounceIn; }

@-webkit-keyframes bounceInUp {
  0% {
    opacity: 0;
    -webkit-transform: translateY(2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateY(-30px); }

  80% {
    -webkit-transform: translateY(10px); }

  100% {
    -webkit-transform: translateY(0); } }

@-moz-keyframes bounceInUp {
  0% {
    opacity: 0;
    -moz-transform: translateY(2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateY(-30px); }

  80% {
    -moz-transform: translateY(10px); }

  100% {
    -moz-transform: translateY(0); } }

@-o-keyframes bounceInUp {
  0% {
    opacity: 0;
    -o-transform: translateY(2000px); }

  60% {
    opacity: 1;
    -o-transform: translateY(-30px); }

  80% {
    -o-transform: translateY(10px); }

  100% {
    -o-transform: translateY(0); } }

@keyframes bounceInUp {
  0% {
    opacity: 0;
    transform: translateY(2000px); }

  60% {
    opacity: 1;
    transform: translateY(-30px); }

  80% {
    transform: translateY(10px); }

  100% {
    transform: translateY(0); } }

.bounceInUp {
  -webkit-animation-name: bounceInUp;
  -moz-animation-name: bounceInUp;
  -o-animation-name: bounceInUp;
  animation-name: bounceInUp; }

@-webkit-keyframes bounceInDown {
  0% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateY(30px); }

  80% {
    -webkit-transform: translateY(-10px); }

  100% {
    -webkit-transform: translateY(0); } }

@-moz-keyframes bounceInDown {
  0% {
    opacity: 0;
    -moz-transform: translateY(-2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateY(30px); }

  80% {
    -moz-transform: translateY(-10px); }

  100% {
    -moz-transform: translateY(0); } }

@-o-keyframes bounceInDown {
  0% {
    opacity: 0;
    -o-transform: translateY(-2000px); }

  60% {
    opacity: 1;
    -o-transform: translateY(30px); }

  80% {
    -o-transform: translateY(-10px); }

  100% {
    -o-transform: translateY(0); } }

@keyframes bounceInDown {
  0% {
    opacity: 0;
    transform: translateY(-2000px); }

  60% {
    opacity: 1;
    transform: translateY(30px); }

  80% {
    transform: translateY(-10px); }

  100% {
    transform: translateY(0); } }

.bounceInDown {
  -webkit-animation-name: bounceInDown;
  -moz-animation-name: bounceInDown;
  -o-animation-name: bounceInDown;
  animation-name: bounceInDown; }

@-webkit-keyframes bounceInLeft {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateX(30px); }

  80% {
    -webkit-transform: translateX(-10px); }

  100% {
    -webkit-transform: translateX(0); } }

@-moz-keyframes bounceInLeft {
  0% {
    opacity: 0;
    -moz-transform: translateX(-2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateX(30px); }

  80% {
    -moz-transform: translateX(-10px); }

  100% {
    -moz-transform: translateX(0); } }

@-o-keyframes bounceInLeft {
  0% {
    opacity: 0;
    -o-transform: translateX(-2000px); }

  60% {
    opacity: 1;
    -o-transform: translateX(30px); }

  80% {
    -o-transform: translateX(-10px); }

  100% {
    -o-transform: translateX(0); } }

@keyframes bounceInLeft {
  0% {
    opacity: 0;
    transform: translateX(-2000px); }

  60% {
    opacity: 1;
    transform: translateX(30px); }

  80% {
    transform: translateX(-10px); }

  100% {
    transform: translateX(0); } }

.bounceInLeft {
  -webkit-animation-name: bounceInLeft;
  -moz-animation-name: bounceInLeft;
  -o-animation-name: bounceInLeft;
  animation-name: bounceInLeft; }

@-webkit-keyframes bounceInRight {
  0% {
    opacity: 0;
    -webkit-transform: translateX(2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateX(-30px); }

  80% {
    -webkit-transform: translateX(10px); }

  100% {
    -webkit-transform: translateX(0); } }

@-moz-keyframes bounceInRight {
  0% {
    opacity: 0;
    -moz-transform: translateX(2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateX(-30px); }

  80% {
    -moz-transform: translateX(10px); }

  100% {
    -moz-transform: translateX(0); } }

@-o-keyframes bounceInRight {
  0% {
    opacity: 0;
    -o-transform: translateX(2000px); }

  60% {
    opacity: 1;
    -o-transform: translateX(-30px); }

  80% {
    -o-transform: translateX(10px); }

  100% {
    -o-transform: translateX(0); } }

@keyframes bounceInRight {
  0% {
    opacity: 0;
    transform: translateX(2000px); }

  60% {
    opacity: 1;
    transform: translateX(-30px); }

  80% {
    transform: translateX(10px); }

  100% {
    transform: translateX(0); } }

.bounceInRight {
  -webkit-animation-name: bounceInRight;
  -moz-animation-name: bounceInRight;
  -o-animation-name: bounceInRight;
  animation-name: bounceInRight; }

@-webkit-keyframes bounceOut {
  0% {
    -webkit-transform: scale(1); }

  25% {
    -webkit-transform: scale(0.95); }

  50% {
    opacity: 1;
    -webkit-transform: scale(1.1); }

  100% {
    opacity: 0;
    -webkit-transform: scale(0.3); } }

@-moz-keyframes bounceOut {
  0% {
    -moz-transform: scale(1); }

  25% {
    -moz-transform: scale(0.95); }

  50% {
    opacity: 1;
    -moz-transform: scale(1.1); }

  100% {
    opacity: 0;
    -moz-transform: scale(0.3); } }

@-o-keyframes bounceOut {
  0% {
    -o-transform: scale(1); }

  25% {
    -o-transform: scale(0.95); }

  50% {
    opacity: 1;
    -o-transform: scale(1.1); }

  100% {
    opacity: 0;
    -o-transform: scale(0.3); } }

@keyframes bounceOut {
  0% {
    transform: scale(1); }

  25% {
    transform: scale(0.95); }

  50% {
    opacity: 1;
    transform: scale(1.1); }

  100% {
    opacity: 0;
    transform: scale(0.3); } }

.bounceOut {
  -webkit-animation-name: bounceOut;
  -moz-animation-name: bounceOut;
  -o-animation-name: bounceOut;
  animation-name: bounceOut; }

@-webkit-keyframes bounceOutUp {
  0% {
    -webkit-transform: translateY(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateY(20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); } }

@-moz-keyframes bounceOutUp {
  0% {
    -moz-transform: translateY(0); }

  20% {
    opacity: 1;
    -moz-transform: translateY(20px); }

  100% {
    opacity: 0;
    -moz-transform: translateY(-2000px); } }

@-o-keyframes bounceOutUp {
  0% {
    -o-transform: translateY(0); }

  20% {
    opacity: 1;
    -o-transform: translateY(20px); }

  100% {
    opacity: 0;
    -o-transform: translateY(-2000px); } }

@keyframes bounceOutUp {
  0% {
    transform: translateY(0); }

  20% {
    opacity: 1;
    transform: translateY(20px); }

  100% {
    opacity: 0;
    transform: translateY(-2000px); } }

.bounceOutUp {
  -webkit-animation-name: bounceOutUp;
  -moz-animation-name: bounceOutUp;
  -o-animation-name: bounceOutUp;
  animation-name: bounceOutUp; }

@-webkit-keyframes bounceOutDown {
  0% {
    -webkit-transform: translateY(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateY(-20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(2000px); } }

@-moz-keyframes bounceOutDown {
  0% {
    -moz-transform: translateY(0); }

  20% {
    opacity: 1;
    -moz-transform: translateY(-20px); }

  100% {
    opacity: 0;
    -moz-transform: translateY(2000px); } }

@-o-keyframes bounceOutDown {
  0% {
    -o-transform: translateY(0); }

  20% {
    opacity: 1;
    -o-transform: translateY(-20px); }

  100% {
    opacity: 0;
    -o-transform: translateY(2000px); } }

@keyframes bounceOutDown {
  0% {
    transform: translateY(0); }

  20% {
    opacity: 1;
    transform: translateY(-20px); }

  100% {
    opacity: 0;
    transform: translateY(2000px); } }

.bounceOutDown {
  -webkit-animation-name: bounceOutDown;
  -moz-animation-name: bounceOutDown;
  -o-animation-name: bounceOutDown;
  animation-name: bounceOutDown; }

@-webkit-keyframes bounceOutLeft {
  0% {
    -webkit-transform: translateX(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateX(20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); } }

@-moz-keyframes bounceOutLeft {
  0% {
    -moz-transform: translateX(0); }

  20% {
    opacity: 1;
    -moz-transform: translateX(20px); }

  100% {
    opacity: 0;
    -moz-transform: translateX(-2000px); } }

@-o-keyframes bounceOutLeft {
  0% {
    -o-transform: translateX(0); }

  20% {
    opacity: 1;
    -o-transform: translateX(20px); }

  100% {
    opacity: 0;
    -o-transform: translateX(-2000px); } }

@keyframes bounceOutLeft {
  0% {
    transform: translateX(0); }

  20% {
    opacity: 1;
    transform: translateX(20px); }

  100% {
    opacity: 0;
    transform: translateX(-2000px); } }

.bounceOutLeft {
  -webkit-animation-name: bounceOutLeft;
  -moz-animation-name: bounceOutLeft;
  -o-animation-name: bounceOutLeft;
  animation-name: bounceOutLeft; }

@-webkit-keyframes bounceOutRight {
  0% {
    -webkit-transform: translateX(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateX(-20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(2000px); } }

@-moz-keyframes bounceOutRight {
  0% {
    -moz-transform: translateX(0); }

  20% {
    opacity: 1;
    -moz-transform: translateX(-20px); }

  100% {
    opacity: 0;
    -moz-transform: translateX(2000px); } }

@-o-keyframes bounceOutRight {
  0% {
    -o-transform: translateX(0); }

  20% {
    opacity: 1;
    -o-transform: translateX(-20px); }

  100% {
    opacity: 0;
    -o-transform: translateX(2000px); } }

@keyframes bounceOutRight {
  0% {
    transform: translateX(0); }

  20% {
    opacity: 1;
    transform: translateX(-20px); }

  100% {
    opacity: 0;
    transform: translateX(2000px); } }

.bounceOutRight {
  -webkit-animation-name: bounceOutRight;
  -moz-animation-name: bounceOutRight;
  -o-animation-name: bounceOutRight;
  animation-name: bounceOutRight; }

@-webkit-keyframes rotateIn {
  0% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(-200deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateIn {
  0% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(-200deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateIn {
  0% {
    -o-transform-origin: center center;
    -o-transform: rotate(-200deg);
    opacity: 0; }

  100% {
    -o-transform-origin: center center;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateIn {
  0% {
    transform-origin: center center;
    transform: rotate(-200deg);
    opacity: 0; }

  100% {
    transform-origin: center center;
    transform: rotate(0);
    opacity: 1; } }

.rotateIn {
  -webkit-animation-name: rotateIn;
  -moz-animation-name: rotateIn;
  -o-animation-name: rotateIn;
  animation-name: rotateIn; }

@-webkit-keyframes rotateInUpLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInUpLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInUpLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInUpLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(90deg);
    opacity: 0; }

  100% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInUpLeft {
  -webkit-animation-name: rotateInUpLeft;
  -moz-animation-name: rotateInUpLeft;
  -o-animation-name: rotateInUpLeft;
  animation-name: rotateInUpLeft; }

@-webkit-keyframes rotateInDownLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInDownLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInDownLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInDownLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(-90deg);
    opacity: 0; }

  100% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInDownLeft {
  -webkit-animation-name: rotateInDownLeft;
  -moz-animation-name: rotateInDownLeft;
  -o-animation-name: rotateInDownLeft;
  animation-name: rotateInDownLeft; }

@-webkit-keyframes rotateInUpRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInUpRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInUpRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInUpRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(-90deg);
    opacity: 0; }

  100% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInUpRight {
  -webkit-animation-name: rotateInUpRight;
  -moz-animation-name: rotateInUpRight;
  -o-animation-name: rotateInUpRight;
  animation-name: rotateInUpRight; }

@-webkit-keyframes rotateInDownRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInDownRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInDownRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInDownRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(90deg);
    opacity: 0; }

  100% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInDownRight {
  -webkit-animation-name: rotateInDownRight;
  -moz-animation-name: rotateInDownRight;
  -o-animation-name: rotateInDownRight;
  animation-name: rotateInDownRight; }

@-webkit-keyframes rotateOut {
  0% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(200deg);
    opacity: 0; } }

@-moz-keyframes rotateOut {
  0% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(200deg);
    opacity: 0; } }

@-o-keyframes rotateOut {
  0% {
    -o-transform-origin: center center;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: center center;
    -o-transform: rotate(200deg);
    opacity: 0; } }

@keyframes rotateOut {
  0% {
    transform-origin: center center;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: center center;
    transform: rotate(200deg);
    opacity: 0; } }

.rotateOut {
  -webkit-animation-name: rotateOut;
  -moz-animation-name: rotateOut;
  -o-animation-name: rotateOut;
  animation-name: rotateOut; }

@-webkit-keyframes rotateOutUpLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutUpLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; } }

@-o-keyframes rotateOutUpLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; } }

@keyframes rotateOutUpLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: left bottom;
    transform: rotate(-90deg);
    opacity: 0; } }

.rotateOutUpLeft {
  -webkit-animation-name: rotateOutUpLeft;
  -moz-animation-name: rotateOutUpLeft;
  -o-animation-name: rotateOutUpLeft;
  animation-name: rotateOutUpLeft; }

@-webkit-keyframes rotateOutDownLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutDownLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; } }

@-o-keyframes rotateOutDownLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(90deg);
    opacity: 0; } }

@keyframes rotateOutDownLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: left bottom;
    transform: rotate(90deg);
    opacity: 0; } }

.rotateOutDownLeft {
  -webkit-animation-name: rotateOutDownLeft;
  -moz-animation-name: rotateOutDownLeft;
  -o-animation-name: rotateOutDownLeft;
  animation-name: rotateOutDownLeft; }

@-webkit-keyframes rotateOutUpRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutUpRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; } }

@-o-keyframes rotateOutUpRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(90deg);
    opacity: 0; } }

@keyframes rotateOutUpRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: right bottom;
    transform: rotate(90deg);
    opacity: 0; } }

.rotateOutUpRight {
  -webkit-animation-name: rotateOutUpRight;
  -moz-animation-name: rotateOutUpRight;
  -o-animation-name: rotateOutUpRight;
  animation-name: rotateOutUpRight; }

@-webkit-keyframes rotateOutDownRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutDownRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; } }

@-o-keyframes rotateOutDownRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; } }

@keyframes rotateOutDownRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: right bottom;
    transform: rotate(-90deg);
    opacity: 0; } }

.rotateOutDownRight {
  -webkit-animation-name: rotateOutDownRight;
  -moz-animation-name: rotateOutDownRight;
  -o-animation-name: rotateOutDownRight;
  animation-name: rotateOutDownRight; }

@-webkit-keyframes hinge {
  0% {
    -webkit-transform: rotate(0);
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  20%, 60% {
    -webkit-transform: rotate(80deg);
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  40% {
    -webkit-transform: rotate(60deg);
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  80% {
    -webkit-transform: rotate(60deg) translateY(0);
    opacity: 1;
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  100% {
    -webkit-transform: translateY(700px);
    opacity: 0; } }

@-moz-keyframes hinge {
  0% {
    -moz-transform: rotate(0);
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  20%, 60% {
    -moz-transform: rotate(80deg);
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  40% {
    -moz-transform: rotate(60deg);
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  80% {
    -moz-transform: rotate(60deg) translateY(0);
    opacity: 1;
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  100% {
    -moz-transform: translateY(700px);
    opacity: 0; } }

@-o-keyframes hinge {
  0% {
    -o-transform: rotate(0);
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  20%, 60% {
    -o-transform: rotate(80deg);
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  40% {
    -o-transform: rotate(60deg);
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  80% {
    -o-transform: rotate(60deg) translateY(0);
    opacity: 1;
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  100% {
    -o-transform: translateY(700px);
    opacity: 0; } }

@keyframes hinge {
  0% {
    transform: rotate(0);
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  20%, 60% {
    transform: rotate(80deg);
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  40% {
    transform: rotate(60deg);
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  80% {
    transform: rotate(60deg) translateY(0);
    opacity: 1;
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  100% {
    transform: translateY(700px);
    opacity: 0; } }

.hinge {
  -webkit-animation-name: hinge;
  -moz-animation-name: hinge;
  -o-animation-name: hinge;
  animation-name: hinge; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes rollIn {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0px) rotate(0deg); } }

@-moz-keyframes rollIn {
  0% {
    opacity: 0;
    -moz-transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0px) rotate(0deg); } }

@-o-keyframes rollIn {
  0% {
    opacity: 0;
    -o-transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    -o-transform: translateX(0px) rotate(0deg); } }

@keyframes rollIn {
  0% {
    opacity: 0;
    transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    transform: translateX(0px) rotate(0deg); } }

.rollIn {
  -webkit-animation-name: rollIn;
  -moz-animation-name: rollIn;
  -o-animation-name: rollIn;
  animation-name: rollIn; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes rollOut {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(100%) rotate(120deg); } }

@-moz-keyframes rollOut {
  0% {
    opacity: 1;
    -moz-transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    -moz-transform: translateX(100%) rotate(120deg); } }

@-o-keyframes rollOut {
  0% {
    opacity: 1;
    -o-transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    -o-transform: translateX(100%) rotate(120deg); } }

@keyframes rollOut {
  0% {
    opacity: 1;
    transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    transform: translateX(100%) rotate(120deg); } }

.rollOut {
  -webkit-animation-name: rollOut;
  -moz-animation-name: rollOut;
  -o-animation-name: rollOut;
  animation-name: rollOut; }

/* originally authored by Angelo Rohit - https://github.com/angelorohit */
@-webkit-keyframes lightSpeedIn {
  0% {
    -webkit-transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    -webkit-transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    -webkit-transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    -webkit-transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

@-moz-keyframes lightSpeedIn {
  0% {
    -moz-transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    -moz-transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    -moz-transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    -moz-transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

@-o-keyframes lightSpeedIn {
  0% {
    -o-transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    -o-transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    -o-transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    -o-transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

@keyframes lightSpeedIn {
  0% {
    transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

.lightSpeedIn {
  -webkit-animation-name: lightSpeedIn;
  -moz-animation-name: lightSpeedIn;
  -o-animation-name: lightSpeedIn;
  animation-name: lightSpeedIn;
  -webkit-animation-timing-function: ease-out;
  -moz-animation-timing-function: ease-out;
  -o-animation-timing-function: ease-out;
  animation-timing-function: ease-out; }

.animated.lightSpeedIn {
  -webkit-animation-duration: 0.5s;
  -moz-animation-duration: 0.5s;
  -o-animation-duration: 0.5s;
  animation-duration: 0.5s; }

/* originally authored by Angelo Rohit - https://github.com/angelorohit */
@-webkit-keyframes lightSpeedOut {
  0% {
    -webkit-transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    -webkit-transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

@-moz-keyframes lightSpeedOut {
  0% {
    -moz-transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    -moz-transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

@-o-keyframes lightSpeedOut {
  0% {
    -o-transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    -o-transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

@keyframes lightSpeedOut {
  0% {
    transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

.lightSpeedOut {
  -webkit-animation-name: lightSpeedOut;
  -moz-animation-name: lightSpeedOut;
  -o-animation-name: lightSpeedOut;
  animation-name: lightSpeedOut;
  -webkit-animation-timing-function: ease-in;
  -moz-animation-timing-function: ease-in;
  -o-animation-timing-function: ease-in;
  animation-timing-function: ease-in; }

.animated.lightSpeedOut {
  -webkit-animation-duration: 0.25s;
  -moz-animation-duration: 0.25s;
  -o-animation-duration: 0.25s;
  animation-duration: 0.25s; }

/* originally authored by Angelo Rohit - https://github.com/angelorohit */
@-webkit-keyframes wiggle {
  0% {
    -webkit-transform: skewX(9deg); }

  10% {
    -webkit-transform: skewX(-8deg); }

  20% {
    -webkit-transform: skewX(7deg); }

  30% {
    -webkit-transform: skewX(-6deg); }

  40% {
    -webkit-transform: skewX(5deg); }

  50% {
    -webkit-transform: skewX(-4deg); }

  60% {
    -webkit-transform: skewX(3deg); }

  70% {
    -webkit-transform: skewX(-2deg); }

  80% {
    -webkit-transform: skewX(1deg); }

  90% {
    -webkit-transform: skewX(0deg); }

  100% {
    -webkit-transform: skewX(0deg); } }

@-moz-keyframes wiggle {
  0% {
    -moz-transform: skewX(9deg); }

  10% {
    -moz-transform: skewX(-8deg); }

  20% {
    -moz-transform: skewX(7deg); }

  30% {
    -moz-transform: skewX(-6deg); }

  40% {
    -moz-transform: skewX(5deg); }

  50% {
    -moz-transform: skewX(-4deg); }

  60% {
    -moz-transform: skewX(3deg); }

  70% {
    -moz-transform: skewX(-2deg); }

  80% {
    -moz-transform: skewX(1deg); }

  90% {
    -moz-transform: skewX(0deg); }

  100% {
    -moz-transform: skewX(0deg); } }

@-o-keyframes wiggle {
  0% {
    -o-transform: skewX(9deg); }

  10% {
    -o-transform: skewX(-8deg); }

  20% {
    -o-transform: skewX(7deg); }

  30% {
    -o-transform: skewX(-6deg); }

  40% {
    -o-transform: skewX(5deg); }

  50% {
    -o-transform: skewX(-4deg); }

  60% {
    -o-transform: skewX(3deg); }

  70% {
    -o-transform: skewX(-2deg); }

  80% {
    -o-transform: skewX(1deg); }

  90% {
    -o-transform: skewX(0deg); }

  100% {
    -o-transform: skewX(0deg); } }

@keyframes wiggle {
  0% {
    transform: skewX(9deg); }

  10% {
    transform: skewX(-8deg); }

  20% {
    transform: skewX(7deg); }

  30% {
    transform: skewX(-6deg); }

  40% {
    transform: skewX(5deg); }

  50% {
    transform: skewX(-4deg); }

  60% {
    transform: skewX(3deg); }

  70% {
    transform: skewX(-2deg); }

  80% {
    transform: skewX(1deg); }

  90% {
    transform: skewX(0deg); }

  100% {
    transform: skewX(0deg); } }

.wiggle {
  -webkit-animation-name: wiggle;
  -moz-animation-name: wiggle;
  -o-animation-name: wiggle;
  animation-name: wiggle;
  -webkit-animation-timing-function: ease-in;
  -moz-animation-timing-function: ease-in;
  -o-animation-timing-function: ease-in;
  animation-timing-function: ease-in; }

.animated.wiggle {
  -webkit-animation-duration: 0.75s;
  -moz-animation-duration: 0.75s;
  -o-animation-duration: 0.75s;
  animation-duration: 0.75s; }
  

    </style>

    <link href="https://ningyu1.github.io/site/css/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="https://ningyu1.github.io/site/css/github-markdown.css" rel="stylesheet" type="text/css">

    <link href='https://ningyu1.github.io/site/css/Slackey.css' rel='stylesheet' type='text/css'>
    <link href='https://ningyu1.github.io/site/css/Fjallaone.css' rel='stylesheet' type='text/css'>
    <link href='https://ningyu1.github.io/site/css/Amethysta.css' rel='stylesheet' type='text/css'>
	<script src="https://ningyu1.github.io/site/js/jquery.min.js"></script>
    

    <script type="text/javascript" src="https://ningyu1.github.io/site/js/jquery-tapir.js"></script>

    

    <link rel="stylesheet" href="https://ningyu1.github.io/site/css/hljs.css">
    <script src="https://ningyu1.github.io/site/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?5bb9b9d406e3381971859973a2ca3583";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>
</head>


<a href="https://github.com/ningyu1"><img style="position: absolute; top: 0; right: 0; border: 0; width: 149px; height: 149px; z-index:9999; background-color: rgba(0, 0, 0, 0)!important;" src="https://ningyu1.github.io/site/images/right-graphite@2x.png" alt="Fork me on GitHub"></a>








<link href="https://ningyu1.github.io/site/css/music-player.css" media="screen, projection" rel="stylesheet" type="text/css">
<script type="text/javascript" src="https://ningyu1.github.io/site/js/music-player.js"></script>
<iframe class="player"  frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="https://music.163.com/outchain/player?type=2&id=1296583188&auto=0&height=66"></iframe>



<body class="markdown-body">
    <div id="wrapper">
        <header id="header" class="inner">
<h1 class="animated bounceInDown">
    <div id="headerbg">
        凝雨 - Yun
    </div>
</h1>

<span class="subtitle">快乐编程每一天 - Happy Coding Every Day</span>
<br>


<ul id="social-links" style="text-align:center; clear:both;">
	
    
    <li>
    <a href="mailto:ningbe111@163.com" class="email" title="Email"></a>
    </li>
    
    
    
    <li>
    <a href="https://github.com/ningyu1" class="github" title="Github"></a>
    </li>
    
	
    
    <li>
    <a href="https://gitlab.com/ningyu1" class="gitlab" title="Gitlab"></a>
    </li>
    
    
    
    
    
    
    
    
	
    
    <li>
    <a href="https://gitee.com/ningyu" class="gitee" title="Gitee码云"></a>
    </li>
    
	<li>

    <a href="https://ningyu1.github.io/atom.xml" class="rss" title="RSS" target="_blank"></a>
    </li>
</ul>



<ul id="nav">





    
    <li id="ajax"><a href="https://ningyu1.github.io/">Home</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/archives/">Archives</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/categories/">Categories</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/tags/">Tags</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/about/">About</a></li>
    <li id="ajax"><a href="https://g2.okk.dog/?path=register&code=qn7nOwdj">科学上网</a></li>
    
    <li>
    <div id="dark">
        
        <form action="//www.google.com/search" method="get" accept-charset="UTF-8" id="search">

            <input type="hidden" name="sitesearch" value="https://ningyu1.github.io" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
</ul>

</header>

<div id="toload">

    <div id="content" class="inner">
        




    
    <script id="dsq-count-scr" src="//ningyu.disqus.com/count.js" async></script>
    




  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/21-fastfds-client/">FastDFS-Client使用说明</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-09-06T10:17:36.000&#43;00:00' itemprop="datePublished">2017-09-06</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/fastdfs">Fastdfs</a>


</div>
    </div>
        

<h2 id="项目地址">项目地址</h2>

<p><a href="https://github.com/ningyu1/fastdfs-client">fastdfs-client</a></p>

<p><a href="https://github.com/ningyu1/fastdfs-client/releases"><img src="https://img.shields.io/github/release/ningyu1/fastdfs-client.svg?style=social&amp;label=Release"></a>&nbsp;<a href="https://github.com/ningyu1/fastdfs-client/stargazers"><img src="https://img.shields.io/github/stars/ningyu1/fastdfs-client.svg?style=social&amp;label=Star"></a>&nbsp;<a href="https://github.com/ningyu1/fastdfs-client/fork"><img src="https://img.shields.io/github/forks/ningyu1/fastdfs-client.svg?style=social&amp;label=Fork"></a>&nbsp;<a href="https://github.com/ningyu1/fastdfs-client/watchers"><img src="https://img.shields.io/github/watchers/ningyu1/fastdfs-client.svg?style=social&amp;label=Watch"></a> <a href="http://www.gnu.org/licenses/gpl-3.0.html"><img src="https://img.shields.io/badge/license-GPLv3-blue.svg"></a></p>

<h2 id="fastdfs-client是什么">fastdfs-client是什么</h2>

<p>fastdfs-client是一个访问fastdfs的Java客户端框架，帮助开发人员快速使用分布式文件系统的工具，封装了TrackerClient操作来管理存储节点，封装了StorageClient操作来执行文件上传下载功能。</p>

<h2 id="change-log">change log</h2>

<p><a href="https://github.com/ningyu1/fastdfs-client/releases/tag/V1.1.0">V1.1.0</a></p>

<ol>
<li>修改download文件receive时带入的inputStream对象，inputStream对象修改为克隆socket的inputstream，避免污染连接池中的socket对象，当业务回调不读取留时会影响下一次连接池中获取的socket对象。</li>
<li>在使用1.0.0版本进行download文件时，建议使用DownloadCallback的实现类：DownloadByteArray和DownloadFileWriter不要自己去实现，不要关闭receive方法传入的inputStream对象。</li>
<li>在使用1.1.0版本进行download文件时，receive传入的inputStream是克隆的，因此使用完后必须进行关闭操作。</li>
</ol>

<p><a href="https://github.com/ningyu1/fastdfs-client/releases/tag/V1.0.0">V1.0.0</a></p>

<ol>
<li>包装Request和Response报文解析</li>
<li>包装Storage和Tracker操作命令</li>
<li>增加连接池提升使用性能</li>
</ol>

<h2 id="接口方法">接口方法</h2>

<p>StorageClient</p>

<p><img src="https://ningyu1.github.io/site/img/fastdfs-client/1.png" alt="1.png" /></p>

<p>TrackerClient</p>

<p><img src="https://ningyu1.github.io/site/img/fastdfs-client/2.png" alt="2.png" /></p>

<h2 id="maven引入">Maven引入</h2>

<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;cn.tsoft.framework&lt;/groupId&gt;
  &lt;artifactId&gt;fastdfs-client&lt;/artifactId&gt;
  &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h2 id="spring引入">Spring引入</h2>

<pre><code class="language-xml">&lt;import resource=&quot;classpath:spring-fastdfs.xml&quot;/&gt;
</code></pre>

<h2 id="client使用">Client使用</h2>

<pre><code class="language-java">@Autowired
private StorageClient storageClient;
 
//上传
String path = ClassLoader.getSystemResource(&quot;123456.txt&quot;).getPath();
File file = new File(path);
FileInputStream fileInputStream = FileUtils.openInputStream(file);
//方式1
StorePath storePath = storageClient.uploadFile(&quot;group1&quot;, fileInputStream, file.length(), &quot;txt&quot;);
//方式2
StorePath storePath = storageClient.uploadFile(fileInputStream, file.length(), &quot;txt&quot;);
//方式3
StorePath storePath = storageClient.uploadFile(path);
//方式4
StorePath storePath = storageClient.uploadFile(path, &quot;txt&quot;);
//方式5
StorePath storePath = storageClient.uploadFile(&quot;group1&quot;, path, &quot;txt&quot;);
//方式6
StorePath storePath = storageClient.uploadFile(fileInputStream, file.length(), &quot;txt&quot;, metaDataSet);
//上传文件并增加元数据
Set&lt;MateData&gt; metaDataSet = new HashSet&lt;MateData&gt;();
MateData mateData = new MateData(&quot;mateDataName&quot;,&quot;mateDataValue&quot;);
metaDataSet.add(mateData);
StorePath storePath = storageClient.uploadFile(&quot;group1&quot;, fileInputStream, file.length(), &quot;txt&quot;, metaDataSet);
 
//上传从文件，一个主文件可以挂多个从文件
//方式1
String masterFileId = storePath.getFullPath();
String[] parts = new String[2];
splitFileId(masterFileId, parts);
storePath = storageClient.uploadSlaveFile(parts[0], parts[1], fileInputStream, file.length(), &quot;-1&quot;, &quot;txt&quot;);
//方式2
storePath = storageClient.uploadSlaveFile(masterFileId, fileInputStream, file.length(), &quot;-1&quot;, &quot;xlsx&quot;);
         
fileInputStream.close();
 
 
//下载
//方式1
String path = ClassLoader.getSystemResource(&quot;123456.txt&quot;).getPath();
StorePath storePath = storageClient.uploadFile(&quot;group1&quot;, path, &quot;txt&quot;);
addResultFileId(storePath.getFullPath());
DownloadFileWriter downloadFileWriter = new DownloadFileWriter(path.replaceAll(&quot;123456.txt&quot;, &quot;123456downlaod1.txt&quot;));
String filePath = storageClient.downloadFile(storePath.getGroup(), storePath.getPath(), downloadFileWriter);
//方式2
DownloadFileWriter downloadFileWriter = new DownloadFileWriter(path.replaceAll(&quot;123456.txt&quot;, &quot;123456downlaod2.txt&quot;));
String filePath = storageClient.downloadFile(storePath.getFullPath(), downloadFileWriter);
//方式3
DownloadFileWriter downloadFileWriter = new DownloadFileWriter(path.replaceAll(&quot;123456.txt&quot;, &quot;123456downlaod3.txt&quot;));
String filePath = storageClient.downloadFile(storePath.getGroup(), storePath.getPath(), 10, 0, downloadFileWriter); 
//方式4
DownloadFileWriter downloadFileWriter = new DownloadFileWriter(path.replaceAll(&quot;123456.txt&quot;, &quot;123456downlaod4.txt&quot;));
String filePath = storageClient.downloadFile(storePath.getFullPath(), 5, 0, downloadFileWriter);
 
//删除
//方式1
String path = ClassLoader.getSystemResource(&quot;123456.txt&quot;).getPath();
StorePath storePath = storageClient.uploadFile(&quot;group1&quot;, path, &quot;txt&quot;);
boolean flag = storageClient.deleteFile(storePath.getGroup(), storePath.getPath());
//方式2
boolean flag = storageClient.deleteFile(storePath.getFullPath());
 
//获取文件信息
//方式1
String path = ClassLoader.getSystemResource(&quot;123456.txt&quot;).getPath();
StorePath storePath = storageClient.uploadFile(&quot;group1&quot;, path, &quot;txt&quot;);
addResultFileId(storePath.getFullPath());
String fileId = storePath.getFullPath();
FileInfo fileInfo = storageClient.getFileInfo(storePath.getGroup(), storePath.getPath());
//方式2
FileInfo fileInfo = storageClient.getFileInfo(fileId);
 
//获取文件元数据
//方式1
String masterFileId = storePath.getFullPath();
String[] parts = new String[2];
splitFileId(masterFileId, parts);
Set&lt;MateData&gt; mateDataSet = storageClient.getMetadata(parts[0], parts[1]);
//方式2
Set&lt;MateData&gt; mateDataSet = storageClient.getMetadata(masterFileId);
 
//覆盖文件元数据
//方式1
String[] parts = new String[2];
splitFileId(masterFileId, parts);
mateDataSet = new HashSet&lt;MateData&gt;();
mateDataSet.add(new MateData(&quot;key5&quot;, &quot;value5&quot;));
mateDataSet.add(new MateData(&quot;key6&quot;, &quot;value6&quot;));
mateDataSet.add(new MateData(&quot;key7&quot;, &quot;value7&quot;));
boolean flag = storageClient.overwriteMetadata(parts[0], parts[1], mateDataSet);
//方式2
boolean flag = storageClient.overwriteMetadata(masterFileId, mateDataSet);
 
//合并文件元数据
//方式1
String[] parts = new String[2];
splitFileId(masterFileId, parts);
mateDataSet = new HashSet&lt;MateData&gt;();
mateDataSet.add(new MateData(&quot;key5&quot;, &quot;value5&quot;));
mateDataSet.add(new MateData(&quot;key6&quot;, &quot;value6&quot;));
mateDataSet.add(new MateData(&quot;key7&quot;, &quot;value7&quot;));
boolean flag = storageClient.mergeMetadata(parts[0], parts[1], mateDataSet);
//方式2
boolean flag = storageClient.mergeMetadata(masterFileId, mateDataSet);
 
//一下方法就不具体介绍
//续传文件
appendFile
//修改续传文件
modifyFile
//清除续传文件
truncateFile
</code></pre>

<p><strong>ps.TrackerClient的操作是配合StorageClient使用，我们在正常业务使用中一般不会用到它。</strong></p>

<h2 id="fastdfs-nginx-module使用">FastDFS-nginx-module使用</h2>

<p>上传的文件可以通过nginx直接访问</p>

<p>例如：我们上传的文件获取的文件id：group1/M00/02/92/wKgAMFkekciAC8fhAAJjfD2dq-w10.xlsx</p>

<p>nginx访问路径：<a href="http://192.168.0.48:8079/group1/M00/02/92/wKgAMFkekciAC8fhAAJjfD2dq-w10.xlsx">http://192.168.0.48:8079/group1/M00/02/92/wKgAMFkekciAC8fhAAJjfD2dq-w10.xlsx</a></p>

<p>目前nginx模块跟storage存储节点匹配，nginx会通过fastdfs-plugin跟tracker通信将文件的信息路由到不同的storage上去</p>

<h2 id="注意事项">注意事项</h2>

<ol>
<li>上传文件后记录fileId，fastdfs不会自动删除文件，所以业务需要进行定期删除无用的文件，避免硬盘消耗过大</li>
<li>rpc之间调用时

<ul>
<li>以前是rpc client端通过文件byte方式传入rpc server端，这样rpc的请求包过大会导致rpc调用性能急速下降</li>
<li>应修改为通过fastdfs做桥接，rpc client端upload文件到fastdfs，将返回的fileId做参数传入rpc server端 ，rpc server端通过fileid去fastdfs服务器上download文件文件</li>
</ul></li>
</ol>

<h2 id="fastdfs-client-api说明">FastDFS-client-api说明</h2>

<pre><code class="language-java">/**
 * 存储服务(Storage)客户端接口
 * 
 * @author ningyu
 * @date 2017年5月18日 上午11:25:03
 *
 */
public interface StorageClient {
    /**
     * 上传文件
     *
     * @param groupName   组名称
     * @param inputStream 文件输入流
     * @param fileSize    文件大小
     * @param fileExtName 文件扩展名
     * @return 文件存储路径
     */
    StorePath uploadFile(String groupName, InputStream inputStream, long fileSize, String fileExtName);
     
    /**
     * 文件上传
     *
     * @param inputStream 文件输入流
     * @param fileSize    文件大小
     * @param fileExtName 文件扩展名
     * @return
     */
    StorePath uploadFile(InputStream inputStream, long fileSize, String fileExtName);
     
     
    /**
     * 文件上传
     *
     * @param localFilePath 文件完全路径
     * @return
     */
    StorePath uploadFile(String localFilePath);
     
    /**
     * 文件上传
     *
     * @param localFilePath 文件完全路径
     * @param fileExtName   文件后缀名
     * @return
     */
    StorePath uploadFile(String localFilePath, String fileExtName);
     
    /**
     * 文件上传
     *
     * @param groupName     组名称
     * @param localFilePath 文件完全路径
     * @param fileExtName   文件后缀名
     * @return
     */
    StorePath uploadFile(String groupName, String localFilePath, String fileExtName);
 
    /**
     * 上传从文件
     *
     * @param groupName      组名称
     * @param masterFilename 主文件路径(fastdfs返回的file_id 去掉前面的group)
     * @param inputStream    从文件输入流
     * @param fileSize       从文件大小
     * @param prefixName     从文件前缀
     * @param fileExtName    主文件扩展名
     * @return 文件存储路径
     */
    StorePath uploadSlaveFile(String groupName, String masterFilename, InputStream inputStream, long fileSize, String prefixName, String fileExtName);
    
    /**
     * 上传从文件
     *
     * @param masterFileId 主文件路径（fastdfs返回的file_id，包含前面的group）
     * @param inputStream  从文件输入流
     * @param fileSize     从文件大小
     * @param prefixName   从文件前缀
     * @param fileExtName  主文件扩展名
     * @return
     */
    StorePath uploadSlaveFile(String masterFileId, InputStream inputStream, long fileSize, String prefixName, String fileExtName);
 
    /**
     * 获取文件元信息
     *
     * @param groupName 组名称
     * @param path      主文件路径
     * @return 获取文件元信息集合，不存在返回空集合
     */
    Set&lt;MateData&gt; getMetadata(String groupName, String path);
     
    /**
     * 获取文件元信息
     *
     * @param fileId 文件路径（fastdfs返回的file_id，包含前面的group）
     * @return
     */
    Set&lt;MateData&gt; getMetadata(String fileId);
 
    /**
     * 修改文件元信息（覆盖）
     *
     * @param groupName   组名称
     * @param path        主文件路径
     * @param metaDataSet 元信息集合
     */
    boolean overwriteMetadata(String groupName, String path, Set&lt;MateData&gt; metaDataSet);
     
    /**
     * 修改文件元信息（覆盖）
     *
     * @param fileId        文件路径（fastdfs返回的file_id，包含前面的group）
     * @param metaDataSet   元信息集合
     * @return
     */
    boolean overwriteMetadata(String fileId, Set&lt;MateData&gt; metaDataSet);
 
    /**
     * 修改文件元信息（合并）
     *
     * @param groupName   组名称
     * @param path        主文件路径
     * @param metaDataSet 元信息集合
     */
    boolean mergeMetadata(String groupName, String path, Set&lt;MateData&gt; metaDataSet);
     
    /**
     * 修改文件元信息（合并）
     *
     * @param fileId         文件路径（fastdfs返回的file_id，包含前面的group）
     * @param metaDataSet    元信息集合
     * @return
     */
    boolean mergeMetadata(String fileId, Set&lt;MateData&gt; metaDataSet);
 
    /**
     * 获取文件的信息
     *
     * @param groupName 组名称
     * @param path      主文件路径
     * @return 文件信息(不存在返回null)
     */
    FileInfo getFileInfo(String groupName, String path);
     
    /**
     * 获取文件信息
     *
     * @param fileId  文件路径（fastdfs返回的file_id，包含前面的group）
     * @return
     */
    FileInfo getFileInfo(String fileId);
 
    /**
     * 删除文件
     *
     * @param groupName 组名称
     * @param path      主文件路径
     */
    boolean deleteFile(String groupName, String path);
     
    /**
     * 删除文件
     *
     * @param fileId 文件路径（fastdfs返回的file_id，包含前面的group）
     * @return
     */
    boolean deleteFile(String fileId);
 
    /**
     * 下载整个文件
     *
     * @param groupName 组名称
     * @param path      主文件路径
     * @param callback  下载回调接口
     * @return 下载回调接口返回结果
     */
    &lt;T&gt; T downloadFile(String groupName, String path, DownloadCallback&lt;T&gt; callback);
     
    /**
     * 下载整个文件
     *
     * @param fileId   文件路径（fastdfs返回的file_id，包含前面的group）
     * @param callback 下载回调接口
     * @return
     */
    &lt;T&gt; T downloadFile(String fileId, DownloadCallback&lt;T&gt; callback);
 
    /**
     * 下载文件片段
     *
     * @param groupName  组名称
     * @param path       主文件路径
     * @param fileOffset 开始位置
     * @param fileSize   文件大小(经过测试好像这个参数值只能是“0”)
     * @param callback   下载回调接口
     * @return 下载回调接口返回结果
     */
    &lt;T&gt; T downloadFile(String groupName, String path, long fileOffset, long fileSize, DownloadCallback&lt;T&gt; callback);
     
    /**
     * 下载文件片段
     *
     * @param fileId     文件路径（fastdfs返回的file_id，包含前面的group）
     * @param fileOffset 开始位置
     * @param fileSize   文件大小(经过测试好像这个参数值只能是“0”)
     * @param callback   下载回调接口
     * @return
     */
    &lt;T&gt; T downloadFile(String fileId, long fileOffset, long fileSize, DownloadCallback&lt;T&gt; callback);
 
    // ----------------------------------------------------------------------------------------------------------------------------------------------------
 
    /**
     * 上传文件， 并设置文件元数据
     *
     * @param inputStream 文件输入流
     * @param fileSize    文件大小
     * @param fileExtName 文件扩展名
     * @param metaDataSet 元信息集合
     * @return 文件存储路径
     */
    StorePath uploadFile(InputStream inputStream, long fileSize, String fileExtName, Set&lt;MateData&gt; metaDataSet);
     
    /**
     * 上传文件， 并设置文件元数据
     *
     * @param groupName    组名
     * @param inputStream  文件输入流
     * @param fileSize     文件大小
     * @param fileExtName  文件扩展名
     * @param metaDataSet  元信息集合
     * @return
     */
    StorePath uploadFile(String groupName, InputStream inputStream, long fileSize, String fileExtName, Set&lt;MateData&gt; metaDataSet);
 
    /**
     * 文件上传(支持续传追加内容)
     *
     * @param groupName   组名称
     * @param inputStream 文件输入流(文件部分)
     * @param fileSize    文件大小
     * @param fileExtName 文件扩展名
     * @return 文件存储路径
     */
    StorePath uploadAppenderFile(String groupName, InputStream inputStream, long fileSize, String fileExtName);
 
    /**
     * 续传文件(追加内容)&lt;/br&gt;
     * 从末尾追加内容&lt;/br&gt;
     *
     * @param groupName   组名称
     * @param path        文件路径
     * @param inputStream 文件输入流(文件部分)
     * @param fileSize    文件大小
     * 
     */
    void appendFile(String groupName, String path, InputStream inputStream, long fileSize);
     
    /**
     * 续传文件(追加内容)&lt;/br&gt;
     * 从末尾追加内容&lt;/br&gt;
     *
     * @param fileId       文件路径（fastdfs返回的file_id，包含前面的group）
     * @param inputStream  文件输入流(文件部分)
     * @param fileSize     文件大小
     * 
     */
    void appendFile(String fileId, InputStream inputStream, long fileSize);
 
    /**
     * 修改文件内容的内容&lt;/br&gt;
     * 从offset开始覆盖fileSize长度&lt;/br&gt;
     * 报22参数错误，请检查offset是否超过文件长度&lt;/br&gt;
     *
     * @param groupName   组名称
     * @param path        文件路径
     * @param inputStream 文件输入流
     * @param fileSize    文件大小
     * @param fileOffset  开始位置
     * 
     */
    void modifyFile(String groupName, String path, InputStream inputStream, long fileSize, long fileOffset);
     
    /**
     * 修改文件内容的内容&lt;/br&gt;
     * 从offset开始覆盖fileSize长度&lt;/br&gt;
     * 报22参数错误，请检查offset是否超过文件长度&lt;/br&gt;
     *
     * @param fileId      文件路径（fastdfs返回的file_id，包含前面的group）
     * @param inputStream 文件输入流
     * @param fileSize    文件大小
     * @param fileOffset  开始位置
     * 
     */
    void modifyFile(String fileId, InputStream inputStream, long fileSize, long fileOffset);
 
    /**
     * 清除文件的内容
     *
     * @param groupName         组名称
     * @param path              文件路径
     * @param truncatedFileSize 截断文件大小
     * 
     */
    void truncateFile(String groupName, String path, long truncatedFileSize);
     
    /**
     * 清除文件的内容
     *
     * @param fileId            文件路径（fastdfs返回的file_id，包含前面的group）
     * @param truncatedFileSize 截断文件大小
     * 
     */
    void truncateFile(String fileId, long truncatedFileSize);
 
    /**
     * 清除文件的内容
     *
     * @param groupName 组名称
     * @param path      文件路径
     * 
     */
    void truncateFile(String groupName, String path);
     
    /**
     * 清除文件的内容
     *
     * @param fileId 文件路径（fastdfs返回的file_id，包含前面的group）
     * 
     */
    void truncateFile(String fileId);
}
</code></pre>

<p><strong>ps.api我只放出了StorageClient的说明，TrackerClient的使用常规开发时用不到的，架构在进行调优的时候可能会使用到，所以这里就不做过多的解释</strong></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/21-fastfds-client/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/20-mybatis-sqlhelper/">MybatisSql获取工具类SqlHelper使用说明</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-09-05T17:50:36.000&#43;00:00' itemprop="datePublished">2017-09-05</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/mybatis">Mybatis</a>

<a href="https://ningyu1.github.io/site/tags/sqlhelper">Sqlhelper</a>


</div>
    </div>
        

<h2 id="项目地址">项目地址</h2>

<p><a href="https://github.com/ningyu1/tsoft-parent/tree/master/tsoft-common" title="tsoft-common">tsoft-common</a></p>

<p><a href="http://www.gnu.org/licenses/gpl-3.0.html"><img src="https://img.shields.io/badge/license-GPLv3-blue.svg" alt="License" /></a></p>

<h2 id="前言">前言</h2>

<p>有的时候我们想在代码中获取Mybatis方法的sql但是又不想去实际执行Mybatis的查询方法，可以使用该工具直接得到sql。</p>

<h2 id="maven引入">Maven引入</h2>

<pre><code class="language-xml">&lt;dependency&gt;
  &lt;groupId&gt;cn.tsoft.framework&lt;/groupId&gt;
  &lt;artifactId&gt;tsoft-common&lt;/artifactId&gt;
  &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h2 id="目标">目标</h2>

<p>SqlHelper是获取Mybatis方法的sql工具包，支持mybatis mapper方式和sqlmap方式，支持参数：entity，map，array，list，这个工具不需要你实际去执行Mybatis的查询方法就能得到sql，方法主要分两大类，使用命名空间namespace调用或者使用Mapper接口方式调用。</p>

<h2 id="测试方法">测试方法</h2>

<pre><code class="language-java">String sql = null;
UserEntity entity = new UserEntity();
entity.setUserId(1L);
entity.setPassword(&quot;sdflkjsldjf&quot;);
entity.setPasswordExpire(new Date());
entity.setVersion(2L);
List&lt;Long&gt; list = new ArrayList&lt;Long&gt;();
list.add(1L);
list.add(2L);
Long[] ids = new Long[]{1L,2L};
//方式一
sql = SqlHelper.getMapperSql(userMapper, &quot;mobileIsExists&quot;, 1L, &quot;13800138000&quot;);
System.out.println(&quot;方式一：参数为：@Param：&quot;+sql);
sql = SqlHelper.getMapperSql(userMapper, &quot;mobileIsExists&quot;);
System.out.println(&quot;方式一：参数为：无参：&quot;+sql);
sql = SqlHelper.getMapperSql(userMapper, &quot;modifyPassword&quot;, entity);
System.out.println(&quot;方式一：参数为：entity&quot;+sql);
sql = SqlHelper.getMapperSql(userMapper, &quot;blockedArrays&quot;, ids);
System.out.println(&quot;方式一：参数为：arrays&quot;+sql);
sql = SqlHelper.getMapperSql(userMapper, &quot;blockedList&quot;, list);
System.out.println(&quot;方式一：参数为：list&quot;+sql);
 
SqlSession sqlSession = mybatisSessionFactory.getObject().openSession();
//方式二
sql = SqlHelper.getMapperSql(sqlSession, &quot;cn.tsoft.account.mapper.UserMapper.mobileIsExists&quot;, 1L, &quot;13800138000&quot;);
System.out.println(&quot;方式二：参数为：@Param：&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, &quot;cn.tsoft.account.mapper.UserMapper.mobileIsExists&quot;);
System.out.println(&quot;方式二：参数为：无参：&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, &quot;cn.tsoft.account.mapper.UserMapper.modifyPassword&quot;, entity);
System.out.println(&quot;方式二：参数为：entity&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, &quot;cn.tsoft.account.mapper.UserMapper.blockedArrays&quot;, ids);
System.out.println(&quot;方式二：参数为：arrays&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, &quot;cn.tsoft.account.mapper.UserMapper.blockedList&quot;, list);
System.out.println(&quot;方式二：参数为：list&quot;+sql);
 
//方式三
sql = SqlHelper.getMapperSql(sqlSession, UserMapper.class, &quot;mobileIsExists&quot;, 1L, &quot;13800138000&quot;);
System.out.println(&quot;方式三：参数为：@Param：&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, UserMapper.class, &quot;mobileIsExists&quot;);
System.out.println(&quot;方式三：参数为：无参：&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, UserMapper.class, &quot;modifyPassword&quot;, entity);
System.out.println(&quot;方式三：参数为：entity&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, UserMapper.class, &quot;blockedArrays&quot;, ids);
System.out.println(&quot;方式三：参数为：arrays&quot;+sql);
sql = SqlHelper.getMapperSql(sqlSession, UserMapper.class, &quot;blockedList&quot;, list);
System.out.println(&quot;方式三：参数为：list&quot;+sql);
</code></pre>

<h2 id="日志输出">日志输出</h2>

<pre><code class="language-log">方式一：参数为：@Param：
SELECT COUNT(t.`ID`) FROM t_user t 
WHERE t.`MOBILE` = '13800138000'
          
            AND t.`USER_ID` != '1'
方式一：参数为：无参：
SELECT COUNT(t.`ID`) FROM t_user t 
WHERE t.`MOBILE` = 'null'
方式一：参数为：entity：
UPDATE t_user t 
        SET 
        t.`PASSWORD` = 'sdflkjsldjf' , 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`PASSWORD_MODIFY_TIME` = CURRENT_TIMESTAMP , 
        t.`PASSWORD_EXPIRE` = 'Fri Aug 25 19:36:00 CST 2017' , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` = 1 
        AND t.`VERSION` = 2
方式一：参数为：arrays：
UPDATE t_user t
        SET 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` in
           
            1
         , 
            2
方式一：参数为：list：
UPDATE t_user t
        SET 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` in
           
            1
         , 
            2
方式二：参数为：@Param：
SELECT COUNT(t.`ID`) FROM t_user t 
        WHERE t.`MOBILE` = '13800138000'
          
            AND t.`USER_ID` != '1'
方式二：参数为：无参：
SELECT COUNT(t.`ID`) FROM t_user t 
        WHERE t.`MOBILE` = 'null'
方式二：参数为：entity：
UPDATE t_user t 
        SET 
        t.`PASSWORD` = 'sdflkjsldjf' , 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`PASSWORD_MODIFY_TIME` = CURRENT_TIMESTAMP , 
        t.`PASSWORD_EXPIRE` = 'Fri Aug 25 19:36:00 CST 2017' , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` = 1 
        AND t.`VERSION` = 2
方式二：参数为：arrays：
UPDATE t_user t
        SET 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` in
           
            1
         , 
            2
方式二：参数为：list：
UPDATE t_user t
        SET 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` in
           
            1
         , 
            2
方式三：参数为：@Param：
SELECT COUNT(t.`ID`) FROM t_user t 
        WHERE t.`MOBILE` = '13800138000'
          
            AND t.`USER_ID` != '1'
方式三：参数为：无参：
SELECT COUNT(t.`ID`) FROM t_user t 
        WHERE t.`MOBILE` = 'null'
方式三：参数为：entity：
UPDATE t_user t 
        SET 
        t.`PASSWORD` = 'sdflkjsldjf' , 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`PASSWORD_MODIFY_TIME` = CURRENT_TIMESTAMP , 
        t.`PASSWORD_EXPIRE` = 'Fri Aug 25 19:36:00 CST 2017' , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` = 1 
        AND t.`VERSION` = 2
方式三：参数为：arrays：
UPDATE t_user t
        SET 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` in
           
            1
         , 
            2
方式三：参数为：list：
UPDATE t_user t
        SET 
        t.`LAST_UPDATE_TIME` = CURRENT_TIMESTAMP , 
        t.`VERSION` = t.`VERSION` + 1 
        WHERE 
        t.`USER_ID` in
           
            1
         , 
            2
</code></pre>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/20-mybatis-sqlhelper/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/19-jms-ucm/">JMS实现参数的集中式管理</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-09-05T17:12:36.000&#43;00:00' itemprop="datePublished">2017-09-05</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/jms">JMS</a>

<a href="https://ningyu1.github.io/site/tags/ucm">UCM</a>


</div>
    </div>
        

<h1 id="点评">点评</h1>

<p>虽然现在开源的UCM套件很多，UCM统一配置管理（百度的disconf、阿里的diamond、点评的lion，等很多开源的）。但是很多人是知其然不知其所以然，刚好发现下面这篇文章可以作为原理的教程文章，使用JMS、Redis、Zookeeper简单的实现UCM基本功能，作为学习交流还是很不错的。</p>

<p>文章转自：<a href="https://my.oschina.net/OutOfMemory/blog/1510101">https://my.oschina.net/OutOfMemory/blog/1510101</a>
作者：@ksfzhaohui</p>

<h2 id="前言">前言</h2>

<p>JMS的发布订阅机制也能实现类似的功能，集群节点通过订阅指定的节点，同时使用JMS对消息的过滤器功能，实现对指定参数的更新，本文将介绍通过JMS实现简单的参数集中式管理。</p>

<h2 id="maven引入">Maven引入</h2>

<p>Spring相关的jar引入参考上一篇文章</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;javax.jms&lt;/groupId&gt;
    &lt;artifactId&gt;jms&lt;/artifactId&gt;
    &lt;version&gt;1.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;
    &lt;artifactId&gt;activemq-all&lt;/artifactId&gt;
    &lt;version&gt;5.10.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h2 id="目标">目标</h2>

<ol>
<li>可以同时配置监听多个节点如/app1,/app2；</li>
<li>希望只需要配置如/app1，就能够监听其子节点如/app1/modual1以及子节点的子节点如/app1/modual1/xxx/…；</li>
<li>服务器启动能获取当前指定父节点下的所有子节点数据；</li>
<li>在添加节点或者在更新节点数据的时候能够动态通知，这样代码中就能够实时获取最新的数据；</li>
<li>spring配置中可以从Zookeeper中读取参数进行初始化。</li>
</ol>

<p>虽然在实现的方式上有点区别，但是最终达成的目标是一致的，同样列出了这5条目标</p>

<h2 id="实现">实现</h2>

<p>MQWatcher主要用来和JMS建立连接，同时订阅指定节点，建立点对点连接，过滤出需要监听的数据，更新数据，初始化数据，存储数据等
InitConfServer主要作为点对点连接的服务器端用来初始化数据</p>

<p>1.同时配置监听多个节点
提供一个字符串数组给用户用来添加需要监听的节点：</p>

<pre><code class="language-java">private String[] keyPatterns;
</code></pre>

<p>2.能够监听其子节点以及子节点的子节点
使用了一种和Zookeeper不一样的方式，JMS的方式是将所有的数据变更都发送到订阅者，然后订阅者通过过滤出需要的数据进行更新</p>

<pre><code class="language-java">/** MQ的过滤器 **/
private StringBuffer keyFilter = new StringBuffer();
 
private final String TOPIC = &quot;dynamicConfTopic&quot;;
 
private void watcherPaths() throws JMSException {
    Topic topic = session.createTopic(TOPIC);
    MessageConsumer consumer = session.createConsumer(topic, keyFilter.toString());
    consumer.setMessageListener(new MessageListener() {
 
        @Override
        public void onMessage(Message message) {
            try {
                String key = message.getStringProperty(IDENTIFIER);
                TextMessage tm = (TextMessage) message;
                keyValueMap.put(key, tm.getText());
                LOGGER.info(&quot;key = &quot; + key + &quot;,value = &quot; + tm.getText());
            } catch (JMSException e) {
                LOGGER.error(&quot;onMessage error&quot;, e);
            }
        }
    });
}
</code></pre>

<p>对TOPIC进行了订阅，并且指定了过滤器keyFilter，keyFilter正是基于keyPatterns组装而成的</p>

<pre><code class="language-java">private final String IDENTIFIER = &quot;confKey&quot;;
 
/**
* 生成接受过滤器
*/
private void generateKeyFilter() {
    for (int i = 0; i &lt; keyPatterns.length; i++) {
        keyFilter.append(IDENTIFIER + &quot; LIKE '&quot; + keyPatterns[i] + &quot;%'&quot;);
        if (i &lt; keyPatterns.length - 1) {
            keyFilter.append(&quot; OR &quot;);
        }
    }
    LOGGER.info(&quot;keyFilter : &quot; + keyFilter.toString());
}
</code></pre>

<p>对指定的属性IDENTIFIER，通过LIKE和OR关键字进行过滤</p>

<p>3.服务器启动初始化节点数据
通过点对点的方式，在服务器启动时通过请求响应模式来获取初始化数据</p>

<pre><code class="language-java">private final String QUEUE = &quot;dynamicConfQueue&quot;;
 
/**
 * 初始化key-value值
 * 
 * @throws JMSException
 */
private void initKeyValues() throws JMSException {
    TemporaryQueue responseQueue = null;
    MessageProducer producer = null;
    MessageConsumer consumer = null;
    Queue queue = queueSession.createQueue(QUEUE);
 
    TextMessage requestMessage = queueSession.createTextMessage();
    requestMessage.setText(generateKeyString());
    responseQueue = queueSession.createTemporaryQueue();
    producer = queueSession.createProducer(queue);
    consumer = queueSession.createConsumer(responseQueue);
    requestMessage.setJMSReplyTo(responseQueue);
    producer.send(requestMessage);
 
    MapMessage receiveMap = (MapMessage) consumer.receive();
    @SuppressWarnings(&quot;unchecked&quot;)
    Enumeration&lt;String&gt; mapNames = receiveMap.getPropertyNames();
    while (mapNames.hasMoreElements()) {
        String key = mapNames.nextElement();
        String value = receiveMap.getStringProperty(key);
        keyValueMap.put(key, value);
        LOGGER.info(&quot;init key = &quot; + key + &quot;,value = &quot; + value);
    }
}
</code></pre>

<p>通过对指定QUEUE请求，同时建立一个临时的响应QUEUE，然后接受一个MapMessage，用来初始化keyValueMap</p>

<p>4.监听节点数据的变更
通过发布订阅模式，接受所有数据，然后进行过滤，目标2中已经有相关实现</p>

<p>5.spring配置中可以从Zookeeper中读取参数进行初始化</p>

<pre><code class="language-java">public class MQPropPlaceholderConfigurer extends PropertyPlaceholderConfigurer {
 
    private MQWatcher mqwatcher;
 
    @Override
    protected Properties mergeProperties() throws IOException {
        return loadPropFromMQ(super.mergeProperties());
    }
 
    /**
     * 从MQ中加载配置的常量
     * 
     * @param result
     * @return
     */
    private Properties loadPropFromMQ(Properties result) {
        mqwatcher.watcherKeys();
        mqwatcher.fillProperties(result);
        return result;
    }
}
</code></pre>

<p>通过以上的处理，可以使用如下简单的配置来达到目标：</p>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;
    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;
    xsi:schemaLocation=&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;&gt;
    &lt;bean id=&quot;person&quot; class=&quot;zh.maven.DynamicConf.Person&quot;&gt;
        &lt;property name=&quot;name&quot;&gt;
            &lt;value&gt;${/a2/m1}&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;address&quot;&gt;
            &lt;value&gt;${/a3/m1/v2}&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;company&quot;&gt;
            &lt;value&gt;${/a3/m1/v2/t2}&lt;/value&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean id=&quot;mqwatcher&quot; class=&quot;zh.maven.DynamicConf.mq.MQWatcher&quot;&gt;
        &lt;property name=&quot;keyPatterns&quot; value=&quot;/a2,/a3&quot; /&gt;
    &lt;/bean&gt;
    &lt;bean id=&quot;propertyConfigurer&quot; class=&quot;zh.maven.DynamicConf.mq.MQPropPlaceholderConfigurer&quot;&gt;
        &lt;property name=&quot;mqwatcher&quot; ref=&quot;mqwatcher&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<h2 id="测试">测试</h2>

<p>1.启动ActiveMQ</p>

<pre><code>activemq.bat
</code></pre>

<p>2.InitConfServer启动
用来监听集群节点的初始化请求，获取到集群节点发送来的keyPatterns，然后将符合其模式的数据封装成MapMessage发送给集群节点</p>

<pre><code class="language-java">@Override
public void onMessage(Message message) {
    try {
        TextMessage receiveMessage = (TextMessage) message;
        String keys = receiveMessage.getText();
        LOGGER.info(&quot;keys = &quot; + keys);
        MapMessage returnMess = session.createMapMessage();
        returnMess.setStringProperty(&quot;/a2/m1&quot;, &quot;zhaohui&quot;);
        returnMess.setStringProperty(&quot;/a3/m1/v2&quot;, &quot;nanjing&quot;);
        returnMess.setStringProperty(&quot;/a3/m1/v2/t2&quot;, &quot;zhaohui&quot;);
 
        QueueSender sender = session.createSender((Queue) message.getJMSReplyTo());
        sender.send(returnMess);
    } catch (Exception e) {
        LOGGER.error(&quot;onMessage error&quot;, e);
    }
}
</code></pre>

<p>以上代码只是进行了简单的模拟，提供了一个思路</p>

<p>3.启动Main类</p>

<pre><code class="language-java">public class Main {
 
    public static void main(String[] args) throws Exception {
        ApplicationContext context = new ClassPathXmlApplicationContext(new String[] { &quot;spring-config.xml&quot; });
        Person person = (Person) context.getBean(&quot;person&quot;);
        System.out.println(person.toString());
        }
}
</code></pre>

<p>4.启动TopicPublisher
定时发布数据，同时查看集群节点的Main类日志输出</p>

<pre><code class="language-java">public class TopicPublisher {
    private static final String TOPIC = &quot;dynamicConfTopic&quot;;
    private static final String IDENTIFIER = &quot;confKey&quot;;
 
    public static void main(String[] args) throws JMSException {
        ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory(&quot;tcp://localhost:61616&quot;);
        Connection connection = factory.createConnection();
        connection.start();
 
        Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);
        Topic topic = session.createTopic(TOPIC);
 
        MessageProducer producer = session.createProducer(topic);
        producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);
 
        int i=1;
        while (true) {
            TextMessage message = session.createTextMessage();
            message.setStringProperty(IDENTIFIER, &quot;/a2/&quot;+i);
            message.setText(&quot;message_&quot; + System.currentTimeMillis());
            producer.send(message);
            System.out.println(&quot;Sent message: &quot; + message.getText());
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            i++;
        }
    }
}
</code></pre>

<p>日志输出如下：</p>

<pre><code class="language-log">2017-08-14 21:52:23 - keyFilter : confKey LIKE '/a2%' OR confKey LIKE '/a3%'
2017-08-14 21:52:24 - init key = /a3/m1/v2/t2,value = zhaohui
2017-08-14 21:52:24 - init key = /a3/m1/v2,value = nanjing
2017-08-14 21:52:24 - init key = /a2/m1,value = zhaohui
2017-08-14 21:52:24 - Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@223dd567: defining beans [person,mqwatcher,propertyConfigurer]; root of factory hierarchy
name = zhaohui,address = nanjing,company = zhaohui
2017-08-14 21:52:33 - key = /a2/1,value = message_1502718753819
2017-08-14 21:52:35 - key = /a2/2,value = message_1502718755832
2017-08-14 21:52:37 - key = /a2/3,value = message_1502718757846
2017-08-14 21:52:39 - key = /a2/4,value = message_1502718759860
2017-08-14 21:52:41 - key = /a2/5,value = message_1502718761876
</code></pre>

<h2 id="总结">总结</h2>

<p>通过JMS实现了一个简单的参数化平台系统，当然想在生产中使用还有很多需要优化的地方，本文在于提供一个思路；后续有时间准备对DynamicConf提供更加完善的方案。</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/19-jms-ucm/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/18-zookeeper-ucm/">Zookeeper实现参数的集中式管理</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-09-05T17:07:36.000&#43;00:00' itemprop="datePublished">2017-09-05</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/zookeeper">Zookeeper</a>

<a href="https://ningyu1.github.io/site/tags/ucm">UCM</a>


</div>
    </div>
        

<h1 id="点评">点评</h1>

<p>虽然现在开源的UCM套件很多，UCM统一配置管理（百度的disconf、阿里的diamond、点评的lion，等很多开源的）。但是很多人是知其然不知其所以然，刚好发现下面这篇文章可以作为原理的教程文章，使用JMS、Redis、Zookeeper简单的实现UCM基本功能，作为学习交流还是很不错的。</p>

<p>文章转自：<a href="https://my.oschina.net/OutOfMemory/blog/1503392">https://my.oschina.net/OutOfMemory/blog/1503392</a>
作者：@ksfzhaohui</p>

<h2 id="前言">前言</h2>

<p>应用项目中都会有一些参数，一般的做法通常可以选择将其存储在本地配置文件或者内存变量中；对于集群机器规模不大、配置变更不是特别频繁的情况下，这两种方式都能很好的解决；但是一旦集群机器规模变大，且配置信息越来越频繁，依靠这两种方式就越来越困难；我们希望能够快速的做到全局参数的变更，因此需要一种参数的集中式管理，下面利用Zookeeper的一些特性来实现简单的参数管理。</p>

<h2 id="准备">准备</h2>

<pre><code>jdk:1.7.0_80
zookeeper:3.4.3
curator:2.6.0
spring:3.1.2
</code></pre>

<h2 id="maven引入">Maven引入</h2>

<p>Spring相关的jar引入参考上一篇文章</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-core&lt;/artifactId&gt;
    &lt;version&gt;3.1.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
    &lt;version&gt;3.1.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;
    &lt;version&gt;3.1.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.zookeeper&lt;/groupId&gt;
    &lt;artifactId&gt;zookeeper&lt;/artifactId&gt;
    &lt;version&gt;3.4.3&lt;/version&gt;
    &lt;exclusions&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;com.sun.jmx&lt;/groupId&gt;
            &lt;artifactId&gt;jmxri&lt;/artifactId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;com.sun.jdmk&lt;/groupId&gt;
            &lt;artifactId&gt;jmxtools&lt;/artifactId&gt;
        &lt;/exclusion&gt;
        &lt;exclusion&gt;
            &lt;groupId&gt;javax.jms&lt;/groupId&gt;
            &lt;artifactId&gt;jms&lt;/artifactId&gt;
        &lt;/exclusion&gt;
    &lt;/exclusions&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
    &lt;artifactId&gt;curator-framework&lt;/artifactId&gt;
    &lt;version&gt;2.6.0&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.curator&lt;/groupId&gt;
    &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt;
    &lt;version&gt;2.6.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h2 id="目标">目标</h2>

<ol>
<li>可以同时配置监听多个节点如/app1,/app2；</li>
<li>希望只需要配置如/app1，就能够监听其子节点如/app1/modual1以及子节点的子节点如/app1/modual1/xxx/…；</li>
<li>服务器启动能获取当前指定父节点下的所有子节点数据；</li>
<li>在添加节点或者在更新节点数据的时候能够动态通知，这样代码中就能够实时获取最新的数据；</li>
<li>spring配置中可以从Zookeeper中读取参数进行初始化。</li>
</ol>

<h2 id="实现">实现</h2>

<p>提供ZKWatcher类主要用来和Zookeeper建立连接，监听节点，初始化节点数据，更新节点数据，存储节点数据等</p>

<p>1.同时配置监听多个节点
提供一个字符串数组给用户用来添加需要监听的节点：</p>

<pre><code class="language-java">private String[] keyPatterns;
</code></pre>

<p>2.能够监听其子节点以及子节点的子节点
使用递归的方式用来获取指定监听节点的子节点：</p>

<pre><code class="language-java">private List&lt;String&gt; listChildren(String path) throws Exception {
    List&lt;String&gt; pathList = new ArrayList&lt;String&gt;();
    pathList.add(path);
    List&lt;String&gt; list = client.getChildren().forPath(path);
    if (list != null &amp;&amp; list.size() &gt; 0) {
        for (String cPath : list) {
            String temp = &quot;&quot;;
            if (&quot;/&quot;.equals(path)) {
                temp = path + cPath;
            } else {
                temp = path + &quot;/&quot; + cPath;
            }
            pathList.addAll(listChildren(temp));
        }
    }
    return pathList;
}
</code></pre>

<p>3.服务器启动初始化节点数据
上面已经递归获取了所有的节点，所有可以遍历获取所有节点数据，并且存储在Map中：</p>

<pre><code class="language-java">private Map&lt;String, String&gt; keyValueMap = new ConcurrentHashMap&lt;String, String&gt;();
 
if (pathList != null &amp;&amp; pathList.size() &gt; 0) {
    for (String path : pathList) {
        keyValueMap.put(path, readPath(path));
        watcherPath(path);
    }
}
 
private String readPath(String path) throws Exception {
    byte[] buffer = client.getData().forPath(path);
    String value = new String(buffer);
    logger.info(&quot;readPath:path = &quot; + path + &quot;,value = &quot; + value);
    return value;
}
</code></pre>

<p>4.监听节点数据的变更
使用PathChildrenCache用来监听子节点的CHILD_ADDED，CHILD_UPDATED，CHILD_REMOVED事件：</p>

<pre><code class="language-java">private void watcherPath(String path) {
    PathChildrenCache cache = null;
    try {
        cache = new PathChildrenCache(client, path, true);
        cache.start(StartMode.POST_INITIALIZED_EVENT);
        cache.getListenable().addListener(new PathChildrenCacheListener() {
 
            @Override
            public void childEvent(CuratorFramework client, PathChildrenCacheEvent event) throws Exception {
                switch (event.getType()) {
                case CHILD_ADDED:
                    logger.info(&quot;CHILD_ADDED,&quot; + event.getData().getPath());
                    watcherPath(event.getData().getPath());
                    keyValueMap.put(event.getData().getPath(), new String(event.getData().getData()));
                    break;
                case CHILD_UPDATED:
                    logger.info(&quot;CHILD_UPDATED,&quot; + event.getData().getPath());
                    keyValueMap.put(event.getData().getPath(), new String(event.getData().getData()));
                    break;
                case CHILD_REMOVED:
                    logger.info(&quot;CHILD_REMOVED,&quot; + event.getData().getPath());
                    break;
                default:
                    break;
                }
            }
        });
    } catch (Exception e) {
        if (cache != null) {
            try {
                cache.close();
            } catch (IOException e1) {
            }
        }
        logger.error(&quot;watch path error&quot;, e);
    }
}
</code></pre>

<p>5.spring配置中可以从Zookeeper中读取参数进行初始化
实现自定义的PropertyPlaceholderConfigurer类ZKPropPlaceholderConfigurer：</p>

<pre><code class="language-java">public class ZKPropPlaceholderConfigurer extends PropertyPlaceholderConfigurer {
 
    private ZKWatcher zkwatcher;
 
    @Override
    protected Properties mergeProperties() throws IOException {
        return loadPropFromZK(super.mergeProperties());
    }
 
    /**
     * 从zk中加载配置的常量
     * 
     * @param result
     * @return
     */
    private Properties loadPropFromZK(Properties result) {
        zkwatcher.watcherKeys();
        zkwatcher.fillProperties(result);
        return result;
    }
    ......
}
</code></pre>

<p>通过以上的处理，可以使用如下简单的配置来达到目标：</p>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;
    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;
    xsi:schemaLocation=&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;&gt;
 
    &lt;bean id=&quot;zkwatcher&quot; class=&quot;zh.maven.DynamicConf.ZKWatcher&quot;&gt;
        &lt;property name=&quot;keyPatterns&quot; value=&quot;/a2,/a3/m1&quot; /&gt;
    &lt;/bean&gt;
 
    &lt;bean id=&quot;propertyConfigurer&quot; class=&quot;zh.maven.DynamicConf.ZKPropPlaceholderConfigurer&quot;&gt;
        &lt;property name=&quot;zkwatcher&quot; ref=&quot;zkwatcher&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;
 
    &lt;bean id=&quot;person&quot; class=&quot;zh.maven.DynamicConf.Person&quot;&gt;
        &lt;property name=&quot;name&quot;&gt;
            &lt;value&gt;${/a2/m1}&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;address&quot;&gt;
            &lt;value&gt;${/a3/m1/v2}&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;company&quot;&gt;
            &lt;value&gt;${/a3/m1/v2/t2}&lt;/value&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<h2 id="测试">测试</h2>

<p>1.首先启动Zookeeper</p>

<pre><code>zkServer.cmd
</code></pre>

<p>2.初始化需要使用的节点</p>

<pre><code class="language-java">public class Create_Node {
 
    static String path = &quot;/a3/m1/v2/t2&quot;;
    static CuratorFramework client = CuratorFrameworkFactory.builder()
            .connectString(&quot;127.0.0.1:2181&quot;).sessionTimeoutMs(5000)
            .retryPolicy(new ExponentialBackoffRetry(1000, 3)).build();
 
    public static void main(String[] args) throws Exception {
        client.start();
        client.create().creatingParentsIfNeeded()
                .withMode(CreateMode.PERSISTENT)
                .forPath(path, &quot;init&quot;.getBytes());
    }
}
</code></pre>

<p>创建需要的节点方便ZKWatcher来监听，这里根据以上的配置，分别初始化/a3/m1/v2/t2和/a2/m1/v1/t1</p>

<p>3.启动Main，分别验证配置文件中的初始化以及代码动态获取参数</p>

<pre><code class="language-java">public class Main {
 
    public static void main(String[] args) throws Exception {
        ApplicationContext context = new ClassPathXmlApplicationContext(new String[] { &quot;spring-config.xml&quot; });
        Person person = (Person) context.getBean(&quot;person&quot;);
        System.out.println(person.toString());
 
        ZKWatcher zkwatcher = (ZKWatcher) context.getBean(&quot;zkwatcher&quot;);
        while (true) {
            Person p = new Person(zkwatcher.getKeyValue(&quot;/a2/m1&quot;), zkwatcher.getKeyValue(&quot;/a3/m1/v2&quot;),
                    zkwatcher.getKeyValue(&quot;/a3/m1/v2/t2&quot;));
            System.out.println(p.toString());
 
            Thread.sleep(1000);
        }
    }
}
</code></pre>

<p>4.观察日志同时更新参数：</p>

<pre><code class="language-java">public class Set_Data {
 
    static String path = &quot;/a3/m1/v2/t2&quot;;
    static CuratorFramework client = CuratorFrameworkFactory.builder().connectString(&quot;127.0.0.1:2181&quot;)
            .sessionTimeoutMs(5000).retryPolicy(new ExponentialBackoffRetry(1000, 3)).build();
 
    public static void main(String[] args) throws Exception {
        client.start();
        Stat stat = new Stat();
        System.out.println(stat.getVersion());
        System.out.println(&quot;Success set node for :&quot; + path + &quot;,new version:&quot;
                + client.setData().forPath(path, &quot;codingo_v2&quot;.getBytes()).getVersion());
    }
}
</code></pre>

<p>部分日志如下：</p>

<pre><code class="language-log">2017-08-05 18:04:57 - watcher path : [/a2, /a2/m1, /a2/m1/v1, /a2/m1/v1/t2, /a3/m1, /a3/m1/v2, /a3/m1/v2/t2]
2017-08-05 18:04:57 - readPath:path = /a2,value = 
2017-08-05 18:04:57 - readPath:path = /a2/m1,value = zhaohui
2017-08-05 18:04:57 - readPath:path = /a2/m1/v1,value = 
2017-08-05 18:04:57 - readPath:path = /a2/m1/v1/t2,value = init
2017-08-05 18:04:57 - readPath:path = /a3/m1,value = 
2017-08-05 18:04:57 - readPath:path = /a3/m1/v2,value = nanjing
2017-08-05 18:04:57 - readPath:path = /a3/m1/v2/t2,value = codingo_v10
2017-08-05 18:04:57 - Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@182f4aea: defining beans [zkwatcher,propertyConfigurer,person]; root of factory hierarchy
name = zhaohui,address = nanjing,company = codingo_v10
name = zhaohui,address = nanjing,company = codingo_v10
2017-08-05 18:04:57 - CHILD_ADDED,/a2/m1
2017-08-05 18:04:57 - CHILD_ADDED,/a3/m1/v2
2017-08-05 18:04:57 - CHILD_ADDED,/a2/m1/v1
2017-08-05 18:04:57 - CHILD_ADDED,/a2/m1/v1/t2
2017-08-05 18:04:57 - CHILD_ADDED,/a3/m1/v2/t2
name = zhaohui,address = nanjing,company = codingo_v10
name = zhaohui,address = nanjing,company = codingo_v10
name = zhaohui,address = nanjing,company = codingo_v10
2017-08-05 18:05:04 - CHILD_UPDATED,/a3/m1/v2/t2
name = zhaohui,address = nanjing,company = codingo_v11
name = zhaohui,address = nanjing,company = codingo_v11
</code></pre>

<h2 id="总结">总结</h2>

<p>通过Zookeeper实现了一个简单的参数化平台，当然想在生产中使用还有很多需要优化的地方，本文在于提供一个思路；当然除了Zookeeper还可以使用MQ，分布式缓存等来实现参数化平台。</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/18-zookeeper-ucm/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/17-redis-ucm/">[转]Redis实现参数的集中式管理</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-09-05T16:40:36.000&#43;00:00' itemprop="datePublished">2017-09-05</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/redis">Redis</a>

<a href="https://ningyu1.github.io/site/tags/ucm">UCM</a>


</div>
    </div>
        

<h1 id="点评">点评</h1>

<p>虽然现在开源的UCM套件很多，UCM统一配置管理（百度的disconf、阿里的diamond、点评的lion，等很多开源的）。但是很多人是知其然不知其所以然，刚好发现下面这篇文章可以作为原理的教程文章，使用JMS、Redis、Zookeeper简单的实现UCM基本功能，作为学习交流还是很不错的。</p>

<p>文章转自：<a href="https://my.oschina.net/OutOfMemory/blog/1526063">https://my.oschina.net/OutOfMemory/blog/1526063</a>
作者：@ksfzhaohui</p>

<h2 id="前言">前言</h2>

<p>利用的Redis的发布订阅功能实现对参数的集中式管理；分布式缓存Redis提供了类似的发布订阅功能，并且Redis本身提供了缓存和持久化的功能，本文将介绍通过Redis实现简单的参数集中式管理。</p>

<h2 id="maven引入">Maven引入</h2>

<p>Spring相关的jar引入参考上一篇文章</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;redis.clients&lt;/groupId&gt;
    &lt;artifactId&gt;jedis&lt;/artifactId&gt;
    &lt;version&gt;2.4.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<h2 id="目标">目标</h2>

<ol>
<li>可以同时配置监听多个节点如/app1,/app2；</li>
<li>希望只需要配置如/app1，就能够监听其子节点如/app1/modual1以及子节点的子节点如/app1/modual1/xxx/…；</li>
<li>服务器启动能获取当前指定父节点下的所有子节点数据；</li>
<li>在添加节点或者在更新节点数据的时候能够动态通知，这样代码中就能够实时获取最新的数据；</li>
<li>spring配置中可以从Zookeeper中读取参数进行初始化。</li>
</ol>

<p>虽然在实现的方式上有点区别，但是最终达成的目标是一致的，同样列出了这5条目标</p>

<h2 id="实现">实现</h2>

<p>RedisWatcher主要用来和Redis进行连接，然后对监听的节点进行初始化，模糊订阅需要监听的节点，最后接受数据的变更，更新本地数据，存储数据等。</p>

<p>1.同时配置监听多个节点
提供一个字符串数组给用户用来添加需要监听的节点：</p>

<pre><code class="language-java">private String[] keyPatterns;
</code></pre>

<p>2.能够监听其子节点以及子节点的子节点
使用Redis提供的psubscribe命令，订阅一个或多个符合给定模式的频道，提供了模糊订阅的功能</p>

<pre><code class="language-java">private void watcherPaths() {
    new Thread(new Runnable() {
 
        @Override
        public void run() {
            jedis.psubscribe(new JedisPubSub() {
 
                @Override
                public void onMessage(String channel, String message) {
                    try {
                        keyValueMap.put(channel, message);
                        LOGGER.info(&quot;key = &quot; + channel + &quot;,value = &quot; + message);
                    } catch (Exception e) {
                        LOGGER.error(&quot;onMessage error&quot;, e);
                    }
                }
 
                @Override
                public void onPMessage(String arg0, String arg1, String arg2) {
                    System.out.println(&quot;onPMessage=&gt;&quot; + arg0 + &quot;=&quot; + arg1 + &quot;=&quot;
                            + arg2);
                }
 
                @Override
                public void onPSubscribe(String pattern, int subscribedChannels) {
                    LOGGER.info(&quot;onPSubscribe=&gt;&quot; + pattern + &quot;=&quot; + subscribedChannels);
                }
 
                @Override
                public void onPUnsubscribe(String arg0, int arg1) {
                }
 
                @Override
                public void onSubscribe(String arg0, int arg1) {
                }
 
                @Override
                public void onUnsubscribe(String arg0, int arg1) {
                }
            }, getSubKeyPatterns());
        }
    }).start();
}
</code></pre>

<p>3.服务器启动初始化节点数据
通过使用keys命令来获取匹配节点的数据（keys命令可能引发性能问题，根据实际情况使用）</p>

<pre><code class="language-java">private void initKeyValues() {
    for (String keyPattern : keyPatterns) {
        Set&lt;String&gt; keys = jedis.keys(keyPattern + &quot;*&quot;);
        for (String key : keys) {
            String value = jedis.get(key);
            keyValueMap.put(key, value);
            LOGGER.info(&quot;init key = &quot; + key + &quot;,value = &quot; + value);
        }
    }
}
</code></pre>

<p>4.监听节点数据的变更
目标2中通过psubscribe命令，使用模糊订阅来监听数据的变更，onMessage用来接受变更的数据</p>

<p>5.spring配置中可以从Redis中读取参数进行初始化</p>

<pre><code class="language-java">public class RedisPropPlaceholderConfigurer extends PropertyPlaceholderConfigurer {
 
    private RedisWatcher rediswatcher;
 
    @Override
    protected Properties mergeProperties() throws IOException {
        return loadPropFromRedis(super.mergeProperties());
    }
 
    /**
     * 从Redis中加载配置的常量
     * 
     * @param result
     * @return
     */
    private Properties loadPropFromRedis(Properties result) {
        rediswatcher.watcherKeys();
        rediswatcher.fillProperties(result);
        return result;
    }
}
</code></pre>

<p>通过以上的处理，可以使用如下简单的配置来达到目标：</p>

<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot;
    xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;
    xsi:schemaLocation=&quot;http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd&quot;&gt;
    &lt;bean id=&quot;rediswatcher&quot; class=&quot;zh.maven.DynamicConf.redis.RedisWatcher&quot;&gt;
        &lt;property name=&quot;keyPatterns&quot; value=&quot;/a2,/a3&quot; /&gt;
    &lt;/bean&gt;
    &lt;bean id=&quot;propertyConfigurer&quot; class=&quot;zh.maven.DynamicConf.redis.RedisPropPlaceholderConfigurer&quot;&gt;
        &lt;property name=&quot;rediswatcher&quot; ref=&quot;rediswatcher&quot;&gt;&lt;/property&gt;
    &lt;/bean&gt;
    &lt;bean id=&quot;person&quot; class=&quot;zh.maven.DynamicConf.Person&quot;&gt;
        &lt;property name=&quot;name&quot;&gt;
            &lt;value&gt;${/a2/m1}&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;address&quot;&gt;
            &lt;value&gt;${/a3/m1/v2}&lt;/value&gt;
        &lt;/property&gt;
        &lt;property name=&quot;company&quot;&gt;
            &lt;value&gt;${/a3/m1/v2/t2}&lt;/value&gt;
        &lt;/property&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre>

<h2 id="测试">测试</h2>

<p>1.启动Redis服务器</p>

<pre><code>redis-server.exe
</code></pre>

<p>2.启动Redis客户端进行初始化数据</p>

<pre><code>redis-cli.exe
redis 127.0.0.1:6379&gt; set /a2/m1 zhaohui
OK
redis 127.0.0.1:6379&gt; set /a3/m1/v2 nanjing
OK
redis 127.0.0.1:6379&gt; set /a3/m1/v2/t2 codingo
OK
</code></pre>

<p>3.启动Main类</p>

<pre><code class="language-java">public class Main {
  
    public static void main(String[] args) throws Exception {
        ApplicationContext context = new ClassPathXmlApplicationContext(new String[] { &quot;spring-config.xml&quot; });
        Person person = (Person) context.getBean(&quot;person&quot;);
        System.out.println(person.toString());
        }
}
</code></pre>

<p>4.启动RedisPublish
定时发布数据，同时查看集群节点的Main类日志输出</p>

<pre><code class="language-java">public class RedisPublish {
 
    public static void main(String[] args) {
        Jedis jedis = new Jedis(&quot;127.0.0.1&quot;, 6379);
        int i = 0;
        while (true) {
            jedis.publish(&quot;/a2/b4/c1&quot; + i, &quot;message_&quot; + System.currentTimeMillis());
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            i++;
        }
    }
}
</code></pre>

<p>日志输出如下：</p>

<pre><code class="language-log">2017-08-30 10:44:00 - init key = /a2/m1,value = zhaohui
2017-08-30 10:44:00 - init key = /a3/m1/v2,value = nanjing
2017-08-30 10:44:00 - init key = /a3/m1/v2/t2,value = codingo
2017-08-30 10:44:00 - onPSubscribe=&gt;/a2*=1
2017-08-30 10:44:00 - onPSubscribe=&gt;/a3*=2
2017-08-30 10:44:00 - Pre-instantiating singletons in org.springframework.beans.factory.support.DefaultListableBeanFactory@4bad4a49: defining beans [rediswatcher,propertyConfigurer,person]; root of factory hierarchy
name = zhaohui,address = nanjing,company = codingo
onPMessage=&gt;/a2*=/a2/b4/c10=message_1504061045414
onPMessage=&gt;/a2*=/a2/b4/c11=message_1504061047458
onPMessage=&gt;/a2*=/a2/b4/c12=message_1504061049458
onPMessage=&gt;/a2*=/a2/b4/c13=message_1504061051458
</code></pre>

<h2 id="总结">总结</h2>

<p>关于参数的集中式管理一共写了三篇文章，分别利用Zookeeper，MQ以及Redis来实现了一个简单的参数的集中式管理，但更多的只是提供了一个思路
离生产还有很大距离，本片文章也是这个系列的最后一篇，综合来看Zookeeper更加适合做参数的集中式管理平台，MQ方式本身没有提供存储的功能
只能作为一个中间层存在；而Redis方式虽然提供了持久化功能，但是会因为选择不同的持久化方式会出现丢数据的可能，还有就是本身的集群方式
并不是很完善；虽然Zookeeper本身并不是一个存储系统，但是紧紧用来存储少量的参数应该足够了。</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/17-redis-ucm/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/16-spring-transaction/">Spring框架-事务管理注意事项</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-08-26T16:40:36.000&#43;00:00' itemprop="datePublished">2017-08-26</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/spring">Spring</a>

<a href="https://ningyu1.github.io/site/tags/transaction">Transaction</a>


</div>
    </div>
        

<h2 id="常见事务问题">常见事务问题</h2>

<ol>
<li>事务不起作用

<ul>
<li>可能是配置不起效，如扫描问题</li>
</ul></li>
<li>事务自动提交了（批量操作中）

<ul>
<li>可能是在没事务的情况下，利用了数据库的隐式提交</li>
</ul></li>
</ol>

<h2 id="事务配置说明">事务配置说明</h2>

<p>通常情况下我们的<code>Spring Component</code>扫描分为两部分，一部分是<code>Spring Servlet(MVC)</code>，一部分是其他<code>Context Config</code>的内容。主要扫描<code>Annotation</code>定义，包括<code>@Controller</code>、<code>@Autowired</code>、<code>@Resource</code>、<code>@Service</code>、<code>@Component</code>、<code>@Repository</code>等。</p>

<p><code>Spring Servlet</code>部分的扫描配置可以通过<code>web.xml</code>中<code>DispatchServlet</code>的<code>init-param</code>节点配置确定。</p>

<p><code>Context Config</code>部分的扫描配置为非以上配置的其他<code>Spring</code>配置文件确定。</p>

<p>为了能够使用事务，需要防止因<code>Spring Servlet</code>的扫描导致<code>@Service</code>事务配置失效。可以调整<code>DispatchServlet</code>中的配置文件，排除对<code>@Service</code>的扫描。</p>

<p>配置如下：</p>

<pre><code class="language-xml">&lt;context:component-scan base-package=&quot;com.jiuyescm.xxx&quot;&gt;
	&lt;context:exclude-filter type=&quot;annotation&quot; expression=&quot;org.springframework.stereotype.Service&quot; /&gt;
&lt;/context:component-scan&gt;
</code></pre>

<h2 id="如何通过日志判断事务是否已经被spring所管理">如何通过日志判断事务是否已经被Spring所管理？</h2>

<ol>
<li>在logback或者log4j中对org.springframework.aop、org.springframework.transaction、org.springframework.jdbc、org.mybatis.spring.transaction进行DEBUG级别日志跟踪（开发期）</li>

<li><p>查看日志中是否有事务管理、开启、提交、回滚等字符，如：</p>

<pre><code class="language-log">DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@28cfe912] will be managed by Spring
</code></pre></li>

<li><p>没有被控制的时候，日志如下：</p>

<pre><code class="language-log">DEBUG o.m.spring.transaction.SpringManagedTransaction - JDBC Connection [com.alibaba.druid.proxy.jdbc.ConnectionProxyImpl@28cfe912] will not be managed by Spring
</code></pre></li>
</ol>

<h2 id="如何通过程序判断是否存在事务">如何通过程序判断是否存在事务？</h2>

<pre><code class="language-java">boolean flag = TransactionSynchronizationManager.isActualTransactionActive();
</code></pre>

<p>返回true，则在事务控制下，否则不在控制下</p>

<h2 id="什么时候做了隐式提交">什么时候做了隐式提交？</h2>

<p>在没有容器事务的情况下，系统会尝试隐时提交。</p>

<p><img src="https://ningyu1.github.io/site/img/spring-transaction/1.png" alt="spring1" /></p>

<h2 id="开发建议">开发建议：</h2>

<ol>
<li>所有Service代码中设置Class级别的@Transactional，并设置为只读，开发时可以很容易发现误数据库操作的动作。如：@Transactional(readOnly=true)。</li>
<li>所有Service代码中Public的方法设置@Transactional，并根据实际情况设置Propagation，可以设置为REQUIRED。</li>
<li>对于有异常产生可能的情况下，根据情况选择合适的rollbackFor，默认情况下可以设置对Exception.class或BizException.class进行控制。</li>
<li>尽可能减少嵌套的使用方法（Service call Service），采用传统的Controller-》Service-》Repository(DAO)的模型。</li>
</ol>

<p>如果需要深入了解Transaction的流程，请自行翻阅和跟踪Spring和Mybatis相关代码。</p>

<p>以下是嵌套事务的各种情况下的执行结果（前提数据库的AutoCommit为true）</p>

<table>
<thead>
<tr>
<th align="left">编号</th>
<th align="left">External（Service）</th>
<th align="left">Internal（Service）</th>
<th align="left">Result</th>
<th align="left">Memo</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">1</td>
<td align="left">No Transactional</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left">Auto Commit = True</td>
</tr>

<tr>
<td align="left">2</td>
<td align="left">No Transactional</td>
<td align="left">Class Level ReadOnly Transactional</td>
<td align="left">External Committed Internal TransientDataAccessResourceException</td>
<td align="left">Can&rsquo;t update table</td>
</tr>

<tr>
<td align="left">3</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">4</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(REQUIRES_NEW)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">5</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(SUPPORTS)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">6</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(MANDATORY)</td>
<td align="left">External Committed Internal IllegalTransactionStateException</td>
<td align="left">Must under transaction</td>
</tr>

<tr>
<td align="left">7</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(NOT_SUPPORTED)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">8</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(NEVER)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">9</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(NESTED)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">10</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(REQUIRED) rollackFor=Exception.class IOException</td>
<td align="left">External Committed Internal Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">11</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(REQUIRED) rollbackFor=RuntimeException.class IOException</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">12</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollbackFor=Exception.class RuntimeException</td>
<td align="left">External Committed Internal Rollbacked</td>
</tr>

<tr>
<td align="left">13</td>
<td align="left">No Transactional</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollbackFor=RuntimeException.class RuntimeException</td>
<td align="left">External Committed Internal Rollbacked</td>
</tr>

<tr>
<td align="left">14</td>
<td align="left">Class Level ReadOnly Transactional</td>
<td align="left">No Transactional</td>
<td align="left">External TransientDataAccessResourceException</td>
<td align="left">Can&rsquo;t update table</td>
</tr>

<tr>
<td align="left">15</td>
<td align="left">Class Level ReadOnly Transactional</td>
<td align="left">Class Level ReadOnly Transactional</td>
<td align="left">External TransientDataAccessResourceException</td>
<td align="left">Can&rsquo;t update table</td>
</tr>

<tr>
<td align="left">16</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">17</td>
<td align="left">Transactional(REQUIRES_NEW)</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">18</td>
<td align="left">Transactional(SUPPORTS)</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">19</td>
<td align="left">Transactional(MANDATORY)</td>
<td align="left">No Transactional</td>
<td align="left">External IllegalTransactionStateException</td>
<td align="left">Must under transaction</td>
</tr>

<tr>
<td align="left">20</td>
<td align="left">Transactional(NOT_SUPPORTED)</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">21</td>
<td align="left">Transactional(NEVER)</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">22</td>
<td align="left">Transactional(NESTED)</td>
<td align="left">No Transactional</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">23</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">24</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(REQUIRES_NEW)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">25</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(SUPPORTS)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">26</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(MANDATORY)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">27</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(NOT_SUPPORTED)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">28</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(NEVER)</td>
<td align="left">External Rollbacked Internal IllegalTransactionStateException</td>
<td align="left">Must under transaction</td>
</tr>

<tr>
<td align="left">29</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">Transactional(NESTED)</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">30</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Transactional(REQUIRED) rollackFor=Exception.class IOException</td>
<td align="left">All Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">31</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Transactional(REQUIRED) rollbackFor=RuntimeException.class IOException</td>
<td align="left">All Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">32</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=RuntimeException.class Transactional(REQUIRED) rollackFor=Exception.class IOException</td>
<td align="left">All Rollbacked UnexpectedRollbackException</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">33</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=RuntimeException.class Transactional(REQUIRED) rollbackFor=RuntimeException.class IOException</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">34</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Transactional(REQUIRED) rollackFor=Exception.class RuntimeException</td>
<td align="left">All Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">35</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Transactional(REQUIRED) rollbackFor=RuntimeException.class RuntimeException</td>
<td align="left">All Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">36</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=RuntimeException.class Transactional(REQUIRED) rollackFor=Exception.class RuntimeException</td>
<td align="left">All Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">37</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=RuntimeException.class Transactional(REQUIRED) rollbackFor=RuntimeException.class RuntimeException</td>
<td align="left">All Rollbacked</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">38</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Transactional(REQUIRED) rollackFor=Exception.class IOException Catch IOException</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">39</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Catch IOExceptio Transactional(REQUIRED) rollbackFor=Exception.class IOException</td>
<td align="left">All Rollbacked UnexpectedRollbackException</td>
<td align="left"></td>
</tr>

<tr>
<td align="left">40</td>
<td align="left">Transactional(REQUIRED)</td>
<td align="left">rollackFor=Exception.class Catch IOException Transactional(REQUIRED) rollbackFor=RuntimeException.class IOException</td>
<td align="left">All Committed</td>
<td align="left"></td>
</tr>
</tbody>
</table>

<p>其他情况按照事务是否开启和是否抛出（捕获）对应异常来判断结果。</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/16-spring-transaction/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/15-java-npe/">NPE（java.lang.NullPointerException）防范</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-08-26T16:01:36.000&#43;00:00' itemprop="datePublished">2017-08-26</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/npe">NPE</a>

<a href="https://ningyu1.github.io/site/tags/nullpointexception">NullPointException</a>


</div>
    </div>
        

<p>我们程序中NPE还是比较多的，下面介绍良好的编码规范防止NPE的发生</p>

<p>NPE（java.lang.NullPointerException）: 空指针异常</p>

<h2 id="一-推荐-防止-npe-是程序员的基本修养-注意-npe-产生的场景">一、【推荐】防止 NPE，是程序员的基本修养，注意 NPE 产生的场景：</h2>

<p>1） 返回类型为基本数据类型， return 包装数据类型的对象时，自动拆箱有可能产生 NPE。</p>

<p>反例： public int f() { return Integer 对象}， 如果为 null，自动解箱抛 NPE。</p>

<p>2） 数据库的查询结果可能为 null。</p>

<p>3） 集合里的元素即使 isNotEmpty，取出的数据元素也可能为 null。</p>

<p>4） 远程调用返回对象时，一律要求进行空指针判断，防止 NPE。</p>

<p>5） 对于 Session 中获取的数据，建议 NPE 检查，避免空指针。</p>

<p>6） 级联调用 obj.getA().getB().getC()； 一连串调用，易产生 NPE。</p>

<p>正例： 使用 JDK8 的 Optional 类来防止 NPE 问题。</p>

<p>ps.我们现在开发规范jdk版本jdk1.7.0_45，对于jdk8里面的optional可以了解学习，它是一种友好的解决方式。</p>

<h2 id="二-强制-当某一列的值全是-null-时-count-col-的返回结果为-0-但-sum-col-的返回结果为">二、【强制】当某一列的值全是 NULL 时， count(col)的返回结果为 0，但 sum(col)的返回结果为</h2>

<p>NULL，因此使用 sum()时需注意 NPE 问题。</p>

<p>正例： 可以使用如下方式来避免 sum 的 NPE 问题： SELECT IF(ISNULL(SUM(g)),0,SUM(g))</p>

<p>FROM table;</p>

<h2 id="三-推荐-高度注意-map-类集合-k-v-能不能存储-null-值的情况-如下表格">三、【推荐】高度注意 Map 类集合 K/V 能不能存储 null 值的情况，如下表格：</h2>

<table>
<thead>
<tr>
<th align="left">集合类</th>
<th align="left">Key</th>
<th align="left">Value</th>
<th align="left">Super</th>
<th align="left">说明</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Hashtable</td>
<td align="left">不允许为null</td>
<td align="left">不允许为null</td>
<td align="left">Dictionary</td>
<td align="left">线程安全</td>
</tr>

<tr>
<td align="left">ConcurrentHashMap</td>
<td align="left">不允许为null</td>
<td align="left">不允许为null</td>
<td align="left">AbstractMap</td>
<td align="left">分段锁技术</td>
</tr>

<tr>
<td align="left">TreeMap</td>
<td align="left">不允许为null</td>
<td align="left">允许为null</td>
<td align="left">AbstractMap</td>
<td align="left">线程不安全</td>
</tr>

<tr>
<td align="left">HashMap</td>
<td align="left">允许为null</td>
<td align="left">允许为null</td>
<td align="left">AbstractMap</td>
<td align="left">线程不安全</td>
</tr>
</tbody>
</table>

<p>反例： 由于 HashMap 的干扰，很多人认为 ConcurrentHashMap 是可以置入 null 值，而事实上，</p>

<p>存储 null 值时会抛出 NPE 异常。</p>

<h2 id="四-推荐-方法的返回值可以为-null-不强制返回空集合-或者空对象等-必须添加注释充分">四、【推荐】方法的返回值可以为 null，不强制返回空集合，或者空对象等，必须添加注释充分</h2>

<p>说明什么情况下会返回 null 值。调用方需要进行 null 判断防止 NPE 问题。</p>

<p>说明： 明确防止 NPE 是调用者的责任。即使被调用方法返回空集合或者空对象，对调用</p>

<p>者来说，也并非高枕无忧，必须考虑到远程调用失败、 序列化失败、 运行时异常等场景返回</p>

<p>null 的情况。</p>

<h2 id="五-关于基本数据类型与包装数据类型的使用标准如下">五、关于基本数据类型与包装数据类型的使用标准如下：</h2>

<p>1） 【强制】 所有的 POJO 类属性必须使用包装数据类型。</p>

<p>2） 【强制】 RPC 方法的返回值和参数必须使用包装数据类型。</p>

<p>3） 【 推荐】 所有的局部变量使用基本数据类型。</p>

<p>说明： POJO 类属性没有初值是提醒使用者在需要使用时，必须自己显式地进行赋值，任何</p>

<p>NPE 问题，或者入库检查，都由使用者来保证。</p>

<p>正例： 数据库的查询结果可能是 null，因为自动拆箱，用基本数据类型接收有 NPE 风险。</p>

<p><span style="color:blue"><strong><em>以上内容摘自阿里巴巴Java开发手册v1.2.0.pdf</em></strong></span></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/15-java-npe/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/15-java-jvm/">JVM调优总结 -Xms -Xmx -Xmn -Xss</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-08-26T15:56:36.000&#43;00:00' itemprop="datePublished">2017-08-26</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/jvm">JVM</a>

<a href="https://ningyu1.github.io/site/tags/%E8%B0%83%E4%BC%98">调优</a>


</div>
    </div>
        

<h2 id="堆大小设置">堆大小设置</h2>

<p>JVM 中最大堆大小有三方面限制：相关操作系统的数据模型（32-bt还是64-bit）限制；系统的可用虚拟内存限制；系统的可用物理内存限制。32位系统下，一般限制在1.5G~2G；64为操作系统对内存无限制。我在Windows Server 2003 系统，3.5G物理内存，JDK5.0下测试，最大可设置为1478m。</p>

<h2 id="典型设置">典型设置</h2>

<ul>
<li><p>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k
-Xmx3550m：设置JVM最大可用内存为3550M。
-Xms3550m：设置JVM促使内存为3550m。此值可以设置与-Xmx相同，以避免每次垃圾回收完成后JVM重新分配内存。
-Xmn2g：设置年轻代大小为2G。整个JVM内存大小=年轻代大小 + 年老代大小 + 持久代大小。持久代一般固定大小为64m，所以增大年轻代后，将会减小年老代大小。此值对系统性能影响较大，Sun官方推荐配置为整个堆的3/8。
-Xss128k：设置每个线程的堆栈大小。JDK5.0以后每个线程堆栈大小为1M，以前每个线程堆栈大小为256K。更具应用的线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右。</p></li>

<li><p>java -Xmx3550m -Xms3550m -Xss128k -XX:NewRatio=4 -XX:SurvivorRatio=4 -XX:MaxPermSize=16m -XX:MaxTenuringThreshold=0
-XX:NewRatio=4:设置年轻代（包括Eden和两个Survivor区）与年老代的比值（除去持久代）。设置为4，则年轻代与年老代所占比值为1：4，年轻代占整个堆栈的1/5
-XX:SurvivorRatio=4：设置年轻代中Eden区与Survivor区的大小比值。设置为4，则两个Survivor区与一个Eden区的比值为2:4，一个Survivor区占整个年轻代的1/6
-XX:MaxPermSize=16m:设置持久代大小为16m。
-XX:MaxTenuringThreshold=0：设置垃圾最大年龄。如果设置为0的话，则年轻代对象不经过Survivor区，直接进入年老代。对于年老代比较多的应用，可以提高效率。如果将此值设置为一个较大值，则年轻代对象会在Survivor区进行多次复制，这样可以增加对象再年轻代的存活时间，增加在年轻代即被回收的概论。</p></li>
</ul>

<h2 id="回收器选择">回收器选择</h2>

<p>JVM给了三种选择：串行收集器、并行收集器、并发收集器，但是串行收集器只适用于小数据量的情况，所以这里的选择主要针对并行收集器和并发收集器。默认情况下，JDK5.0以前都是使用串行收集器，如果想使用其他收集器需要在启动时加入相应参数。JDK5.0以后，JVM会根据当前<a href="http://java.sun.com/j2se/1.5.0/docs/guide/vm/server-class.html" title="系统配置">系统配置</a>进行判断。</p>

<ul>
<li><p>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:ParallelGCThreads=20 -XX:+UseConcMarkSweepGC -XX:+UseParNewGC
-XX:+UseConcMarkSweepGC：设置年老代为并发收集。测试中配置这个以后，-XX:NewRatio=4的配置失效了，原因不明。所以，此时年轻代大小最好用-Xmn设置。
-XX:+UseParNewGC:设置年轻代为并行收集。可与CMS收集同时使用。JDK5.0以上，JVM会根据系统配置自行设置，所以无需再设置此值。</p></li>

<li><p>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseConcMarkSweepGC -XX:CMSFullGCsBeforeCompaction=5 -XX:+UseCMSCompactAtFullCollection
-XX:CMSFullGCsBeforeCompaction：由于并发收集器不对内存空间进行压缩、整理，所以运行一段时间以后会产生“碎片”，使得运行效率降低。此值设置运行多少次GC以后对内存空间进行压缩、整理。
-XX:+UseCMSCompactAtFullCollection：打开对年老代的压缩。可能会影响性能，但是可以消除碎片</p></li>

<li><p>java -Xmx3800m -Xms3800m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20
-XX:+UseParallelGC：选择垃圾收集器为并行收集器。此配置仅对年轻代有效。即上述配置下，年轻代使用并发收集，而年老代仍旧使用串行收集。
-XX:ParallelGCThreads=20：配置并行收集器的线程数，即：同时多少个线程一起进行垃圾回收。此值最好配置与处理器数目相等。</p></li>

<li><p>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC -XX:ParallelGCThreads=20 -XX:+UseParallelOldGC
-XX:+UseParallelOldGC：配置年老代垃圾收集方式为并行收集。JDK6.0支持对年老代并行收集。</p></li>

<li><p>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC  -XX:MaxGCPauseMillis=100
-XX:MaxGCPauseMillis=100:设置每次年轻代垃圾回收的最长时间，如果无法满足此时间，JVM会自动调整年轻代大小，以满足此值。</p></li>

<li><p>java -Xmx3550m -Xms3550m -Xmn2g -Xss128k -XX:+UseParallelGC  -XX:MaxGCPauseMillis=100 -XX:+UseAdaptiveSizePolicy
-XX:+UseAdaptiveSizePolicy：设置此选项后，并行收集器会自动选择年轻代区大小和相应的Survivor区比例，以达到目标系统规定的最低相应时间或者收集频率等，此值建议使用并行收集器时，一直打开。</p>

<ol>
<li>吞吐量优先的并行收集器
如上文所述，并行收集器主要以到达一定的吞吐量为目标，适用于科学技术和后台处理等。</li>
<li>响应时间优先的并发收集器
如上文所述，并发收集器主要是保证系统的响应时间，减少垃圾收集时的停顿时间。适用于应用服务器、电信领域等。</li>
</ol></li>
</ul>

<h2 id="辅助信息">辅助信息</h2>

<p>JVM提供了大量命令行参数，打印信息，供调试使用。主要有以下一些：</p>

<ul>
<li><p>-XX:+PrintGC
输出形式：</p>

<pre><code class="language-log">[GC 118250K-&gt;113543K(130112K), 0.0094143 secs]
[Full GC 121376K-&gt;10414K(130112K), 0.0650971 secs]
</code></pre></li>

<li><p>-XX:+PrintGCDetails
输出形式：</p>

<pre><code class="language-log">[GC [DefNew: 8614K-&gt;781K(9088K), 0.0123035 secs] 118250K-&gt;113543K(130112K), 0.0124633 secs]
[GC [DefNew: 8614K-&gt;8614K(9088K), 0.0000665 secs][Tenured: 112761K-&gt;10414K(121024K), 0.0433488 secs] 121376K-&gt;10414K(130112K), 0.0436268 secs]
</code></pre></li>

<li><p>-XX:+PrintGCTimeStamps -XX:+PrintGC：PrintGCTimeStamps可与上面两个混合使用
输出形式：</p>

<pre><code class="language-log">[GC 98328K-&gt;93620K(130112K), 0.0082960 secs]
</code></pre></li>

<li><p>-XX:+PrintGCApplicationConcurrentTime:打印每次垃圾回收前，程序未中断的执行时间。可与上面混合使用
输出形式：</p>

<pre><code class="language-log">Application time: 0.5291524 seconds
</code></pre></li>

<li><p>-XX:+PrintGCApplicationStoppedTime：打印垃圾回收期间程序暂停的时间。可与上面混合使用
输出形式：</p>

<pre><code class="language-log">Total time for which application threads were stopped: 0.0468229 seconds
</code></pre></li>

<li><p>-XX:PrintHeapAtGC:打印GC前后的详细堆栈信息
输出形式：</p>

<pre><code class="language-log">[GC {Heap before gc invocations=7:
		 def new generation   total 55296K, used 52568K [0x1ebd0000, 0x227d0000, 0x227d0000)
		eden space 49152K,  99% used [0x1ebd0000, 0x21bce430, 0x21bd0000)
		from space 6144K,  55% used [0x221d0000, 0x22527e10, 0x227d0000)
		  to   space 6144K,   0% used [0x21bd0000, 0x21bd0000, 0x221d0000)
		 tenured generation   total 69632K, used 2696K [0x227d0000, 0x26bd0000, 0x26bd0000)
		the space 69632K,   3% used [0x227d0000, 0x22a720f8, 0x22a72200, 0x26bd0000)
		 compacting perm gen  total 8192K, used 2898K [0x26bd0000, 0x273d0000, 0x2abd0000)
		   the space 8192K,  35% used [0x26bd0000, 0x26ea4ba8, 0x26ea4c00, 0x273d0000)
		    ro space 8192K,  66% used [0x2abd0000, 0x2b12bcc0, 0x2b12be00, 0x2b3d0000)
		    rw space 12288K,  46% used [0x2b3d0000, 0x2b972060, 0x2b972200, 0x2bfd0000)
		34.735: [DefNew: 52568K-&gt;3433K(55296K), 0.0072126 secs] 55264K-&gt;6615K(124928K)Heap after gc invocations=8:
		 def new generation   total 55296K, used 3433K [0x1ebd0000, 0x227d0000, 0x227d0000)
		eden space 49152K,   0% used [0x1ebd0000, 0x1ebd0000, 0x21bd0000)
		  from space 6144K,  55% used [0x21bd0000, 0x21f2a5e8, 0x221d0000)
		  to   space 6144K,   0% used [0x221d0000, 0x221d0000, 0x227d0000)
		 tenured generation   total 69632K, used 3182K [0x227d0000, 0x26bd0000, 0x26bd0000)
		the space 69632K,   4% used [0x227d0000, 0x22aeb958, 0x22aeba00, 0x26bd0000)
		 compacting perm gen  total 8192K, used 2898K [0x26bd0000, 0x273d0000, 0x2abd0000)
		   the space 8192K,  35% used [0x26bd0000, 0x26ea4ba8, 0x26ea4c00, 0x273d0000)
		    ro space 8192K,  66% used [0x2abd0000, 0x2b12bcc0, 0x2b12be00, 0x2b3d0000)
		    rw space 12288K,  46% used [0x2b3d0000, 0x2b972060, 0x2b972200, 0x2bfd0000)
		}
		, 0.0757599 secs]
</code></pre></li>

<li><p>-Xloggc:filename:与上面几个配合使用，把相关日志信息记录到文件以便分析。</p></li>
</ul>

<h2 id="常见配置汇总">常见配置汇总</h2>

<ul>
<li>-XX:+CMSIncrementalMode:设置为增量模式。适用于单CPU情况。</li>
<li>-XX:ParallelGCThreads=n:设置并发收集器年轻代收集方式为并行收集时，使用的CPU数。并行收集线程数。</li>
<li>-XX:ParallelGCThreads=n:设置并行收集器收集时使用的CPU数。并行收集线程数。</li>
<li>-XX:MaxGCPauseMillis=n:设置并行收集最大暂停时间</li>
<li>-XX:GCTimeRatio=n:设置垃圾回收时间占程序运行时间的百分比。公式为1/(1+n)</li>
<li>-XX:+PrintGC</li>
<li>-XX:+PrintGCDetails</li>
<li>-XX:+PrintGCTimeStamps</li>
<li>-Xloggc:filename</li>
<li>-XX: +UseSerialGC:设置串行收集器</li>
<li>-XX: +UseParallelGC:设置并行收集器</li>
<li>-XX: +UseParalledlOldGC:设置并行年老代收集器</li>
<li>-XX: +UseConcMarkSweepGC:设置并发收集器</li>
<li>-Xms:初始堆大小</li>
<li>-Xmx:最大堆大小</li>
<li>-XX:NewSize=n:设置年轻代大小</li>
<li>-XX:NewRatio=n:设置年轻代和年老代的比值。如:为3，表示年轻代与年老代比值为1：3，年轻代占整个年轻代年老代和的1/4</li>
<li>-XX:SurvivorRatio=n:年轻代中Eden区与两个Survivor区的比值。注意Survivor区有两个。如：3，表示Eden：Survivor=3：2，一个Survivor区占整个年轻代的1/5</li>
<li>-XX:MaxPermSize=n:设置持久代大小
a. 堆设置
b. 收集器设置
c. 垃圾回收统计信息
d. 并行收集器设置
f. 并发收集器设置</li>
</ul>

<h2 id="调优总结">调优总结</h2>

<p>年轻代大小选择</p>

<ul>
<li>响应时间优先的应用：尽可能设大，直到接近系统的最低响应时间限制（根据实际情况选择）。在此种情况下，年轻代收集发生的频率也是最小的。同时，减少到达年老代的对象。</li>
<li>吞吐量优先的应用：尽可能的设置大，可能到达Gbit的程度。因为对响应时间没有要求，垃圾收集可以并行进行，一般适合8CPU以上的应用。</li>
<li>年老代大小选择</li>
<li>并发垃圾收集信息</li>
<li>持久代并发收集次数</li>
<li>传统GC信息</li>
<li>花在年轻代和年老代回收上的时间比例</li>
<li>响应时间优先的应用：年老代使用并发收集器，所以其大小需要小心设置，一般要考虑并发会话率和会话持续时间等一些参数。如果堆设置小了，可以会造成内存碎片、高回收频率以及应用暂停而使用传统的标记清除方式；如果堆大了，则需要较长的收集时间。最优化的方案，一般需要参考以下数据获得：减少年轻代和年老代花费的时间，一般会提高应用的效率</li>
<li>吞吐量优先的应用：一般吞吐量优先的应用都有一个很大的年轻代和一个较小的年老代。原因是，这样可以尽可能回收掉大部分短期对象，减少中期的对象，而年老代尽存放长期存活对象。</li>
<li>较小堆引起的碎片问题
因为年老代的并发收集器使用标记、清除算法，所以不会对堆进行压缩。当收集器回收时，他会把相邻的空间进行合并，这样可以分配给较大的对象。但是，当堆空间较小时，运行一段时间以后，就会出现“碎片”，如果并发收集器找不到足够的空间，那么并发收集器将会停止，然后使用传统的标记、清除方式进行回收。如果出现“碎片”，可能需要进行如下配置：</li>
<li>-XX:+UseCMSCompactAtFullCollection：使用并发收集器时，开启对年老代的压缩。</li>
<li>-XX:CMSFullGCsBeforeCompaction=0：上面配置开启的情况下，这里设置多少次Full GC后，对年老代进行压缩</li>
</ul>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/15-java-jvm/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/12-vue-axios/">关于Axios的GET与DELETE用法注意事项</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-08-24T10:51:30.000&#43;00:00' itemprop="datePublished">2017-08-24</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/vue.js">Vue.js</a>

<a href="https://ningyu1.github.io/site/tags/axios">Axios</a>


</div>
    </div>
        

<h2 id="axios的接口定义如下">axios的接口定义如下</h2>

<p><img src="https://ningyu1.github.io/site/img/vue-axios/1.png" alt="vue1" /></p>

<h2 id="config定义如下">config定义如下：</h2>

<p><img src="https://ningyu1.github.io/site/img/vue-axios/2.png" alt="vue2" /></p>

<p>因此，我们在使用get和delete时需要注意，这两个接口接收的第二个参数是config。用时，就需要区别对待，且需要与后台定义对应。</p>

<ol>
<li>如果想参数在Query Parameter里面，那就用{params: params}，后台那边会用RequestParam接收</li>
<li>如果想参数在Payload里面，那就用{data: params}，后台那边会用RequestBody接收</li>
</ol>

<p>如果后台不匹配，可能会抛ContentType错误的异常，如：</p>

<p><img src="https://ningyu1.github.io/site/img/vue-axios/3.png" alt="vue3" /></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/12-vue-axios/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/11-redis-aof-pit/">Trouble Shooting —— Redis AOF rewrite错误导致Redis被Block住</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-08-15T10:30:34.000&#43;00:00' itemprop="datePublished">2017-08-15</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/redis">Redis</a>

<a href="https://ningyu1.github.io/site/tags/aof-rewriting">AOF rewriting</a>

<a href="https://ningyu1.github.io/site/tags/aof">AOF</a>

<a href="https://ningyu1.github.io/site/tags/connnection-reset-by-peer">Connnection reset by peer</a>

<a href="https://ningyu1.github.io/site/tags/numerical-result-out-of-range">Numerical result out of range</a>

<a href="https://ningyu1.github.io/site/tags/cannot-allocate-memory">Cannot allocate memory</a>

<a href="https://ningyu1.github.io/site/tags/cant-rewrite-append-only-file-in-background">Can&#39;t rewrite append only file in background</a>

<a href="https://ningyu1.github.io/site/tags/%E8%B0%83%E4%BC%98">调优</a>


</div>
    </div>
        

<h2 id="问题现状">问题现状：</h2>

<p>redis-cli 上去执行任何命令返回：connnection reset by peer</p>

<p>重启的应用无法连接到redis，已经建立连接的应用可以正常使用。</p>

<h2 id="分析过程">分析过程：</h2>

<p>第一反应查看redis 日志，如下：</p>

<pre><code class="language-log">1838:M 16 Aug 01:07:39.319 # Error opening /setting AOF rewrite IPC pipes: Numerical result out of range
1838:M 16 Aug 01:07:39.319 * Starting automatic rewriting of AOF on 110% growth
1838:M 16 Aug 01:07:39.319 # Error opening /setting AOF rewrite IPC pipes: Numerical result out of range
1838:M 16 Aug 01:07:39.419 * Starting automatic rewriting of AOF on 110% growth
1838:M 16 Aug 01:07:39.419 # Error opening /setting AOF rewrite IPC pipes: Numerical result out of range
1838:M 16 Aug 01:07:39.441 # Error registering fd event for the new client: Numerical result out of range (fd=10311)
1838:M 16 Aug 01:07:39.457 # Error registering fd event for the new client: Numerical result out of range (fd=10311)
1838:M 16 Aug 01:07:39.457 # Error registering fd event for the new client: Numerical result out of range (fd=10311)
1838:M 16 Aug 01:07:39.461 # Error registering fd event for the new client: Numerical result out of range (fd=10311)
1838:M 16 Aug 01:07:39.461 # Error registering fd event for the new client: Numerical result out of range (fd=10311)
1838:M 16 Aug 01:07:39.462 # Error registering fd event for the new client: Numerical result out of range (fd=10311)
</code></pre>

<p>上面有两种错误日志</p>

<ul>
<li>Error opening /setting AOF rewrite IPC pipes: Numerical result out of range

<ul>
<li>写aof出错了，超限</li>
</ul></li>
<li>Error registering fd event for the new client: Numerical result out of range (fd=10311)

<ul>
<li>创建连接没有成功，能看到fd已经是10311 过万了</li>
</ul></li>
</ul>

<p>出现这种问题第一个先去看一下redis现在有多少个连接数</p>

<pre><code class="language-bash">&gt;netstat -anp|grep 6379
&gt;499
</code></pre>

<p>查看redis.conf中配置maxclients没有配置，redis默认为10000
这个时候有个疑问？为什么netstat查看的连接数只有499，但是redis日志中已经过万（ fd=10311）？这个问题值得思考？
我们通过查询进程的fd看一下具体打开了多少个连接（在linux中任何连接都是open file）</p>

<pre><code class="language-bash">&gt;ls -al /proc/1838/fd | grep socket | wc -l
&gt;499
 
&gt;ls -al /proc/1838/fd | wc -l
&gt;10322
</code></pre>

<p>为什么fd中socket的只有499，所有类型的确是10322呢？通过具体查看发现有9823个全都是pipe类型的连接</p>

<pre><code class="language-bash">&gt;ls -al /proc/1838/fd | grep pipe | wc -l
&gt;9823
</code></pre>

<p>为什么redis进程会有那么多pipe的连接呢？
难道是我们redis client使用的pipeline导致的连接泄漏？</p>

<p>于是查看了Jedis的源码</p>

<pre><code>  /**
   * Synchronize pipeline by reading all responses. This operation close the pipeline. In order to
   * get return values from pipelined commands, capture the different Response&amp;lt;?&amp;gt; of the
   * commands you execute.
   */
  public void sync() {
    if (getPipelinedResponseLength() &gt; 0) {
      List&lt;Object&gt; unformatted = client.getAll();
      for (Object o : unformatted) {
        generateResponse(o);
      }
    }
  }
</code></pre>

<p>能看到注释中有描述调用这个方法会操作连接关闭：This operation close the pipeline</p>

<p>又询问了开发的同学我们目前没有使用到pipelined，因此排除了这个可能</p>

<p>那问题来了是什么原因导致的pipe连接过多？</p>

<p>网上兜了一圈没发现有价值的信息，没办法只能去扫redis源码，</p>

<p>accetpCommonHandler函数源码：</p>

<pre><code>static void acceptCommonHandler(int fd, int flags) {  
    redisClient *c;  
    if ((c = createClient(fd)) == NULL) {  
        redisLog(REDIS_WARNING,  
            &quot;Error registering fd event for the new client: %s (fd=%d)&quot;,  
            strerror(errno),fd);  
        close(fd); /* May be already closed, just ignore errors */  
        return;  
    }  
    /* If maxclient directive is set and this is one client more... close the 
     * connection. Note that we create the client instead to check before 
     * for this condition, since now the socket is already set in non-blocking 
     * mode and we can send an error for free using the Kernel I/O */  
    if (listLength(server.clients) &gt; server.maxclients) {  
        char *err = &quot;-ERR max number of clients reached\r\n&quot;;  
   
        /* That's a best effort error message, don't check write errors */  
        if (write(c-&gt;fd,err,strlen(err)) == -1) {  
            /* Nothing to do, Just to avoid the warning... */  
        }  
        server.stat_rejected_conn++;  
        freeClient(c);  
        return;  
    }  
    server.stat_numconnections++;  
    c-&gt;flags |= flags;  
}
</code></pre>

<p>ps.这个函数主要调用createClient初始化客户端相关数据结构以及对应的socket，初始化后会判断当前连接的客户端是否超过最大值，如果超过的话，会拒绝这次连接。否则，更新客户端连接数的计数。
数据结构redisClient用于表示一个客户端的连接，包括一个客户多次请求的状态，createClient函数主要是初始化这个数据结构。在createClient函数中，首先是创建redisClient，然后是设置socket的属性，然后添加该socket的读事件</p>

<p>createClient函数源码：</p>

<pre><code>if (fd != -1) {  
    anetNonBlock(NULL,fd);  
    // &lt;MM&gt;  
    // 关闭Nagle算法，提升响应速度  
    // &lt;/MM&gt;  
    anetEnableTcpNoDelay(NULL,fd);  
    if (server.tcpkeepalive)  
        anetKeepAlive(NULL,fd,server.tcpkeepalive);  
    if (aeCreateFileEvent(server.el,fd,AE_READABLE,  
        readQueryFromClient, c) == AE_ERR)  
    {  
        close(fd);  
        zfree(c);  
        return NULL;  
    }  
}
</code></pre>

<p>ps.将socket设置为非阻塞的并且no delay，关闭Nagle算法，提升响应速度。最后会注册socket的读事件，事件处理函数是readQueryFromClient，这个函数便是客户端请求的起点，之后会详细介绍。</p>

<p>createClient函数的最后部分，就是对redisClient的属性初始化，代码不再列出。</p>

<p>当从acceptTcpHandler返回后，客户端的连接就建立完毕，接下来就是等待客户端的请求。</p>

<p>以上就是这个错误涉及到的redis源码</p>

<p>在redis的github上发现了有类似的问题issue：<a href="https://github.com/antirez/redis/issues/2857">https://github.com/antirez/redis/issues/2857</a></p>

<p>在源码aof.c文件中</p>

<pre><code>/* Parent */    
server.stat_fork_time = ustime()-start;    
server.stat_fork_rate = (double) zmalloc_used_memory() * 1000000 / server.stat_fork_time / (1024*1024*1024); /* GB per second. */    
latencyAddSampleIfNeeded(&quot;fork&quot;,server.stat_fork_time/1000);    
if (childpid == -1) {    
serverLog(LL_WARNING,    
&quot;Can't rewrite append only file in background: fork: %s&quot;,    
strerror(errno));      
return C_ERR;    
}
</code></pre>

<p>源码发现在报出Can&rsquo;t rewrite append only file in background: fork: %s这个错误的时候，没有关闭pipe连接</p>

<p>因此看到了redis官方的修复说明已经修复了这个问题，翻出github上的提交记录，如下</p>

<p><img src="https://ningyu1.github.io/site/img/redis-pit/1.png" alt="redis1" /></p>

<p>这个时候看到了希望</p>

<p>于是搜索日志寻找是否有上图的错误：Can&rsquo;t rewrite append only file in background: fork</p>

<pre><code class="language-log">1838:M 15 Aug 13:52:01.101 # Can't rewrite append only file in background: fork: Cannot allocate memory
1838:M 15 Aug 13:52:01.202 * Starting automatic rewriting of AOF on 100% growth
1838:M 15 Aug 13:52:01.203 # Can't rewrite append only file in background: fork: Cannot allocate memory
1838:M 15 Aug 13:52:01.303 * Starting automatic rewriting of AOF on 100% growth
1838:M 15 Aug 13:52:01.304 # Can't rewrite append only file in background: fork: Cannot allocate memory
</code></pre>

<p>有很多我这里截取了前面的，总共出现的次数</p>

<pre><code class="language-bash">&gt;less redis.log.1 | grep &quot;Can't rewrite append only file in background: fork&quot; | wc -l
&gt;1644
</code></pre>

<p>基本可以断定是这个问题引发的连锁反应，这个时候我们需要研究一下Redis AOF机制，最终确认是否是这个问题导致。</p>

<p>研究redis AOF机制</p>

<p>redis aof rewirte机制，自动触发bgrewritedaof的条件：</p>

<pre><code>long long growth =(server.appendonly_current_size*100/base) - 100;
if (growth &gt;=server.auto_aofrewrite_perc)
</code></pre>

<p>我们的配置文件配置的auto-aof-rewrite-percentage 为100，也就是说当写入日志文件文件大小超过上次rewrite之后的文件大小的百分之100的时候就触发rewrite（也就是超过2倍）</p>

<p>ps.rewrite之后aof文件会保存keys的最后的状态，清除掉之前冗余的，来缩小这个文件。</p>

<h2 id="通过分析aof-rewrite发现rewrite出错就是导致redis连接数超过最大值的罪魁祸首">通过分析aof rewrite发现rewrite出错就是导致Redis连接数超过最大值的罪魁祸首。</h2>

<h2 id="分析总结">分析总结：</h2>

<p>基本可以定位到，这个错误是个连锁反应最终导致Redis服务出现问题
* 首先redis在进行aof的rewrite的时候，会检查机器可以用的内存够不够支撑做aof rewrite，这个时候我们机器的可用内存太小，因此报了如下错误</p>

<pre><code>Can't rewrite append only file in background: fork: Cannot allocate memory
</code></pre>

<ul>
<li>但是rewirte自动触发机制当达到2倍的时候会一直触发，他就会一直尝试aof rewrite</li>
<li>在aof rewrite尝试的过程中，已经创建的连接还是可以正常使用，这导致aof的auto_aofrewrite_perc一直在增长但是无法写入到aof文件中，因此又暴漏出另外一个错误，如下所示</li>
</ul>

<pre><code class="language-log">1838:M 16 Aug 01:07:39.319 * Starting automatic rewriting of AOF on 110% growth
1838:M 16 Aug 01:07:39.319 # Error opening /setting AOF rewrite IPC pipes: Numerical result out of range
</code></pre>

<ul>
<li>当aof rewirte出错时，从redis代码也能看到，他没有调用close pipes管道连接，这个就造成了服务器上有大量连接被占用（pipe类型）</li>
</ul>

<pre><code class="language-bash">&gt;netstat -anp|grep 6379
&gt;499

&gt;ls -al /proc/1838/fd | grep socket | wc -l
&gt;499

&gt;ls -al /proc/1838/fd | grep pipe | wc -l
&gt;9823

&gt;ls -al /proc/1838/fd | wc -l
&gt;10322
</code></pre>

<ul>
<li>当连接到达maxclients 10000时就会拒绝新建连接，并且报如下错误</li>
</ul>

<pre><code class="language-log">Error registering fd event for the new client: Numerical result out of range (fd=10311)
</code></pre>

<h2 id="本次分析的结论">本次分析的结论</h2>

<p>这个问题未解决需要继续跟踪，可能需要升级redis的版本，目前看到3.2.9以上才修复了这个bug，我们用的3.0.6版本的跨度有点大兼容性也需要考虑，还要对redis的配置在进一步研究，通过timeout配置让自动关闭无用的连接着也是一个解决问题的思路，这次只是先定位问题，具体解决还需要进一步研究</p>

<p>这个问题的issue：<a href="https://github.com/antirez/redis/issues/2857">#2857</a>，<a href="https://github.com/antirez/redis/issues/2883">#2883</a></p>

<p>这个问题的提交记录：<a href="https://github.com/antirez/redis/commit/9b05aafb50348838f45bfddcd689e7d8d1d3c950">fix #2883, #2857 pipe fds leak when fork() failed on bg aof rw</a></p>

<p>问题修改的文件：<a href="https://github.com/antirez/redis/blob/3.2.9/src/aof.c">3.2.9分支 -&gt; aof.c文件</a></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/11-redis-aof-pit/#disqus_thread">Comments</a></span>
    
    
</div>
</article>



  <nav id="pagenavi">
    
        <a href="https://ningyu1.github.io/site/page/9/" class="prev">Prev</a>
    
    
        <a href="https://ningyu1.github.io/site/page/11/" class="next">Next</a>
    
    <div class="center"><a href="https://ningyu1.github.io/site/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2024
    
    凝雨-Yun
    . Powered by <a href="http://gohugo.io" target="_blank">Hugo</a> |
    Theme is <a href="https://github.com/wd/hugo-fabric">hugo-fabric</a>
</div>

    </footer>
    <script src="https://ningyu1.github.io/site/js/fabric.js"></script>


</div>
</div>
<script src="https://ningyu1.github.io/site/js/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
 
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery);
 
</script>
</body>
</html>
