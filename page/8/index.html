<!DOCTYPE HTML>
<html>
<head>
	<meta name="generator" content="Hugo 0.51" />
	<meta charset="utf-8">
    
    
    <title>凝雨 - Yun</title>
    <meta name="author" content="凝雨-Yun">
    <meta name="description" content="">
    <meta name="keywords" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <link href="https://ningyu1.github.io/site/index.xml" rel="alternate" title="凝雨 - Yun" type="application/atom+xml">
    <link href="https://ningyu1.github.io/site/images/fav.ico" rel="shortcut icon">
    <style>
    @charset "UTF-8";
@font-face {
  font-family: 'FontAwesome';
  src: url("https://ningyu1.github.io/site/font/fontawesome-webfont.eot");
  src: url("https://ningyu1.github.io/site/font/fontawesome-webfont.eot?#iefix") format("embedded-opentype"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.woff") format("woff"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.ttf") format("truetype"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.svgz#FontAwesomeRegular") format("svg"),
  url("https://ningyu1.github.io/site/font/fontawesome-webfont.svg#FontAwesomeRegular") format("svg");
  font-weight: normal;
  font-style: normal; }

@font-face{
    font-family: 'MyHermit';
    src: url('https://ningyu1.github.io/site/font/hermit-medium-webfont.eot');
    src: url('https://ningyu1.github.io/site/font/hermit-medium-webfont.eot?#iefix') format('embedded-opentype'),
         url('https://ningyu1.github.io/site/font/hermit-medium-webfont.woff') format('woff'),
         url('https://ningyu1.github.io/site/font/hermit-medium-webfont.ttf') format('truetype');
}

* {
  margin: 0;
  padding: 0; }

body {
  font-family: 'PingFang SC', serif;
  font-weight: 300;
  font-size: 16px;
  /*background: url("https://ningyu1.github.io/site/images/retina_dust.png");*/
  color: #444;
  colori: #666666; }
  @media screen and (max-width: 1040px) {
    body {
      margin: 0 20px; } }
  @media screen and (max-width: 600px) {
    body {
      font-size: 13px; } }

.bBackground {
  position: fixed;
  height: 100%;
  width: 100%;
  background: -moz-radial-gradient(50% 50%, farthest-side, white, #efefef);
  background: -webkit-gradient(radial, 50% 50%, 250, 50% 50%, 750, from(white), to(#bbbbbb));
  z-index: -100; }

h1 {
  font-size: 1.8em; }

h2 {
  font-family: 'Fjalla One', sans-serif;
  font-size: 1.5em; }

h3 {
  font-size: 1.3em; }

a {
  text-decoration: none;
  outline-width: 0;
  color: #258fb8; }

.alignleft {
  float: left; }

.alignright {
  float: right; }

.clearfix {
  *zoom: 1; }
  .clearfix:after {
    content: "";
    display: table;
    clear: both; }

.inner {
  width: 900px;
  margin: 0 auto; }
  @media screen and (max-width: 1040px) {
    .inner {
      width: 100%; } }

#w2btoTop {
  display: none;
  text-decoration: none;
  position: fixed;
  bottom: 10px;
  right: 10px;
  overflow: hidden;
  width: 51px;
  height: 51px;
  border: none;
  text-indent: -999px;
  background: url(https://ningyu1.github.io/site/images/totop.png) no-repeat left top; }

#w2btoTopHover {
  background: url(https://ningyu1.github.io/site/images/totop.png) no-repeat left -51px;
  width: 51px;
  height: 51px;
  display: block;
  overflow: hidden;
  float: left;
  opacity: 0;
  -moz-opacity: 0;
  filter: alpha(opacity=0); }

#w2btoTop:active, #w2btoTop:focus {
  outline: none; }

.basic-alignment.left, article .entry-content img.left, article .entry-content video.left {
  float: left;
  margin-right: 1.5em; }
.basic-alignment.right, article .entry-content img.right, article .entry-content video.right {
  float: right;
  margin-left: 1.5em; }
.basic-alignment.center, article .entry-content img.center, article .entry-content video.center {
  display: block;
  margin: 0 auto 1.5em; }
.basic-alignment.left, article .entry-content img.left, article .entry-content video.left, .basic-alignment.right, article .entry-content img.right, article .entry-content video.right {
  margin-bottom: .8em; }

/* changes tooltip, to use, make elements 'class' as 'tooltip' and 'title' would be shown in tooltip */
.tooltip {
  display: inline;
  position: relative; }

.tooltip:hover {
  text-decoration: none; }

.tooltip:hover:after {
  background: #111;
  background: rgba(0, 0, 0, 0.8);
  border-radius: 5px;
  bottom: 18px;
  color: #fff;
  content: attr(title);
  display: block;
  left: 50%;
  padding: 5px 15px;
  position: absolute;
  white-space: nowrap;
  z-index: 98; }

.tooltip:hover:before {
  border: solid;
  border-color: #111 transparent;
  border-width: 6px 6px 0 6px;
  bottom: 12px;
  content: "";
  display: block;
  left: 75%;
  position: absolute;
  z-index: 99; }

.pullquote-right:before,
.pullquote-left:before {
  /* Reset metrics. */
  padding: 0;
  border: none;
  /* Content */
  content: attr(data-pullquote);
  /* Pull out to the right, modular scale based margins. */
  float: right;
  width: 45%;
  margin: .5em 0 1em 1.5em;
  /* Baseline correction */
  position: relative;
  top: 7px;
  font-size: 1.4em;
  line-height: 1.45em; }

.pullquote-left:before {
  /* Make left pullquotes align properly. */
  float: left;
  margin: .5em 1.5em 1em 0; }

#header {
  padding: 20px 0 20px 0; }
  @media screen and (max-width: 1040px) {
    #header {
      height: auto;
      position: relative;
      padding-bottom: 10px; } }
  #header a {
    color: #666666;
    -webkit-transition: compact(compact(color 0.3s, false, false, false, false, false, false, false, false, false) false false);
    -moz-transition: compact(compact(color 0.3s, false, false, false, false, false, false, false, false, false) false false false);
    -o-transition: compact(compact(color 0.3s, false, false, false, false, false, false, false, false, false) false false false);
    transition: compact(color 0.3s, false, false, false, false, false, false, false, false, false); }
    #header a:hover {
      color: #258fb8; }
  #header h1 {
    font-family: 'Slackey', cursive;
    font-weight: 300;
    font-size: 52px; }
    @media screen and (max-width: 1040px) {
      #header h1 {
        float: none; } }

#headerbg {
  text-align: center;
  background: #444;
  padding: 10px 10px;
  display: table;
  color: #fff;
  margin: 0 auto;
  border-radius: 5px;
  font-weight: bold;
  -webkit-mask-image: -webkit-linear-gradient(black, rgba(0, 0, 0, 0.9));
  -webkit-backface-visibility: hidden;
  -moz-backface-visibility: hidden;
  -ms-backface-visibility: hidden;
  -o-backface-visibility: hidden;
  backface-visibility: hidden;
  -webkit-animation-duration: 1s;
  -webkit-animation-delay: .2s;
  -webkit-animation-timing-function: ease;
  -webkit-animation-fill-mode: both;
  -moz-animation-duration: 1s;
  -moz-animation-delay: .2s;
  -moz-animation-timing-function: ease;
  -moz-animation-fill-mode: both;
  -ms-animation-duration: 1s;
  -ms-animation-delay: .2s;
  -ms-animation-timing-function: ease;
  -ms-animation-fill-mode: both;
  -o-animation-duration: 1s;
  -o-animation-delay: .2s;
  -o-animation-timing-function: ease;
  -o-animation-fill-mode: both;
  animation-duration: 1s;
  animation-delay: .2s;
  animation-timing-function: ease;
  animation-fill-mode: both; }

#load {
  display: none;
  position: absolute;
  right: 50%;
  top: 50%;
  background: url("https://ningyu1.github.io/site/images/loading.gif");
  width: 50px;
  height: 50px;
  text-indent: -9999em; }

#social-links li {
  display: inline-block;
  width: 35px;
  height: 35px;
  border-radius: 35px;
  margin-top: 20px;
  margin-right: 9px;
  background-color: #ddd;
  text-align: center;
  line-height: 35px;
  -webkit-transition: compact(compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false) false false);
  -moz-transition: compact(compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false) false false false);
  -o-transition: compact(compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false) false false false);
  transition: compact(background-color 1s ease-in-out, false, false, false, false, false, false, false, false, false); }
  #social-links li:hover {
    background-color: #555; }
#social-links a {
  display: inline-block;
  position: relative;
  width: 100%;
  height: 100%; }
  #social-links a svg {
    position: absolute; }
  #social-links a .github {
    top: 3px;
    left: 2px; }
  #social-links a .sina-weibo {
    top: 8px;
    left: 6px; }
  #social-links a .tencent-weibo {
    top: 6px;
    left: 4px; }
  #social-links a .twitter {
    top: 2px;
    left: 3px; }

a.facebook {
  background: url("https://ningyu1.github.io/site/images/social/Facebook.png") center no-repeat; }

a.facebook:hover {
  background: url("https://ningyu1.github.io/site/images/social/FacebookH.png") center no-repeat; }

a.github {
  background: url("https://ningyu1.github.io/site/images/social/Github.png") center no-repeat; }

a.github:hover {
  background: url("https://ningyu1.github.io/site/images/social/GithubH.png") center no-repeat; }

a.gitee {
  background: url("https://ningyu1.github.io/site/images/social/Gitee.png") center no-repeat; }

a.gitee:hover {
  background: url("https://ningyu1.github.io/site/images/social/GiteeH.png") center no-repeat; }

a.gitlab {
  background: url("https://ningyu1.github.io/site/images/social/Gitlab.png") center no-repeat; }

a.gitlab:hover {
  background: url("https://ningyu1.github.io/site/images/social/GitlabH.png") center no-repeat; }

a.email {
  background: url("https://ningyu1.github.io/site/images/social/Email.png") center no-repeat; }

a.email:hover {
  background: url("https://ningyu1.github.io/site/images/social/EmailH.png") center no-repeat; }

a.rss {
  background: url("https://ningyu1.github.io/site/images/social/Rss.png") center no-repeat; }

a.rss:hover {
  background: url("https://ningyu1.github.io/site/images/social/RssH.png") center no-repeat; }

a.twitter {
  background: url("https://ningyu1.github.io/site/images/social/Twitter.png") center no-repeat; }

a.twitter:hover {
  background: url("https://ningyu1.github.io/site/images/social/TwitterH.png") center no-repeat; }

a.google {
  background: url("https://ningyu1.github.io/site/images/social/Picasa.png") center no-repeat; }

a.google:hover {
  background: url("https://ningyu1.github.io/site/images/social/PicasaH.png") center no-repeat; }

a.skype {
  background: url("https://ningyu1.github.io/site/images/social/Skype.png") center no-repeat; }

a.skype:hover {
  background: url("https://ningyu1.github.io/site/images/social/SkypeH.png") center no-repeat; }

a.linkedin {
  background: url("https://ningyu1.github.io/site/images/social/LinkedIn.png") center no-repeat; }

a.linkedin:hover {
  background: url("https://ningyu1.github.io/site/images/social/LinkedInH.png") center no-repeat; }

a.youtube {
  background: url("https://ningyu1.github.io/site/images/social/Youtube.png") center no-repeat; }

a.youtube:hover {
  background: url("https://ningyu1.github.io/site/images/social/YoutubeH.png") center no-repeat; }

a.lastfm {
  background: url("https://ningyu1.github.io/site/images/social/LastFM.png") center no-repeat; }

a.lastfm:hover {
  background: url("https://ningyu1.github.io/site/images/social/LastFMH.png") center no-repeat; }

/* search bar */
#search {
  display: inline; }

#search input[type="text"] {
  background: url("https://ningyu1.github.io/site/images/search-dark.png") no-repeat 10px 6px #444444;
  border: 0 none;
  font: bold 12px Arial,Helvetica,Sans-serif;
  color: #777;
  width: 110px;
  padding: 6px 15px 6px 35px;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  text-shadow: 0 2px 2px rgba(0, 0, 0, 0.3);
  -webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -moz-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -webkit-transition: all 0.7s ease 0s;
  -moz-transition: all 0.7s ease 0s;
  -o-transition: all 0.7s ease 0s;
  transition: all 0.7s ease 0s; }

#search input[type="text"]:focus {
  width: 160px; }

#dark {
  display: inline-block;
  height: 70px; }

#dark #search input[type="text"] {
  background: url("https://ningyu1.github.io/site/images/search-dark.png") no-repeat 10px 6px #444444;
  border: 0 none;
  font: bold 12px Arial,Helvetica,Sans-serif;
  color: #ddd;
  width: 110px;
  padding: 6px 15px 6px 35px;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  text-shadow: 0 2px 2px rgba(0, 0, 0, 0.3);
  -webkit-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -moz-box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  box-shadow: 0 1px 0 rgba(255, 255, 255, 0.1), 0 1px 3px rgba(0, 0, 0, 0.2) inset;
  -webkit-transition: all 0.4s ease 0s;
  -moz-transition: all 0.4s ease 0s;
  -o-transition: all 0.4s ease 0s;
  transition: all 0.4s ease 0s; }

#dark #search input[type="text"]:focus {
  width: 160px;
  outline: 0; }

/* nav */
#nav {
  text-align: center;
  position: relative;
  margin: 10px auto; }

ul#nav *{
	box-sizing:content-box
}

ul#nav li {
  display: inline-block; }

ul#nav li {
  list-style-type: none;
  background-repeat: no-repeat;
  overflow: hidden;
  margin-right: 1px; }

ul#nav li a {
  display: inline-block;
  width: 110px;
  height: 40px;
  text-align: center;
  padding-top: 20px;
  padding-bottom: 20px;
  color: #222;
  font-weight: normal;
  text-decoration: none;
  font-family: "Lucida Grande", Arial, Helvetica, sans-serif;
  text-transform: uppercase;
  font-size: 16px;
  font-style: normal;
  text-shadow: 1px 1px 10px #222;
  overflow: hidden; }

ul#nav li a:hover {
  color: #fff;
  font-style: normal;
  font-weight: normal;
  background-image: url("https://ningyu1.github.io/site/images/hover.png");
  background-repeat: no-repeat;
  background-position: center top; }

ul#nav li a:active {
  position: relative;
  top: 2px; }

ul#nav li#active a {
  color: #FFF;
  background-image: url("https://ningyu1.github.io/site/images/active.png");
  background-repeat: no-repeat;
  background-position: center top; }

#pagenavi {
  padding: 20px 0;
  height: 20px;
  line-height: 20px;
  position: relative;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }
  #pagenavi a:hover {
    text-decoration: underline; }
  #pagenavi .prev, #pagenavi .next {
    position: absolute; }
  #pagenavi .prev {
    padding-left: 30px;
    left: 0; }
    #pagenavi .prev:before {
      content: "\f060";
      font: 1.3em FontAwesome;
      position: absolute;
      left: 0; }
  #pagenavi .next {
    padding-right: 30px;
    right: 0; }
    #pagenavi .next:before {
      content: "\f061";
      font: 1.3em FontAwesome;
      position: absolute;
      right: 0; }
  #pagenavi .center {
    text-align: center;
    width: 100%;
    display: block; }
    @media screen and (max-width: 400px) {
      #pagenavi .center {
        display: none; } }

article {
  border-bottom: 1px solid #dddddd;
  padding: 30px 0;
  position: relative; }
  @media screen and (max-width: 800px) {
    article {
      padding-bottom: 15px; } }
  @media screen and (max-width: 600px) {
    article {
      padding: 15px 0; } }
  article h2.title {
    font-family: 'Fjalla One', sans-serif;
    font-size: 2em;
    font-weight: 300;
    line-height: 35px;
    margin-bottom: 20px; }
    article h2.title a {
      color: #1094e8; }
  article .title a {
    color: #7c7873;
    -webkit-transition: all 1s ease-in-out;
    -moz-transition: all 1s ease-in-out;
    -o-transition: all 1s ease-in-out;
    transition: all 1s ease-in-out; }
  article .title a:hover {
    color: #084B8A;
    text-shadow: 3px 3px 12px #888;
    -webkit-transform: scale(1.3);
    -moz-transform: scale(1.3); }
  article .entry-content {
    line-height: 2;
    text-align: justify; }
    article .entry-content a:hover {
      text-decoration: underline; }
    article .entry-content .more-link {
      display: block;
      margin-top: 16px;
      padding-left: 30px;
      position: relative; }
      article .entry-content .more-link:before {
        content: "\f061";
        font: 1.3em FontAwesome;
        line-height: 1.6em;
        position: absolute;
        left: 0; }
    article .entry-content p, article .entry-content blockquote, article .entry-content ul, article .entry-content ol, article .entry-content dl, article .entry-content iframe, article .entry-content h1, article .entry-content h2, article .entry-content h3, article .entry-content h4, article .entry-content h5, article .entry-content h6, article .entry-content .video-container {
      margin-top: 10px; }
    article .entry-content ul, article .entry-content ol, article .entry-content dl {
      margin-left: 20px; }
      article .entry-content ul ul, article .entry-content ul ol, article .entry-content ul dl, article .entry-content ol ul, article .entry-content ol ol, article .entry-content ol dl, article .entry-content dl ul, article .entry-content dl ol, article .entry-content dl dl {
        margin-top: 0; }
    article .entry-content strong {
      font-weight: bold; }
    article .entry-content em {
      font-style: italic; }
    article .entry-content p {
      margin-top: 10px; }
    article .entry-content h2 {
      font-weight: 300;
      border-bottom: 1px solid #dddddd;
      position: relative; }
      article .entry-content h2:before {
        content: "";
        position: absolute;
        bottom: -2px;
        border-bottom: 1px solid white;
        width: 100%; }
    article .entry-content img, article .entry-content video {
      margin: 10px 0;
      max-width: 100%;
      height: auto;
      -moz-border-radius: 0.3em;
      -webkit-border-radius: 0.3em;
      -o-border-radius: 0.3em;
      -ms-border-radius: 0.3em;
      -khtml-border-radius: 0.3em;
      border-radius: 0.3em;
      -moz-box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      -webkit-box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      -o-box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      box-shadow: rgba(0, 0, 0, 0.75) 0 1px 4px;
      -moz-box-sizing: border-box;
      -webkit-box-sizing: border-box;
      -ms-box-sizing: border-box;
      box-sizing: border-box;
      border: #fff 0.3em solid; }
    article .entry-content img.noborder, article .entry-content video.noborder {
      border: none;
      box-shadow: none; }
    article .entry-content blockquote {
      background: #dddddd;
      border-left: 5px solid #cccccc;
      padding: 15px 20px;
      margin-top: 10px; }
      article .entry-content blockquote > p:first-of-type {
        margin-top: 0; }
    article .entry-content iframe {
      border: none; }
    article .entry-content .caption {
      display: block;
      font-size: 0.9em;
      color: #999999;
      padding-left: 25px;
      position: relative; }
      article .entry-content .caption:before {
        content: "\f040";
        color: #cccccc;
        font: 1.3em FontAwesome;
        line-height: 1.6em;
        position: absolute;
        left: 0; }
    article .entry-content .video-container {
      position: relative;
      padding-bottom: 56.25%;
      padding-top: 30px;
      height: 0;
      overflow: hidden; }
      article .entry-content .video-container iframe, article .entry-content .video-container object, article .entry-content .video-container embed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        margin-top: 0; }

.share {
  padding: 15px 0;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }

@media screen and (max-width: 800px) {
  .post h2.title, .post .entry-content {
    margin-left: 0; } }
.post .meta {
  line-height: 2;
  color: #999999;
  width: 370px; }
  @media screen and (max-width: 800px) {
    .post .meta {
      margin-top: 15px;
      position: static;
      width: auto; } }
  .post .meta a {
    color: #999999;
    -webkit-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false);
    -moz-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    -o-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    transition: compact(0.3s, false, false, false, false, false, false, false, false, false); }
    .post .meta a:hover {
      color: #666666; }
  .post .meta .date, .post .meta .tags, .post .meta .comments {
    padding-left: 30px;
    position: relative; }
    .post .meta .date:before, .post .meta .tags:before, .post .meta .comments:before {
      color: #cccccc;
      font: 1.3em FontAwesome;
      line-height: 1.6em;
      position: absolute;
      left: 0; }
    @media screen and (max-width: 800px) {
      .post .meta .date, .post .meta .tags, .post .meta .comments {
        display: -moz-inline-stack;
        display: inline-block;
        vertical-align: middle;
        *vertical-align: auto;
        zoom: 1;
        *display: inline;
        margin-right: 30px; } }
  .post .meta .date:before {
    content: "\f073"; }
  .post .meta .tags:before {
    content: "\f02c"; }
  .post .meta .comments:before {
    content: "\f075"; }

.archives {
  position: relative; }
  .archives:last-of-type:before {
    content: "";
    position: absolute;
    bottom: 0;
    width: 200px;
    border-top: 1px solid #dddddd; }
  .archives .top-border-padding {
    border-top: 1px solid #fff; }
    .archives .top-border-padding:before {
      content: "";
      position: absolute;
      top: -1px;
      width: 100%;
      border-top: 1px solid #dddddd; }
  .archives .year {
    line-height: 35px;
    width: 200px;
    position: absolute;
    top: 0;
    padding-top: 15px;
    border-top: 1px solid #fff; }
    .archives .year:before {
      content: "";
      position: absolute;
      top: -2px;
      width: 100%;
      border-top: 1px solid #dddddd; }
    @media screen and (max-width: 600px) {
      .archives .year {
        position: relative;
        width: 100%; } }
  .archives article {
    margin-left: 200px;
    padding: 10px 0; }
    @media screen and (max-width: 600px) {
      .archives article {
        margin-left: 0; }
        .archives article:first-of-type {
          border-top: none;
          padding-top: 30px; } }
    .archives article .title {
      margin-bottom: 0;
      font-size: 25px; }
    .archives article .meta {
      color: #999999;
      font-size: 0.9em;
      line-height: 2;
      margin-top: 10px; }
      @media screen and (max-width: 600px) {
        .archives article .meta {
          display: none; } }
      .archives article .meta span {
        margin-right: 30px;
        display: -moz-inline-stack;
        display: inline-block;
        vertical-align: middle;
        *vertical-align: auto;
        zoom: 1;
        *display: inline; }
        .archives article .meta span:before {
          color: #cccccc;
          font: 1.3em FontAwesome;
          padding-right: 10px; }
      .archives article .meta a {
        color: #999999;
        -webkit-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false);
        -moz-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
        -o-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
        transition: compact(0.3s, false, false, false, false, false, false, false, false, false); }
        .archives article .meta a:hover {
          color: #666666; }
      .archives article .meta .date:before {
        content: "\f073"; }
      .archives article .meta .tags:before {
        content: "\f02c"; }
      .archives article .meta .comments:before {
        content: "\f075"; }

#comment {
  padding: 30px 0;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }
  #comment h2.title {
    font-size: 25px;
    font-weight: 300;
    line-height: 35px;
    margin-bottom: 20px; }

footer {
  padding: 20px 0;
  text-align: center;
  font-size: 0.6em;
  color: #666; }

footer a {
  color: #123; }

footer a:hover {
  color: #456; }

#banner {
  color: #999999;
  padding: 30px 0;
  line-height: 30px;
  text-align: center;
  position: relative;
  display: none;
  border-top: 1px solid white;
  border-bottom: 1px solid #dddddd; }
  #banner:hover a {
    color: #258fb8; }
  #banner a {
    color: #999999;
    -webkit-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false);
    -moz-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    -o-transition: compact(compact(0.3s, false, false, false, false, false, false, false, false, false) false false false);
    transition: compact(0.3s, false, false, false, false, false, false, false, false, false); }
    #banner a:hover {
      text-decoration: underline; }
  #banner small {
    position: absolute;
    right: 0;
    bottom: 0; }
  #banner .loading {
    background: image-url("loading_pacman.gif") center no-repeat;
    text-indent: -9999px; }
  #banner .container {
    height: 30px;
    overflow: hidden;
    position: relative;
    display: none; }
    #banner .container .feed {
      list-style: none;
      position: absolute;
      top: 0;
      width: 100%; }
      #banner .container .feed li {
        position: relative; }
        #banner .container .feed li small {
          position: absolute;
          right: 0; }

/*! fancyBox v2.0.6 fancyapps.com | fancyapps.com/fancybox/#license */
.fancybox-tmp iframe, .fancybox-tmp object {
  vertical-align: top;
  padding: 0;
  margin: 0; }

.fancybox-wrap {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 8020; }

.fancybox-skin {
  position: relative;
  padding: 0;
  margin: 0;
  background: #f9f9f9;
  color: #444;
  text-shadow: none;
  -webkit-border-radius: 4px;
  -moz-border-radius: 4px;
  -ms-border-radius: 4px;
  -o-border-radius: 4px;
  border-radius: 4px; }

.fancybox-opened {
  z-index: 8030; }

.fancybox-opened .fancybox-skin {
  -webkit-box-shadow: compact(0 10px 25px rgba(0, 0, 0, 0.5), false, false, false, false, false, false, false, false, false);
  -moz-box-shadow: compact(0 10px 25px rgba(0, 0, 0, 0.5), false, false, false, false, false, false, false, false, false);
  box-shadow: compact(0 10px 25px rgba(0, 0, 0, 0.5), false, false, false, false, false, false, false, false, false); }

.fancybox-outer, .fancybox-inner {
  padding: 0;
  margin: 0;
  position: relative;
  outline: none; }

.fancybox-inner {
  overflow: hidden; }

.fancybox-type-iframe .fancybox-inner {
  -webkit-overflow-scrolling: touch; }

.fancybox-error {
  color: #444;
  font: 14px/20px "Helvetica Neue",Helvetica,Arial,sans-serif;
  margin: 0;
  padding: 10px; }

.fancybox-image, .fancybox-iframe {
  display: block;
  width: 100%;
  height: 100%;
  border: 0;
  padding: 0;
  margin: 0;
  vertical-align: top; }

.fancybox-image {
  max-width: 100%;
  max-height: 100%; }

#fancybox-loading, .fancybox-close, .fancybox-prev span, .fancybox-next span {
  background-image: image-url("fancybox/fancybox_sprite.png"); }

#fancybox-loading {
  position: fixed;
  top: 50%;
  left: 50%;
  margin-top: -22px;
  margin-left: -22px;
  background-position: 0 -108px;
  opacity: 0.8;
  cursor: pointer;
  z-index: 8020; }

#fancybox-loading div {
  width: 44px;
  height: 44px;
  background: image-url("fancybox/fancybox_loading.gif") center center no-repeat; }

.fancybox-close {
  position: absolute;
  top: -18px;
  right: -18px;
  width: 36px;
  height: 36px;
  cursor: pointer;
  z-index: 8040; }

.fancybox-nav {
  position: absolute;
  top: 0;
  width: 40%;
  height: 100%;
  cursor: pointer;
  background: transparent image-url("fancybox/blank.gif");
  /* helps IE */
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
  z-index: 8040; }

.fancybox-prev {
  left: 0; }

.fancybox-next {
  right: 0; }

.fancybox-nav span {
  position: absolute;
  top: 50%;
  width: 36px;
  height: 34px;
  margin-top: -18px;
  cursor: pointer;
  z-index: 8040;
  visibility: hidden; }

.fancybox-prev span {
  left: 20px;
  background-position: 0 -36px; }

.fancybox-next span {
  right: 20px;
  background-position: 0 -72px; }

.fancybox-nav:hover span {
  visibility: visible; }

.fancybox-tmp {
  position: absolute;
  top: -9999px;
  left: -9999px;
  padding: 0;
  overflow: visible;
  visibility: hidden; }

/* Overlay helper */
#fancybox-overlay {
  position: absolute;
  top: 0;
  left: 0;
  overflow: hidden;
  display: none;
  z-index: 8010;
  background: #000; }

#fancybox-overlay.overlay-fixed {
  position: fixed;
  bottom: 0;
  right: 0; }

/* Title helper */
.fancybox-title {
  visibility: hidden;
  font: normal 13px/20px "Helvetica Neue",Helvetica,Arial,sans-serif;
  position: relative;
  text-shadow: none;
  z-index: 8050; }

.fancybox-opened .fancybox-title {
  visibility: visible; }

.fancybox-title-float-wrap {
  position: absolute;
  bottom: 0;
  right: 50%;
  margin-bottom: -35px;
  z-index: 8030;
  text-align: center; }

.fancybox-title-float-wrap .child {
  display: inline-block;
  margin-right: -100%;
  padding: 2px 20px;
  background: transparent;
  /* Fallback for web browsers that doesn't support RGBa */
  background: rgba(0, 0, 0, 0.8);
  text-shadow: 0 1px 2px #222;
  color: #FFF;
  font-weight: bold;
  line-height: 24px;
  white-space: nowrap;
  -webkit-border-radius: 15px;
  -moz-border-radius: 15px;
  -ms-border-radius: 15px;
  -o-border-radius: 15px;
  border-radius: 15px; }

.fancybox-title-outside-wrap {
  position: relative;
  margin-top: 10px;
  color: #fff; }

.fancybox-title-inside-wrap {
  margin-top: 10px; }

.fancybox-title-over-wrap {
  position: absolute;
  bottom: 0;
  left: 0;
  color: #fff;
  padding: 10px;
  background: #000;
  background: rgba(0, 0, 0, 0.8); }

/*
Animate.css - http://daneden.me/animate
Licensed under the ☺ license (http://licence.visualidiot.com/)

Copyright (c) 2012 Dan Eden

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
*/
body {
  /* Addresses a small issue in webkit: http://bit.ly/NEdoDq */
  -webkit-backface-visibility: hidden; }

.animated {
  -webkit-animation-duration: 1s;
  -moz-animation-duration: 1s;
  -o-animation-duration: 1s;
  animation-duration: 1s;
  -webkit-animation-fill-mode: both;
  -moz-animation-fill-mode: both;
  -o-animation-fill-mode: both;
  animation-fill-mode: both; }

.animated.hinge {
  -webkit-animation-duration: 2s;
  -moz-animation-duration: 2s;
  -o-animation-duration: 2s;
  animation-duration: 2s; }

@-webkit-keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

@-moz-keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

@-o-keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

@keyframes flash {
  0%, 50%, 100% {
    opacity: 1; }

  25%, 75% {
    opacity: 0; } }

.flash {
  -webkit-animation-name: flash;
  -moz-animation-name: flash;
  -o-animation-name: flash;
  animation-name: flash; }

@-webkit-keyframes shake {
  0%, 100% {
    -webkit-transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    -webkit-transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    -webkit-transform: translateX(10px); } }

@-moz-keyframes shake {
  0%, 100% {
    -moz-transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    -moz-transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    -moz-transform: translateX(10px); } }

@-o-keyframes shake {
  0%, 100% {
    -o-transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    -o-transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    -o-transform: translateX(10px); } }

@keyframes shake {
  0%, 100% {
    transform: translateX(0); }

  10%, 30%, 50%, 70%, 90% {
    transform: translateX(-10px); }

  20%, 40%, 60%, 80% {
    transform: translateX(10px); } }

.shake {
  -webkit-animation-name: shake;
  -moz-animation-name: shake;
  -o-animation-name: shake;
  animation-name: shake; }

@-webkit-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -webkit-transform: translateY(0); }

  40% {
    -webkit-transform: translateY(-30px); }

  60% {
    -webkit-transform: translateY(-15px); } }

@-moz-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -moz-transform: translateY(0); }

  40% {
    -moz-transform: translateY(-30px); }

  60% {
    -moz-transform: translateY(-15px); } }

@-o-keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    -o-transform: translateY(0); }

  40% {
    -o-transform: translateY(-30px); }

  60% {
    -o-transform: translateY(-15px); } }

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0); }

  40% {
    transform: translateY(-30px); }

  60% {
    transform: translateY(-15px); } }

.bounce {
  -webkit-animation-name: bounce;
  -moz-animation-name: bounce;
  -o-animation-name: bounce;
  animation-name: bounce; }

@-webkit-keyframes tada {
  0% {
    -webkit-transform: scale(1); }

  10%, 20% {
    -webkit-transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    -webkit-transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    -webkit-transform: scale(1.1) rotate(-3deg); }

  100% {
    -webkit-transform: scale(1) rotate(0); } }

@-moz-keyframes tada {
  0% {
    -moz-transform: scale(1); }

  10%, 20% {
    -moz-transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    -moz-transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    -moz-transform: scale(1.1) rotate(-3deg); }

  100% {
    -moz-transform: scale(1) rotate(0); } }

@-o-keyframes tada {
  0% {
    -o-transform: scale(1); }

  10%, 20% {
    -o-transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    -o-transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    -o-transform: scale(1.1) rotate(-3deg); }

  100% {
    -o-transform: scale(1) rotate(0); } }

@keyframes tada {
  0% {
    transform: scale(1); }

  10%, 20% {
    transform: scale(0.9) rotate(-3deg); }

  30%, 50%, 70%, 90% {
    transform: scale(1.1) rotate(3deg); }

  40%, 60%, 80% {
    transform: scale(1.1) rotate(-3deg); }

  100% {
    transform: scale(1) rotate(0); } }

.tada {
  -webkit-animation-name: tada;
  -moz-animation-name: tada;
  -o-animation-name: tada;
  animation-name: tada; }

@-webkit-keyframes swing {
  20%, 40%, 60%, 80%, 100% {
    -webkit-transform-origin: top center; }

  20% {
    -webkit-transform: rotate(15deg); }

  40% {
    -webkit-transform: rotate(-10deg); }

  60% {
    -webkit-transform: rotate(5deg); }

  80% {
    -webkit-transform: rotate(-5deg); }

  100% {
    -webkit-transform: rotate(0deg); } }

@-moz-keyframes swing {
  20% {
    -moz-transform: rotate(15deg); }

  40% {
    -moz-transform: rotate(-10deg); }

  60% {
    -moz-transform: rotate(5deg); }

  80% {
    -moz-transform: rotate(-5deg); }

  100% {
    -moz-transform: rotate(0deg); } }

@-o-keyframes swing {
  20% {
    -o-transform: rotate(15deg); }

  40% {
    -o-transform: rotate(-10deg); }

  60% {
    -o-transform: rotate(5deg); }

  80% {
    -o-transform: rotate(-5deg); }

  100% {
    -o-transform: rotate(0deg); } }

@keyframes swing {
  20% {
    transform: rotate(15deg); }

  40% {
    transform: rotate(-10deg); }

  60% {
    transform: rotate(5deg); }

  80% {
    transform: rotate(-5deg); }

  100% {
    transform: rotate(0deg); } }

.swing {
  -webkit-transform-origin: top center;
  -moz-transform-origin: top center;
  -o-transform-origin: top center;
  transform-origin: top center;
  -webkit-animation-name: swing;
  -moz-animation-name: swing;
  -o-animation-name: swing;
  animation-name: swing; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes wobble {
  0% {
    -webkit-transform: translateX(0%); }

  15% {
    -webkit-transform: translateX(-25%) rotate(-5deg); }

  30% {
    -webkit-transform: translateX(20%) rotate(3deg); }

  45% {
    -webkit-transform: translateX(-15%) rotate(-3deg); }

  60% {
    -webkit-transform: translateX(10%) rotate(2deg); }

  75% {
    -webkit-transform: translateX(-5%) rotate(-1deg); }

  100% {
    -webkit-transform: translateX(0%); } }

@-moz-keyframes wobble {
  0% {
    -moz-transform: translateX(0%); }

  15% {
    -moz-transform: translateX(-25%) rotate(-5deg); }

  30% {
    -moz-transform: translateX(20%) rotate(3deg); }

  45% {
    -moz-transform: translateX(-15%) rotate(-3deg); }

  60% {
    -moz-transform: translateX(10%) rotate(2deg); }

  75% {
    -moz-transform: translateX(-5%) rotate(-1deg); }

  100% {
    -moz-transform: translateX(0%); } }

@-o-keyframes wobble {
  0% {
    -o-transform: translateX(0%); }

  15% {
    -o-transform: translateX(-25%) rotate(-5deg); }

  30% {
    -o-transform: translateX(20%) rotate(3deg); }

  45% {
    -o-transform: translateX(-15%) rotate(-3deg); }

  60% {
    -o-transform: translateX(10%) rotate(2deg); }

  75% {
    -o-transform: translateX(-5%) rotate(-1deg); }

  100% {
    -o-transform: translateX(0%); } }

@keyframes wobble {
  0% {
    transform: translateX(0%); }

  15% {
    transform: translateX(-25%) rotate(-5deg); }

  30% {
    transform: translateX(20%) rotate(3deg); }

  45% {
    transform: translateX(-15%) rotate(-3deg); }

  60% {
    transform: translateX(10%) rotate(2deg); }

  75% {
    transform: translateX(-5%) rotate(-1deg); }

  100% {
    transform: translateX(0%); } }

.wobble {
  -webkit-animation-name: wobble;
  -moz-animation-name: wobble;
  -o-animation-name: wobble;
  animation-name: wobble; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes pulse {
  0% {
    -webkit-transform: scale(1); }

  50% {
    -webkit-transform: scale(1.1); }

  100% {
    -webkit-transform: scale(1); } }

@-moz-keyframes pulse {
  0% {
    -moz-transform: scale(1); }

  50% {
    -moz-transform: scale(1.1); }

  100% {
    -moz-transform: scale(1); } }

@-o-keyframes pulse {
  0% {
    -o-transform: scale(1); }

  50% {
    -o-transform: scale(1.1); }

  100% {
    -o-transform: scale(1); } }

@keyframes pulse {
  0% {
    transform: scale(1); }

  50% {
    transform: scale(1.1); }

  100% {
    transform: scale(1); } }

.pulse {
  -webkit-animation-name: pulse;
  -moz-animation-name: pulse;
  -o-animation-name: pulse;
  animation-name: pulse; }

@-webkit-keyframes flip {
  0% {
    -webkit-transform: perspective(400px) rotateY(0);
    -webkit-animation-timing-function: ease-out; }

  40% {
    -webkit-transform: perspective(400px) translateZ(150px) rotateY(170deg);
    -webkit-animation-timing-function: ease-out; }

  50% {
    -webkit-transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    -webkit-animation-timing-function: ease-in; }

  80% {
    -webkit-transform: perspective(400px) rotateY(360deg) scale(0.95);
    -webkit-animation-timing-function: ease-in; }

  100% {
    -webkit-transform: perspective(400px) scale(1);
    -webkit-animation-timing-function: ease-in; } }

@-moz-keyframes flip {
  0% {
    -moz-transform: perspective(400px) rotateY(0);
    -moz-animation-timing-function: ease-out; }

  40% {
    -moz-transform: perspective(400px) translateZ(150px) rotateY(170deg);
    -moz-animation-timing-function: ease-out; }

  50% {
    -moz-transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    -moz-animation-timing-function: ease-in; }

  80% {
    -moz-transform: perspective(400px) rotateY(360deg) scale(0.95);
    -moz-animation-timing-function: ease-in; }

  100% {
    -moz-transform: perspective(400px) scale(1);
    -moz-animation-timing-function: ease-in; } }

@-o-keyframes flip {
  0% {
    -o-transform: perspective(400px) rotateY(0);
    -o-animation-timing-function: ease-out; }

  40% {
    -o-transform: perspective(400px) translateZ(150px) rotateY(170deg);
    -o-animation-timing-function: ease-out; }

  50% {
    -o-transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    -o-animation-timing-function: ease-in; }

  80% {
    -o-transform: perspective(400px) rotateY(360deg) scale(0.95);
    -o-animation-timing-function: ease-in; }

  100% {
    -o-transform: perspective(400px) scale(1);
    -o-animation-timing-function: ease-in; } }

@keyframes flip {
  0% {
    transform: perspective(400px) rotateY(0);
    animation-timing-function: ease-out; }

  40% {
    transform: perspective(400px) translateZ(150px) rotateY(170deg);
    animation-timing-function: ease-out; }

  50% {
    transform: perspective(400px) translateZ(150px) rotateY(190deg) scale(1);
    animation-timing-function: ease-in; }

  80% {
    transform: perspective(400px) rotateY(360deg) scale(0.95);
    animation-timing-function: ease-in; }

  100% {
    transform: perspective(400px) scale(1);
    animation-timing-function: ease-in; } }

.flip {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flip;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flip;
  -o-backface-visibility: visible !important;
  -o-animation-name: flip;
  backface-visibility: visible !important;
  animation-name: flip; }

@-webkit-keyframes flipInX {
  0% {
    -webkit-transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    -webkit-transform: perspective(400px) rotateX(-10deg); }

  70% {
    -webkit-transform: perspective(400px) rotateX(10deg); }

  100% {
    -webkit-transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

@-moz-keyframes flipInX {
  0% {
    -moz-transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    -moz-transform: perspective(400px) rotateX(-10deg); }

  70% {
    -moz-transform: perspective(400px) rotateX(10deg); }

  100% {
    -moz-transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

@-o-keyframes flipInX {
  0% {
    -o-transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    -o-transform: perspective(400px) rotateX(-10deg); }

  70% {
    -o-transform: perspective(400px) rotateX(10deg); }

  100% {
    -o-transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

@keyframes flipInX {
  0% {
    transform: perspective(400px) rotateX(90deg);
    opacity: 0; }

  40% {
    transform: perspective(400px) rotateX(-10deg); }

  70% {
    transform: perspective(400px) rotateX(10deg); }

  100% {
    transform: perspective(400px) rotateX(0deg);
    opacity: 1; } }

.flipInX {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flipInX;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flipInX;
  -o-backface-visibility: visible !important;
  -o-animation-name: flipInX;
  backface-visibility: visible !important;
  animation-name: flipInX; }

@-webkit-keyframes flipOutX {
  0% {
    -webkit-transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    -webkit-transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

@-moz-keyframes flipOutX {
  0% {
    -moz-transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    -moz-transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

@-o-keyframes flipOutX {
  0% {
    -o-transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    -o-transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

@keyframes flipOutX {
  0% {
    transform: perspective(400px) rotateX(0deg);
    opacity: 1; }

  100% {
    transform: perspective(400px) rotateX(90deg);
    opacity: 0; } }

.flipOutX {
  -webkit-animation-name: flipOutX;
  -webkit-backface-visibility: visible !important;
  -moz-animation-name: flipOutX;
  -moz-backface-visibility: visible !important;
  -o-animation-name: flipOutX;
  -o-backface-visibility: visible !important;
  animation-name: flipOutX;
  backface-visibility: visible !important; }

@-webkit-keyframes flipInY {
  0% {
    -webkit-transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    -webkit-transform: perspective(400px) rotateY(-10deg); }

  70% {
    -webkit-transform: perspective(400px) rotateY(10deg); }

  100% {
    -webkit-transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

@-moz-keyframes flipInY {
  0% {
    -moz-transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    -moz-transform: perspective(400px) rotateY(-10deg); }

  70% {
    -moz-transform: perspective(400px) rotateY(10deg); }

  100% {
    -moz-transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

@-o-keyframes flipInY {
  0% {
    -o-transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    -o-transform: perspective(400px) rotateY(-10deg); }

  70% {
    -o-transform: perspective(400px) rotateY(10deg); }

  100% {
    -o-transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

@keyframes flipInY {
  0% {
    transform: perspective(400px) rotateY(90deg);
    opacity: 0; }

  40% {
    transform: perspective(400px) rotateY(-10deg); }

  70% {
    transform: perspective(400px) rotateY(10deg); }

  100% {
    transform: perspective(400px) rotateY(0deg);
    opacity: 1; } }

.flipInY {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flipInY;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flipInY;
  -o-backface-visibility: visible !important;
  -o-animation-name: flipInY;
  backface-visibility: visible !important;
  animation-name: flipInY; }

@-webkit-keyframes flipOutY {
  0% {
    -webkit-transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    -webkit-transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

@-moz-keyframes flipOutY {
  0% {
    -moz-transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    -moz-transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

@-o-keyframes flipOutY {
  0% {
    -o-transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    -o-transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

@keyframes flipOutY {
  0% {
    transform: perspective(400px) rotateY(0deg);
    opacity: 1; }

  100% {
    transform: perspective(400px) rotateY(90deg);
    opacity: 0; } }

.flipOutY {
  -webkit-backface-visibility: visible !important;
  -webkit-animation-name: flipOutY;
  -moz-backface-visibility: visible !important;
  -moz-animation-name: flipOutY;
  -o-backface-visibility: visible !important;
  -o-animation-name: flipOutY;
  backface-visibility: visible !important;
  animation-name: flipOutY; }

@-webkit-keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

@-moz-keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

@-o-keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

@keyframes fadeIn {
  0% {
    opacity: 0; }

  100% {
    opacity: 1; } }

.fadeIn {
  -webkit-animation-name: fadeIn;
  -moz-animation-name: fadeIn;
  -o-animation-name: fadeIn;
  animation-name: fadeIn; }

@-webkit-keyframes fadeInUp {
  0% {
    opacity: 0;
    -webkit-transform: translateY(20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInUp {
  0% {
    opacity: 0;
    -moz-transform: translateY(20px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInUp {
  0% {
    opacity: 0;
    -o-transform: translateY(20px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInUp {
  0% {
    opacity: 0;
    transform: translateY(20px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInUp {
  -webkit-animation-name: fadeInUp;
  -moz-animation-name: fadeInUp;
  -o-animation-name: fadeInUp;
  animation-name: fadeInUp; }

@-webkit-keyframes fadeInDown {
  0% {
    opacity: 0;
    -webkit-transform: translateY(-20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInDown {
  0% {
    opacity: 0;
    -moz-transform: translateY(-20px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInDown {
  0% {
    opacity: 0;
    -o-transform: translateY(-20px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInDown {
  0% {
    opacity: 0;
    transform: translateY(-20px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInDown {
  -webkit-animation-name: fadeInDown;
  -moz-animation-name: fadeInDown;
  -o-animation-name: fadeInDown;
  animation-name: fadeInDown; }

@-webkit-keyframes fadeInLeft {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInLeft {
  0% {
    opacity: 0;
    -moz-transform: translateX(-20px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInLeft {
  0% {
    opacity: 0;
    -o-transform: translateX(-20px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInLeft {
  0% {
    opacity: 0;
    transform: translateX(-20px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInLeft {
  -webkit-animation-name: fadeInLeft;
  -moz-animation-name: fadeInLeft;
  -o-animation-name: fadeInLeft;
  animation-name: fadeInLeft; }

@-webkit-keyframes fadeInRight {
  0% {
    opacity: 0;
    -webkit-transform: translateX(20px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInRight {
  0% {
    opacity: 0;
    -moz-transform: translateX(20px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInRight {
  0% {
    opacity: 0;
    -o-transform: translateX(20px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInRight {
  0% {
    opacity: 0;
    transform: translateX(20px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInRight {
  -webkit-animation-name: fadeInRight;
  -moz-animation-name: fadeInRight;
  -o-animation-name: fadeInRight;
  animation-name: fadeInRight; }

@-webkit-keyframes fadeInUpBig {
  0% {
    opacity: 0;
    -webkit-transform: translateY(2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInUpBig {
  0% {
    opacity: 0;
    -moz-transform: translateY(2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInUpBig {
  0% {
    opacity: 0;
    -o-transform: translateY(2000px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInUpBig {
  0% {
    opacity: 0;
    transform: translateY(2000px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInUpBig {
  -webkit-animation-name: fadeInUpBig;
  -moz-animation-name: fadeInUpBig;
  -o-animation-name: fadeInUpBig;
  animation-name: fadeInUpBig; }

@-webkit-keyframes fadeInDownBig {
  0% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateY(0); } }

@-moz-keyframes fadeInDownBig {
  0% {
    opacity: 0;
    -moz-transform: translateY(-2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateY(0); } }

@-o-keyframes fadeInDownBig {
  0% {
    opacity: 0;
    -o-transform: translateY(-2000px); }

  100% {
    opacity: 1;
    -o-transform: translateY(0); } }

@keyframes fadeInDownBig {
  0% {
    opacity: 0;
    transform: translateY(-2000px); }

  100% {
    opacity: 1;
    transform: translateY(0); } }

.fadeInDownBig {
  -webkit-animation-name: fadeInDownBig;
  -moz-animation-name: fadeInDownBig;
  -o-animation-name: fadeInDownBig;
  animation-name: fadeInDownBig; }

@-webkit-keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    -moz-transform: translateX(-2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    -o-transform: translateX(-2000px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInLeftBig {
  0% {
    opacity: 0;
    transform: translateX(-2000px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInLeftBig {
  -webkit-animation-name: fadeInLeftBig;
  -moz-animation-name: fadeInLeftBig;
  -o-animation-name: fadeInLeftBig;
  animation-name: fadeInLeftBig; }

@-webkit-keyframes fadeInRightBig {
  0% {
    opacity: 0;
    -webkit-transform: translateX(2000px); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0); } }

@-moz-keyframes fadeInRightBig {
  0% {
    opacity: 0;
    -moz-transform: translateX(2000px); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0); } }

@-o-keyframes fadeInRightBig {
  0% {
    opacity: 0;
    -o-transform: translateX(2000px); }

  100% {
    opacity: 1;
    -o-transform: translateX(0); } }

@keyframes fadeInRightBig {
  0% {
    opacity: 0;
    transform: translateX(2000px); }

  100% {
    opacity: 1;
    transform: translateX(0); } }

.fadeInRightBig {
  -webkit-animation-name: fadeInRightBig;
  -moz-animation-name: fadeInRightBig;
  -o-animation-name: fadeInRightBig;
  animation-name: fadeInRightBig; }

@-webkit-keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

@-moz-keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

@-o-keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

@keyframes fadeOut {
  0% {
    opacity: 1; }

  100% {
    opacity: 0; } }

.fadeOut {
  -webkit-animation-name: fadeOut;
  -moz-animation-name: fadeOut;
  -o-animation-name: fadeOut;
  animation-name: fadeOut; }

@-webkit-keyframes fadeOutUp {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(-20px); } }

@-moz-keyframes fadeOutUp {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(-20px); } }

@-o-keyframes fadeOutUp {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(-20px); } }

@keyframes fadeOutUp {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(-20px); } }

.fadeOutUp {
  -webkit-animation-name: fadeOutUp;
  -moz-animation-name: fadeOutUp;
  -o-animation-name: fadeOutUp;
  animation-name: fadeOutUp; }

@-webkit-keyframes fadeOutDown {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(20px); } }

@-moz-keyframes fadeOutDown {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(20px); } }

@-o-keyframes fadeOutDown {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(20px); } }

@keyframes fadeOutDown {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(20px); } }

.fadeOutDown {
  -webkit-animation-name: fadeOutDown;
  -moz-animation-name: fadeOutDown;
  -o-animation-name: fadeOutDown;
  animation-name: fadeOutDown; }

@-webkit-keyframes fadeOutLeft {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(-20px); } }

@-moz-keyframes fadeOutLeft {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(-20px); } }

@-o-keyframes fadeOutLeft {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(-20px); } }

@keyframes fadeOutLeft {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(-20px); } }

.fadeOutLeft {
  -webkit-animation-name: fadeOutLeft;
  -moz-animation-name: fadeOutLeft;
  -o-animation-name: fadeOutLeft;
  animation-name: fadeOutLeft; }

@-webkit-keyframes fadeOutRight {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(20px); } }

@-moz-keyframes fadeOutRight {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(20px); } }

@-o-keyframes fadeOutRight {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(20px); } }

@keyframes fadeOutRight {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(20px); } }

.fadeOutRight {
  -webkit-animation-name: fadeOutRight;
  -moz-animation-name: fadeOutRight;
  -o-animation-name: fadeOutRight;
  animation-name: fadeOutRight; }

@-webkit-keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); } }

@-moz-keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(-2000px); } }

@-o-keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(-2000px); } }

@keyframes fadeOutUpBig {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(-2000px); } }

.fadeOutUpBig {
  -webkit-animation-name: fadeOutUpBig;
  -moz-animation-name: fadeOutUpBig;
  -o-animation-name: fadeOutUpBig;
  animation-name: fadeOutUpBig; }

@-webkit-keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    -webkit-transform: translateY(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(2000px); } }

@-moz-keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    -moz-transform: translateY(0); }

  100% {
    opacity: 0;
    -moz-transform: translateY(2000px); } }

@-o-keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    -o-transform: translateY(0); }

  100% {
    opacity: 0;
    -o-transform: translateY(2000px); } }

@keyframes fadeOutDownBig {
  0% {
    opacity: 1;
    transform: translateY(0); }

  100% {
    opacity: 0;
    transform: translateY(2000px); } }

.fadeOutDownBig {
  -webkit-animation-name: fadeOutDownBig;
  -moz-animation-name: fadeOutDownBig;
  -o-animation-name: fadeOutDownBig;
  animation-name: fadeOutDownBig; }

@-webkit-keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); } }

@-moz-keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(-2000px); } }

@-o-keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(-2000px); } }

@keyframes fadeOutLeftBig {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(-2000px); } }

.fadeOutLeftBig {
  -webkit-animation-name: fadeOutLeftBig;
  -moz-animation-name: fadeOutLeftBig;
  -o-animation-name: fadeOutLeftBig;
  animation-name: fadeOutLeftBig; }

@-webkit-keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(2000px); } }

@-moz-keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    -moz-transform: translateX(0); }

  100% {
    opacity: 0;
    -moz-transform: translateX(2000px); } }

@-o-keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    -o-transform: translateX(0); }

  100% {
    opacity: 0;
    -o-transform: translateX(2000px); } }

@keyframes fadeOutRightBig {
  0% {
    opacity: 1;
    transform: translateX(0); }

  100% {
    opacity: 0;
    transform: translateX(2000px); } }

.fadeOutRightBig {
  -webkit-animation-name: fadeOutRightBig;
  -moz-animation-name: fadeOutRightBig;
  -o-animation-name: fadeOutRightBig;
  animation-name: fadeOutRightBig; }

@-webkit-keyframes bounceIn {
  0% {
    opacity: 0;
    -webkit-transform: scale(0.3); }

  50% {
    opacity: 1;
    -webkit-transform: scale(1.05); }

  70% {
    -webkit-transform: scale(0.9); }

  100% {
    -webkit-transform: scale(1); } }

@-moz-keyframes bounceIn {
  0% {
    opacity: 0;
    -moz-transform: scale(0.3); }

  50% {
    opacity: 1;
    -moz-transform: scale(1.05); }

  70% {
    -moz-transform: scale(0.9); }

  100% {
    -moz-transform: scale(1); } }

@-o-keyframes bounceIn {
  0% {
    opacity: 0;
    -o-transform: scale(0.3); }

  50% {
    opacity: 1;
    -o-transform: scale(1.05); }

  70% {
    -o-transform: scale(0.9); }

  100% {
    -o-transform: scale(1); } }

@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3); }

  50% {
    opacity: 1;
    transform: scale(1.05); }

  70% {
    transform: scale(0.9); }

  100% {
    transform: scale(1); } }

.bounceIn {
  -webkit-animation-name: bounceIn;
  -moz-animation-name: bounceIn;
  -o-animation-name: bounceIn;
  animation-name: bounceIn; }

@-webkit-keyframes bounceInUp {
  0% {
    opacity: 0;
    -webkit-transform: translateY(2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateY(-30px); }

  80% {
    -webkit-transform: translateY(10px); }

  100% {
    -webkit-transform: translateY(0); } }

@-moz-keyframes bounceInUp {
  0% {
    opacity: 0;
    -moz-transform: translateY(2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateY(-30px); }

  80% {
    -moz-transform: translateY(10px); }

  100% {
    -moz-transform: translateY(0); } }

@-o-keyframes bounceInUp {
  0% {
    opacity: 0;
    -o-transform: translateY(2000px); }

  60% {
    opacity: 1;
    -o-transform: translateY(-30px); }

  80% {
    -o-transform: translateY(10px); }

  100% {
    -o-transform: translateY(0); } }

@keyframes bounceInUp {
  0% {
    opacity: 0;
    transform: translateY(2000px); }

  60% {
    opacity: 1;
    transform: translateY(-30px); }

  80% {
    transform: translateY(10px); }

  100% {
    transform: translateY(0); } }

.bounceInUp {
  -webkit-animation-name: bounceInUp;
  -moz-animation-name: bounceInUp;
  -o-animation-name: bounceInUp;
  animation-name: bounceInUp; }

@-webkit-keyframes bounceInDown {
  0% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateY(30px); }

  80% {
    -webkit-transform: translateY(-10px); }

  100% {
    -webkit-transform: translateY(0); } }

@-moz-keyframes bounceInDown {
  0% {
    opacity: 0;
    -moz-transform: translateY(-2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateY(30px); }

  80% {
    -moz-transform: translateY(-10px); }

  100% {
    -moz-transform: translateY(0); } }

@-o-keyframes bounceInDown {
  0% {
    opacity: 0;
    -o-transform: translateY(-2000px); }

  60% {
    opacity: 1;
    -o-transform: translateY(30px); }

  80% {
    -o-transform: translateY(-10px); }

  100% {
    -o-transform: translateY(0); } }

@keyframes bounceInDown {
  0% {
    opacity: 0;
    transform: translateY(-2000px); }

  60% {
    opacity: 1;
    transform: translateY(30px); }

  80% {
    transform: translateY(-10px); }

  100% {
    transform: translateY(0); } }

.bounceInDown {
  -webkit-animation-name: bounceInDown;
  -moz-animation-name: bounceInDown;
  -o-animation-name: bounceInDown;
  animation-name: bounceInDown; }

@-webkit-keyframes bounceInLeft {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateX(30px); }

  80% {
    -webkit-transform: translateX(-10px); }

  100% {
    -webkit-transform: translateX(0); } }

@-moz-keyframes bounceInLeft {
  0% {
    opacity: 0;
    -moz-transform: translateX(-2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateX(30px); }

  80% {
    -moz-transform: translateX(-10px); }

  100% {
    -moz-transform: translateX(0); } }

@-o-keyframes bounceInLeft {
  0% {
    opacity: 0;
    -o-transform: translateX(-2000px); }

  60% {
    opacity: 1;
    -o-transform: translateX(30px); }

  80% {
    -o-transform: translateX(-10px); }

  100% {
    -o-transform: translateX(0); } }

@keyframes bounceInLeft {
  0% {
    opacity: 0;
    transform: translateX(-2000px); }

  60% {
    opacity: 1;
    transform: translateX(30px); }

  80% {
    transform: translateX(-10px); }

  100% {
    transform: translateX(0); } }

.bounceInLeft {
  -webkit-animation-name: bounceInLeft;
  -moz-animation-name: bounceInLeft;
  -o-animation-name: bounceInLeft;
  animation-name: bounceInLeft; }

@-webkit-keyframes bounceInRight {
  0% {
    opacity: 0;
    -webkit-transform: translateX(2000px); }

  60% {
    opacity: 1;
    -webkit-transform: translateX(-30px); }

  80% {
    -webkit-transform: translateX(10px); }

  100% {
    -webkit-transform: translateX(0); } }

@-moz-keyframes bounceInRight {
  0% {
    opacity: 0;
    -moz-transform: translateX(2000px); }

  60% {
    opacity: 1;
    -moz-transform: translateX(-30px); }

  80% {
    -moz-transform: translateX(10px); }

  100% {
    -moz-transform: translateX(0); } }

@-o-keyframes bounceInRight {
  0% {
    opacity: 0;
    -o-transform: translateX(2000px); }

  60% {
    opacity: 1;
    -o-transform: translateX(-30px); }

  80% {
    -o-transform: translateX(10px); }

  100% {
    -o-transform: translateX(0); } }

@keyframes bounceInRight {
  0% {
    opacity: 0;
    transform: translateX(2000px); }

  60% {
    opacity: 1;
    transform: translateX(-30px); }

  80% {
    transform: translateX(10px); }

  100% {
    transform: translateX(0); } }

.bounceInRight {
  -webkit-animation-name: bounceInRight;
  -moz-animation-name: bounceInRight;
  -o-animation-name: bounceInRight;
  animation-name: bounceInRight; }

@-webkit-keyframes bounceOut {
  0% {
    -webkit-transform: scale(1); }

  25% {
    -webkit-transform: scale(0.95); }

  50% {
    opacity: 1;
    -webkit-transform: scale(1.1); }

  100% {
    opacity: 0;
    -webkit-transform: scale(0.3); } }

@-moz-keyframes bounceOut {
  0% {
    -moz-transform: scale(1); }

  25% {
    -moz-transform: scale(0.95); }

  50% {
    opacity: 1;
    -moz-transform: scale(1.1); }

  100% {
    opacity: 0;
    -moz-transform: scale(0.3); } }

@-o-keyframes bounceOut {
  0% {
    -o-transform: scale(1); }

  25% {
    -o-transform: scale(0.95); }

  50% {
    opacity: 1;
    -o-transform: scale(1.1); }

  100% {
    opacity: 0;
    -o-transform: scale(0.3); } }

@keyframes bounceOut {
  0% {
    transform: scale(1); }

  25% {
    transform: scale(0.95); }

  50% {
    opacity: 1;
    transform: scale(1.1); }

  100% {
    opacity: 0;
    transform: scale(0.3); } }

.bounceOut {
  -webkit-animation-name: bounceOut;
  -moz-animation-name: bounceOut;
  -o-animation-name: bounceOut;
  animation-name: bounceOut; }

@-webkit-keyframes bounceOutUp {
  0% {
    -webkit-transform: translateY(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateY(20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(-2000px); } }

@-moz-keyframes bounceOutUp {
  0% {
    -moz-transform: translateY(0); }

  20% {
    opacity: 1;
    -moz-transform: translateY(20px); }

  100% {
    opacity: 0;
    -moz-transform: translateY(-2000px); } }

@-o-keyframes bounceOutUp {
  0% {
    -o-transform: translateY(0); }

  20% {
    opacity: 1;
    -o-transform: translateY(20px); }

  100% {
    opacity: 0;
    -o-transform: translateY(-2000px); } }

@keyframes bounceOutUp {
  0% {
    transform: translateY(0); }

  20% {
    opacity: 1;
    transform: translateY(20px); }

  100% {
    opacity: 0;
    transform: translateY(-2000px); } }

.bounceOutUp {
  -webkit-animation-name: bounceOutUp;
  -moz-animation-name: bounceOutUp;
  -o-animation-name: bounceOutUp;
  animation-name: bounceOutUp; }

@-webkit-keyframes bounceOutDown {
  0% {
    -webkit-transform: translateY(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateY(-20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateY(2000px); } }

@-moz-keyframes bounceOutDown {
  0% {
    -moz-transform: translateY(0); }

  20% {
    opacity: 1;
    -moz-transform: translateY(-20px); }

  100% {
    opacity: 0;
    -moz-transform: translateY(2000px); } }

@-o-keyframes bounceOutDown {
  0% {
    -o-transform: translateY(0); }

  20% {
    opacity: 1;
    -o-transform: translateY(-20px); }

  100% {
    opacity: 0;
    -o-transform: translateY(2000px); } }

@keyframes bounceOutDown {
  0% {
    transform: translateY(0); }

  20% {
    opacity: 1;
    transform: translateY(-20px); }

  100% {
    opacity: 0;
    transform: translateY(2000px); } }

.bounceOutDown {
  -webkit-animation-name: bounceOutDown;
  -moz-animation-name: bounceOutDown;
  -o-animation-name: bounceOutDown;
  animation-name: bounceOutDown; }

@-webkit-keyframes bounceOutLeft {
  0% {
    -webkit-transform: translateX(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateX(20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(-2000px); } }

@-moz-keyframes bounceOutLeft {
  0% {
    -moz-transform: translateX(0); }

  20% {
    opacity: 1;
    -moz-transform: translateX(20px); }

  100% {
    opacity: 0;
    -moz-transform: translateX(-2000px); } }

@-o-keyframes bounceOutLeft {
  0% {
    -o-transform: translateX(0); }

  20% {
    opacity: 1;
    -o-transform: translateX(20px); }

  100% {
    opacity: 0;
    -o-transform: translateX(-2000px); } }

@keyframes bounceOutLeft {
  0% {
    transform: translateX(0); }

  20% {
    opacity: 1;
    transform: translateX(20px); }

  100% {
    opacity: 0;
    transform: translateX(-2000px); } }

.bounceOutLeft {
  -webkit-animation-name: bounceOutLeft;
  -moz-animation-name: bounceOutLeft;
  -o-animation-name: bounceOutLeft;
  animation-name: bounceOutLeft; }

@-webkit-keyframes bounceOutRight {
  0% {
    -webkit-transform: translateX(0); }

  20% {
    opacity: 1;
    -webkit-transform: translateX(-20px); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(2000px); } }

@-moz-keyframes bounceOutRight {
  0% {
    -moz-transform: translateX(0); }

  20% {
    opacity: 1;
    -moz-transform: translateX(-20px); }

  100% {
    opacity: 0;
    -moz-transform: translateX(2000px); } }

@-o-keyframes bounceOutRight {
  0% {
    -o-transform: translateX(0); }

  20% {
    opacity: 1;
    -o-transform: translateX(-20px); }

  100% {
    opacity: 0;
    -o-transform: translateX(2000px); } }

@keyframes bounceOutRight {
  0% {
    transform: translateX(0); }

  20% {
    opacity: 1;
    transform: translateX(-20px); }

  100% {
    opacity: 0;
    transform: translateX(2000px); } }

.bounceOutRight {
  -webkit-animation-name: bounceOutRight;
  -moz-animation-name: bounceOutRight;
  -o-animation-name: bounceOutRight;
  animation-name: bounceOutRight; }

@-webkit-keyframes rotateIn {
  0% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(-200deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateIn {
  0% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(-200deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateIn {
  0% {
    -o-transform-origin: center center;
    -o-transform: rotate(-200deg);
    opacity: 0; }

  100% {
    -o-transform-origin: center center;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateIn {
  0% {
    transform-origin: center center;
    transform: rotate(-200deg);
    opacity: 0; }

  100% {
    transform-origin: center center;
    transform: rotate(0);
    opacity: 1; } }

.rotateIn {
  -webkit-animation-name: rotateIn;
  -moz-animation-name: rotateIn;
  -o-animation-name: rotateIn;
  animation-name: rotateIn; }

@-webkit-keyframes rotateInUpLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInUpLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInUpLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInUpLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(90deg);
    opacity: 0; }

  100% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInUpLeft {
  -webkit-animation-name: rotateInUpLeft;
  -moz-animation-name: rotateInUpLeft;
  -o-animation-name: rotateInUpLeft;
  animation-name: rotateInUpLeft; }

@-webkit-keyframes rotateInDownLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInDownLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInDownLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInDownLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(-90deg);
    opacity: 0; }

  100% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInDownLeft {
  -webkit-animation-name: rotateInDownLeft;
  -moz-animation-name: rotateInDownLeft;
  -o-animation-name: rotateInDownLeft;
  animation-name: rotateInDownLeft; }

@-webkit-keyframes rotateInUpRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInUpRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInUpRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInUpRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(-90deg);
    opacity: 0; }

  100% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInUpRight {
  -webkit-animation-name: rotateInUpRight;
  -moz-animation-name: rotateInUpRight;
  -o-animation-name: rotateInUpRight;
  animation-name: rotateInUpRight; }

@-webkit-keyframes rotateInDownRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; } }

@-moz-keyframes rotateInDownRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; } }

@-o-keyframes rotateInDownRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(90deg);
    opacity: 0; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; } }

@keyframes rotateInDownRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(90deg);
    opacity: 0; }

  100% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; } }

.rotateInDownRight {
  -webkit-animation-name: rotateInDownRight;
  -moz-animation-name: rotateInDownRight;
  -o-animation-name: rotateInDownRight;
  animation-name: rotateInDownRight; }

@-webkit-keyframes rotateOut {
  0% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: center center;
    -webkit-transform: rotate(200deg);
    opacity: 0; } }

@-moz-keyframes rotateOut {
  0% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: center center;
    -moz-transform: rotate(200deg);
    opacity: 0; } }

@-o-keyframes rotateOut {
  0% {
    -o-transform-origin: center center;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: center center;
    -o-transform: rotate(200deg);
    opacity: 0; } }

@keyframes rotateOut {
  0% {
    transform-origin: center center;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: center center;
    transform: rotate(200deg);
    opacity: 0; } }

.rotateOut {
  -webkit-animation-name: rotateOut;
  -moz-animation-name: rotateOut;
  -o-animation-name: rotateOut;
  animation-name: rotateOut; }

@-webkit-keyframes rotateOutUpLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutUpLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; } }

@-o-keyframes rotateOutUpLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; } }

@keyframes rotateOutUpLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: left bottom;
    transform: rotate(-90deg);
    opacity: 0; } }

.rotateOutUpLeft {
  -webkit-animation-name: rotateOutUpLeft;
  -moz-animation-name: rotateOutUpLeft;
  -o-animation-name: rotateOutUpLeft;
  animation-name: rotateOutUpLeft; }

@-webkit-keyframes rotateOutDownLeft {
  0% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: left bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutDownLeft {
  0% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: left bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; } }

@-o-keyframes rotateOutDownLeft {
  0% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: left bottom;
    -o-transform: rotate(90deg);
    opacity: 0; } }

@keyframes rotateOutDownLeft {
  0% {
    transform-origin: left bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: left bottom;
    transform: rotate(90deg);
    opacity: 0; } }

.rotateOutDownLeft {
  -webkit-animation-name: rotateOutDownLeft;
  -moz-animation-name: rotateOutDownLeft;
  -o-animation-name: rotateOutDownLeft;
  animation-name: rotateOutDownLeft; }

@-webkit-keyframes rotateOutUpRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutUpRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(90deg);
    opacity: 0; } }

@-o-keyframes rotateOutUpRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(90deg);
    opacity: 0; } }

@keyframes rotateOutUpRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: right bottom;
    transform: rotate(90deg);
    opacity: 0; } }

.rotateOutUpRight {
  -webkit-animation-name: rotateOutUpRight;
  -moz-animation-name: rotateOutUpRight;
  -o-animation-name: rotateOutUpRight;
  animation-name: rotateOutUpRight; }

@-webkit-keyframes rotateOutDownRight {
  0% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(0);
    opacity: 1; }

  100% {
    -webkit-transform-origin: right bottom;
    -webkit-transform: rotate(-90deg);
    opacity: 0; } }

@-moz-keyframes rotateOutDownRight {
  0% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(0);
    opacity: 1; }

  100% {
    -moz-transform-origin: right bottom;
    -moz-transform: rotate(-90deg);
    opacity: 0; } }

@-o-keyframes rotateOutDownRight {
  0% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(0);
    opacity: 1; }

  100% {
    -o-transform-origin: right bottom;
    -o-transform: rotate(-90deg);
    opacity: 0; } }

@keyframes rotateOutDownRight {
  0% {
    transform-origin: right bottom;
    transform: rotate(0);
    opacity: 1; }

  100% {
    transform-origin: right bottom;
    transform: rotate(-90deg);
    opacity: 0; } }

.rotateOutDownRight {
  -webkit-animation-name: rotateOutDownRight;
  -moz-animation-name: rotateOutDownRight;
  -o-animation-name: rotateOutDownRight;
  animation-name: rotateOutDownRight; }

@-webkit-keyframes hinge {
  0% {
    -webkit-transform: rotate(0);
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  20%, 60% {
    -webkit-transform: rotate(80deg);
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  40% {
    -webkit-transform: rotate(60deg);
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  80% {
    -webkit-transform: rotate(60deg) translateY(0);
    opacity: 1;
    -webkit-transform-origin: top left;
    -webkit-animation-timing-function: ease-in-out; }

  100% {
    -webkit-transform: translateY(700px);
    opacity: 0; } }

@-moz-keyframes hinge {
  0% {
    -moz-transform: rotate(0);
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  20%, 60% {
    -moz-transform: rotate(80deg);
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  40% {
    -moz-transform: rotate(60deg);
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  80% {
    -moz-transform: rotate(60deg) translateY(0);
    opacity: 1;
    -moz-transform-origin: top left;
    -moz-animation-timing-function: ease-in-out; }

  100% {
    -moz-transform: translateY(700px);
    opacity: 0; } }

@-o-keyframes hinge {
  0% {
    -o-transform: rotate(0);
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  20%, 60% {
    -o-transform: rotate(80deg);
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  40% {
    -o-transform: rotate(60deg);
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  80% {
    -o-transform: rotate(60deg) translateY(0);
    opacity: 1;
    -o-transform-origin: top left;
    -o-animation-timing-function: ease-in-out; }

  100% {
    -o-transform: translateY(700px);
    opacity: 0; } }

@keyframes hinge {
  0% {
    transform: rotate(0);
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  20%, 60% {
    transform: rotate(80deg);
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  40% {
    transform: rotate(60deg);
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  80% {
    transform: rotate(60deg) translateY(0);
    opacity: 1;
    transform-origin: top left;
    animation-timing-function: ease-in-out; }

  100% {
    transform: translateY(700px);
    opacity: 0; } }

.hinge {
  -webkit-animation-name: hinge;
  -moz-animation-name: hinge;
  -o-animation-name: hinge;
  animation-name: hinge; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes rollIn {
  0% {
    opacity: 0;
    -webkit-transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    -webkit-transform: translateX(0px) rotate(0deg); } }

@-moz-keyframes rollIn {
  0% {
    opacity: 0;
    -moz-transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    -moz-transform: translateX(0px) rotate(0deg); } }

@-o-keyframes rollIn {
  0% {
    opacity: 0;
    -o-transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    -o-transform: translateX(0px) rotate(0deg); } }

@keyframes rollIn {
  0% {
    opacity: 0;
    transform: translateX(-100%) rotate(-120deg); }

  100% {
    opacity: 1;
    transform: translateX(0px) rotate(0deg); } }

.rollIn {
  -webkit-animation-name: rollIn;
  -moz-animation-name: rollIn;
  -o-animation-name: rollIn;
  animation-name: rollIn; }

/* originally authored by Nick Pettit - https://github.com/nickpettit/glide */
@-webkit-keyframes rollOut {
  0% {
    opacity: 1;
    -webkit-transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    -webkit-transform: translateX(100%) rotate(120deg); } }

@-moz-keyframes rollOut {
  0% {
    opacity: 1;
    -moz-transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    -moz-transform: translateX(100%) rotate(120deg); } }

@-o-keyframes rollOut {
  0% {
    opacity: 1;
    -o-transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    -o-transform: translateX(100%) rotate(120deg); } }

@keyframes rollOut {
  0% {
    opacity: 1;
    transform: translateX(0px) rotate(0deg); }

  100% {
    opacity: 0;
    transform: translateX(100%) rotate(120deg); } }

.rollOut {
  -webkit-animation-name: rollOut;
  -moz-animation-name: rollOut;
  -o-animation-name: rollOut;
  animation-name: rollOut; }

/* originally authored by Angelo Rohit - https://github.com/angelorohit */
@-webkit-keyframes lightSpeedIn {
  0% {
    -webkit-transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    -webkit-transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    -webkit-transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    -webkit-transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

@-moz-keyframes lightSpeedIn {
  0% {
    -moz-transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    -moz-transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    -moz-transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    -moz-transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

@-o-keyframes lightSpeedIn {
  0% {
    -o-transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    -o-transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    -o-transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    -o-transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

@keyframes lightSpeedIn {
  0% {
    transform: translateX(100%) skewX(-30deg);
    opacity: 0; }

  60% {
    transform: translateX(-20%) skewX(30deg);
    opacity: 1; }

  80% {
    transform: translateX(0%) skewX(-15deg);
    opacity: 1; }

  100% {
    transform: translateX(0%) skewX(0deg);
    opacity: 1; } }

.lightSpeedIn {
  -webkit-animation-name: lightSpeedIn;
  -moz-animation-name: lightSpeedIn;
  -o-animation-name: lightSpeedIn;
  animation-name: lightSpeedIn;
  -webkit-animation-timing-function: ease-out;
  -moz-animation-timing-function: ease-out;
  -o-animation-timing-function: ease-out;
  animation-timing-function: ease-out; }

.animated.lightSpeedIn {
  -webkit-animation-duration: 0.5s;
  -moz-animation-duration: 0.5s;
  -o-animation-duration: 0.5s;
  animation-duration: 0.5s; }

/* originally authored by Angelo Rohit - https://github.com/angelorohit */
@-webkit-keyframes lightSpeedOut {
  0% {
    -webkit-transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    -webkit-transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

@-moz-keyframes lightSpeedOut {
  0% {
    -moz-transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    -moz-transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

@-o-keyframes lightSpeedOut {
  0% {
    -o-transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    -o-transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

@keyframes lightSpeedOut {
  0% {
    transform: translateX(0%) skewX(0deg);
    opacity: 1; }

  100% {
    transform: translateX(100%) skewX(-30deg);
    opacity: 0; } }

.lightSpeedOut {
  -webkit-animation-name: lightSpeedOut;
  -moz-animation-name: lightSpeedOut;
  -o-animation-name: lightSpeedOut;
  animation-name: lightSpeedOut;
  -webkit-animation-timing-function: ease-in;
  -moz-animation-timing-function: ease-in;
  -o-animation-timing-function: ease-in;
  animation-timing-function: ease-in; }

.animated.lightSpeedOut {
  -webkit-animation-duration: 0.25s;
  -moz-animation-duration: 0.25s;
  -o-animation-duration: 0.25s;
  animation-duration: 0.25s; }

/* originally authored by Angelo Rohit - https://github.com/angelorohit */
@-webkit-keyframes wiggle {
  0% {
    -webkit-transform: skewX(9deg); }

  10% {
    -webkit-transform: skewX(-8deg); }

  20% {
    -webkit-transform: skewX(7deg); }

  30% {
    -webkit-transform: skewX(-6deg); }

  40% {
    -webkit-transform: skewX(5deg); }

  50% {
    -webkit-transform: skewX(-4deg); }

  60% {
    -webkit-transform: skewX(3deg); }

  70% {
    -webkit-transform: skewX(-2deg); }

  80% {
    -webkit-transform: skewX(1deg); }

  90% {
    -webkit-transform: skewX(0deg); }

  100% {
    -webkit-transform: skewX(0deg); } }

@-moz-keyframes wiggle {
  0% {
    -moz-transform: skewX(9deg); }

  10% {
    -moz-transform: skewX(-8deg); }

  20% {
    -moz-transform: skewX(7deg); }

  30% {
    -moz-transform: skewX(-6deg); }

  40% {
    -moz-transform: skewX(5deg); }

  50% {
    -moz-transform: skewX(-4deg); }

  60% {
    -moz-transform: skewX(3deg); }

  70% {
    -moz-transform: skewX(-2deg); }

  80% {
    -moz-transform: skewX(1deg); }

  90% {
    -moz-transform: skewX(0deg); }

  100% {
    -moz-transform: skewX(0deg); } }

@-o-keyframes wiggle {
  0% {
    -o-transform: skewX(9deg); }

  10% {
    -o-transform: skewX(-8deg); }

  20% {
    -o-transform: skewX(7deg); }

  30% {
    -o-transform: skewX(-6deg); }

  40% {
    -o-transform: skewX(5deg); }

  50% {
    -o-transform: skewX(-4deg); }

  60% {
    -o-transform: skewX(3deg); }

  70% {
    -o-transform: skewX(-2deg); }

  80% {
    -o-transform: skewX(1deg); }

  90% {
    -o-transform: skewX(0deg); }

  100% {
    -o-transform: skewX(0deg); } }

@keyframes wiggle {
  0% {
    transform: skewX(9deg); }

  10% {
    transform: skewX(-8deg); }

  20% {
    transform: skewX(7deg); }

  30% {
    transform: skewX(-6deg); }

  40% {
    transform: skewX(5deg); }

  50% {
    transform: skewX(-4deg); }

  60% {
    transform: skewX(3deg); }

  70% {
    transform: skewX(-2deg); }

  80% {
    transform: skewX(1deg); }

  90% {
    transform: skewX(0deg); }

  100% {
    transform: skewX(0deg); } }

.wiggle {
  -webkit-animation-name: wiggle;
  -moz-animation-name: wiggle;
  -o-animation-name: wiggle;
  animation-name: wiggle;
  -webkit-animation-timing-function: ease-in;
  -moz-animation-timing-function: ease-in;
  -o-animation-timing-function: ease-in;
  animation-timing-function: ease-in; }

.animated.wiggle {
  -webkit-animation-duration: 0.75s;
  -moz-animation-duration: 0.75s;
  -o-animation-duration: 0.75s;
  animation-duration: 0.75s; }
  

    </style>

    <link href="https://ningyu1.github.io/site/css/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="https://ningyu1.github.io/site/css/github-markdown.css" rel="stylesheet" type="text/css">

    <link href='https://ningyu1.github.io/site/css/Slackey.css' rel='stylesheet' type='text/css'>
    <link href='https://ningyu1.github.io/site/css/Fjallaone.css' rel='stylesheet' type='text/css'>
    <link href='https://ningyu1.github.io/site/css/Amethysta.css' rel='stylesheet' type='text/css'>
	<script src="https://ningyu1.github.io/site/js/jquery.min.js"></script>
    

    <script type="text/javascript" src="https://ningyu1.github.io/site/js/jquery-tapir.js"></script>

    

    <link rel="stylesheet" href="https://ningyu1.github.io/site/css/hljs.css">
    <script src="https://ningyu1.github.io/site/js/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?5bb9b9d406e3381971859973a2ca3583";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>
</head>


<a href="https://github.com/ningyu1"><img style="position: absolute; top: 0; right: 0; border: 0; width: 149px; height: 149px; z-index:9999; background-color: rgba(0, 0, 0, 0)!important;" src="https://ningyu1.github.io/site/images/right-graphite@2x.png" alt="Fork me on GitHub"></a>








<link href="https://ningyu1.github.io/site/css/music-player.css" media="screen, projection" rel="stylesheet" type="text/css">
<script type="text/javascript" src="https://ningyu1.github.io/site/js/music-player.js"></script>
<iframe class="player"  frameborder="no" border="0" marginwidth="0" marginheight="0" width=280 height=86 src="https://music.163.com/outchain/player?type=2&id=1296583188&auto=0&height=66"></iframe>



<body class="markdown-body">
    <div id="wrapper">
        <header id="header" class="inner">
<h1 class="animated bounceInDown">
    <div id="headerbg">
        凝雨 - Yun
    </div>
</h1>

<span class="subtitle">快乐编程每一天 - Happy Coding Every Day</span>
<br>


<ul id="social-links" style="text-align:center; clear:both;">
	
    
    <li>
    <a href="mailto:ningbe111@163.com" class="email" title="Email"></a>
    </li>
    
    
    
    <li>
    <a href="https://github.com/ningyu1" class="github" title="Github"></a>
    </li>
    
	
    
    <li>
    <a href="https://gitlab.com/ningyu1" class="gitlab" title="Gitlab"></a>
    </li>
    
    
    
    
    
    
    
    
	
    
    <li>
    <a href="https://gitee.com/ningyu" class="gitee" title="Gitee码云"></a>
    </li>
    
	<li>

    <a href="https://ningyu1.github.io/atom.xml" class="rss" title="RSS" target="_blank"></a>
    </li>
</ul>



<ul id="nav">





    
    <li id="ajax"><a href="https://ningyu1.github.io/">Home</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/archives/">Archives</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/categories/">Categories</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/tags/">Tags</a></li>
    <li id="ajax"><a href="https://ningyu1.github.io/about/">About</a></li>
    <li id="ajax"><a href="https://g2.okk.dog/?path=register&code=qn7nOwdj">科学上网</a></li>
    
    <li>
    <div id="dark">
        
        <form action="//www.google.com/search" method="get" accept-charset="UTF-8" id="search">

            <input type="hidden" name="sitesearch" value="https://ningyu1.github.io" />
            <input type="text" name="q" results="0" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
</ul>

</header>

<div id="toload">

    <div id="content" class="inner">
        




    
    <script id="dsq-count-scr" src="//ningyu.disqus.com/count.js" async></script>
    




  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/41-apm/">Java开源APM概要</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-12-11T10:00:36.000&#43;00:00' itemprop="datePublished">2017-12-11</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/apm">APM</a>

<a href="https://ningyu1.github.io/site/tags/pinpoint">pinpoint</a>

<a href="https://ningyu1.github.io/site/tags/cat">cat</a>

<a href="https://ningyu1.github.io/site/tags/sky-walking">sky walking</a>


</div>
    </div>
        

<h1 id="候选apm">候选APM</h1>

<ul>
<li><a href="https://github.com/naver/pinpoint">naver/pinpoint</a>(github上2148个star)</li>
</ul>

<p>韩国的一个公司开源的，有待评估使用情况，就是整体还不是JDK8，有些还是有点费劲，技术上采用agent的方式，对java友好</p>

<ul>
<li><a href="https://github.com/dianping/cat">大众点评cat</a>(github上1725个star)</li>
</ul>

<p>看接入的公司还是挺多的，个人感觉是点评名气还可以，但是搭建起来有点费劲，很多东西都写死配置了，不灵活。整体设计的话，由于没有采用agent的方式，采用的是api手工埋点的方式，跟SNG的很像，好处的是跨语言，不好的地方就是对java来说用起来还需要包装一下</p>

<ul>
<li><a href="https://github.com/wu-sheng/sky-walking">sky-walking</a>(github上374个star)</li>
</ul>

<p>开发团队加入了OneAPM,目前看使用的公司不多，整体技术采用agent方式，对java友好。提供了对dubbo等的支持，属于soa时代的产品</p>

<h1 id="技术架构">技术架构</h1>

<h2 id="pinpoint">pinpoint</h2>

<p><img src="https://ningyu1.github.io/site/img/apm/1.png" alt="" /></p>

<h2 id="cat">CAT</h2>

<p><img src="https://ningyu1.github.io/site/img/apm/2.png" alt="" /></p>

<h2 id="skywalking">skywalking</h2>

<p><img src="https://ningyu1.github.io/site/img/apm/3.png" alt="" /></p>

<h2 id="简要评价">简要评价</h2>

<p>从技术架构上看，对于log的存储都使用了hbase，也都是自己实现了日志/监控数据的上报。pinpoint支持udp的方式，这个好一点。这类还是有点SOA时代的痕迹，更为符合大数据时代的做法是，监控数据丢给kafka，然后监控server来消费数据即可，这一点在cat中使用了consumer有点这个味道，但是没有彻底转型过来。</p>

<h2 id="展望">展望</h2>

<p>APM整体的功能结构，主要是 1.日志追踪，2.监控报警 3.性能统计。对于日志追踪，已经有spirng cloud zipkin了，这个对spring cloud体系结合的很好，确的就是监控报警和性能统计，可以采用agent的方式进行无侵入的监控，或者采用log appender的方式到kafka，之后再进行error的监控报警，以及把performance的数据log到日志，发送到kafka来进行统计。</p>

<h2 id="docs">docs</h2>

<ul>
<li><a href="https://github.com/naver/pinpoint">pinpoint</a></li>
<li><a href="http://blog.csdn.net/szwandcj/article/details/51025669">大众点评Cat&ndash;架构分析</a></li>
<li><a href="http://www.infoq.com/cn/articles/distributed-real-time-monitoring-and-control-system">透过CAT，来看分布式实时监控系统的设计与实现</a></li>
<li><a href="https://github.com/wu-sheng/sky-walking">sky-walking</a></li>
</ul>

<p>转自原文地址：<a href="https://segmentfault.com/a/1190000006817114">https://segmentfault.com/a/1190000006817114</a></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/41-apm/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/40-distributed-db-paging/">跨库分页-架构技术实践</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-11-24T18:00:36.000&#43;00:00' itemprop="datePublished">2017-11-24</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/rdb-paging">rdb-paging</a>


</div>
    </div>
        

<p>文章来源：<a href="http://gitbook.cn/books/58a98f512bd83c246b6b8866/index.html">http://gitbook.cn/books/58a98f512bd83c246b6b8866/index.html</a>
作者：@58沈剑
说明：文章转自沈老板的文章，分析的很不错</p>

<h1 id="一-需求缘起">一、需求缘起</h1>

<h2 id="分页需求">分页需求</h2>

<p>互联网很多业务都有分页拉取数据的需求，例如：</p>

<ul>
<li>微信消息过多时，拉取第N页消息。</li>
<li>京东下单过多时，拉取第N页订单。</li>
<li>浏览58同城，查看第N页帖子。
这些业务场景对应的消息表，订单表，帖子表分页拉取需求有这样一些特点：</li>
<li>有一个业务主键id，例如msg_id，order_id，tiezi_id</li>
<li>分页排序是按照非业务主键id来排序的，业务中经常按照时间time来排序order by</li>
</ul>

<p>在数据量不大时，可以通过在排序字段time上建立索引，利用SQL提供的offset/limit功能就能满足分页查询需求：</p>

<pre><code>select * from t_msg order by time offset 200 limit 100   
select * from t_order order by time offset 200 limit 100   
select * from t_tiezi order by time offset 200 limit 100
</code></pre>

<p>此处假设一页数据为100条，均拉取第3页数据。</p>

<h2 id="分库需求">分库需求</h2>

<p>高并发大流量的互联网架构，一般通过服务层来访问数据库，随着数据量的增大，数据库需要进行水平切分，分库后将数据分布到不同的数据库实例（甚至物理机器）上，以达到降低数据量，增加实例数的扩容目的。</p>

<p>一旦涉及分库，逃不开“分库依据”patition key的概念，使用哪一个字段来水平切分数据库呢：大部分的业务场景，会使用业务主键id。</p>

<p>确定了分库依据patition key后，接下来要确定的是分库算法：大部分的业务场景，会使用业务主键id取模的算法来分库，这样即能够保证每个库的数据分布是均匀的，又能够保证每个库的请求分布是均匀的，实在是简单实现负载均衡的好方法，此法在互联网架构中应用颇多。</p>

<p>举一个更具体的例子：</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/1.png" alt="" /></p>

<p>用户库user，水平切分后变为两个库，分库依据patition key是uid，分库算法是uid取模：uid%2余0的数据会落到db0，uid%2余1的数据会落到db1。</p>

<h2 id="问题的提出">问题的提出</h2>

<p>仍然是上述用户库的例子，如果业务要查询“最近注册的第3页用户”，该如何实现呢？单库上，可以<code>select * from t_user order by time offset 200 limit 100</code>，变成两个库后，分库依据是uid，排序依据是time，数据库层失去了time排序的全局视野，数据分布在两个库上，此时该怎么办呢？</p>

<p>如何满足“跨越多个水平切分数据库，且分库依据与排序依据为不同属性，并需要进行分页”的查询需求，实现<code>select*from T order by time offset X limit Y</code>的跨库分页SQL，是本文将要讨论的技术问题。</p>

<h1 id="二-全局视野法">二、全局视野法</h1>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/2.png" alt="" /></p>

<p>如上图所述，服务层通过uid取模将数据分布到两个库上去之后，每个数据库都失去了全局视野，数据按照time局部排序之后，不管哪个分库的第3页数据，都不一定是全局排序的第3页数据。</p>

<p>那到底哪些数据才是全局排序的第3页数据呢，暂且分三种情况讨论。</p>

<p>（1）极端情况，两个库的数据完全一样</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/3.png" alt="" /></p>

<p>如果两个库的数据完全相同，只需要每个库offset一半，再取半页，就是最终想要的数据（如上图中粉色部分数据）。</p>

<p>（2）极端情况，结果数据来自一个库</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/4.png" alt="" /></p>

<p>也可能两个库的数据分布及其不均衡，例如db0的所有数据的time都大于db1的所有数据的time，则可能出现：一个库的第3页数据，就是全局排序后的第3页数据（如上图中粉色部分数据）。</p>

<p>（3）一般情况，每个库数据各包含一部分</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/5.png" alt="" /></p>

<p>正常情况下，全局排序的第3页数据，每个库都会包含一部分（如上图中粉色部分数据）。</p>

<p>由于不清楚到底是哪种情况，所以必须每个库都返回3页数据，所得到的6页数据在服务层进行内存排序，得到数据全局视野，再取第3页数据，便能够得到想要的全局分页数据。</p>

<p>再总结一下这个方案的步骤：</p>

<ul>
<li>将<code>order by time offset X limit Y</code>，改写成<code>order by time offset 0 limit X+Y</code>。</li>
<li>服务层将改写后的SQL语句发往各个分库：即例子中的各取3页数据。</li>
<li>假设共分为N个库，服务层将得到N*(X+Y)条数据：即例子中的6页数据。</li>
<li>服务层对得到的N*(X+Y)条数据进行内存排序，内存排序后再取偏移量X后的Y条记录，就是全局视野所需的一页数据。</li>
</ul>

<p>方案优点：通过服务层修改SQL语句，扩大数据召回量，能够得到全局视野，业务无损，精准返回所需数据。</p>

<p>方案缺点（显而易见）：</p>

<ul>
<li>每个分库需要返回更多的数据，增大了网络传输量（耗网络）；</li>
<li>除了数据库按照time进行排序，服务层还需要进行二次排序，增大了服务层的计算量（耗CPU）；</li>
<li>最致命的，这个算法随着页码的增大，性能会急剧下降，这是因为SQL改写后每个分库要返回X+Y行数据：返回第3页，offset中的X=200；假如要返回第100页，offset中的X=9900，即每个分库要返回100页数据，数据量和排序量都将大增，性能平方级下降。</li>
</ul>

<h1 id="三-业务折衷法">三、业务折衷法</h1>

<p>“全局视野法”虽然性能较差， 但其业务无损，数据精准，不失为一种方案，有没有性能更优的方案呢？</p>

<p>“任何脱离业务的架构设计都是耍流氓”，技术方案需要折衷，在技术难度较大的情况下，业务需求的折衷能够极大的简化技术方案。</p>

<h2 id="业务折衷一-禁止跳页查询">业务折衷一：禁止跳页查询</h2>

<p>在数据量很大，翻页数很多的时候，很多产品并不提供“直接跳到指定页面”的功能，而只提供“下一页”的功能，这一个小小的业务折衷，就能极大的降低技术方案的复杂度。</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/6.png" alt="" /></p>

<p>如上图，不能够跳页，那么第一次只能够查询第一页：</p>

<ul>
<li>将查询<code>order by time offset 0 limit 100</code>，改写成<code>order by time where time&gt;0 limit 100</code>。</li>
<li>上述改写和offset 0 limit 100的效果相同，都是每个分库返回了一页数据（上图中粉色部分）。</li>
</ul>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/7.png" alt="" /></p>

<ul>
<li>服务层得到2页数据，内存排序，取出前100条数据，作为最终的第一页数据，这个全局的第一页数据，一般来说每个分库都包含一部分数据（如上图粉色部分）。</li>
</ul>

<p>咦，这个方案也需要服务器内存排序，岂不是和“全局视野法”一样么？第一页数据的拉取确实一样，但每一次“下一页”拉取的方案就不一样了。</p>

<p>点击“下一页”时，需要拉取第二页数据，在第一页数据的基础之上，能够找到第一页数据time的最大值：</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/8.png" alt="" /></p>

<p>这个上一页记录的time_max，会作为第二页数据拉取的查询条件：</p>

<ul>
<li>将查询<code>order by time offset 100 limit 100</code>，改写成<code>order by time where time&gt;$time_max limit 100</code>。</li>
</ul>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/9.png" alt="" /></p>

<ul>
<li>这下不是返回2页数据了（“全局视野法，会改写成offset 0 limit 200”），每个分库还是返回一页数据（如上图中粉色部分）。</li>
</ul>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/10.png" alt="" /></p>

<ul>
<li>服务层得到2页数据，内存排序，取出前100条数据，作为最终的第2页数据，这个全局的第2页数据，一般来说也是每个分库都包含一部分数据（如上图粉色部分）。</li>
</ul>

<p>如此往复，查询全局视野第100页数据时，不是将查询条件改写为offset 0 limit 9900+100（返回100页数据），而是改写为time&gt;$time_max99 limit 100（仍返回一页数据），以保证数据的传输量和排序的数据量不会随着不断翻页而导致性能下降。</p>

<h2 id="业务折衷二-允许数据精度损失">业务折衷二：允许数据精度损失</h2>

<p>“全局视野法”能够返回业务无损的精确数据，在查询页数较大，例如第100页时，会有性能问题，此时业务上是否能够接受，返回的100页不是精准的数据，而允许有一些数据偏差呢？</p>

<p>数据库分库-数据均衡原理</p>

<p>使用patition key进行分库，在数据量较大，数据分布足够随机的情况下，各分库所有非patition key属性，在各个分库上的数据分布，统计概率情况应该是一致的。</p>

<p>例如，在uid随机的情况下，使用uid取模分两库，db0和db1：</p>

<ul>
<li>性别属性，如果db0库上的男性用户占比70%，则db1上男性用户占比也应为70%；</li>
<li>年龄属性，如果db0库上18-28岁少女用户比例占比15%，则db1上少女用户比例也应为15%；</li>
<li>时间属性，如果db0库上每天10:00之前登录的用户占比为20%，则db1上应该是相同的统计规律；</li>
<li>…</li>
</ul>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/11.png" alt="" /></p>

<p>利用这一原理，要查询全局100页数据，offset 9900 limit 100改写为offset 4950 limit 50，每个分库偏移4950（一半），获取50条数据（半页），得到的数据集的并集，基本能够认为，是全局数据的offset 9900 limit 100的数据，当然，这一页数据的精度，并不是精准的。</p>

<p>根据实际业务经验，用户都要查询第100页网页、帖子、邮件的数据了，这一页数据的精准性损失，业务上往往是可以接受的，但此时技术方案的复杂度便大大降低列，既不需要返回更多的数据，也不需要进行服务内存排序了。</p>

<h1 id="四-终极武器-二次查询法">四、终极武器：二次查询法</h1>

<p>有没有一种技术方案，即能够满足业务的精确需要，无需业务折衷，又高性能的方法呢？这就是接下来要介绍的终极武器：“二次查询法”。</p>

<p>为了方便举例，假设一页只有5条数据，查询第200页的SQL语句为<code>select*from T order by time offset 1000 limit 5</code>。</p>

<h1 id="步骤一-查询改写">步骤一：查询改写</h1>

<p>将<code>select*from T order by time offset 1000 limit 5</code>改写为<code>select*from T order by time offset 500 limit 5</code>并投递给所有的分库，注意，这个<code>offset</code>的500，来自于全局<code>offset</code>的总偏移量1000，除以水平切分数据库个数2。</p>

<p>如果是3个分库，则可以改写为<code>select*from T order by time offset 333 limit 5</code>，假设这三个分库返回的数据(time, uid)如下：</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/12.png" alt="" /></p>

<p>可以看到，每个分库都是返回的按照time排序的一页数据。</p>

<h2 id="步骤二-找到所返回3页全部数据的最小值">步骤二：找到所返回3页全部数据的最小值</h2>

<ul>
<li>第一个库，5条数据的time最小值是1487501123</li>
<li>第二个库，5条数据的time最小值是1487501133</li>
<li>第三个库，5条数据的time最小值是1487501143</li>
</ul>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/13.png" alt="" /></p>

<p>故，三页数据中，time最小值来自第一个库，time_min=1487501123，这个过程只需要比较各个分库第一条数据，时间复杂度很低。</p>

<h2 id="步骤三-查询二次改写">步骤三：查询二次改写</h2>

<p>第一次改写的SQL语句是<code>select*from T order by time offset 333 limit 5</code>。第二次要改写成一个between语句，between的起点是time_min，between的终点是原来每个分库各自返回数据的最大值：</p>

<p>第一个分库，第一次返回数据的最大值是1487501523；所以查询改写为<code>select*from T order by time where time between time_min and 1487501523</code>。</p>

<p>第二个分库，第一次返回数据的最大值是1487501323；所以查询改写为<code>select*from T order by time where time between time_min and 1487501323</code>。</p>

<p>第三个分库，第一次返回数据的最大值是1487501553；所以查询改写为<code>select*from T order by time where time between time_min and 1487501553</code>。</p>

<p>相对第一次查询，第二次查询条件放宽了，故第二次查询会返回比第一次查询结果集更多的数据，假设这三个分库返回的数据(time, uid)如下：</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/14.png" alt="" /></p>

<p>可以看到：</p>

<ul>
<li>由于time_min来自原来的分库一，所以分库一的返回结果集和第一次查询相同（所以其实这次查询是可以省略的）；</li>
<li>分库二的结果集，比第一次多返回了1条数据，头部的1条记录（time最小的记录）是新的（上图中粉色记录）；</li>
<li>分库三的结果集，比第一次多返回了2条数据，头部的2条记录（time最小的2条记录）是新的（上图中粉色记录）。</li>
</ul>

<h2 id="步骤四-在每个结果集中虚拟一个time-min记录-找到time-min在全局的offset">步骤四：在每个结果集中虚拟一个time_min记录，找到time_min在全局的offset</h2>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/15.png" alt="" /></p>

<ul>
<li>在第一个库中，time_min在第一个库的offset是333；</li>
<li>在第二个库中，(1487501133, uid_aa)的offset是333（根据第一次查询条件得出的），故虚拟time_min在第二个库的offset是331；</li>
<li>在第三个库中，(1487501143, uid_aaa)的offset是333（根据第一次查询条件得出的），故虚拟time_min在第三个库的offset是330。</li>
</ul>

<p>综上，time_min在全局的offset是333+331+330=994。</p>

<p>步骤五：既然得到了time_min在全局的offset，就相当于有了全局视野，根据第二次的结果集，就能够得到全局offset 1000 limit 5的记录</p>

<p><img src="https://ningyu1.github.io/site/img/rdb-paging/16.png" alt="" /></p>

<p>第二次查询在各个分库返回的结果集是有序的，又知道了time_min在全局的offset是994，一路排下来，容易知道全局offset 1000 limit 5的一页记录（上图中黄色记录）。</p>

<p>是不是非常巧妙？这种方法的优点是：可以精确的返回业务所需数据，每次返回的数据量都非常小，不会随着翻页增加数据的返回量。</p>

<p>不足是：需要进行两次数据库查询。</p>

<h1 id="五-总结">五、总结</h1>

<p>今天分享了解决“夸N库分页”这一技术难题的四种方法，稍作总结：</p>

<p>方法一：全局视野法</p>

<ul>
<li>将<code>order by time offset X limit Y</code>，改写成<code>order by time offset 0 limit X+Y</code>。</li>
<li>服务层对得到的N*(X+Y)条数据进行内存排序，内存排序后再取偏移量X后的Y条记录。</li>
</ul>

<p>方法二：业务折衷法-禁止跳页查询</p>

<ul>
<li>用正常的方法取得第一页数据，并得到第一页记录的time_max。</li>
<li>每次翻页，将<code>order by time offset X limit Y</code>，改写成<code>order by time where time&gt;$time_max limit Y</code>以保证每次只返回一页数据，性能为常量。</li>
</ul>

<p>方法三：业务折衷法-允许模糊数据</p>

<ul>
<li>将<code>order by time offset X limit Y</code>，改写成<code>order by time offset X/N limit Y/N</code>。</li>
</ul>

<p>方法四：二次查询法</p>

<ul>
<li>将<code>order by time offset X limit Y</code>，改写成<code>order by time offset X/N limit Y</code>；</li>
<li>找到最小值time_min；</li>
<li>between二次查询，<code>order by time between $$time_min and $time_i_max</code>；</li>
<li>设置虚拟time_min，找到time_min在各个分库的offset，从而得到time_min在全局的offset；</li>
<li>得到了time_min在全局的offset，自然得到了全局的offset X limit Y。</li>
</ul>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/40-distributed-db-paging/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/39-btrace/">BTrace使用笔记</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-11-15T11:00:36.000&#43;00:00' itemprop="datePublished">2017-11-15</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/btrace">btrace</a>


</div>
    </div>
        

<h2 id="btrace是什么">BTrace是什么？</h2>

<p>Btrace是由sundararajan在2009年6月开发的一个开源项目，是一种动态跟踪分析一个运行中的Java应用程序的工具。
BTrace是一个为Java平台开发的安全、动态的追踪工具。BTrace动态地向目标应用程序的字节码注入追踪代码（字节码追踪），这些追踪字节码追踪代码使用Java语言表达，也就是BTrace的脚本。</p>

<h2 id="btrace能做什么">BTrace能做什么？</h2>

<p>BTrace可以用来帮我们做运行时的JAVA程序分析，监控等等操作，BTrace也有一些使用上的限制，如：不能在脚本中新建类等。
Btrace是通过Attach API中提供的VirtualMachine.attach(PID)方法来获得要监控的JVM，然后使用VirtualMachine.loadAgent(&rdquo;*.jar&rdquo;)方法来加载jar文件。</p>

<h2 id="特别注意">特别注意</h2>

<p><span style="color:red"><strong>BTrace植入过的代码，会一直在，直到应用重启为止。所以即使Btrace退出了，业务函数每次执行时都会执行Btrace植入的代码</strong></span></p>

<h2 id="btrace术语">Btrace术语</h2>

<p><strong>Probe Point(探测点)</strong>
追踪语句（或者一组追踪语句）被触发执行的“位置”或“事件”。也就是我们想要执行一些追踪语句的“位置”或“事件”。
<strong>Trace Actions or Actions（追踪动作）</strong>
probe被触发时，执行的追踪语句。
<strong>Action Methods（动作方法）</strong>
我的理解是定义追踪动作的方法，当然根据官方的说明这个方法应该是静态的。
在静态方法中定义probe触发所调用的trace语句，那么这种定义了trace脚本的静态方法就是”动作方法”</p>

<h2 id="btrace程序结构">BTrace程序结构</h2>

<p>一个BTrace程序是其实就是一个普通的java类，特别之处就是由一个或者多个被(public static void)组合修饰的方法并且这些方法被BTrace对应的annotations注解。注解用来指出被追踪程序的位置（probe point）。追踪动作须书写在静态方法体中，也就是action方法（可以有多个action方法）。</p>

<h2 id="btrace约束">BTrace约束</h2>

<p>为了保证追踪动作是“只读”的（也就是这些动作不可以修改被追踪程序的状态）和有限度的（比如在固定时间里结束）。一个BTrace程序只允许完成一些指定的动作。下面是BTrace一些不可以完成的事情：</p>

<ul>
<li>不能创建新的对象</li>
<li>不能创建新的数组</li>
<li>不能抛出异常</li>
<li>不能捕获异常</li>
<li>不能进行任何的实例函数或者静态函数 – 只有com.sun.btrace.BTraceUtils类中的静态函数或者BTrace程序自己声明的函数才可以被BTrace调用</li>
<li>不可以在目标程序的类，或者对象的静态或者实例级别的field进行赋值。但是，BTrace自身的类是可以给它的静态field进行赋值的</li>
<li>不能有outer，inner,嵌套的或者本地类。</li>
<li>不能有同步代码块或者同步的函数</li>
<li>不能有循环语句（for,while, do..while）</li>
<li>不能继承其它类（父类只能是java.lang.Object）</li>
<li>不能实现接口</li>
<li>不能包含断言(assert)语句</li>
<li>不能使用类字面值</li>
</ul>

<p>这上面的种种限制可以通过一个配置改变：unsafe=true，在使用BTrace注解时修改该属性的默认值（false）为true，即@BTrace（unsafe=true）；也可以启动选项中显式声明-Dcom.sun.btrace.unsafe=true（响应也有-u参数）；现在你可以为所欲为了。<span style="color:red"><strong>BUT，这样做之前最好考虑好风险并再三检查脚本，请斟酌使用！</strong></span></p>

<h2 id="btrace安装">BTrace安装</h2>

<p><a href="https://github.com/btraceio/btrace" title="btrace-gitbub">btrace</a> git下载地址
下载下来直接解压就可以使用</p>

<h2 id="基本语法">基本语法</h2>

<pre><code>btrace &lt;pid&gt; &lt;btrace-script&gt;脚本
</code></pre>

<p>btrace命令行工具运行命令如下：</p>

<pre><code>btrace &lt;options&gt; &lt;pid&gt; &lt;btrace source or .class file&gt; &lt;btrace arguments&gt;
常用选项：
[-I &lt;include-path&gt;] [-p &lt;port&gt;] [-cp &lt;classpath&gt;]
</code></pre>

<p>参数说明：</p>

<pre><code>where possible options include:
  --version             Show the version
  -v                    Run in verbose mode
  -o &lt;file&gt;             The path to store the probe output (will disable showing the output in console)
  -u                    Run in trusted mode
  -d &lt;path&gt;             Dump the instrumented classes to the specified path
  -pd &lt;path&gt;            The search path for the probe XML descriptors
  -classpath &lt;path&gt;     Specify where to find user class files and annotation processors
  -cp &lt;path&gt;            Specify where to find user class files and annotation processors
  -I &lt;path&gt;             Specify where to find include files
  -p &lt;port&gt;             Specify port to which the btrace agent listens for clients
  -statsd &lt;host[:port]&gt; Specify the statsd server, if any
</code></pre>

<ul>
<li><strong>include-path</strong> : 是一些用来查找头文件的目录。BTrace包含一个简单的预处理,支持# define,# + include和条件编译。它不像一个完整的C / c++预处理器–而是一个有用的子集。详见demo代码“ThreadBean.java”，如果没有显式的声明选项-I，Btrace跳过预处理程序调用步骤。</li>
<li><strong>port</strong>： BTrace代理程序所侦听的端口，这是可选的选项。默认是2020</li>
<li><strong>classpath</strong>: 是一些用来查找jar文件的目录。默认是当前目录”.”</li>
<li><strong>pid</strong>：是要追踪目标程序id</li>
<li><strong>btrace-script</strong>: 就是追踪程序本身。如果这是个java文件，那么提交前会进行编译。否则,它被认为已预编译(即它必须是一个类)并提交</li>
<li><strong>arguments</strong>: 这是传递给BTrace程序的参数。BTrace程序可以通过内置的符号来引用这些参数，length是这些参数的个数。</li>
</ul>

<p>在samples目录下有很多示例，并且有的跟踪很有用可直接使用，下来让我们编写一个脚本来看一下具体是怎么使用的</p>

<h2 id="btrace的注解">BTrace的注解</h2>

<h3 id="方法注解">方法注解</h3>

<ul>
<li><strong>@com.sun.btrace.annotations.OnMethod</strong> 该注解可用来指定目标类，目标方法，以及目标方法里的“位置”。加了该注解后的操作方法会在对应的方法运行到指定的“位置”时被执行。这该注解中，目标类用“clazz”属性来指定，而目标方法用“method”属性来指定。”clazz”可以是类的全路径(比如java.awt.Component或者用两个反斜杠中间的正则表达式，参考例子NewComponent.java和Classload.java来看它们的用法，正则表达式可以匹配0个或多个目标类，这个时候多个类都会被进行动态指令更换。如/java.awt.+/匹配java.awt包下的所有类)。方法名也可以用这样的正则表达式 来匹配零个或者多个多个方法。参考例子MultiClass.java来查看用法。 还有一种方法来指定追踪类和函数。被追踪的类和函数可以用注解来指定。比如，如果”clazz”属性是@javax.jws.Webservice.那么BTrace会会把所有注解是这个的函数都进行动态指令更换。类似地，方法级别的注解也可以用来执行方法。参看例子WebServiceTracker.java来了解如何使用。可以把正则表达式和注解放在一起用，比如@/com.acme..+/可以匹配任何类，只要这个类的注解能跟那段正则表达式匹配即可。可以通过指定父类来匹配多个类名，比如+java.lang.Runnable就可以匹配所有实现了java.lang.Runnable这个接口的类。参考例子SubtypeTracer.java来看它的用法。</li>
<li><strong>@com.sun.btrace.annotations.OnTimer</strong> 该注解可以用来执行那些需要周期性（间隔是毫秒）的追踪操作。参考Histogram.java来看它的用法。</li>
<li><strong>@com.sun.btrace.annotations.OnError</strong> 该注解可以用来指定当任何异常抛出时需要执行的操作。被该注解修饰后的BTrace函数会在同一个BTrace类的其他操作方法抛出异常时执行。</li>
<li><strong>@com.sun.btrace.annotations.OnExit</strong> 该注解用来执行党BTrace代码调用了exit(int)结束追踪会话后需要执行的操作。参考例子ProbeExit.java来了解如何使用。</li>
<li><strong>@com.sun.btrace.annotations.OnEvent</strong> 该注解用来追踪函数与”外部”的事件关联起来。当BTrace客户端发送了一个“事件”后，该注解里的操作就会被执行。客户端发送的事件可能是由用户触发的（比如按下Ctrl-C）。事件的名字是个字符串，这样追踪操作就只会在对应的事件触发后被执行。到目标为止，BTrace命令行客户端会在用户按下Ctrl-C后发送事件，参考例子HistoOnEvent.java来了解用法。</li>
<li><strong>@com.sun.btrace.annotations.OnLowMemory</strong> 该注解可以用来追踪特定内存阈值被用光的事件。参看例子MemAlerter.java了解用法。</li>
<li><strong>@com.sun.btrace.annotations.OnProbe</strong> 该注解可以用来避免使用BTrace脚本的内部类。@OnProbe探测点被映射到一个或多个@OnMethod上。目前这个映射是通过一个XML探测描述文件类指定的（这个文件会被BTrace代理所使用）。参考例子SocketTracker1.java和对应的描述文件java.net.socket.xml.当运行这个例子时，xml文件需要放在目标JVM所有运行的目录下(或者修改btracer.bat中的probeDescPath选项来指向任意的xml文件)。</li>
<li><strong>@com.sun.btrace.annotations.Location</strong>：该注解在一个traced/probed方法中指定一个特定的“位置”</li>
<li><strong>@com.sun.btrace.annotations.Simpled</strong>：标记@OnMethod注解处理器采样。采样处理程序时并不是所有的事件将被追踪,只有一个统计样品与给定的意思。在默认情况下使用一种自适应采样。BTrace将增加或减少样品之间的调用数量保持平均时间窗口,因此减少整体的开销。</li>
</ul>

<h3 id="参数相关的注解">参数相关的注解</h3>

<ul>
<li><strong>@com.sun.btrace.annotations.Self</strong>：该注解把一个参数标识为保留了目标函数所指向的this的值。参考例子AWTEventTracer.java和AllCalls1.java.</li>
<li><strong>@com.sun.btrace.annotations.Return</strong>：该注解说明这个参数保存目标函数的返回值。参考例子Classload.java</li>
<li><strong>@com.sun.btrace.annotations.ProbeClassName</strong>：所修饰的参数保留了探测类的类名 。参看AllMethods.java（有多个探测类）</li>
<li><strong>@com.sun.btrace.annotations.ProbeMethodName</strong>：所修饰的参数保留了探测函数的函数名。参考WebServiceTracker.java（多个探测函数）</li>
<li><strong>@com.sun.btrace.annotations.TargetInstance</strong>：修饰的参数保留了被调用的实例。参考例子AllCall2.java.</li>
<li><strong>@com.sun.btrace.annotations.TargetMethodOrField</strong>：该注解修饰的参数保存了调用的函数名。参考AllCalls1.java 和AllCall2.java</li>
<li><strong>@com.sun.btrace.annotations.Duration</strong>：探测方法参数标记为持续时间值的接收者，即目标方法执行的时间，单位纳秒。只是用带Location属性的@OnMethod，并且需要配合Kind.ERROR或者Kind.RETURN使用</li>
</ul>

<h3 id="无注解的参数">无注解的参数</h3>

<p>没有注解的<code>BTrace</code>探测函数参数是用来作签名匹配的，因为他们必须必须在固定的位置上出现。然而，它们可以和其他的注解的参数进行交换。如果一个参数的类型是_AnyType[]_，它就会“吃”掉所所有剩下的参数。没有注解的参数的具体含义与他们所在的位置有关：</p>

<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">作用</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">Kind.ARRAY_GET</td>
<td align="left">数组元素加载</td>
</tr>

<tr>
<td align="left">Kind.ARRAY_SET</td>
<td align="left">数组元素存储</td>
</tr>

<tr>
<td align="left">Kind.CALL</td>
<td align="left">方法调用</td>
</tr>

<tr>
<td align="left">Kind.CATCH</td>
<td align="left">异常捕获</td>
</tr>

<tr>
<td align="left">Kind.CHECKCAST</td>
<td align="left">checkcast</td>
</tr>

<tr>
<td align="left">Kind.ENTRY</td>
<td align="left">方法进入。意指进入匹配probe点，跟你@Location设置的clazz和method没有任何关系</td>
</tr>

<tr>
<td align="left">Kind.ERROR</td>
<td align="left">错误，异常没有捕获，返回</td>
</tr>

<tr>
<td align="left">Kind.FIELD_GET</td>
<td align="left">field获取</td>
</tr>

<tr>
<td align="left">Kind.FIELD_SET</td>
<td align="left">field设置</td>
</tr>

<tr>
<td align="left">Kind.INSTANCEOF</td>
<td align="left">实例检测</td>
</tr>

<tr>
<td align="left">Kind.LINE</td>
<td align="left">源代码行号</td>
</tr>

<tr>
<td align="left">Kind.NEW</td>
<td align="left">创建新实例</td>
</tr>

<tr>
<td align="left">Kind.NEWARRAY</td>
<td align="left">新的数组对象被创建</td>
</tr>

<tr>
<td align="left">Kind.RETURN</td>
<td align="left">意指从某个匹配probe的方法中调用了匹配A class method的点，一定要和clazz,method配合使用。clazz和method的默认值为”“，所以不能被匹配</td>
</tr>

<tr>
<td align="left">Kind.SYNC_ENTRY</td>
<td align="left">进入一个同步方法锁</td>
</tr>

<tr>
<td align="left">Kind.SYNC_EXIT</td>
<td align="left">离开一个同步方法锁</td>
</tr>

<tr>
<td align="left">Kind.THROW</td>
<td align="left">抛出异常</td>
</tr>
</tbody>
</table>

<h3 id="字段相关的注解">字段相关的注解</h3>

<ul>
<li><strong>@com.sun.btrace.annotations.Export</strong> BTrace字段使用该注解来说明它已经被映射到一个jvmstat计数器上。使用该注解，BTrace程序可以把追踪计数器暴露给外部的jvmstat客户端（比如jstat）。参考例子ThreadCounter.java</li>
<li><strong>@com.sun.btrace.annotations.Property</strong>该注解可以把一个字段标识为一个MBean属性。如果一个BTrace类至少有一个静态的字段使用了该注解。那么一个MBean就会被创建并且注册到平台MBean服务器上。JMX客户端比如VisualVM，jconsole可以访问这个字段来查看BTrace的MBean。在把BTrace附加到目标程序上后，你可以把VisualVM或者jconsole也附加到同一个目标程序上来查看刚创建好的MBean属性。通过VisualVM或者jconsole,你可以通过MBeans tab页来查看BTrace相关的域，然后查看它们的值。参考例子ThreadCounterBean.java 和HistogramBean.java来了解用法</li>
<li><strong>@com.sun.btrace.annotations.TLS</strong> BTrace字段使用该注解来说明它自己是一个线程本地字段（thread local field）.注意你只能在@OnMethod注解后的函数里访问这样的字段。每个Java线程都有一个这个字段的拷贝。为了让这样的方式能够工作，这个字段的类型只能是immutable（比如原始类型） 或者是cloneable （实现了Cloneable接口并且覆盖了clone()函数）的。这些线程本地字段可以被BTrace程序用来识别它是否在同一个线程里执行了多个探测操作。参考例子OnThrow.java和WebServiceTracker.java</li>
</ul>

<h3 id="类相关的注解">类相关的注解</h3>

<ul>
<li><strong>@com.sun.btrace.annotations.DTrace</strong>该注解用来把一小段D脚本（嵌在BTrace 的java类中）和BTrace程序关联起来。参考例子DTraceInline.java</li>
<li><strong>@com.sun.btrace.annotations.DTraceRef</strong> 和上个注解一样，不同的是D脚本是在独立的文件中，不是嵌在java类中。</li>
<li><strong>@com.sun.btrace.annotations.BTrace</strong>必须使用该注解来指定一个Java类是BTrace程序。BTrace编译器会强制查找该注解，BTrace代理也会检查这个是否有该注解。如果没有，则提示错误，并且不会执行。</li>
</ul>

<h2 id="脚本编写">脚本编写</h2>

<pre><code>
package btrace;

import com.sun.btrace.BTraceUtils;
import com.sun.btrace.annotations.*;

@BTrace
public class UniqueIdMgrBtrace {
    @OnMethod(clazz = &quot;com.atomikos.util.UniqueIdMgr&quot;, method = &quot;get&quot;, location = @Location(Kind.RETURN))
    public static void onGet(@Return String result) {
        long millis = BTraceUtils.timeMillis();
        String threadName = BTraceUtils.Threads.name(BTraceUtils.currentThread());
        String str = BTraceUtils.strcat(BTraceUtils.str(millis), &quot; - [&quot;);
        str = BTraceUtils.strcat(str, BTraceUtils.str(threadName));
        str = BTraceUtils.strcat(str, &quot;] - com.atomikos.util.UniqueIdMgr.get()--&gt;&quot;);
        str = BTraceUtils.strcat(str, BTraceUtils.str(result));
        BTraceUtils.println(BTraceUtils.str(str));
    }

    @OnMethod(clazz = &quot;com.atomikos.icatch.imp.TransactionServiceImp&quot;, method = &quot;setTidToTx&quot;)
    public static void onSetTidToTx(String tid) {
        long millis = BTraceUtils.timeMillis();
        String threadName = BTraceUtils.Threads.name(BTraceUtils.currentThread());
        String str = BTraceUtils.strcat(BTraceUtils.str(millis), &quot; - [&quot;);
        str = BTraceUtils.strcat(str, BTraceUtils.str(threadName));
        str = BTraceUtils.strcat(str, &quot;] - com.atomikos.icatch.imp.TransactionServiceImp.setTidToTx(&quot;);
        str = BTraceUtils.strcat(str, BTraceUtils.str(tid));
        str = BTraceUtils.strcat(str, &quot;)&quot;);
        BTraceUtils.println(BTraceUtils.str(str));
    }
}
</code></pre>

<p>上面代码意思是在<code>com.atomikos.util.UniqueIdMgr.get()</code>方法上面进行跟踪返回值，要跟踪赶回值必须要加<code>@Location(Kind.RETURN))</code>,才能使用参数的<code>@Return</code></p>

<p>如果要使用方法参数，可以在脚本方法上直接写跟踪的原始方法参数并且类型保持一样，例如：</p>

<pre><code>package com.btrace;
//需要跟踪的类
public class RemoteClass {

    public String f1(String a, int b) {
        System.out.println(a + &quot; &quot; + b);
        return a;
    }
}

//btrace脚本
@BTrace public class HelloBtrace {

  @OnMethod(
    clazz=&quot;com.btrace.RemoteClass&quot;,
    method=&quot;f1&quot;
  ) 
  public static void onF1() {
    println(&quot;Hello BTrace&quot;);
  }

  @OnMethod(
    clazz=&quot;com.btrace.RemoteClass&quot;,
    method=&quot;f1&quot;
  ) 
  public static void onF2(String a,int b) {
    println(str(a));
    println(str(b));
    println(&quot;&quot;);
  }
}
</code></pre>

<h2 id="注意事项">注意事项</h2>

<ol>
<li>脚本中方法参数需要跟原方法参数类型保持一致</li>
<li>脚本中不允许使用除btrace之外的类，拼接字符串使用<code>BTraceUtils.strcat()</code>,打印使用<code>BTraceUtils.println()</code>,获取线程使用<code>BTraceUtils.Threads</code></li>
<li><span style="color:red"><strong>BTrace植入过的代码，会一直在，直到应用重启为止。所以即使Btrace退出了，业务函数每次执行时都会执行Btrace植入的代码</strong></span></li>
</ol>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/39-btrace/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/38-activemq-slow-speed/">ActiveMQ发送速度慢问题排查</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-11-09T17:00:36.000&#43;00:00' itemprop="datePublished">2017-11-09</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/activemq">activemq</a>

<a href="https://ningyu1.github.io/site/tags/activemq-slow-speed">activemq slow speed</a>


</div>
    </div>
        

<h1 id="目录">目录：</h1>

<ol>
<li><a href="#sync-async-problem">关于使用发送消息给activemq的同步/异步发送问题需要注意</a></li>
<li><a href="#sync-async-scene">同步/异步发送使用场景</a></li>
<li><a href="#maxconnections">maxConnections配置问题注意事项</a></li>
<li><a href="#idletimeout">idleTimeout配置问题注意事项</a></li>
<li><a href="#failover">关于Failover的问题</a></li>
</ol>

<h2 id="a-name-sync-async-problem-关于使用发送消息给activemq的同步-异步发送问题需要注意-a"><a name="sync-async-problem">关于使用发送消息给activemq的同步/异步发送问题需要注意</a></h2>

<p>activemq发送异步参数：useAsyncSend与发送超时参数：sendTimeout是存在冲突的，
1. 当useAsyncSend=true，没有sendTimeout参数时（sendTimeout默认值0秒），走异步发送
2. 当useAsyncSend=false，没有sendTimeout参数时（sendTimeout默认值0秒），走同步发送
3. 当useAsyncSend=true，sendTimeout=1000，优先根据sendTimeout参数走同步发送</p>

<h2 id="a-name-sync-async-scene-同步-异步发送使用场景-a"><a name="sync-async-scene">同步/异步发送使用场景</a></h2>

<p>场景一：业务可以容忍消息丢失（日志记录）这样的场景使用：
使用：异步发送
配置：useAsyncSend=true，sendTimeout不配置（sendTimeout默认值0秒）
注意：可以不需要补偿机制</p>

<p>场景二：业务不能容忍消息丢失，这样的场景使用：
使用1：异步发送
配置1：useAsyncSend=true，sendTimeout不配置（sendTimeout默认值0秒）
注意1：当异步发送消息失败或异常导致消息丢失时有补偿的做法（如：定时任务、重发消息、等）
使用2：同步发送
配置2：useAsyncSend=false（useAsyncSend默认值false），sendTimeout=2000（超时时间一定要配置）
注意2：可以不需要补偿机制</p>

<p>场景三：业务必须将消息发送和jdbc事务放在一个事务内，保证数据的强一致性，这样的场景使用：
使用：同步发送
配置：useAsyncSend=false（useAsyncSend默认值false），sendTimeout=2000（超时时间一定要配置）
注意：消息发送的超时时间（sendTimeout）&lt; jdbc事务超时时间</p>

<p>禁止使用的配置：
配置：useAsyncSend=false（useAsyncSend默认值false），sendTimeout不配置（sendTimeout默认值0秒）
注意：上面不配置超时时间的同步发送会造成请求阻塞在这里。</p>

<h2 id="a-name-maxconnections-maxconnections配置问题注意事项-a"><a name="maxconnections">maxConnections配置问题注意事项</a></h2>

<p>根据activemq的连接池实现代码，发现maxconnections不适合设置很大，除非并发非常高的情况下，因为现在activemq创建一个连接平均在1-2秒钟左右，根据activemq的连接实现发现</p>

<pre><code>if (getConnectionsPool().getNumIdle(key) &lt; getMaxConnections()) {
            try {
                connectionsPool.addObject(key);
                connection = mostRecentlyCreated.getAndSet(null);
                connection.incrementReferenceCount();
            } catch (Exception e) {
                throw createJmsException(&quot;Error while attempting to add new Connection to the pool&quot;, e);
            }
        } else {
            try {
                // We can race against other threads returning the connection when there is an
                // expiration or idle timeout.  We keep pulling out ConnectionPool instances until
                // we win and get a non-closed instance and then increment the reference count
                // under lock to prevent another thread from triggering an expiration check and
                // pulling the rug out from under us.
                while (connection == null) {
                    connection = connectionsPool.borrowObject(key);
                    synchronized (connection) {
                        if (connection.getConnection() != null) {
                            connection.incrementReferenceCount();
                            break;
                        }
                        // Return the bad one to the pool and let if get destroyed as normal.
                        connectionsPool.returnObject(key, connection);
                        connection = null;
                    }
                }
            } catch (Exception e) {
                throw createJmsException(&quot;Error while attempting to retrieve a connection from the pool&quot;, e);
            }
            try {
                connectionsPool.returnObject(key, connection);
            } catch (Exception e) {
                throw createJmsException(&quot;Error when returning connection to the pool&quot;, e);
            }
        }
</code></pre>

<p>当MaxConnections设置的很大的时候，会在发消息的时候一直判断池子中数量是否达到最大值，如果小于最大值再创建一个新的连接放入池子，这样就会前面发送消息的动作都会创建连接从而发送时间会增长。
比如：MaxConnections=20，发送消息50次，前20次都会去创建连接并且发送，后面30次会去复用连接池内的连接</p>

<h2 id="a-name-idletimeout-idletimeout配置问题注意事项-a"><a name="idletimeout">idleTimeout配置问题注意事项</a></h2>

<p>空闲时间配置问题，activemq默认idleTimeout=30秒，activemq开启failover的话它的连接创建时间相对较长，因此建议这个时间设置大一些，尽量不要让超时清空掉，提高复用率</p>

<h2 id="a-name-failover-关于failover的问题-a"><a name="failover">关于Failover的问题</a></h2>

<p>activemq开启failover策略会根据配置的连接串中的tpc ip按顺序迭代去检测可用来创建连接，当可用的连接排在第一个的时候他的创建连接时间相比可用连接排在后面的时间短一些。
但是我们现在单个连接的时间耗时确实很高，这个问题不太清楚具体是什么问题，如下是创建连接耗时日志：
不开启failover的日志</p>

<pre><code>耗时0：945ms
耗时1：1040ms
耗时2：595ms
耗时3：853ms
耗时4：716ms
耗时5：0ms
耗时6：0ms
耗时7：0ms
</code></pre>

<p>开启failover，可用连接排在第一位置，的日志</p>

<pre><code>耗时0：2689ms
2017-11-03 18:47:20.599 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时1：1944ms
2017-11-03 18:47:22.615 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时2：1968ms
2017-11-03 18:47:24.724 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时3：2079ms
2017-11-03 18:47:25.318 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时4：608ms
耗时5：0ms
耗时6：0ms
耗时7：0ms
</code></pre>

<p>开启failover，可用连接排在最后的位置，的日志</p>

<pre><code>耗时0：1960ms
2017-11-03 18:49:14.991 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时1：2084ms
2017-11-03 18:49:16.661 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时2：1775ms
2017-11-03 18:49:17.397 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时3：708ms
2017-11-03 18:49:18.066 [ActiveMQ Task-1] INFO  o.a.activemq.transport.failover.FailoverTransport - Successfully connected to tcp://10.51.232.238:61616
耗时4：864ms
耗时5：3ms
耗时6：0ms
耗时7：0ms
</code></pre>

<p>以上创建连接包括vpn加密的过程，可能会影响时间。
<span style="color:red"><strong>ps.前五个是创建连接，因为我配置的5个连接数，后面都是连接复用，异步发送</strong></span></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/38-activemq-slow-speed/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/37-concurrency-idempotent/">并发与幂等性</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-11-06T17:40:36.000&#43;00:00' itemprop="datePublished">2017-11-06</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/concurrency">concurrency</a>

<a href="https://ningyu1.github.io/site/tags/idempotent">idempotent</a>


</div>
    </div>
        <p>文章来源：<a href="https://my.oschina.net/wangen2009/blog/1560975">https://my.oschina.net/wangen2009/blog/1560975</a>
作者：@码代码的小司机</p>

<p><img src="https://ningyu1.github.io/site/img/concurrency/1.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/2.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/3.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/4.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/5.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/6.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/7.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/8.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/9.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/10.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/11.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/12.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/13.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/14.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/15.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/16.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/17.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/18.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/19.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/20.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/21.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/22.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/23.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/24.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/25.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/26.jpg" alt="" />
<img src="https://ningyu1.github.io/site/img/concurrency/27.jpg" alt="" /></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/37-concurrency-idempotent/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/36-atomikos-transactions-trouble/">atomikos jta(xa) transaction问题：Already mapped: xxxx</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-11-02T15:52:36.000&#43;00:00' itemprop="datePublished">2017-11-02</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/atomikos">atomikos</a>

<a href="https://ningyu1.github.io/site/tags/transaction">transaction</a>

<a href="https://ningyu1.github.io/site/tags/jta-xa">jta xa</a>

<a href="https://ningyu1.github.io/site/tags/already-mapped">Already mapped</a>


</div>
    </div>
        

<h1 id="目录">目录：</h1>

<ol>
<li><a href="#trouble">问题现象</a></li>
<li><a href="#troubleshooting">问题分析</a></li>
<li><a href="#validation">修改验证</a></li>
<li><a href="#solutions">解决方案</a></li>
<li><a href="#summed">总结</a></li>
</ol>

<h2 id="a-name-trouble-问题现象-a"><a name="trouble">问题现象</a></h2>

<p>库存中心在压测过程中会时不时的报错，错误如下：</p>

<pre><code>2017-11-02 11:38:37.620 [DubboServerHandler-10.27.69.168:20888-thread-156] ERROR xx.xx.inv.service.impl.OptionApiImpl - java.lang.IllegalStateException: Already mapped: 10.27.69.168.tm150959391756909559
xx.xx.exception.BizException: java.lang.IllegalStateException: Already mapped: 10.27.69.168.tm150959391756909559
        at xx.xx.inv.service.impl.OptionApiImpl.invWmsOption(OptionApiImpl.java:290) ~[inv-api-impl-1.0.1-SNAPSHOT.jar:na]
        at com.alibaba.dubbo.common.bytecode.Wrapper1.invokeMethod(Wrapper1.java) [na:2.5.3]
        at com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory$1.doInvoke(JavassistProxyFactory.java:46) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker.invoke(AbstractProxyInvoker.java:72) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.InvokerWrapper.invoke(InvokerWrapper.java:53) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.AccessLogFilter.invoke(AccessLogFilter.java:199) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.ExceptionFilter.invoke(ExceptionFilter.java:64) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.TimeoutFilter.invoke(TimeoutFilter.java:42) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.monitor.support.MonitorFilter.invoke(MonitorFilter.java:75) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.dubbo.filter.TraceFilter.invoke(TraceFilter.java:78) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.ContextFilter.invoke(ContextFilter.java:60) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.GenericFilter.invoke(GenericFilter.java:112) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.ClassLoaderFilter.invoke(ClassLoaderFilter.java:38) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.filter.EchoFilter.invoke(EchoFilter.java:38) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper$1.invoke(ProtocolFilterWrapper.java:91) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol$1.reply(DubboProtocol.java:108) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.handleRequest(HeaderExchangeHandler.java:84) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandler.received(HeaderExchangeHandler.java:170) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.remoting.transport.DecodeHandler.received(DecodeHandler.java:52) [dubbo-2.5.3.jar:2.5.3]
        at com.alibaba.dubbo.remoting.transport.dispatcher.ChannelEventRunnable.run(ChannelEventRunnable.java:82) [dubbo-2.5.3.jar:2.5.3]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_79]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_79]
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_79]
Caused by: java.lang.IllegalStateException: Already mapped: 10.27.69.168.tm150959391756909559
        at com.atomikos.icatch.imp.TransactionServiceImp.setTidToTx(TransactionServiceImp.java:191) ~[transactions-4.0.0.jar:na]
        at com.atomikos.icatch.imp.TransactionServiceImp.createCT(TransactionServiceImp.java:277) ~[transactions-4.0.0.jar:na]
        at com.atomikos.icatch.imp.TransactionServiceImp.createCompositeTransaction(TransactionServiceImp.java:783) ~[transactions-4.0.0.jar:na]
        at com.atomikos.icatch.imp.CompositeTransactionManagerImp.createCompositeTransaction(CompositeTransactionManagerImp.java:393) ~[transactions-4.0.0.jar:na]
        at com.atomikos.icatch.jta.TransactionManagerImp.begin(TransactionManagerImp.java:271) ~[transactions-jta-4.0.0.jar:na]
        at com.atomikos.icatch.jta.TransactionManagerImp.begin(TransactionManagerImp.java:249) ~[transactions-jta-4.0.0.jar:na]
        at com.atomikos.icatch.jta.UserTransactionImp.begin(UserTransactionImp.java:72) ~[transactions-jta-4.0.0.jar:na]
        at org.springframework.transaction.jta.JtaTransactionManager.doJtaBegin(JtaTransactionManager.java:874) ~[spring-tx-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.transaction.jta.JtaTransactionManager.doBegin(JtaTransactionManager.java:831) ~[spring-tx-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction(AbstractPlatformTransactionManager.java:373) ~[spring-tx-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.transaction.interceptor.TransactionAspectSupport.createTransactionIfNecessary(TransactionAspectSupport.java:447) ~[spring-tx-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:277) ~[spring-tx-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:96) ~[spring-tx-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:179) ~[spring-aop-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:656) ~[spring-aop-4.3.6.RELEASE.jar:4.3.6.RELEASE]
        at xx.xx.inv.service.impl.VoucherExecutor$$EnhancerBySpringCGLIB$$a5e2dd9c.doWms(&lt;generated&gt;) ~[inv-api-impl-1.0.1-SNAPSHOT.jar:na]
        at xx.xx.inv.service.impl.OptionApiImpl.invWmsOption(OptionApiImpl.java:286) ~[inv-api-impl-1.0.1-SNAPSHOT.jar:na]
        ... 30 common frames omitted
</code></pre>

<h2 id="a-name-troubleshooting-问题分析-a"><a name="troubleshooting">问题分析</a></h2>

<p>跟踪源码：com.atomikos.icatch.imp.TransactionServiceImp.setTidToTx()</p>

<pre><code>private void setTidToTx ( String tid , CompositeTransaction ct )
        throws IllegalStateException
{
    synchronized ( tidToTransactionMap_ ) {
        if ( tidToTransactionMap_.containsKey ( tid.intern () ) )
            throw new IllegalStateException ( &quot;Already mapped: &quot; + tid );
        tidToTransactionMap_.put ( tid.intern (), ct );
        ct.addSubTxAwareParticipant(this); // for GC purposes
    }
}
</code></pre>

<p>发现在tidToTransactionMap_中存在tid重复的情况，这个方法判断如果出现重复报：Already mapped: ${tid}，继续跟踪找到tid生成的地方</p>

<pre><code>public CompositeTransaction createCompositeTransaction ( long timeout ) throws SysException
{
    if ( !initialized_ ) throw new IllegalStateException ( &quot;Not initialized&quot; );
    if ( maxNumberOfActiveTransactions_ &gt;= 0 &amp;&amp;
         tidToTransactionMap_.size () &gt;= maxNumberOfActiveTransactions_ ) {
        throw new IllegalStateException ( &quot;Max number of active transactions reached:&quot; + maxNumberOfActiveTransactions_ );
    }
     
    String tid = tidmgr_.get ();
    Stack&lt;CompositeTransaction&gt; lineage = new Stack&lt;CompositeTransaction&gt;();
    // create a CC with heuristic preference set to false,
    // since it does not really matter anyway (since we are
    // creating a root)
    CoordinatorImp cc = createCC ( null, tid, true, false, timeout );
    CompositeTransaction ct = createCT ( tid, cc, lineage, false );
    return ct;
}
</code></pre>

<p>tid是通过tidmgr_.get ();这个东西生成的，那我们进去看一下生成的代码具体是什么？</p>

<pre><code>private final static int MAX_LENGTH_OF_NUMERIC_SUFFIX = 8 + 5;
private final static int MAX_COUNTER_WITHIN_SAME_MILLIS = 32000;
 
 
private final String commonPartOfId; //name of server
private int lastcounter;
 
public String get()
{
    incrementAndGet();
    StringBuffer buffer = new StringBuffer();
    return buffer.append(commonPartOfId).
                  append(System.currentTimeMillis()).
                  append(getCountWithLeadingZeroes ( lastcounter )).
                  toString() ;
}
 
private synchronized void incrementAndGet() {
    lastcounter++;
    if (lastcounter == MAX_COUNTER_WITHIN_SAME_MILLIS) lastcounter = 0;
}
</code></pre>

<p>那极其有可能get的时候在极端的情况下生成的id是相同的，incrementAndGet方法是synchronized 理论上不会有并发问题，但是lastcounter这个属性不是支持并发的对象，在get方法中先调用同步方法incrementAndGet对属性lastcounter++，后面buffer在append的时候直接使用的是属性lastcounter属性的值，很有可能问题就出在这里，那让我们使用btrace验证一下。</p>

<p>通过btrace对get方法拦截验证发现确实在极端的情况下会有多个线程生成同一个tid，如下：</p>

<pre><code>[DubboServerHandler-10.27.69.168:20888-thread-177] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391749109556
[DubboServerHandler-10.27.69.168:20888-thread-156] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391749509557
[DubboServerHandler-10.27.69.168:20888-thread-156] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391756909559
[DubboServerHandler-10.27.69.168:20888-thread-177] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391756909559
[DubboServerHandler-10.27.69.168:20888-thread-155] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391780109560
[DubboServerHandler-10.27.69.168:20888-thread-155] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391786909561
[DubboServerHandler-10.27.69.168:20888-thread-112] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391791609562
[DubboServerHandler-10.27.69.168:20888-thread-197] - com.atomikos.util.UniqueIdMgr.get()--&gt;10.27.69.168.tm150959391794109563
</code></pre>

<p>出现了两个tm150959391756909559，那就能断定肯定是这块出问题，那如何解决呢?</p>

<p>首先查看我们使用的atomikos transaction的版本号 – &gt; 4.0.0</p>

<p>去maven官服上搜索transaction的版本信息:<a href="http://mvnrepository.com/artifact/com.atomikos/atomikos-util" title="maven repostory">http://mvnrepository.com/artifact/com.atomikos/atomikos-util</a></p>

<p><img src="https://ningyu1.github.io/site/img/atomikos-transactions/1.png" alt="1.png" /></p>

<p>看来有更高的版本，那我们下载一个版本看一下get的代码是否发生了变化，我们从4.0.1版本开始查看。</p>

<pre><code>public String get()
{
  StringBuffer buffer = new StringBuffer();
  String id = this.commonPartOfId + System.currentTimeMillis() + getCountWithLeadingZeroes(incrementAndGet());
  return id;
}
 
private synchronized int incrementAndGet()
{
  this.lastcounter += 1;
  if (this.lastcounter == 32000) {
    this.lastcounter = 0;
  }
  return this.lastcounter;
}
</code></pre>

<p>从上面代码可以发现跟4.0.0的代码是有变化的</p>

<p><span style="color:red"><strong>一、4.0.0版本在incrementAndGet方法同步的对lastcounter++之后，在拼接id的时候是直接使用属性lastcounter进行拼接</strong></span>
<span style="color:red"><strong>二、4.0.1版本在incrementAndGet方法同步的对lastcounter++之后直接将lastcounter值返回，在拼接的时候使用返回的lastcounter值来进行拼接</strong></span></p>

<p>从代码上看好像是为了解决这个问题，那我们还需要进一步验证</p>

<p>首先先找到官方的chang log看是否有明确的版本升级描述中fixed并发tid的bug，翻atomikos的<a href="https://www.atomikos.com/Blog/ExtremeTransactions4dot0dot1">官网站点</a></p>

<p><img src="https://ningyu1.github.io/site/img/atomikos-transactions/2.png" alt="2.png" /></p>

<p>功夫不负有心人找到了fixed记录，接下来就需要升级程序然后再进行实际压测过程去校验是否真的解决了这个问题</p>

<h2 id="a-name-validation-修改验证-a"><a name="validation">修改验证</a></h2>

<p>升级atomikos transactions版本–&gt;4.0.1,打包程序发布进行压力测试
压测场景：
4个仓，一个仓10个线程，一个线程2000单，一单2个商品，一个商品6个sku
<span style="color:red"><strong>压测后再没有Already mapped: xxxx的错误爆出，库存扣除也是正确的。</strong></span></p>

<h2 id="a-name-solutions-解决方案-a"><a name="solutions">解决方案</a></h2>

<p><span style="color:red"><strong>升级atomikos transactions版本–&gt;4.0.1</strong></span></p>

<h2 id="a-name-summed-总结-a"><a name="summed">总结</a></h2>

<p>在使用任何第三方框架都是存在风险，就看如何进行权衡，出现问题能否hold的住，当出现由于使用第三方框架带来的问题时。
1. 首先要彻底的分析出问题的原因
2. 其次就去社区或者官网或者问作者是否bug已经fixed。
3. 上面的都尝试之后如果还不能解决，要么寻找替换方案，要么修改源码。
<span style="color:red"><strong>能使用官网升级的版本解决问题尽量升级版本解决，第三步的方法虽然不推荐，但是在特定的环境也是一个兜底的方案。</strong></span></p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/36-atomikos-transactions-trouble/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/35-datasource-connection-leak/">数据源连接泄漏问题分析</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-10-26T13:29:36.000&#43;00:00' itemprop="datePublished">2017-10-26</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/abandon-connection">abandon connection</a>

<a href="https://ningyu1.github.io/site/tags/connection-leak">connection leak</a>

<a href="https://ningyu1.github.io/site/tags/datasource">datasource</a>


</div>
    </div>
        

<h1 id="目录">目录：</h1>

<ol>
<li><a href="#trouble">问题现象</a></li>
<li><a href="#troubleshooting">问题分析</a></li>
<li><a href="#validation">修改验证</a></li>
<li><a href="#solutions">解决方案</a></li>
<li><a href="#summed">总结</a></li>
</ol>

<h2 id="a-name-trouble-问题现象-a"><a name="trouble">问题现象</a></h2>

<p>开启druid数据源的连接泄漏开关（removeAbandoned=true），设置强制回收非法连接的超时时间为120（removeAbandonedTimeout=120,2分钟，目的是调试方便，让非法连接快速close掉）。
启动程序，等待2分钟会有连接泄漏的异常爆出，具体日志如下：</p>

<pre><code>2017-10-25 17:19:52.858 [qtp365976330-72] WARN  org.jasig.cas.client.session.SingleSignOutHandler - Front Channel single sign out redirects are disabled when the 'casServerUrlPrefix' value is not set.
2017-10-25 17:21:56.531 [Druid-ConnectionPool-Destroy-678372234] ERROR com.alibaba.druid.pool.DruidDataSource - abandon connection, open stackTrace
    at java.lang.Thread.getStackTrace(Thread.java:1588)
    at com.alibaba.druid.pool.DruidDataSource.getConnectionDirect(DruidDataSource.java:995)
    at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:4544)
    at com.alibaba.druid.filter.FilterAdapter.dataSource_getConnection(FilterAdapter.java:2723)
    at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:4540)
    at com.alibaba.druid.filter.stat.StatFilter.dataSource_getConnection(StatFilter.java:661)
    at com.alibaba.druid.filter.FilterChainImpl.dataSource_connect(FilterChainImpl.java:4540)
    at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:919)
    at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:911)
    at com.alibaba.druid.pool.DruidDataSource.getConnection(DruidDataSource.java:98)
    at com.github.pagehelper.PageHelper.initSqlUtil(PageHelper.java:165)
    at com.github.pagehelper.PageHelper.intercept(PageHelper.java:148)
    at org.apache.ibatis.plugin.Plugin.invoke(Plugin.java:60)
    at com.sun.proxy.$Proxy64.query(Unknown Source)
    at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:108)
    at org.apache.ibatis.session.defaults.DefaultSqlSession.selectList(DefaultSqlSession.java:102)
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:606)
    at org.mybatis.spring.SqlSessionTemplate$SqlSessionInterceptor.invoke(SqlSessionTemplate.java:358)
    at com.sun.proxy.$Proxy57.selectList(Unknown Source)
    at org.mybatis.spring.SqlSessionTemplate.selectList(SqlSessionTemplate.java:198)
    at com.xx.xx.xx.mybatis.MyBatisDao.selectList(MyBatisDao.java:391)
    at com.xx.xx.xx.xx.xx.xx.XXDaoImpl.queryByDeliverCode(XXDaoImpl.java:158)
    at com.xx.xx.xx.xx.xx.xx.XXServiceImpl.queryByDeliverCode(XXServiceImpl.java:159)
    at com.xx.xx.xx.xx.xx.xx.XXServiceImpl$$FastClassByCGLIB$$41eff1cc.invoke(&lt;generated&gt;)
    at org.springframework.cglib.proxy.MethodProxy.invoke(MethodProxy.java:204)
    at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:642)
    at com.xx.xx.xx.xx.xx.xx.XXServiceImpl$$EnhancerByCGLIB$$708c18f3.queryByDeliverCode(&lt;generated&gt;)
    at com.xx.xx.xx.xx.xx.XXController.initId(XXController.java:168)
    at com.xx.xx.xx.xx.xx.XXController.afterPropertiesSet(XXController.java:2080)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.invokeInitMethods(AbstractAutowireCapableBeanFactory.java:1612)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1549)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:539)
    at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:475)
    at org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:304)
    at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:228)
    at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:300)
    at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:195)
    at org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:700)
    at org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:760)
    at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:482)
    at org.springframework.web.context.ContextLoader.configureAndRefreshWebApplicationContext(ContextLoader.java:381)
    at org.springframework.web.context.ContextLoader.initWebApplicationContext(ContextLoader.java:293)
    at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:106)
    at com.bstek.dorado.web.servlet.SpringContextLoaderListener.contextInitialized(SpringContextLoaderListener.java:73)
    at org.eclipse.jetty.server.handler.ContextHandler.callContextInitialized(ContextHandler.java:782)
    at org.eclipse.jetty.servlet.ServletContextHandler.callContextInitialized(ServletContextHandler.java:424)
    at org.eclipse.jetty.server.handler.ContextHandler.startContext(ContextHandler.java:774)
    at org.eclipse.jetty.servlet.ServletContextHandler.startContext(ServletContextHandler.java:249)
    at org.eclipse.jetty.webapp.WebAppContext.startContext(WebAppContext.java:1242)
    at org.eclipse.jetty.server.handler.ContextHandler.doStart(ContextHandler.java:717)
    at org.eclipse.jetty.webapp.WebAppContext.doStart(WebAppContext.java:494)
    at org.eclipse.jetty.util.component.AbstractLifeCycle.start(AbstractLifeCycle.java:64)
    at org.eclipse.jetty.server.handler.HandlerWrapper.doStart(HandlerWrapper.java:95)
    at org.eclipse.jetty.server.Server.doStart(Server.java:282)
    at org.eclipse.jetty.util.component.AbstractLifeCycle.start(AbstractLifeCycle.java:64)
    at net.sourceforge.eclipsejetty.starter.embedded.JettyEmbeddedAdapter.start(JettyEmbeddedAdapter.java:67)
    at net.sourceforge.eclipsejetty.starter.common.AbstractJettyLauncherMain.launch(AbstractJettyLauncherMain.java:84)
    at net.sourceforge.eclipsejetty.starter.embedded.JettyEmbeddedLauncherMain.main(JettyEmbeddedLauncherMain.java:42)
</code></pre>

<h2 id="a-name-troubleshooting-问题分析-a"><a name="troubleshooting">问题分析</a></h2>

<p>断点调试com.alibaba.druid.pool.DruidDataSource与com.alibaba.druid.pool.DruidPooledConnection中的close方法均有调用，如果都有关闭的话那怎么还会有连接泄漏呢？肯定有地方不对劲，因此进一步查询，开启druid的管理页面查看连接数，如下</p>

<p><img src="https://ningyu1.github.io/site/img/connection-leak/1.png" alt="1.png" /></p>

<p>逻辑连接打开次数132，逻辑连接关闭次数131，发现问题有一个连接是没有放回连接池的，当到2分钟报了连接泄漏异常后再刷新查看，如下：</p>

<p><img src="https://ningyu1.github.io/site/img/connection-leak/2.png" alt="2.png" /></p>

<p>逻辑连接打开次数和关闭次数一致了。</p>

<p>于是从上面的错误日志跟踪代码，第一感觉就是自己的业务代码出现了问题，找到业务代码的地方</p>

<pre><code>at com.xx.xx.xx.xx.xx.xx.XXDaoImpl.queryByDeliverCode(XXDaoImpl.java:158)
at com.xx.xx.xx.xx.xx.xx.XXServiceImpl.queryByDeliverCode(XXServiceImpl.java:159)
at com.xx.xx.xx.xx.xx.xx.XXServiceImpl$$FastClassByCGLIB$$41eff1cc.invoke(&lt;generated&gt;)
</code></pre>

<p>打开：XXServiceImpl.queryByDeliverCode代码第159行，代码如下：</p>

<pre><code>@Override
public DeliverEntity queryByDeliverCode(String code) {
    return deliverDao.queryByDeliverCode(code);
}
</code></pre>

<p>代码非常简单调用dao的方法，代开dao的queryByDeliverCode方法，代码如下：</p>

<pre><code>@Override
public DeliverEntity queryByDeliverCode(String deliverCode) {
    Map&lt;String,Object&gt; map=new HashMap&lt;String,Object&gt;();
    map.put(&quot;deliverCode&quot;, deliverCode);
    List&lt;DeliverEntity&gt; list = selectList(&quot;com.xx.xx.xx.xx.xx.XXMapper.queryByDeliverCode&quot;, map);
    return list.size() &gt; 0 ? list.get(0) : null;
}
</code></pre>

<p>代码也非常简单调用的是基类：MybatisDao的selectList方法，代码如下：</p>

<pre><code>public List&lt;E&gt; selectList(final String aStatement, final Map&lt;String, Object&gt; aCondition) {
    SqlSession session = getSqlSessionTemplate();
    return session.selectList(aStatement, aCondition);
}
</code></pre>

<p>就是调用sqlsession的selectList方法，这个没有问题，连接是可以正常回收的，如果不能回收那上面的数字不可能是只有1个连接泄漏，应该是逻辑打开的132个都没有关闭才对。因此排除了这个地方，那还有什么地方会有问题呢？
肯定是有地方getConnection之后没有close导致!
继续分析连接泄漏打出来的日志！日志中的代码逐个分析，最终找到PageHelper.initSqlUtil方法</p>

<pre><code>at com.github.pagehelper.PageHelper.initSqlUtil(PageHelper.java:165)
at com.github.pagehelper.PageHelper.intercept(PageHelper.java:148)
</code></pre>

<p>打开PageHelper.initSqlUtil代码，如下：</p>

<pre><code>public synchronized void initSqlUtil(Invocation invocation) {
       if (sqlUtil == null) {
            String url = null;
            try {
                MappedStatement ms = (MappedStatement) invocation.getArgs()[0];
                MetaObject msObject = SystemMetaObject.forObject(ms);
                DataSource dataSource = (DataSource) msObject.getValue(&quot;configuration.environment.dataSource&quot;);
                url = dataSource.getConnection().getMetaData().getURL();
            } catch (SQLException e) {
                throw new RuntimeException(&quot;分页插件初始化异常:&quot; + e.getMessage());
            }
            if (url == null || url.length() == 0) {
                throw new RuntimeException(&quot;无法自动获取jdbcUrl，请在分页插件中配置dialect参数!&quot;);
            }
            String dialect = Dialect.fromJdbcUrl(url);
            if (dialect == null) {
                throw new RuntimeException(&quot;无法自动获取数据库类型，请通过dialect参数指定!&quot;);
            }
            sqlUtil = new SqlUtil(dialect);
            sqlUtil.setProperties(properties);
            properties = null;
            autoDialect = false;
       }
}
</code></pre>

<p>貌似问题找到了，第8行代码：dataSource.getConnection()，但是没有在finally中对connection进行回收，罪魁祸首竟然是PageHelper</p>

<pre><code>public Object intercept(Invocation invocation) throws Throwable {
    if (autoDialect) {
        initSqlUtil(invocation);
    }
    return sqlUtil.processPage(invocation);
}
</code></pre>

<p>根据代码逻辑发现当autoDialect=true时会调用initSqlUtil(invocation);，因此核对了我们的配置mybatis-config.xml</p>

<pre><code>&lt;plugins&gt;
        &lt;!-- com.github.pagehelper为PageHelper类所在包名 --&gt;
        &lt;plugin interceptor=&quot;com.github.pagehelper.PageHelper&quot;&gt;
&lt;!--             &lt;property name=&quot;dialect&quot; value=&quot;mysql&quot; /&gt; --&gt;
             
            &lt;property name=&quot;autoDialect&quot; value=&quot;true&quot; /&gt;
             
            &lt;!-- 该参数默认为false --&gt;
            &lt;!-- 设置为true时，会将RowBounds第一个参数offset当成pageNum页码使用 --&gt;
            &lt;!-- 和startPage中的pageNum效果一样 --&gt;
            &lt;property name=&quot;offsetAsPageNum&quot; value=&quot;true&quot; /&gt;
            &lt;!-- 该参数默认为false --&gt;
            &lt;!-- 设置为true时，使用RowBounds分页会进行count查询 --&gt;
            &lt;property name=&quot;rowBoundsWithCount&quot; value=&quot;true&quot; /&gt;
            &lt;!-- 设置为true时，如果pageSize=0或者RowBounds.limit = 0就会查询出全部的结果 --&gt;
            &lt;!-- （相当于没有执行分页查询，但是返回结果仍然是Page类型） --&gt;
            &lt;property name=&quot;pageSizeZero&quot; value=&quot;true&quot; /&gt;
            &lt;!-- 3.3.0版本可用 - 分页参数合理化，默认false禁用 --&gt;
            &lt;!-- 启用合理化时，如果pageNum&lt;1会查询第一页，如果pageNum&gt;pages会查询最后一页 --&gt;
            &lt;!-- 禁用合理化时，如果pageNum&lt;1或pageNum&gt;pages会返回空数据 --&gt;
            &lt;property name=&quot;reasonable&quot; value=&quot;false&quot; /&gt;
            &lt;!-- 3.5.0版本可用 - 为了支持startPage(Object params)方法 --&gt;
            &lt;!-- 增加了一个`params`参数来配置参数映射，用于从Map或ServletRequest中取值 --&gt;
            &lt;!-- 可以配置pageNum,pageSize,count,pageSizeZero,reasonable,不配置映射的用默认值 --&gt;
            &lt;!-- 不理解该含义的前提下，不要随便复制该配置 --&gt;
            &lt;property name=&quot;params&quot; value=&quot;pageNum=start;pageSize=limit;&quot; /&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
</code></pre>

<p>我们果然配置的是：autoDialect=true，PageHelper在没有设置数据库方言的时候，他会主动的获取jdbc url来判断时那种数据库，因此会发生有一个连接是泄漏的，那这个问题如何解决呢？
我们打开PageHelper.setProperties方法，如下：</p>

<pre><code>public void setProperties(Properties p) {
    //MyBatis3.2.0版本校验
    try {
        Class.forName(&quot;org.apache.ibatis.scripting.xmltags.SqlNode&quot;);//SqlNode是3.2.0之后新增的类
    } catch (ClassNotFoundException e) {
        throw new RuntimeException(&quot;您使用的MyBatis版本太低，MyBatis分页插件PageHelper支持MyBatis3.2.0及以上版本!&quot;);
    }
    //数据库方言
    String dialect = p.getProperty(&quot;dialect&quot;);
    if (dialect == null || dialect.length() == 0) {
        autoDialect = true;
        this.properties = p;
    } else {
        autoDialect = false;
        sqlUtil = new SqlUtil(dialect);
        sqlUtil.setProperties(p);
    }
}
</code></pre>

<p>只要我们在plugin配置的时候设置具体的方言就可以避免这个问题：dialect=mysql，如果有明确的dialect设置，autoDialect就会等于false，因此在intercept方法中就不会走initSqlUtil(invocation);方法，这就间接的避免了PageHelper的这个bug。
但是如果我们的数据源有不同的dialect怎么办呢？有两个办法解决
1. 构造SessionFactory的时候加载不同的mybatis-config.xml配置，如果有两种数据库类型就写两个mybatis-config.xml分别配置不同的dialect
2. 查看PageHelper高版本是否修复了这个bug，升级PageHelper版本
3. 修改PageHelper源码，在dataSource.getConnection()之后增加close调用</p>

<p><strong>ps. 我们现在用的PageHelper版本&ndash;&gt;4.0.0，根据官方的chang log可以看出4.X的版本修复了这个问题，可以升级到4.x的final released version &ndash;&gt; 4.2.1解决这个问题，5.x版本变更比较大。</strong></p>

<h2 id="a-name-validation-修改验证-a"><a name="validation">修改验证</a></h2>

<p>修改mybatis-config.xml的plugin中PageHelper的dialect的配置</p>

<pre><code>&lt;plugin interceptor=&quot;com.github.pagehelper.PageHelper&quot;&gt;
            &lt;property name=&quot;dialect&quot; value=&quot;mysql&quot; /&gt;
&lt;!--             &lt;property name=&quot;autoDialect&quot; value=&quot;true&quot; /&gt; --&gt;
 
&lt;/plugin&gt;
</code></pre>

<p>修改后启动程序，打开druid的管理页面和等待2分钟超时看是否还有泄漏的异常爆出，如下：</p>

<p><img src="https://ningyu1.github.io/site/img/connection-leak/3.png" alt="3.png" /></p>

<p>超过2分钟并没有泄漏异常爆出</p>

<h2 id="a-name-solutions-解决方案-a"><a name="solutions">解决方案</a></h2>

<p>升级pagehelper版本&ndash;&gt;4.2.1,升级jsqlparser版本–&gt;0.9.5,其余配置无需变更</p>

<p><span style="color: rgb(255,0,0);">如果升级了4.2.1，如果出现SqlUtil.java(120)行报NullPointerException，具体异常如下：</span></p>

<p><img src="https://ningyu1.github.io/site/img/connection-leak/4.png" alt="4.png" /></p>

<p><span style="color: rgb(255,0,0);">遇到上面问题，请修改pagehelper的配置参数，参数修改有两种方式，如下：</span></p>

<ol>
<li><span style="color: rgb(255,0,0);">直接配置dialect=目标数据源类型</span><span style="color: rgb(255,204,0);"><strong>（适合使用场景：项目中只有一个固定的数据库类型，例如：mysql，无需开启自动发现dialect）</strong></span></li>
<li><span style="color: rgb(255,0,0);">配置autoRuntimeDialect=true走自动获取，这个属性是替换老属性（autoDialect），老的属性为了向下兼容在并发获取dialect时会有bug存在。</span><span style="color: rgb(255,204,0);"><strong>（适合使用场景：项目中有多个数据库类型，需要运行中自动发现时使用）</strong></span></li>
</ol>

<h2 id="a-name-summed-总结-a"><a name="summed">总结</a></h2>

<p>这个问题告诉我们使用第三方的组件的风险很大。</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/35-datasource-connection-leak/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/34-redis-rdb/">Redis RDB文件格式全解析</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-10-09T14:30:36.000&#43;00:00' itemprop="datePublished">2017-10-09</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/redis">Redis</a>

<a href="https://ningyu1.github.io/site/tags/rdb">RDB</a>


</div>
    </div>
        

<h1 id="点评">点评</h1>

<p>这篇文章作为对RDB理解的教程文章，对RDB文件的原理理解有助于进行Redis高阶应用的设计与开发。</p>

<p>文章转自：<a href="http://blog.nosqlfan.com/html/3734.html">http://blog.nosqlfan.com/html/3734.html</a>
作者：@nosqlfan</p>

<p>RDB文件是Redis持久化的一种方式，Redis通过制定好的策略，按期将内存中的数据以镜像的形式转存到RDB文件中。那么RDB文件内部格式是什么样的呢，Redis又做了哪些工作让RDB能够更快的dump和加载呢，下面我们深入RDB文件，来看一看其内部结构。
首先我们来看一个RDB文件的概况图：</p>

<pre><code>----------------------------# RDB文件是二进制的，所以并不存在回车换行来分隔一行一行.
52 45 44 49 53              # 以字符串 &quot;REDIS&quot; 开头
30 30 30 33                 # RDB 的版本号，大端存储，比如左边这个表示版本号为0003
----------------------------
FE 00                       # FE = FE表示数据库编号，Redis支持多个库，以数字编号，这里00表示第0个数据库
----------------------------# Key-Value 对存储开始了
FD $length-encoding         # FD 表示过期时间，过期时间是用 length encoding 编码存储的，后面会讲到
$value-type                 # 1 个字节用于表示value的类型，比如set,hash,list,zset等
$string-encoded-key         # Key 值，通过string encoding 编码，同样后面会讲到
$encoded-value              # Value值，根据不同的Value类型采用不同的编码方式
----------------------------
FC $length-encoding         # FC 表示毫秒级的过期时间，后面的具体时间用length encoding编码存储
$value-type                 # 同上，也是一个字节的value类型
$string-encoded-key         # 同样是以 string encoding 编码的 Key值
$encoded-value              # 同样是以对应的数据类型编码的 Value 值
----------------------------
$value-type                 # 下面是没有过期时间设置的 Key-Value对，为防止冲突，数据类型不会以 FD, FC, FE, FF 开头
$string-encoded-key
$encoded-value
----------------------------
FE $length-encoding         # 下一个库开始，库的编号用 length encoding 编码
----------------------------
...                         # 继续存储这个数据库的 Key-Value 对
FF                          ## FF：RDB文件结束的标志
</code></pre>

<p>下面我们对上面的内容进行详细讲解</p>

<h2 id="magic-number">Magic Number</h2>

<p>第一行就不用讲了，REDIS字符串用于标识是Redis的RDB文件</p>

<h2 id="版本号">版本号</h2>

<p>用了4个字节存储版本号，以大端（big endian）方式存储和读取</p>

<h2 id="数据库编号">数据库编号</h2>

<p>以一个字节的0xFE开头，后面存储数据库的具体编号，数据库的编号是一个数字，通过 “Length Encoding” 方式编码存储，“Length Encoding” 我们后面会讲到。</p>

<h2 id="key-value值对">Key-Value值对</h2>

<p>值对包括下面四个部分
1. Key 过期时间，这一项是可有可无的
2. 一个字节表示value的类型
3. Key的值，Key都是字符串，通过 “Redis String Encoding” 来保存
4. Value的值，通过 “Redis Value Encoding” 来根据不同的数据类型做不同的存储</p>

<h2 id="key过期时间">Key过期时间</h2>

<p>过期时间由 0xFD 或 0xFC开头用于标识，分别表示秒级的过期时间和毫秒级的过期时间，后面的具体时间是一个UNIX时间戳，秒级或毫秒级的。具体时间戳的值通过“Redis Length Encoding” 编码存储。在导入RDB文件的过程中，会通过过期时间判断是否已过期并需要忽略。</p>

<h2 id="value类型">Value类型</h2>

<p>Value类型用一个字节进行存储，目前包括以下一些值：</p>

<ul>
<li>0 = “String Encoding”</li>
<li>1 = “List Encoding”</li>
<li>2 = “Set Encoding”</li>
<li>3 = “Sorted Set Encoding”</li>
<li>4 = “Hash Encoding”</li>
<li>9 = “Zipmap Encoding”</li>
<li>10 = “Ziplist Encoding”</li>
<li>11 = “Intset Encoding”</li>
<li>12 = “Sorted Set in Ziplist Encoding”</li>
</ul>

<h2 id="key">Key</h2>

<p>Key值就是简单的 “String Encoding” 编码，具体可以看后面的描述</p>

<h2 id="value">Value</h2>

<p>上面列举了Value的9种类型，实际上可以分为三大类</p>

<ul>
<li>type = 0, 简单字符串</li>
<li>type 为  9, 10, 11 或 12, value字符串在读取出来后需要先解压</li>
<li>type 为 1, 2, 3 或 4, value是字符串序列，这一系列的字符串用于构建list，set，hash 和 zset 结构</li>
</ul>

<h2 id="length-encoding">Length Encoding</h2>

<p>上面说了很多 Length Encoding ，现在就为大家讲解。可能你会说，长度用一个int存储不就行了吗？但是，通常我们使用到的长度可能都并不大，一个int 4个字节是否有点浪费呢。所以Redis采用了变长编码的方法，将不同大小的数字编码成不同的长度。</p>

<ol>
<li>首先在读取长度时，会读一个字节的数据，其中前两位用于进行变长编码的判断</li>
<li>如果前两位是 0 0，那么下面剩下的 6位就表示具体长度</li>
<li>如果前两位是 0 1，那么会再读取一个字节的数据，加上前面剩下的6位，共14位用于表示具体长度</li>
<li>如果前两位是 1 0，那么剩下的 6位就被废弃了，取而代之的是再读取后面的4 个字节用于表示具体长度</li>
<li>如果前两位是 1 1，那么下面的应该是一个特殊编码，剩下的 6位用于标识特殊编码的种类。特殊编码主要用于将数字存成字符串，或者编码后的字符串。具体见 “String Encoding”</li>
</ol>

<p>这样做有什么好处呢，实际就是节约空间：</p>

<ol>
<li>0 – 63的数字只需要一个字节进行存储</li>
<li>而64 – 16383 的数字只需要两个字节进行存储</li>
<li>16383 - 2^32 -1 的数字只需要用5个字节（1个字节的标识加4个字节的值）进行存储</li>
</ol>

<h2 id="string-encoding">String Encoding</h2>

<p>Redis的 String Encoding 是二进制安全的，也就是说他没有任何特殊分隔符用于分隔各个值，你可以在里面存储任何东西。它就是一串字节码。
下面是 String Encoding 的三种类型</p>

<ol>
<li>长度编码的字符串</li>
<li>数字替代字符串：8位，16位或者32位的数字</li>
<li>LZF 压缩的字符串</li>
</ol>

<h2 id="长度编码字符串">长度编码字符串</h2>

<p>长度编码字符串是最简单的一种类型，它由两部分组成，一部分是用 “Length Encoding” 编码的字符串长度，第二部分是具体的字节码。</p>

<h2 id="数字替代字符串">数字替代字符串</h2>

<p>上面说到过 Length Encoding 的特殊编码，就在这里用上了。所以数字替代字符串是以 1 1 开头的，然后读取这个字节剩下的6 位，根据不同的值标识不同的数字类型：</p>

<ul>
<li>0 表示下面是一个8 位的数字</li>
<li>1 表示下面是一个16 位的数字</li>
<li>2 表示下面是一个32 位的数字</li>
</ul>

<h2 id="lzf压缩字符串">LZF压缩字符串</h2>

<p>和数据替代字符串一样，它也是以1 1 开头的，然后剩下的6 位如果值为4，那么就表示它是一个压缩字符串。压缩字符串解析规则如下：</p>

<ol>
<li>首先按 Length Encoding 规则读取压缩长度 clen</li>
<li>然后按 Length Encoding 规则读取非压缩长度</li>
<li>再读取第二个 clen</li>
<li>获取到上面的三个信息后，再通过LZF算法解码后面clen长度的字节码</li>
</ol>

<h2 id="list-encoding">List Encoding</h2>

<p>Redis List 结构在RDB文件中的存储，是依次存储List中的各个元素的。其结构如下：</p>

<ol>
<li>首先按 Length Encoding 读取这个List 的长度 size</li>
<li>然后读取 size个 String Encoding的值</li>
<li>然后再用这些读到的 size 个值重新构建 List就完成了</li>
</ol>

<h2 id="set-encoding">Set Encoding</h2>

<p>Set结构和List结构一样，也是依次存储各个元素的</p>

<h2 id="sorted-set-encoding">Sorted Set Encoding</h2>

<p>todo</p>

<h2 id="hash-encoding">Hash Encoding</h2>

<ol>
<li>首先按 Length Encoding 读出hash 结构的大小 size</li>
<li>然后读取2×size 个 String Encoding的字符串（因为一个hash项包括key和value两项）</li>
<li>将上面读取到的2×size 个字符串解析为hash 和key 和 value</li>
<li>然后将上面的key value对存储到hash结构中</li>
</ol>

<h2 id="zipmap-encoding">Zipmap Encoding</h2>

<p>参见本站之前的文章：Redis zipmap内存布局分析</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/34-redis-rdb/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/33-redis-considerations/">Redis数据结构使用以及注意事项，运维问题总结</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-10-09T12:00:36.000&#43;00:00' itemprop="datePublished">2017-10-09</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/redis">Redis</a>

<a href="https://ningyu1.github.io/site/tags/aof-block">AOF Block</a>

<a href="https://ningyu1.github.io/site/tags/aof">AOF</a>

<a href="https://ningyu1.github.io/site/tags/asynchronous-aof-fsync-is-taking-too-long-disk-is-busywriting-the-aof-buffer-without-waiting-for-fsync-to-complete-this-may-slow-down-redis">Asynchronous AOF fsync is taking too long (disk is busy?)Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis</a>


</div>
    </div>
        

<p>文章转自：<a href="http://www.cnblogs.com/cnmenglang/p/6225987.html">http://www.cnblogs.com/cnmenglang/p/6225987.html</a>
作者：@江南白衣</p>

<h2 id="优缺点">优缺点</h2>

<p>非常非常的快，有测评说比Memcached还快(当大家都是单CPU的时候)，而且是无短板的快，读写都一般的快，所有API都差不多快，也没有MySQL Cluster、MongoDB那样更新同一条记录如Counter时慢下去的毛病。</p>

<p>丰富的数据结构，超越了一般的Key-Value数据库而被认为是一个数据结构服务器。组合各种结构，限制Redis用途的是你自己的想象力，作者自己捉刀写的用途入门。</p>

<p>因为是个人作品，Redis目前只有2.3万行代码，Keep it simple的死硬做法，使得普通公司而不需淘宝那个级别的文艺公司也可以吃透它。</p>

<p>Redis宣言就是作者的自白，我最喜欢其中的&rdquo;代码像首诗&rdquo;，&rdquo;设计是一场与复杂性的战斗&rdquo;，&rdquo;Coding是一件艰苦的事情，唯一的办法是享受它。如果它已不能带来快乐就停止它。为了防止这一天的出现，我们要尽量避免把Redis往乏味的路上带。</p>

<p>让人又爱又恨的单线程架构，使得代码不用处理平时最让人头痛的并发而大幅简化，也不用老是担心作者的并发有没有写对，但也带来CPU的瓶颈，而且单线程被慢操作所阻塞时，其他请求的延时变得不确定。</p>

<p>那Redis不是什么？</p>

<p>Redis 不是Big Data，数据都在内存中，无法以T为单位。</p>

<p>在Redis-Cluster发布并被稳定使用之前，Redis没有真正的平滑水平扩展能力。</p>

<p>Redis 不支持Ad-Hoc Query，提供的只是数据结构的API，没有SQL一样的查询能力。</p>

<h3 id="feature速览">Feature速览</h3>

<p>所有数据都在内存中。</p>

<p>五种数据结构：String / Hash / List / Set / Ordered Set。</p>

<p>数据过期时间支持。</p>

<p>不完全的事务支持。</p>

<p>服务端脚本：使用Lua Script编写，类似存储过程的作用。</p>

<p>PubSub：捞过界的消息一对多发布订阅功能，起码Redis-Sentinel使用了它。</p>

<p>持久化：支持定期导出内存的Snapshot 与 记录写操作日志的Append Only File两种模式。</p>

<p>Replication：Master-Slave模式，Master可连接多个只读Slave，暂无专门的Geographic Replication支持。</p>

<p>Fail-Over：Redis-Sentinel节点负责监控Master节点，在master失效时提升slave，独立的仲裁节点模式有效防止脑裂。</p>

<p>Sharding：开发中的Redis-Cluser。</p>

<p>动态配置：所有参数可用命令行动态配置不需重启，并重新写回配置文件中，对云上的大规模部署非常合适。</p>

<h3 id="八卦">八卦</h3>

<p>作者是意大利的Salvatore Sanfilippo(antirez)，又是VMWare大善人聘请了他专心写Redis。</p>

<p>EMC与VMWare将旗下的开源产品如Redis和Spring都整合到了孙公司Pivotal公司。</p>

<p><a href="http://blog.gopivotal.com/pivotal-people/pivotal-people-salvatore-sanfilippo-inventor-of-redis">Pivotal做的antirez访谈录</a>，内含一切八卦，比如他的爱好是举重、跑步和品红酒。</p>

<p>默认端口6379，是手机按键上MERZ对应的号码，意大利歌女Alessia Merz是antirez和朋友们认为愚蠢的代名词。</p>

<h2 id="数据结构">数据结构</h2>

<h3 id="key">Key</h3>

<p>Key 不能太长，比如1024字节，但antirez也不喜欢太短如&rdquo;u:1000:pwd&rdquo;，要表达清楚意思才好。他私人建议用&rdquo;:&ldquo;分隔域，用&rdquo;.&ldquo;作为单词间的连接，如&rdquo;comment:1234:reply.to&rdquo;。</p>

<p><a href="http://redis.readthedocs.org/en/latest/key/keys.html">Keys</a>，返回匹配的key，支持通配符如 &ldquo;keys a*&rdquo; 、 &ldquo;keys a?c&rdquo;，但不建议在生产环境大数据量下使用。</p>

<p><a href="http://redis.readthedocs.org/en/latest/key/sort.html">Sort</a>，对集合按数字或字母顺序排序后返回或另存为list，还可以关联到外部key等。因为复杂度是最高的O(N+M*log(M))(N是集合大小，M 为返回元素的数量)，有时会安排到slave上执行。</p>

<p><a href="http://redis.readthedocs.org/en/latest/key/expire.html">Expire</a>/<a href="http://redis.readthedocs.org/en/latest/key/expireat.html">ExpireAt</a>/<a href="http://redis.readthedocs.org/en/latest/key/persist.html">Persist</a>/<a href="http://redis.readthedocs.org/en/latest/key/ttl.html">TTL</a>，关于Key超时的操作。默认以秒为单位，也有p字头的以毫秒为单位的版本， Redis的内部实现见2.9 过期数据清除。</p>

<h3 id="string">String</h3>

<p>最普通的key-value类型，说是String，其实是任意的byte[]，比如图片，最大512M。 所有常用命令的复杂度都是O(1)，普通的Get/Set方法，可以用来做Cache，存Session，为了简化架构甚至可以替换掉Memcached。</p>

<p><a href="http://redis.readthedocs.org/en/latest/string/incr.html">Incr</a>/<a href="http://redis.readthedocs.org/en/latest/string/incrby.html">IncrBy</a>/<a href="http://redis.readthedocs.org/en/latest/string/incrbyfloat.html">IncrByFloat</a>/<a href="http://redis.readthedocs.org/en/latest/string/decr.html">Decr</a>/<a href="http://redis.readthedocs.org/en/latest/string/decrby.html">DecrBy</a>，可以用来做计数器，做自增序列。key不存在时会创建并贴心的设原值为0。IncrByFloat专门针对float，没有对应的decrByFloat版本？用负数啊。</p>

<p>SetNx， 仅当key不存在时才Set。可以用来选举Master或做分布式锁：所有Client不断尝试使用SetNx master myName抢注Master，成功的那位不断使用Expire刷新它的过期时间。</p>

<p>如果Master倒掉了key就会失效，剩下的节点又会发生新一轮抢夺。</p>

<p>其他Set指令：</p>

<p><a href="http://redis.readthedocs.org/en/latest/string/setnx.html">SetEx</a>， Set + Expire 的简便写法，p字头版本以毫秒为单位。</p>

<p><a href="http://redis.readthedocs.org/en/latest/string/getset.html">GetSet</a>， 设置新值，返回旧值。比如一个按小时计算的计数器，可以用GetSet获取计数并重置为0。这种指令在服务端做起来是举手之劳，客户端便方便很多。</p>

<p><a href="http://redis.readthedocs.org/en/latest/string/mget.html">MGet</a>/<a href="http://redis.readthedocs.org/en/latest/string/mset.html">MSet</a>/<a href="http://redis.readthedocs.org/en/latest/string/msetnx.html">MSetNx</a>， 一次get/set多个key。</p>

<p>2.6.12版开始，Set命令已融合了Set/SetNx/SetEx三者，SetNx与SetEx可能会被废弃，这对Master抢注非常有用，不用担心setNx成功后，来不及执行Expire就倒掉了。可惜有些懒惰的Client并没有快速支持这个新指令。</p>

<p><a href="http://redis.readthedocs.org/en/latest/string/getbit.html">GetBit</a>/<a href="http://redis.readthedocs.org/en/latest/string/Setbit.html">SetBit</a>/<a href="http://redis.readthedocs.org/en/latest/string/bitop.html">BitOp,与或非</a>/<a href="http://redis.readthedocs.org/en/latest/string/bitcount.html">BitCount</a>/<a href="http://blog.getspool.com/2011/11/29/fast-easy-realtime-metrics-using-redis-bitmaps/">BitMap的玩法</a>，比如统计今天的独立访问用户数时，每个注册用户都有一个offset，他今天进来的话就把他那个位设为1，用BitCount就可以得出今天的总人树。</p>

<p><a href="http://redis.readthedocs.org/en/latest/string/append.html">Append</a>/<a href="http://redis.readthedocs.org/en/latest/string/setrange.html">SetRange</a>/<a href="http://redis.readthedocs.org/en/latest/string/getrange.html">GetRange</a>/<a href="http://redis.readthedocs.org/en/latest/string/strlen.html">StrLen</a>，对文本进行扩展、替换、截取和求长度，只对特定数据格式如字段定长的有用，json就没什么用。</p>

<h3 id="hash">Hash</h3>

<p>Key-HashMap结构，相比String类型将这整个对象持久化成JSON格式，Hash将对象的各个属性存入Map里，可以只读取/更新对象的某些属性。</p>

<p>这样有些属性超长就让它一边呆着不动，另外不同的模块可以只更新自己关心的属性而不会互相并发覆盖冲突。</p>

<p>另一个用法是土法建索引。比如User对象，除了id有时还要按name来查询。</p>

<p>可以有如下的数据记录:</p>

<pre><code>(String) user:101 -&gt; {&quot;id&quot;:101,&quot;name&quot;:&quot;calvin&quot;...}
(String) user:102 -&gt; {&quot;id&quot;:102,&quot;name&quot;:&quot;kevin&quot;...}
(Hash) user:index-&gt; &quot;calvin&quot;-&gt;101, &quot;kevin&quot; -&gt; 102
</code></pre>

<p>底层实现是<a href="http://www.redisbook.com/en/latest/internal-datastruct/dict.html">hash table</a>，一般操作复杂度是O(1)，要同时操作多个field时就是O(N)，N是field的数量。</p>

<h3 id="list">List</h3>

<p>List是一个<a href="http://www.redisbook.com/en/latest/internal-datastruct/adlist.html">双向链表</a>，支持双向的Pop/Push，江湖规矩一般从左端Push，右端Pop——<a href="http://redis.readthedocs.org/en/latest/list/lpush.html">LPush</a>/<a href="http://redis.readthedocs.org/en/latest/list/rpop.html">RPop</a>，而且还有Blocking的版本<a href="http://redis.readthedocs.org/en/latest/list/blpop.html">BLPop</a>/<a href="http://redis.readthedocs.org/en/latest/list/brpop.html">BRPop</a>，客户端可以阻塞在那直到有消息到来，所有操作都是O(1)的好孩子，可以当Message Queue来用。</p>

<p>当多个Client并发阻塞等待，有消息入列时谁先被阻塞谁先被服务。任务队列系统<a href="http://github.com/defunkt/resque">Resque</a>是其典型应用。</p>

<p>还有<a href="http://redis.readthedocs.org/en/latest/list/rpoplpush.html">RPopLPush</a>/ <a href="http://redis.readthedocs.org/en/latest/list/brpoplpush">BRPopLPush</a>，弹出来返回给client的同时，把自己又推入另一个list，<a href="http://redis.readthedocs.org/en/latest/list/llen.html">LLen</a>获取列表的长度。</p>

<p>还有按值进行的操作：LRem(按值删除元素)、LInsert(插在某个值的元素的前后)，复杂度是O(N)，N是List长度，因为List的值不唯一，所以要遍历全部元素，而Set只要O(log(N))。</p>

<p>按下标进行的操作：下标从0开始，队列从左到右算，下标为负数时则从右到左。</p>

<p><a href="http://redis.readthedocs.org/en/latest/list/lset.html">LSet</a> ，按下标设置元素值。</p>

<p><a href="http://redis.readthedocs.org/en/latest/list/lindex.html">LIndex</a>，按下标返回元素。</p>

<p><a href="http://redis.readthedocs.org/en/latest/list/lrange.html">LRange</a>，不同于POP直接弹走元素，只是返回列表内一段下标的元素，是分页的最爱。</p>

<p><a href="http://redis.readthedocs.org/en/latest/list/ltrim.html">LTrim</a>，限制List的大小，比如只保留最新的20条消息。</p>

<p>复杂度也是O(N)，其中LSet的N是List长度，LIndex的N是下标的值，LRange的N是start的值+列出元素的个数，因为是链表而不是数组，所以按下标访问其实要遍历链表，除非下标正好是队头和队尾。LTrim的N是移除元素的个数。</p>

<p>在消息队列中，并没有JMS的ack机制，如果消费者把job给Pop走了又没处理完就死机了怎么办？</p>

<p>解决方法之一是加多一个sorted set，分发的时候同时发到list与sorted set，以分发时间为score，用户把job做完了之后要用ZREM消掉sorted set里的job，并且定时从sorted set中取出超时没有完成的任务，重新放回list。</p>

<p>另一个做法是为每个worker多加一个的list，弹出任务时改用RPopLPush，将job同时放到worker自己的list中，完成时用LREM消掉。</p>

<p>如果集群管理(如zookeeper)发现worker已经挂掉，就将worker的list内容重新放回主list。</p>

<h3 id="set">Set</h3>

<p>Set就是Set，可以将重复的元素随便放入而Set会自动去重，底层实现也是<a href="http://www.redisbook.com/en/latest/internal-datastruct/dict.html">hash table</a>。</p>

<p><a href="http://redis.readthedocs.org/en/latest/set/sadd.html">SAdd</a>/<a href="http://redis.readthedocs.org/en/latest/set/srem.html">SRem</a>/<a href="http://redis.readthedocs.org/en/latest/set/sismember.html">SISMember</a>/<a href="http://redis.readthedocs.org/en/latest/set/scard.html">SCard</a>/<a href="http://redis.readthedocs.org/en/latest/set/smove.html">SMove</a>/<a href="http://redis.readthedocs.org/en/latest/set/smembers.html">SMembers</a>，各种标准操作。除了SMembers都是O(1)。</p>

<p><a href="http://redis.readthedocs.org/en/latest/set/sinter.html">SInter</a>/<a href="http://redis.readthedocs.org/en/latest/set/sinterstore.html">SInterStore</a>/<a href="http://redis.readthedocs.org/en/latest/set/sunion.html">SUnion</a>/<a href="http://redis.readthedocs.org/en/latest/set/sunionstore.html">SUnionStore</a>/<a href="http://redis.readthedocs.org/en/latest/set/sdiff.html">SDiff</a>/<a href="http://redis.readthedocs.org/en/latest/set/sdiffstore.html">SDiffStore</a>，各种集合操作。交集运算可以用来显示在线好友(在线用户 交集 好友列表)，共同关注(两个用户的关注列表的交集)。</p>

<p>O(N)，并集和差集的N是集合大小之和，交集的N是小的那个集合的大小*2。</p>

<h3 id="sorted-set">Sorted Set</h3>

<p>有序集，元素放入集合时还要提供该元素的分数。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zrange.html">ZRange</a>/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zrevrange.html">ZRevRange</a>，按排名的上下限返回元素，正数与倒数。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zrangebyscore.html">ZRangeByScore</a>/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zrevrangebyscore.html">ZRevRangeByScore</a>，按分数的上下限返回元素，正数与倒数。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zremrangebyrank.html">ZRemRangeByRank</a>/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zremrangebyscore.html">ZRemRangeByScore</a>，按排名/按分数的上下限删除元素。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zcount.html">ZCount</a>，统计分数上下限之间的元素个数。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zrank.html">ZRank</a>/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zrevrank.html">ZRevRank</a> ，显示某个元素的正倒序的排名。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zscore.html">ZScore</a>/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zincrby.html">ZIncrby</a>，显示元素的分数/增加元素的分数。</p>

<p><a href="http://redis.readthedocs.org/en/latest/sorted_set/zadd.html">ZAdd</a>(Add)/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zrem.html">ZRem</a>(Remove)/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zcard.html">ZCard</a>(Count)，<a href="http://redis.readthedocs.org/en/latest/sorted_set/zinterstore.html">ZInsertStore</a>(交集)/<a href="http://redis.readthedocs.org/en/latest/sorted_set/zunionstore.html">ZUnionStore</a>(并集)，Set操作，与正牌Set相比，少了IsMember和差集运算。</p>

<p>Sorted Set的实现是hash table(element-&gt;score, 用于实现ZScore及判断element是否在集合内)，和skip list(score-&gt;element,按score排序)的混合体。</p>

<p><a href="http://www.redisbook.com/en/latest/internal-datastruct/skiplist.html">skip list</a>有点像平衡二叉树那样，不同范围的score被分成一层一层，每层是一个按score排序的链表。</p>

<p>ZAdd/ZRem是O(log(N))，ZRangeByScore/ZRemRangeByScore是O(log(N)+M)，N是Set大小，M是结果/操作元素的个数。</p>

<p>可见，原本可能很大的N被很关键的Log了一下，1000万大小的Set，复杂度也只是几十不到。</p>

<p>当然，如果一次命中很多元素M很大那谁也没办法了。</p>

<h3 id="事务">事务</h3>

<p>用<a href="http://redis.readthedocs.org/en/latest/transaction/multi.html">Multi</a>(Start Transaction)、<a href="http://redis.readthedocs.org/en/latest/transaction/exec.html">Exec</a>(Commit)、<a href="http://redis.readthedocs.org/en/latest/transaction/discard.html">Discard</a>(Rollback)实现。</p>

<p>在事务提交前，不会执行任何指令，只会把它们存到一个队列里，不影响其他客户端的操作。在事务提交时，批量执行所有指令。<a href="http://www.redisbook.com/en/latest/feature/transaction.html">《Redis设计与实现》</a>中的详述。</p>

<p>注意，Redis里的事务，与我们平时的事务概念很不一样：</p>

<p>它仅仅是保证事务里的操作会被连续独占的执行。因为是单线程架构，在执行完事务内所有指令前是不可能再去同时执行其他客户端的请求的。</p>

<p>它没有隔离级别的概念，因为事务提交前任何指令都不会被实际执行，也就不存在&rdquo;事务内的查询要看到事务里的更新，在事务外查询不能看到&rdquo;这个让人万分头痛的问题。</p>

<p>它不保证原子性——所有指令同时成功或同时失败，只有决定是否开始执行全部指令的能力，没有执行到一半进行回滚的能力。</p>

<p>在redis里失败分两种，一种是明显的指令错误，比如指令名拼错，指令参数个数不对，在2.6版中全部指令都不会执行。</p>

<p>另一种是隐含的，比如在事务里，第一句是SET foo bar， 第二句是LLEN foo，对第一句产生的String类型的key执行LLEN会失败，但这种错误只有在指令运行后才能发现，这时候第一句成功，第二句失败。</p>

<p>还有，如果事务执行到一半redis被KILL，已经执行的指令同样也不会被回滚。</p>

<p><a href="http://redis.readthedocs.org/en/latest/transaction/watch.html">Watch</a>指令，类似乐观锁，事务提交时，如果Key的值已被别的客户端改变，比如某个list已被别的客户端push/pop过了，整个事务队列都不会被执行。</p>

<h3 id="lua-script">Lua Script</h3>

<p>Redis2.6内置的<a href="http://redis.readthedocs.org/en/latest/script/eval.html">Lua Script</a>支持，可以在Redis的Server端一次过运行大量逻辑，就像存储过程一样，避免了海量中间数据在网路上的传输。</p>

<p><a href="http://www.lua.org/">Lua</a>自称是在Script语言里关于快的标准，Redis选择了它而不是流行的JavaScript。</p>

<p>因为Redis的单线程架构，整个Script默认是在一个事务里的。</p>

<p>Script里涉及的所有Key尽量用变量，从外面传入，使Redis一开始就知道你要改变哪些key，为了日后做水平分区做准备。如果涉及的key在不同服务器&hellip;&hellip;</p>

<p>Eval每次传输一整段Script比较费带宽，可以先用<a href="http://redis.readthedocs.org/en/latest/script/script_load.html">Script Load</a>载入script，返回哈希值。然后用<a href="http://redis.readthedocs.org/en/latest/script/evalsha.html">EvalHash</a>执行。因为就是SHA-1，所以任何时候执行返回的哈希值都是一样的。</p>

<p>内置的Lua库里还很贴心的带了CJSON，可以处理json字符串。</p>

<p>Script一旦执行则不容易中断，中断了也会有不可知后果，因此最好在开发环境充分测试了再上线。</p>

<p>一段用Redis做Timer的示例代码，下面的script被定期调用，从以触发时间为score的sorted set中取出已到期的Job，放到list中给Client们blocking popup。</p>

<pre><code>-- KEYS: [1]job:sleeping, [2]job:ready
-- ARGS: [1]currentTime
-- Comments: result is the  job id
local jobs=redis.call('zrangebyscore', KEYS[1], '-inf', ARGV[1])
local count = table.maxn(jobs)

if count&gt;0  then
  -- Comments: remove from Sleeping Job sorted set
  redis.call('zremrangebyscore', KEYS[1], '-inf', ARGV[1])
  
  -- Comments: add to the Ready Job list
  -- Comments: can optimize to use lpush id1,id2,... for better performance
  for i=1,count do 
    redis.call('lpush', KEYS[2], jobs[i])
  end
end
</code></pre>

<h3 id="过期数据清除">过期数据清除</h3>

<p><a href="http://redis.io/commands/expire">官方文档</a> 与 <a href="http://www.redisbook.com/en/latest/internal/db.html#id15">《Redis设计与实现》</a>中的详述，过期数据的清除从来不容易，为每一条key设置一个timer，到点立刻删除的消耗太大，每秒遍历所有数据消耗也大，Redis使用了一种相对务实的做法：</p>

<p>当client主动访问key会先对key进行超时判断，过时的key会立刻删除。</p>

<p>如果clien永远都不再get那条key呢？ 它会在Master的后台，每秒10次的执行如下操作： 随机选取100个key校验是否过期，如果有25个以上的key过期了，立刻额外随机选取下100个key(不计算在10次之内)。</p>

<p>可见，如果过期的key不多，它最多每秒回收200条左右，如果有超过25%的key过期了，它就会做得更多，但只要key不被主动get，它占用的内存什么时候最终被清理掉只有天知道。</p>

<h2 id="性能">性能</h2>

<h3 id="测试结果">测试结果</h3>

<p>测试环境： RHEL 6.3 / HP Gen8 Server/ 2 * Intel Xeon 2.00GHz(6 core) / 64G DDR3 memory / 300G RAID-1 SATA / 1 master(writ AOF), 1 slave(write AOF &amp; RDB)</p>

<p>数据准备： 预加载两千万条数据，占用10G内存。</p>

<p>测试工具：自带的redis-benchmark，默认只是基于一个很小的数据集进行测试，调整命令行参数如下，就可以开100条线程(默认50)，SET 1千万次(key在0-1千万间随机)，key长21字节，value长256字节的数据。</p>

<pre><code>redis-benchmark -t SET -c 100 -n 10000000 -r 10000000 -d 256 
</code></pre>

<p>测试结果(TPS)： 1.SET：4.5万， 2.GET：6万 ，3.INCR：6万，4.真实混合场景: 2.5万SET &amp; 3万GET</p>

<p>单条客户端线程时6千TPS，50与100条客户端线程差别不大，200条时会略多。</p>

<p>Get/Set操作，经过了LAN，延时也只有1毫秒左右，可以反复放心调用，不用像调用REST接口和访问数据库那样，每多一次外部访问都心痛。</p>

<p>资源监控:</p>

<ol>
<li>CPU: 占了一个处理器的100%，总CPU是4%(因为总共有2CPU*6核*超线程 = 24个处理器)，可见单线程下单处理器的能力是瓶颈。 AOF rewrite时另一个处理器占用50-70%。</li>
<li>网卡：15-20 MB/s receive, 3Mb/s send(no slave) or 15-20 MB/s send (with slave) 。当把value长度加到4K时，receive 99MB/s，已经到达千兆网卡的瓶颈，TPS降到2万。</li>
<li>硬盘：15MB/s(AOF append), 100MB/s(AOF rewrite/AOF load，普通硬盘的瓶颈)</li>
</ol>

<h3 id="为什么快">为什么快</h3>

<p>纯ANSI C编写。</p>

<p>不依赖第三方类库，没有像memcached那样使用libevent，因为libevent迎合通用性而造成代码庞大，所以作者用libevent中两个文件修改实现了自己的epoll event loop。微软的兼容Windows补丁也因为同样原因被拒了。</p>

<p>快，原因之一是Redis多样的数据结构，每种结构只做自己爱做的事，当然比数据库只有Table，MongogoDB只有JSON一种结构快了。</p>

<p>可惜单线程架构，虽然作者认为CPU不是瓶颈，内存与网络带宽才是。但实际测试时并非如此，见上。</p>

<h3 id="性能调优">性能调优</h3>

<p><a href="http://www.redis.io/topics/latency">官方文档关于各种产生Latency的原因的详细分析, 中文版</a></p>

<p>正视网络往返时间：</p>

<p>1.MSet/LPush/ZAdd等都支持一次输入多个Key。</p>

<p>2.<a href="http://www.redis.io/topics/pipelining">PipeLining</a>模式 可以一次输入多个指令。</p>

<p>3.更快的是Lua Script模式，还可以包含逻辑，直接在服务端又get又set的，见2.8 Lua Script。</p>

<p><a href="http://redis.readthedocs.org/en/latest/server/slowlog.html">发现执行缓慢的命令</a>，可配置执行超过多少时间的指令算是缓慢指令(默认10毫秒，不含IO时间)，可以用slowlog get 指令查看(默认只保留最后的128条)。</p>

<p>单线程的模型下，一个请求占掉10毫秒是件大事情，注意设置和显示的单位为微秒。</p>

<p>CPU永远是瓶颈，但top看到单个CPU 100%时，就是垂直扩展的时候了。</p>

<p>持久化对性能的影响很大，见5.1持久化。</p>

<p>要熟悉各指令的复杂度，不过只要不是O(N)一个超大集合，都不用太担心。</p>

<h2 id="容量">容量</h2>

<h3 id="最大内存">最大内存</h3>

<p>所有的数据都必须在内存中，原来2.0版的VM策略(将Value放到磁盘，Key仍然放在内存)，2.4版后嫌麻烦又不支持了。</p>

<p>一定要设置最大内存，否则物理内存用爆了就会大量使用Swap，写RDB文件时的速度慢得你想死。</p>

<p>多留一倍内存是最安全的。重写AOF文件和RDB文件的进程(即使不做持久化，复制到Slave的时候也要写RDB)会fork出一条新进程来，采用了操作系统的Copy-On-Write策略(子进程与父进程共享Page。</p>

<p>如果父进程的Page-每页4K有修改，父进程自己创建那个Page的副本，不会影响到子进程，父爱如山)。留意Console打出来的报告，如&rdquo;RDB: 1215 MB of memory used by copy-on-write&rdquo;。</p>

<p>在系统极度繁忙时，如果父进程的所有Page在子进程写RDB过程中都被修改过了，就需要两倍内存。</p>

<p>按照Redis启动时的提醒，设置 vm.overcommit_memory = 1 ，使得fork()一条10G的进程时，因为COW策略而不一定需要有10G的free memory。</p>

<p>其他需要考虑的内存包括：</p>

<p>1.AOF rewrite过程中对新写入命令的缓存(rewrite结束后会merge到新的aof文件)，留意&rdquo;Background AOF buffer size: 80 MB&rdquo;的字样。</p>

<p>2.负责与Slave同步的Client的缓存，默认设置master需要为每个slave预留不高于256M的缓存(见5.1持久化)。</p>

<p>当最大内存到达时，按照配置的Policy进行处理， 默认策略为volatile-lru，对设置了expire time的key进行LRU清除(不是按实际expire time)。</p>

<p>如果沒有数据设置了expire time或者policy为noeviction，则直接报错，但此时系统仍支持get之类的读操作。</p>

<p>另外还有几种policy，比如volatile-ttl按最接近expire time的，allkeys-lru对所有key都做LRU。</p>

<h3 id="内存占用">内存占用</h3>

<p>测试表明，string类型需要90字节的额外代价，就是说key 1个字节，value 1个字节时，还是需要占用92字节的长度，而上面的benchmark的记录就占用了367个字节。</p>

<p>其他类型可根据文档自行计算或实际测试一下。</p>

<p>使用jemalloc分配内存，删除数据后，内存并不会乖乖还给操作系统而是被Redis截留下来重用到新的数据上，直到Redis重启。</p>

<p>因此进程实际占用内存是看INFO里返回的used_memory_peak_human。</p>

<p>Redis内部用了<a href="http://www.redisbook.com/en/latest/compress-datastruct/ziplist.html">ziplist</a>/<a href="http://www.redisbook.com/en/latest/compress-datastruct/intset.html">intset</a>这样的压缩结构来减少hash/list/set/zset的存储，默认当集合的元素少于512个且最长那个值不超过64字节时使用，可配置。</p>

<p>用make 32bit可以编译出32位的版本，每个指针占用的内存更小，但只支持最大4GB内存。</p>

<h3 id="水平分区-sharding">水平分区，Sharding</h3>

<p>其实，大内存加上垂直分区也够了，不一定非要沙丁一把。</p>

<p>Jedis支持在客户端做分区，局限是不能动态re-sharding， 有分区的master倒了，不能减少分区必须用slave顶上。要增加分区的话，呃&hellip;..</p>

<p>antire在博客里提到了<a href="http://www.antirez.com/news/44">Twemproxy</a>，一个Twitter写的Proxy，但它在发现节点倒掉后，只会重新计算一致性哈希环，把数据存到别的master去，而不是集成Sentinel指向新由slave升级的master，像Memcached一样的做法也只适合做Cache的场景。</p>

<p>Redis-Cluster是今年工作重点，支持automatic re-sharding， 采用和Hazelcast类似的算法，总共有N个分区(eg.N=1024)，每台Server负责若干个分区。</p>

<p>在客户端先hash出key 属于哪个分区，随便发给一台server，server会告诉它真正哪个Server负责这个分区，缓存下来，下次还有该分区的请求就直接发到地儿了。</p>

<p>Re-sharding时，会将某些分区的数据移到新的Server上，完成后各Server周知分区&lt;-&gt;Server映射的变化，因为分区数量有限，所以通讯量不大。</p>

<p>在迁移过程中，客户端缓存的依然是旧的分区映射信息，原server对于已经迁移走的数据的get请求，会返回一个临时转向的应答，客户端先不会更新Cache。</p>

<p>等迁移完成了，就会像前面那样返回一条永久转向信息，客户端更新Cache，以后就都去新server了。</p>

<h2 id="高可用性">高可用性</h2>

<p>高可用性关乎系统出错时到底会丢失多少数据，多久不能服务。要综合考虑持久化，Master-Slave复制及Fail-Over配置，以及具体Crash情形，比如Master死了，但Slave没死。或者只是Redis死了，操作系统没死等等。</p>

<h3 id="持久化">持久化</h3>

<p>综述： <a href="http://blog.nosqlfan.com/html/3813.html">解密Redis持久化(中文概括版)</a>, <a href="http://redis.io/topics/persistence">英文原版</a>，《Redis设计与实现》： <a href="http://www.redisbook.com/en/latest/internal/rdb.html">RDB</a> 与 <a href="http://www.redisbook.com/en/latest/internal/aof.html">AOF</a>。</p>

<p>很多人开始会想象两者是互相结合的，即dump出一个snapshot到RDB文件，然后在此基础上记录变化日志到AOF文件。</p>

<p>实际上两者毫无关系，完全独立运行，因为作者认为简单才不会出错。如果使用了AOF，重启时只会从AOF文件载入数据，不会再管RDB文件。</p>

<p>正确关闭服务器：redis-cli shutdown 或者 kill，都会graceful shutdown，保证写RDB文件以及将AOF文件fsync到磁盘，不会丢失数据。</p>

<p>如果是粗暴的Ctrl+C，或者kill -9 就可能丢失。</p>

<h3 id="rdb文件">RDB文件</h3>

<p>RDB是整个内存的压缩过的Snapshot，<a href="http://blog.nosqlfan.com/html/3734.html">RDB的数据结构</a>，可以配置复合的快照触发条件，默认是1分钟内改了1万次，或5分钟内改了10次，或15分钟内改了1次。</p>

<p>RDB写入时，会连内存一起Fork出一个新进程，遍历新进程内存中的数据写文件，这样就解决了些Snapshot过程中又有新的写入请求进来的问题。 Fork的细节见4.1最大内存。</p>

<p>RDB会先写到临时文件，完了再Rename成，这样外部程序对RDB文件的备份和传输过程是安全的。而且即使写新快照的过程中Server被强制关掉了，旧的RDB文件还在。</p>

<p>可配置是否进行压缩，压缩方法是字符串的LZF算法，以及将string形式的数字变回int形式存储。</p>

<p>动态所有停止RDB保存规则的方法：redis-cli config set save &ldquo;&rdquo;</p>

<h3 id="aof文件">AOF文件</h3>

<p>操作日志，记录所有有效的写操作，等于mysql的binlog，格式就是明文的<a href="http://redis.io/topics/protocol">Redis协议</a>的纯文本文件。</p>

<p>一般配置成每秒调用一次fdatasync将kernel的文件缓存刷到磁盘。当操作系统非正常关机时，文件可能会丢失不超过2秒的数据(更严谨的定义见后)。 如果设为fsync always，性能只剩几百TPS，不用考虑。</p>

<p>如果设为no，靠操作系统自己的sync，Linux系统一般30秒一次。</p>

<p>AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件，最后再rename，)， 遍历新进程的内存中数据，每条记录有一条的Set语句。</p>

<p>默认配置是当AOF文件大小是上次rewrite后大小的一倍，且文件大于64M时触发。</p>

<p><a href="http://redis.io/topics/protocol">Redis协议</a>，如set mykey hello，将持久化成*3 $3 set $5 mykey $5 hello， 第一个数字代表这条语句有多少元，其他的数字代表后面字符串的长度。</p>

<p>这样的设计，使得即使在写文件过程中突然关机导致文件不完整，也能自我修复，执行redis-check-aof即可。</p>

<p>综上所述，RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。</p>

<p>那要不要只使用AOF呢？作者建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)，快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。</p>

<h3 id="读写性能">读写性能</h3>

<p>AOF重写和RDB写入都是在fork出新进程后，遍历新进程的内存顺序写的，既不阻塞主进程继续处理客户端请求，顺序写的速度也比随机写快。</p>

<p>测试把刚才benchmark的11G数据写成一个1.3的RDB文件，或者等大的AOF文件rewrite，需要80秒，在redis-cli info中可查看。启动时载入一个AOF或RDB文件的速度与上面写入时相同，在log中可查看。</p>

<p>Fork一个使用了大量内存的进程也要时间，大约10ms per GB的样子，但Xen在EC2上是让人郁闷的239ms (KVM和VMWare貌似没有这个毛病)，<a href="http://blog.nosqlfan.com/html/3903.html">各种系统的对比</a>，Info指令里的latest_fork_usec显示上次花费的时间。</p>

<p>在bgrewriteaof过程中，所有新来的写入请求依然会被写入旧的AOF文件，同时放到buffer中，当rewrite完成后，会在主线程把这部分内容合并到临时文件中之后才rename成新的AOF文件。</p>

<p>所以rewrite过程中会不断打印&rdquo;Background AOF buffer size: 80 MB， Background AOF buffer size: 180 MB&rdquo;，计算系统容量时要留意这部分的内存消耗。</p>

<p>注意，这个合并的过程是阻塞的，如果你产生了280MB的buffer，在100MB/s的传统硬盘上，Redis就要阻塞2.8秒！！！</p>

<p>NFS或者Amazon上的EBS都不推荐，因为它们也要消耗带宽。</p>

<p>bgsave和bgaofrewrite不会被同时执行，如果bgsave正在执行，bgaofrewrite会自动延后。</p>

<p>2.4版以后，写入AOF时的fdatasync由另一条线程来执行，不会再阻塞主线程。</p>

<p>2.4版以后，lpush/zadd可以输入一次多个值了，使得AOF重写时可以将旧版本中的多个lpush/zadd指令合成一个，每64个key串一串。</p>

<h3 id="性能调整">性能调整</h3>

<p>因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留save 900 1这条规则。</p>

<p>如果Enalbe AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。</p>

<p>代价一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。</p>

<p>只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上。</p>

<p>默认超过原大小100%大小时重写可以改到适当的数值，比如之前的benchmark每个小时会产生40G大小的AOF文件，如果硬盘能撑到半夜系统闲时才用cron调度bgaofrewrite就好了。</p>

<p>如果不Enable AOF，仅靠Master-Slave Replication 实现高可用性也可以。能省掉一大笔IO也减少了rewrite时带来的系统波动。</p>

<p>代价是如果Master/Slave同时倒掉，会丢失十几分钟的数据，启动脚本也要比较两个Master/Slave中的RDB文件，载入较新的那个。新浪微博就选用了这种架构，<a href="http://timyang.net/data/redis-misunderstanding/">见Tim的博客</a></p>

<h3 id="trouble-shooting-enable-aof可能导致整个redis被block住-在2-6-12版之前">Trouble Shooting —— Enable AOF可能导致整个Redis被Block住，在2.6.12版之前</h3>

<h4 id="现象描述">现象描述：</h4>

<p>当AOF rewrite 15G大小的内存时，Redis整个死掉的样子，所有指令甚至包括slave发到master的ping，redis-cli info都不能被执行。</p>

<h4 id="原因分析">原因分析：</h4>

<p><a href="http://www.redis.io/topics/latency">官方文档，由IO产生的Latency详细分析</a>, 已经预言了悲剧的发生，但一开始没留意。</p>

<p>Redis为求简单，采用了单请求处理线程结构。</p>

<p>打开AOF持久化功能后， Redis处理完每个事件后会调用write(2)将变化写入kernel的buffer，如果此时write(2)被阻塞，Redis就不能处理下一个事件。</p>

<p>Linux规定执行write(2)时，如果对同一个文件正在执行fdatasync(2)将kernel buffer写入物理磁盘，或者有system wide sync在执行，write(2)会被block住，整个Redis被block住。</p>

<p>如果系统IO繁忙，比如有别的应用在写盘，或者Redis自己在AOF rewrite或RDB snapshot(虽然此时写入的是另一个临时文件，虽然各自都在连续写，但两个文件间的切换使得磁盘磁头的寻道时间加长），就可能导致fdatasync(2)迟迟未能完成从而block住write(2)，block住整个Redis。</p>

<p>为了更清晰的看到fdatasync(2)的执行时长，可以使用&rdquo;strace -p (pid of redis server) -T -e -f trace=fdatasync&rdquo;，但会影响系统性能。</p>

<p>Redis提供了一个自救的方式，当发现文件有在执行fdatasync(2)时，就先不调用write(2)，只存在cache里，免得被block。但如果已经超过两秒都还是这个样子，则会硬着头皮执行write(2)，即使redis会被block住。</p>

<p>此时那句要命的log会打印：“Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.”</p>

<p>之后用redis-cli INFO可以看到aof_delayed_fsync的值被加1。</p>

<p>因此，对于fsync设为everysec时丢失数据的可能性的最严谨说法是：如果有fdatasync在长时间的执行，此时redis意外关闭会造成文件里不多于两秒的数据丢失。</p>

<p>如果fdatasync运行正常，redis意外关闭没有影响，只有当操作系统crash时才会造成少于1秒的数据丢失。</p>

<h4 id="解决方法">解决方法：</h4>

<p>最后发现，原来是AOF rewrite时一直埋头的调用write(2)，由系统自己去触发sync。在RedHat Enterprise 6里，默认配置vm.dirty_background_ratio=10，也就是占用了10%的可用内存才会开始后台flush，而我的服务器有64G内存。</p>

<p>很明显一次flush太多数据会造成阻塞，所以最后果断设置了sysctl vm.dirty_bytes=33554432(32M)，问题解决。</p>

<p>然后提了个issue，<a href="https://github.com/antirez/redis/issues/1019">AOF rewrite时定时也执行一下fdatasync嘛</a>， antirez三分钟后就回复了，新版中，AOF rewrite时32M就会重写主动调用fdatasync。</p>

<h3 id="master-slave复制">Master-Slave复制</h3>

<h4 id="概述">概述</h4>

<p>slave可以在配置文件、启动命令行参数、以及redis-cli执行SlaveOf指令来设置自己是奴隶。</p>

<p>测试表明同步延时非常小，指令一旦执行完毕就会立刻写AOF文件和向Slave转发，除非Slave自己被阻塞住了。</p>

<p>比较蠢的是，即使在配置文件里设了slavof，slave启动时依然会先从数据文件载入一堆没用的数据，再去执行slaveof。</p>

<p>&ldquo;Slaveof no one&rdquo;，立马变身master。</p>

<p>2.8版本将支持<a href="http://www.antirez.com/news/47">PSYNC部分同步</a>，master会拨出一小段内存来存放要发给slave的指令，如果slave短暂的断开了，重连时会从内存中读取需要补读的指令，这样就不需要断开两秒也搞一次全同步了。</p>

<p>但如果断开时间较长，已经超过了内存中保存的数据，就还是要全同步。</p>

<p>Slave也可以接收Read-Only的请求。</p>

<h4 id="slaveof执行过程-完全重用已有功能-非常经济">slaveof执行过程，完全重用已有功能，非常经济</h4>

<p>先执行一次全同步 &ndash; 请求master BgSave出自己的一个RDB Snapshot文件发给slave，slave接收完毕后，清除掉自己的旧数据，然后将RDB载入内存。</p>

<p>再进行增量同步 &ndash; master作为一个普通的client连入slave，将所有写操作转发给slave，没有特殊的同步协议。</p>

<h4 id="trouble-shooting-again">Trouble Shooting again</h4>

<p>有时候明明master/slave都活得好好的，突然间就说要重新进行全同步了：</p>

<p>1）Slave显示：</p>

<pre><code># MASTER time out: no data nor PING received...
</code></pre>

<p>slave会每隔repl-ping-slave-period(默认10秒)ping一次master，如果超过repl-timeout(默认60秒)都没有收到响应，就会认为Master挂了。</p>

<p>如果Master明明没挂但被阻塞住了也会报这个错。可以适当调大repl-timeout。</p>

<p>2）Master显示：</p>

<pre><code># Client addr=10.175.162.123:44670 flags=S oll=104654 omem=2147487792 events=rw cmd=sync scheduled to be closed ASAP for overcoming of output buffer limits.
</code></pre>

<p>当slave没挂但被阻塞住了，比如正在loading Master发过来的RDB， Master的指令不能立刻发送给slave，就会放在output buffer中(见oll是命令数量，omem是大小)，</p>

<p>在配置文件中有如下配置：client-output-buffer-limit slave 256mb 64mb 60， 这是说负责发数据给slave的client，如果buffer超过256m或者连续60秒超过64m，就会被立刻强行关闭！！！ Traffic大的话一定要设大一点。</p>

<p>否则就会出现一个很悲剧的循环，Master传输一个大的RDB给Slave，Slave努力的装载，但还没装载完，Master对client的缓存满了，再来一次。</p>

<p>平时可以在master执行 <a href="http://redis.io/commands/client-list">redis-cli client list</a> 找那个cmd=sync，flag=S的client，注意OMem的变化。</p>

<h3 id="fail-over">Fail-Over</h3>

<p>Redis-sentinel是2.6版开始加入的另一组独立运行的节点，提供自动Fail Over的支持。</p>

<p><a href="http://redis.io/topics/sentinel">官方文档</a> 与 <a href="http://www.wzxue.com/redis%E6%A0%B8%E5%BF%83%E8%A7%A3%E8%AF%BB-%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7redis-sentinel/">Redis核心解读–集群管理工具(Redis-sentinel)</a></p>

<p><a href="http://www.antirez.com/news/55">antirez 对 Sentinel的反驳</a>，与<a href="http://www.antirez.com/news/56">下篇</a></p>

<h4 id="主要执行过程">主要执行过程</h4>

<p>Sentinel每秒钟对所有master，slave和其他sentinel执行Ping，redis-server节点要应答+PONG或-LOADING或-MASTERDOWN.</p>

<p>如果某一台Sentinel没有在30秒内(可配置得短一些哦)收到上述正确应答，它就会认为master处于sdown状态(主观Down)</p>

<p>它向其他sentinel询问是否也认为该master倒了（SENTINEL is-master-down-by-addr ）， 如果quonum台(默认是2)sentinel在5秒钟内都这样认为，就会认为master真是odown了(客观Down)。</p>

<p>此时会选出一台sentinel作为Leader执行fail-over, Leader会从slave中选出一个提升为master(执行slaveof no one)，然后让其他slave指向它(执行slaveof new master)。</p>

<h4 id="master-slave-及-其他sentinel的发现">master/slave 及 其他sentinel的发现</h4>

<p>master地址在sentinel.conf里, sentinel会每10秒一次向master发送INFO，知道master的slave有哪些。 如果master已经变为slave，sentinel会分析INFO的应答指向新的master。</p>

<p>以前，sentinel重启时，如果master已经切换过了，但sentinel.conf里master的地址并没有变，很可能有悲剧发生。</p>

<p>另外master重启后如果没有切换成slave，也可能有悲剧发生。新版好像修复了一点这个问题，待研究。</p>

<p>另外，sentinel会在master上建一个pub/sub channel，名为&rdquo;sentinel:hello&rdquo;，通告各种信息，sentinel们也是通过接收pub/sub channel上的+sentinel的信息发现彼此，因为每台sentinel每5秒会发送一次自己的host信息，宣告自己的存在。</p>

<h4 id="自定义reconfig脚本">自定义reconfig脚本</h4>

<p>sentinel在failover时还会执行配置文件里指定的用户自定义reconfig脚本，做用户自己想做的事情，比如让master变为slave并指向新的master。</p>

<p>脚本的将会在命令行按顺序传入如下参数： <master-name> <role(leader/observer)> <state(上述三种情况)> <from-ip> <from-port> <to-ip> <to-port></p>

<p>脚本返回0是正常，如果返回1会被重新执行，如果返回2或以上不会。 如果超过60秒没返回会被强制终止。</p>

<p>觉得Sentinel至少有两个可提升的地方:</p>

<p>一是如果master 主动shutdown，比如系统升级，有办法主动通知sentinel提升新的master，减少服务中断时间。</p>

<p>二是比起redis-server太原始了，要自己丑陋的以nohup sentinel &gt; logfile 2&gt;&amp;1 &amp; 启动，也不支持shutdown命令，要自己kill pid。</p>

<h3 id="client的高可用性">Client的高可用性</h3>

<p>基于Sentinel的方案，client需要执行语句SENTINEL get-master-addr-by-name mymaster 可获得当前master的地址。</p>

<p>Jedis正在集成sentinel，已经支持了sentinel的一些指令，但还没发布，但sentinel版的连接池则暂时完全没有，在公司的项目里我参考<a href="https://github.com/hamsterready/jedis-sentinel-pool">网友的项目</a>自己写了一个。</p>

<p><a href="https://github.com/taobao/tedis">淘宝的Tedis driver</a>，使用了完全不同的思路，不基于Sentinel，而是多写随机读， 一开始就同步写入到所有节点，读的话随便读一个还活着的节点就行了。</p>

<p>但有些节点成功有些节点失败如何处理? 节点死掉重新起来后怎么重新同步?什么时候可以重新Ready? 所以不是很敢用。</p>

<p>另外如Ruby写的<a href="https://github.com/ryanlecompte/redis_failover">redis_failover</a>，也是抛开了Redis Sentinel，基于ZooKeeper的临时方案。</p>

<p>Redis作者也在博客里抱怨<a href="http://www.antirez.com/news/33">怎么没有人做Dynamo-style 的client</a>。</p>

<h3 id="geographic-replication">Geographic Replication</h3>

<p>没有特别支持，依然用Master Slave复制，<a href="http://3scale.github.io/2012/07/25/fun-with-redis-replication/">3Scale想出了诸如用压缩的SSH隧道降低传输量等方法</a>。</p>

<h2 id="运维">运维</h2>

<h3 id="安装">安装</h3>

<p>安装包制作：没有现成，需要自己编译，自己写rpm包的脚本，可参考utils中的install_server.sh与redis_init_script。</p>

<p>但RHEL下设定script runlevel的方式不一样，redis_init_script中要增加一句 &ldquo;# chkconfig: 345 90 10&rdquo; ，而install_server.sh可以删掉后面的那句<code>chkconfig --level 345 reis</code></p>

<p>云服务：<a href="http://redis-cloud.com/">Redis Cloud</a>，在Amazon、Heroku、Windows Azure、App Frog上提供云服务，供同样部署在这些云上的应用使用。</p>

<p>其他的云服务有<a href="http://garantiadata.com/">GarantiaData</a>，已被redis-cloud收购。另外还有<a href="http://redistogo.com/">Redis To Go</a>, <a href="https://openredis.com/">OpenRedis</a>, <a href="http://www.redisgreen.net/">RedisGreen</a>。</p>

<p>CopperEgg统计自己的用户在AWS上的数据库部署：mysqld占了50%半壁江山, redis占了18%排第二, mongodb也有11%, cassandra是3%，Oracle只有可怜的2%。</p>

<p>Chef Recipes：<a href="https://github.com/brianbianco/redisio">brianbianco/redisio</a>，活跃，同步更新版本。</p>

<h3 id="部署模型">部署模型</h3>

<p>Redis只能使用单线程，为了提高CPU利用率，有提议在同一台服务器上启动多个Redis实例，但这会带来严重的IO争用，除非Redis不需要持久化，或者有某种方式保证多个实例不会在同一个时间重写AOF。</p>

<p>一组sentinel能同时监控多个Master。</p>

<p>有提议说环形的slave结构，即master只连一个slave，然后slave再连slave，此部署有两个前提，一是有大量的只读需求需要在slave完成，二是对slave传递时的数据不一致性不敏感。</p>

<h3 id="配置">配置</h3>

<p>约30个配置项，全都有默认配置，对redif.conf默认配置的修改见附录1。</p>

<h4 id="三条路">三条路</h4>

<p>可以配置文件中编写。</p>

<p>可以在启动时的命令行配置，redis-server &ndash;port 7777 &ndash;slaveof 127.0.0.1 8888。</p>

<p>云时代大规模部署，把配置文件满街传显然不是好的做法， 可以用redis-cli执行<a href="http://redis.readthedocs.org/en/latest/server/config_set.html">Config Set</a>指令， 修改所有的参数，达到维护人员最爱的不重启服务而修改参数的效果，而且在新版本里还可以执行 <a href="http://antirez.com/news/54">Config Rewrite</a> 将改动写回到文件中，不过全部默认值都会打印出来，可能会破坏掉原来的文件的排版，注释。</p>

<h4 id="安全保护">安全保护</h4>

<p>在配置文件里设置密码：requirepass foobar。</p>

<p>禁止某些危险命令，比如残暴的FlushDB，将它rename成&rdquo;&ldquo;：rename-command FLUSHDB &ldquo;&ldquo;。</p>

<h3 id="监控与维护">监控与维护</h3>

<p>综述： <a href="http://blog.nosqlfan.com/html/4166.html">Redis监控技巧</a></p>

<h4 id="监控指令">监控指令</h4>

<p><a href="http://redis.readthedocs.org/en/latest/server/info.html">Info</a>指令将返回非常丰富的信息。 着重监控检查内存使用，是否已接近上限，used_memory是Redis申请的内存，used_memory_rss是操作系统分配给Redis的物理内存，两者之间隔着碎片，隔着Swap。</p>

<p>还有重点监控 AOF与RDB文件的保存情况，以及master-slave的关系。Statistic 信息还包括key命中率，所有命令的执行次数，所有client连接数量等， <a href="http://redis.readthedocs.org/en/latest/server/config_resetstat.html">CONFIG RESETSTAT</a> 可重置为0。</p>

<p><a href="http://redis.readthedocs.org/en/latest/server/monitor.html">Monitor</a>指令可以显示Server收到的所有指令，主要用于debug，影响性能，生产环境慎用。</p>

<p>SlowLog 检查慢操作(见2.性能)。</p>

<h4 id="trouble-shooting支持">Trouble Shooting支持</h4>

<p>日志可以动态的设置成verbose/debug模式，但不见得有更多有用的log可看,verbose还会很烦的每5秒打印当前的key情况和client情况。指令为config set loglevel verbose。</p>

<p>最爱Redis的地方是代码只有2.3万行，而且编码优美，而且huangz同学还在原来的注释上再加上了中文注释——<a href="https://github.com/huangz1990/annotated_redis_source/">Redis 2.6源码中文注释版</a> ，所以虽然是C写的代码，虽然有十年没看过C代码，但这几天trouble shooting毫无难度，一看就懂。</p>

<p>Trobule shotting的经历证明antirez处理issue的速度非常快(如果你的issue言之有物的话)，比Weblogic之类的商业支持还好。</p>

<h4 id="持久化文件维护">持久化文件维护</h4>

<p>如果AOF文件在写入过程中crash，可以用redis-check-aof修复，见5.1.2</p>

<p>如果AOF rewrite和 RDB snapshot的过程中crash，会留下无用的临时文件，需要定期扫描删除。</p>

<h4 id="三方工具">三方工具</h4>

<p>官网列出了如下工具，但暂时没发现会直接拿来用的：</p>

<p><a href="http://www.nkrode.com/article/real-time-dashboard-for-redis">Redis Live</a>，基于Python的web应用，使用Info和Monitor获得系统情况和指令统计分析。 因为Monitor指令影响性能，所以建议用cron定期运行，每次偷偷采样两分钟的样子。</p>

<p><a href="https://github.com/ErikDubbelboer/phpRedisAdmin">phpRedisAdmin</a>，基于php的Web应用，目标是MysqlAdmin那样的管理工具，可以管理每一条Key的情况，但它的界面应该只适用于Key的数量不太多的情况，Demo。</p>

<p><a href="https://github.com/Instagram/redis-faina">Redis Faina</a>，基于Python的命令行，Instagram出品，用户自行获得Monitor的输出后发给它进行统计分析。由于Monitor输出的格式在Redis版本间不一样，要去github下最新版。</p>

<p><a href="https://github.com/sripathikrishnan/redis-rdb-tools">Redis-rdb-tools</a> 基于Python的命令行，可以分析RDB文件每条Key对应value所占的大小，还可以将RDB dump成普通文本文件然后比较两个库是否一致，还可以将RDB输出成JSON格式，可能是最有用的一个了。</p>

<p><a href="https://github.com/antirez/redis-sampler">Redis Sampler</a>，基于Ruby的命令行，antirez自己写的，统计数据分布情况。</p>

<h2 id="java-driver">Java Driver</h2>

<h3 id="driver选择">Driver选择</h3>

<p>各个Driver好像只有<a href="https://github.com/xetorthio/jedis/">Jedis</a>比较活跃，但也5个月没提交了，也是Java里唯一的Redis官方推荐。</p>

<p><a href="http://www.springsource.org/spring-data/redis">Spring Data Redis</a>的封装并不太必要，因为Jedis已足够简单，没有像Spring Data MongoDB对MongoDB java driver的封装那样大幅简化代码，顶多就是加强了一点点点pipeline和transaction状态下的coding，禁止了一些此状态下不能用的命令。</p>

<p>而所谓屏蔽各种底层driver的差异并不太吸引人，因为我就没打算选其他几种driver。有兴趣的可以翻翻<a href="https://github.com/SpringSource/spring-data-redis/blob/master/src/main/java/org/springframework/data/redis/connection/jedis/JedisConnection.java">它的JedisConnection代码</a>。</p>

<p>所以，SpringSide直接在Jedis的基础上，按Spring的风格封装了一个JedisTemplate，负责从池中获取与归还Jedis实例，处理异常。</p>

<h3 id="jedis的细节">Jedis的细节</h3>

<p>Jedis基于Apache Commons Pool做的连接池，默认MaxActive最大连接数只有8，必须重新设置。而且MaxIdle也要相应增大，否则所有新建的连接用完即弃，然后会不停的重新连接。</p>

<p>另外Jedis设定了每30秒对所有连接执行一次ping，以发现失效的连接，这样每30秒会有一个拿不到连接的高峰。</p>

<p>但效果如何需要独立分析。比如系统高峰之后可能有一长段时间很闲，而且Redis Server那边做了Timeout控制会把连接断掉，这时候做idle checking是有意义的，但30秒一次也太过频繁了。否则关掉它更好。</p>

<p>Jedis的blocking pop函数，应用执行ExecutorService.shutdownNow()中断线程时并不能把它中断，见讨论组。</p>

<p>两个解决方法：</p>

<p>不要用不限时的blocking popup，传多一个超时时间参数，如5秒。</p>

<p>找地方将调用blocking popup的jedis保存起来，shutdown时主动调用它的close。</p>

<h3 id="redis对client端连接的处理">Redis对Client端连接的处理</h3>

<p>Redis默认最大连接数是一万。</p>

<p>Redis默认不对Client做Timeout处理，可以用timeout 项配置，但即使配了也不会非常精确。</p>

<h2 id="windows的版本">Windows的版本</h2>

<p>Windows版本方便对应用的本地开发调试，但Redis并没有提供，好在微软提供了一个依赖LibUV实现兼容的补丁，<a href="https://github.com/MSOpenTech/redis%EF%BC%8C%E4%BD%86redis%E4%BD%9C%E8%80%85%E6%8B%92%E7%BB%9D%E5%90%88%E5%B9%B6%E5%88%B0master%E4%B8%AD%EF%BC%8C%E5%BE%AE%E8%BD%AF%E5%8F%AA%E5%A5%BD%E8%8B%A6%E6%86%8B%E7%9A%84%E6%97%B6%E6%97%B6%E4%BA%BA%E5%B7%A5%E5%90%8C%E6%AD%A5%E3%80%82">https://github.com/MSOpenTech/redis，但redis作者拒绝合并到master中，微软只好苦憋的时时人工同步</a>。</p>

<p>目前的稳定版是2.6版本，支持Lua脚本。</p>

<p>因为github现在已经没有Download服务了，所以编译好的可执行文件藏在这里：</p>

<p><a href="https://github.com/MSOpenTech/redis/tree/2.6/bin/release">https://github.com/MSOpenTech/redis/tree/2.6/bin/release</a></p>

<h2 id="成功案例">成功案例</h2>

<p>注：下文中的链接都是网站的架构描述文档。</p>

<p><a href="http://www.infoq.com/presentations/Real-Time-Delivery-Twitter">Twitter</a>和<a href="http://www.infoq.com/cn/presentations/tfl-sina-weibo-platform-redis-practice">新浪微博</a>， 都属于将Redis各种数据结构用得出神入化的那种，如何发布大V如奥巴马的消息是它们最头痛的问题。</p>

<p><a href="http://highscalability.com/blog/2013/5/20/the-tumblr-architecture-yahoo-bought-for-a-cool-billion-doll.html">Tumblr</a>： 11亿美刀卖给Yahoo的图片日志网站，22 台Redis server，每台运行8 - 32个实例，总共100多个Redis实例在跑。</p>

<p>有着Redis has been completely problem free and the community is great的崇高评价。Redis在里面扮演了八爪鱼多面手的角色：</p>

<p>Dashboard的海量通知的存储。</p>

<p>Dashboard的二级索引。</p>

<p>存储海量短链接的HBase前面的缓存。</p>

<p>Gearman Job Queue的存储。</p>

<p>正在替换另外30台memcached。</p>

<p><a href="http://highscalability.com/blog/2011/12/6/instagram-architecture-14-million-users-terabytes-of-photos.html">Instagram</a> ，曾经，Redis powers their main feed, activity feed, sessions system, and <a href="http://highscalability.com/blog/2012/4/16/instagram-architecture-update-whats-new-with-instagram.html">other services</a>。</p>

<p>但可惜目前<a href="http://planetcassandra.org/blog/post/instagram-making-the-switch-to-cassandra-from-redis-75-instasavings">已迁往Cassandra</a>，说新架构只需1/4的硬件费用，是的，就是那个导致Digg CTO辞职的Canssandra。</p>

<p><a href="http://code.flickr.net/2011/10/11/talk-real-time-updates-on-the-cheap-for-fun-and-profit/">Flickr</a> , 依然是asynchronous task system and rudimentary queueing system。之前Task system放在mysql innodb，根本，撑不住。</p>

<p>The Others：</p>

<p><a href="http://nosql.mypopescu.com/post/17658415847/polyglot-persistence-at-pinterest-redis-membase">Pinterest</a>，混合使用MySQL、Membase与Redis作为存储。</p>

<p><a href="http://highscalability.com/blog/2012/4/2/youporn-targeting-200-million-views-a-day-and-beyond.html">Youporn.com</a>，100%的Redis，MySQL只用于创建新需求用到的sorted set，300K QPS的大压力。</p>

<p><a href="http://tech.naver.jp/blog/?p=1420">日本微信</a> ，Redis在前负责异步Job Queue和O(n)的数据，且作为O(n*t)数据的cache，HBase在后，负责O(n*t)数据， n是用户，t是时间。</p>

<p><a href="http://highscalability.com/blog/2011/3/3/stack-overflow-architecture-update-now-at-95-million-page-vi.html">StackOverflow</a> ，2 Redis servers for distribute caching，好穷好轻量。</p>

<p><a href="https://github.com/blog/530-how-we-made-github-fast">Github</a>，任务系统<a href="http://github.com/defunkt/resque">Resque</a>的存储。</p>

<p><a href="https://github.com/discourse/discourse">Discourge</a>，号称是为下一个十年打造的论坛系统， We use Redis for our job queue, rate limiting, as a cache and for transient data，刚好和我司的用法一样。</p>

<p>情色网站 YouPorn，使用 Redis 进行数据存储，Redis 服务器每秒处理30万个页面请求，每小时会记录8-15GB数据。</p>

<h2 id="in-springside">In SpringSide</h2>

<p>extension modules项目封装了常用的函数与场景，showcase example的src/demo/redis目录里有各场景的benchmark测试。</p>

<h3 id="jedis-template">Jedis Template</h3>

<p>典型的Spring Template风格，和JdbcTemplate，HibernateTemplate一样，封装从JedisPool获取与归还Connecton的代码，有带返回值与无返回值两种返回接口。</p>

<p>同时，对最常用的Jedis调用，直接封装了一系列方法。</p>

<h3 id="scheduler与master-elector">Scheduler与Master Elector</h3>

<p>Scheduler实现了基于Redis的高并发单次定时任务分发。具体选型见<a href="https://github.com/springside/springside4/wiki/Schedule">Scheduler</a>章节。</p>

<p>Master Elector基于redis setNx()与expire()两个api实现，与基于Zookeeper，Hazelcast实现的效果类似。</p>

<h3 id="showcase中的demo">Showcase中的Demo</h3>

<p>计有Session，Counter，Scheduler 与 Master Elector四款。</p>

<h2 id="附录">附录</h2>

<h3 id="附录1-对redis-conf默认配置的修改">附录1： 对redis.conf默认配置的修改</h3>

<h4 id="master主机">Master主机</h4>

<p>daemonize no -&gt; yes ，启动daemonize模式，注意如果用daemon工具启动redis-server时设回false。
logfile stdout -&gt; /var/log/redis/redis.log ，指定日志文件
注释掉RDB的所有触发规则，在Master不保存RDB文件。
dir ./ -&gt; /var/data/redis，指定持久化文件及临时文件目录.
maxmemory，设置为可用内存/2.
(可选)appendonly no-&gt;yes，打开AOF文件.
auto-aof-rewrite-percentage 100, 综合考虑硬盘大小，可接受重启加载延时等尽量的大，减少AOF rewrite频率.
auto-aof-rewrite-min-size 64mb，同上，起码设为5G.
client-output-buffer-limit slave 256mb 64mb 60. 考虑Traffic及Slave同步是RDB加载所需时间，正确设置避免buffer撑爆client被关掉后又要重新进行全同步。
Master上的安全配置，可选。</p>

<h4 id="slave主机">Slave主机</h4>

<p>设置RDB保存频率，因为RDB只作为Backup工具，只保留15分钟的规则，设置为15分钟保存一次就够了save 900 1。</p>

<p>(可选)slaveof 设置master地址，也可动态设定。</p>

<p>repl-timeout 60, 适当加大比如120，避免master实际还没倒掉就认为master倒了。</p>

<h3 id="附录2-版本变更历史">附录2：版本变更历史</h3>

<p>3.0.1版-3.0.3版 2013-8-1，在微博发布后反应良好，持续修改。</p>

<p>3.0版 2013-6-29，在公司Workshop后修订，提高wiki的可读性而不只是简单的记录知识点。</p>

<h3 id="附录3-其他参考资料">附录3：其他参考资料</h3>

<p><a href="http://timyang.net/data/redis-misunderstanding/">Redis的几个认识误区</a> by Tim yang。</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/33-redis-considerations/#disqus_thread">Comments</a></span>
    
    
</div>
</article>

  <article class="post">
    <h2 class="title"> 
        <a href="https://ningyu1.github.io/site/post/32-redis-aof/">Trouble Shooting —— Enable AOF可能导致整个Redis被Block住，在3.0.6版本仍然存在</a>
    </h2>
    <div class="entry-content">
    <div class="meta">
        <div class="date">Published on: <time datetime='2017-10-09T09:53:36.000&#43;00:00' itemprop="datePublished">2017-10-09</time>
</div>
        <div class="tags">Tags: 

<a href="https://ningyu1.github.io/site/tags/redis">Redis</a>

<a href="https://ningyu1.github.io/site/tags/aof-block">AOF Block</a>

<a href="https://ningyu1.github.io/site/tags/aof">AOF</a>

<a href="https://ningyu1.github.io/site/tags/asynchronous-aof-fsync-is-taking-too-long-disk-is-busywriting-the-aof-buffer-without-waiting-for-fsync-to-complete-this-may-slow-down-redis">Asynchronous AOF fsync is taking too long (disk is busy?)Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis</a>

<a href="https://ningyu1.github.io/site/tags/%E8%B0%83%E4%BC%98">调优</a>


</div>
    </div>
        

<h2 id="redis会有短暂的几秒block-应用报-jedis-connection-failed-retrying">Redis会有短暂的几秒Block，应用报：Jedis connection failed, retrying&hellip;</h2>

<p>这个问题现象是这样的，应用周期性的报：Jedis connection failed, retrying&hellip;，Redis开启AOF会被Block住导致无法连接，查看redis的日志</p>

<pre><code>1486:M 09 Oct 09:33:18.072 * 10 changes in 300 seconds. Saving...
1486:M 09 Oct 09:33:18.075 * Background saving started by pid 20706
1486:M 09 Oct 09:33:34.011 * Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.
20706:C 09 Oct 09:33:42.629 * DB saved on disk
20706:C 09 Oct 09:33:42.630 * RDB: 178 MB of memory used by copy-on-write
1486:M 09 Oct 09:33:42.723 * Background saving terminated with success
</code></pre>

<p>重点：<code>Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.</code></p>

<p>为什么每次写入磁盘会有disk is busy？这个问题？</p>

<p>网上有人写到：当AOF rewrite 15G大小的内存时，Redis整个死掉的样子，所有指令甚至包括slave发到master的ping，redis-cli info都不能被执行。</p>

<h2 id="原因分析">原因分析</h2>

<p><a href="http://www.redis.io/topics/latency">官方文档，由IO产生的Latency详细分析</a>, 已经预言了悲剧的发生，但一开始没留意。</p>

<p>Redis为求简单，采用了单请求处理线程结构。</p>

<p>打开AOF持久化功能后， Redis处理完每个事件后会调用write(2)将变化写入kernel的buffer，如果此时write(2)被阻塞，Redis就不能处理下一个事件。</p>

<p>Linux规定执行write(2)时，如果对同一个文件正在执行fdatasync(2)将kernel buffer写入物理磁盘，或者有system wide sync在执行，write(2)会被Block住，整个Redis被Block住。</p>

<p>如果系统IO繁忙，比如有别的应用在写盘，或者Redis自己在AOF rewrite或RDB snapshot(虽然此时写入的是另一个临时文件，虽然各自都在连续写，但两个文件间的切换使得磁盘磁头的寻道时间加长），就可能导致fdatasync(2)迟迟未能完成从而Block住write(2)，Block住整个Redis。</p>

<p>为了更清晰的看到fdatasync(2)的执行时长，可以使用&rdquo;strace -p (pid of redis server) -T -e -f trace=fdatasync&rdquo;，但会影响系统性能。</p>

<p>Redis提供了一个自救的方式，当发现文件有在执行fdatasync(2)时，就先不调用write(2)，只存在cache里，免得被Block。但如果已经超过两秒都还是这个样子，则会硬着头皮执行write(2)，即使redis会被Block住。</p>

<p>此时那句要命的log会打印：“Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.”</p>

<p>之后用redis-cli INFO可以看到aof_delayed_fsync的值被加1。</p>

<p>因此，对于fsync设为everysec时丢失数据的可能性的最严谨说法是：如果有fdatasync在长时间的执行，此时redis意外关闭会造成文件里不多于两秒的数据丢失。</p>

<p>如果fdatasync运行正常，redis意外关闭没有影响，只有当操作系统crash时才会造成少于1秒的数据丢失。</p>

<h2 id="影响版本">影响版本</h2>

<p>网上有说是在2.6.12版之前，但是我们使用的版本：redis_version:3.0.6 任然存在这个问题</p>

<h2 id="解决方法">解决方法</h2>

<p>最后发现，原来是AOF rewrite时一直埋头的调用write(2)，由系统自己去触发sync。在RedHat Enterprise 6里，默认配置vm.dirty_background_ratio=10，也就是占用了10%的可用内存才会开始后台flush，而我的服务器有8G内存。</p>

<p>很明显一次flush太多数据会造成阻塞，所以最后果断设置了sysctl vm.dirty_bytes=33554432(32M)，问题解决。</p>

<p>然后提了个issue，<a href="https://github.com/antirez/redis/issues/1019">AOF rewrite时定时也执行一下fdatasync嘛</a>， antirez回复新版中，AOF rewrite时32M就会重写主动调用fdatasync。</p>

<ul>
<li>查看一下系统内核参数</li>
</ul>

<pre><code>&gt;sysctl -a | grep dirty_background_ratio
vm.dirty_background_ratio = 10

&gt;sysctl -a | grep vm.dirty_bytes
vm.dirty_bytes = 0
</code></pre>

<p><strong>ps.尝试修改一下</strong></p>

<ul>
<li>编辑/etc/sysctl.conf</li>
</ul>

<pre><code>&gt;vi /etc/sysctl.conf

## 在最后面增加
# 32M
vm.dirty_bytes=33554432

</code></pre>

<p><strong>ps.保存后下次启动会生效，下面是立即生效的修改方法：</strong></p>

<ul>
<li>立即生效的修改方法</li>
</ul>

<pre><code>&gt;sysctl vm.dirty_bytes=33554432
&gt;sysctl -p
</code></pre>

<ul>
<li>验证修改是否成功</li>
</ul>

<pre><code>&gt;sysctl -a | grep vm.dirty_bytes
vm.dirty_bytes = 33554432
</code></pre>

<ul>
<li>修改后redis下次RDB和AOF时的日志</li>
</ul>

<pre><code>1486:M 09 Oct 10:05:02.043 * 10 changes in 300 seconds. Saving...
1486:M 09 Oct 10:05:02.046 * Background saving started by pid 20987
20987:C 09 Oct 10:05:17.188 * DB saved on disk
20987:C 09 Oct 10:05:17.188 * RDB: 944 MB of memory used by copy-on-write
1486:M 09 Oct 10:05:17.274 * Background saving terminated with success
</code></pre>

<p>从redis的日志中发现已经没有了这句：<code>Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis.</code></p>

<p>应用日志中也看不到：<code>Jedis connection failed, retrying...</code>异常</p>

<p>这个问题解决</p>

    </div>

<div class="meta">
    
    
    <span class="comments"><a href="https://ningyu1.github.io/site/post/32-redis-aof/#disqus_thread">Comments</a></span>
    
    
</div>
</article>



  <nav id="pagenavi">
    
        <a href="https://ningyu1.github.io/site/page/7/" class="prev">Prev</a>
    
    
        <a href="https://ningyu1.github.io/site/page/9/" class="next">Next</a>
    
    <div class="center"><a href="https://ningyu1.github.io/site/archives/index.html">Blog Archives</a></div>
  </nav>


    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2024
    
    凝雨-Yun
    . Powered by <a href="http://gohugo.io" target="_blank">Hugo</a> |
    Theme is <a href="https://github.com/wd/hugo-fabric">hugo-fabric</a>
</div>

    </footer>
    <script src="https://ningyu1.github.io/site/js/fabric.js"></script>


</div>
</div>
<script src="https://ningyu1.github.io/site/js/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
 
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery);
 
</script>
</body>
</html>
